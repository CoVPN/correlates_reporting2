---
title: "COVAIL Prototype vs. Omicron-Containing Cohort and Vaccine Efficacy Report for Manuscript"
author: "COVAIL Biostatistics Team"
date: "2024-02-27"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(CFsurvival) 
library(dplyr)
library(survival)
library(lubridate)
library(tableone)
library(patchwork)
library(readr)
library(tidyverse)
library(survminer)
```

# Cohort

A total of n = 907 participants were enrolled in one of the one-dose mRNA Prototype or mRNA Omicron-Containing vaccine arms. 
Among these, n = 904 had no eligibility deviation and had both D1 and D15 markers measured. 
The number of participants in each vaccine arm (treatment_actual) is as follows:

* Stage 1 Beta + Omicron (n = 111)

* Stage 1 Delta + Omicron (n = 100)

* Stage 1 Omicron (n = 99)

* Stage 1 Omicron + Prototype (n = 96)

* Stage 1 Prototype (n = 97)

* Stage 2 Beta + Omicron (n = 51)

* Stage 2 Omicron (n = 53)

* Stage 2 Omicron + Prototype (n = 52)

* Stage 2 Prototype (n = 47)

* Stage 4 Omicron BA.1 + Prototype (n = 99)

* Stage 4 Omicron BA.4/5 + Prototype (n = 99)

Among the 904 participants, n = 503 were enrolled in the Stage 1 (Moderna) arms, 
n = 203 were enrolled in the Stage 2 (Pfizer) arms, and the other n = 198 were
enrolled in the Stage 4 (Pfizer) arms. Stage 1 and Stage 2 can be viewed as two
separate RCTs. We will focus in the two RCTs in the rest of this report. 

Among 904 participants, there were 212 COVID endpoints through 188 days post D15,
among which 17 were early infections.

```{r echo=FALSE}
# read dataset
dt = read.csv('covail_data_processed_20240313.csv')

dtB = dt %>%
  filter(!is.na(TrtB)) %>% # n = 907
  filter(!eligibility_deviation == 'Y') %>% # -2
  filter(D1_D15_flag == 1) %>% # - 1 --> n = 904
  mutate(Bpseudoneutid50_BA.1 = ifelse(Bpseudoneutid50_BA.1 > log10(27104), 
                                       log10(27104), Bpseudoneutid50_BA.1)) %>%
  mutate(Bpseudoneutid50_BA.4.BA.5 = ifelse(Bpseudoneutid50_BA.4.BA.5 > log10(58293), 
                                            log10(58293), Bpseudoneutid50_BA.4.BA.5)) %>%
  mutate(Bpseudoneutid50_Beta = ifelse(Bpseudoneutid50_Beta > log10(35879), 
                                       log10(35879), Bpseudoneutid50_Beta)) %>%
  mutate(Bpseudoneutid50_D614G = ifelse(Bpseudoneutid50_D614G > log10(198904), 
                                        log10(198904), Bpseudoneutid50_D614G)) %>%
  mutate(Bpseudoneutid50_Delta = ifelse(Bpseudoneutid50_Delta > log10(145858), 
                                        log10(145858), Bpseudoneutid50_Delta)) %>%
  mutate(Day15pseudoneutid50_BA.1 = ifelse(Day15pseudoneutid50_BA.1 > log10(27104), 
                                       log10(27104), Day15pseudoneutid50_BA.1)) %>%
  mutate(Day15pseudoneutid50_BA.4.BA.5 = ifelse(Day15pseudoneutid50_BA.4.BA.5 > log10(58293), 
                                            log10(58293), Day15pseudoneutid50_BA.4.BA.5)) %>%
  mutate(Day15pseudoneutid50_Beta = ifelse(Day15pseudoneutid50_Beta > log10(35879), 
                                       log10(35879), Day15pseudoneutid50_Beta)) %>%
  mutate(Day15pseudoneutid50_D614G = ifelse(Day15pseudoneutid50_D614G > log10(198904), 
                                        log10(198904), Day15pseudoneutid50_D614G)) %>%
  mutate(Day15pseudoneutid50_Delta = ifelse(Day15pseudoneutid50_Delta > log10(145858), 
                                        log10(145858), Day15pseudoneutid50_Delta)) %>%
  mutate(Day181pseudoneutid50_BA.1 = ifelse(Day181pseudoneutid50_BA.1 > log10(27104), 
                                       log10(27104), Day181pseudoneutid50_BA.1)) %>%
  mutate(Day181pseudoneutid50_BA.4.BA.5 = ifelse(Day181pseudoneutid50_BA.4.BA.5 > log10(58293), 
                                            log10(58293), Day181pseudoneutid50_BA.4.BA.5)) %>%
  mutate(Day181pseudoneutid50_Beta = ifelse(Day181pseudoneutid50_Beta > log10(35879), 
                                       log10(35879), Day181pseudoneutid50_Beta)) %>%
  mutate(Day181pseudoneutid50_D614G = ifelse(Day181pseudoneutid50_D614G > log10(198904), 
                                        log10(198904), Day181pseudoneutid50_D614G)) %>%
  mutate(Day29pseudoneutid50_Delta = ifelse(Day29pseudoneutid50_Delta > log10(145858), 
                                        log10(145858), Day29pseudoneutid50_Delta)) %>%
  mutate(Day29pseudoneutid50_BA.1 = ifelse(Day29pseudoneutid50_BA.1 > log10(27104), 
                                       log10(27104), Day29pseudoneutid50_BA.1)) %>%
  mutate(Day29pseudoneutid50_BA.4.BA.5 = ifelse(Day29pseudoneutid50_BA.4.BA.5 > log10(58293), 
                                            log10(58293), Day29pseudoneutid50_BA.4.BA.5)) %>%
  mutate(Day29pseudoneutid50_Beta = ifelse(Day29pseudoneutid50_Beta > log10(35879), 
                                       log10(35879), Day29pseudoneutid50_Beta)) %>%
  mutate(Day29pseudoneutid50_D614G = ifelse(Day29pseudoneutid50_D614G > log10(198904), 
                                        log10(198904), Day29pseudoneutid50_D614G)) %>%
  mutate(Day29pseudoneutid50_Delta = ifelse(Day29pseudoneutid50_Delta > log10(145858), 
                                        log10(145858), Day29pseudoneutid50_Delta)) %>%
  mutate(Day91pseudoneutid50_BA.1 = ifelse(Day91pseudoneutid50_BA.1 > log10(27104), 
                                       log10(27104), Day91pseudoneutid50_BA.1)) %>%
  mutate(Day91pseudoneutid50_BA.4.BA.5 = ifelse(Day91pseudoneutid50_BA.4.BA.5 > log10(58293), 
                                            log10(58293), Day91pseudoneutid50_BA.4.BA.5)) %>%
  mutate(Day91pseudoneutid50_Beta = ifelse(Day91pseudoneutid50_Beta > log10(35879), 
                                       log10(35879), Day91pseudoneutid50_Beta)) %>%
  mutate(Day91pseudoneutid50_D614G = ifelse(Day91pseudoneutid50_D614G > log10(198904), 
                                        log10(198904), Day91pseudoneutid50_D614G)) %>%
  mutate(Day91pseudoneutid50_Delta = ifelse(Day91pseudoneutid50_Delta > log10(145858), 
                                        log10(145858), Day91pseudoneutid50_Delta))
dtB_cumulative_incidence = dtB %>%
  select(Ptid, COVIDIndD22toD181, COVIDtimeD22toD181, 
         COVIDIndD22toD91, COVIDtimeD22toD91, 
         Actual_visit_date_15.2, studydose1date,
         naive, Bpseudoneutid50_BA.1, Bpseudoneutid50_Beta,
         Bpseudoneutid50_Delta, Bpseudoneutid50_D614G, Bpseudoneutid50_BA.4.BA.5,
         Bpseudoneutid50_MDW, 
         Day15pseudoneutid50_BA.1, Day15pseudoneutid50_Beta,
         Day15pseudoneutid50_Delta, Day15pseudoneutid50_D614G, Day15pseudoneutid50_BA.4.BA.5,
         Day15pseudoneutid50_MDW, 
         Day29pseudoneutid50_BA.1, Day29pseudoneutid50_Beta,
         Day29pseudoneutid50_Delta, Day29pseudoneutid50_D614G, Day29pseudoneutid50_BA.4.BA.5,
         Day29pseudoneutid50_MDW, 
         
         Day91pseudoneutid50_BA.1, Day91pseudoneutid50_Beta,
         Day91pseudoneutid50_Delta, Day91pseudoneutid50_D614G, Day91pseudoneutid50_BA.4.BA.5,
         Day91pseudoneutid50_MDW, 
         
         Day181pseudoneutid50_BA.1, Day181pseudoneutid50_Beta,
         Day181pseudoneutid50_Delta, Day181pseudoneutid50_D614G, Day181pseudoneutid50_BA.4.BA.5,
         Day181pseudoneutid50_MDW, 
         primary_booster_type, FOIoriginal,
         FOIstandardized, risk_score,
         TrtA, TrtB, TrtC, treatment_actual, stage, ph1.D15,
         Immunemarkerset, COVIDlineage, COVIDlineageObserved) %>% 
  mutate(risk_score = ifelse(is.na(risk_score), # Impute one missing risk score
                             median(risk_score, na.rm = TRUE), risk_score)) %>%
  mutate(num_D15 = as.numeric(as.Date(Actual_visit_date_15.2) - as.Date(studydose1date))) %>%
  mutate(ftime = COVIDtimeD22toD181 + num_D15) %>% # Counting from D1
  mutate(COVIDIndD22toD181 = ifelse(is.na(COVIDIndD22toD181), 1, COVIDIndD22toD181)) %>% # 17 NA's are early infections
  mutate(COVIDIndD22toD91   = ifelse(is.na(COVIDIndD22toD91), 1, COVIDIndD22toD91))
```


## Stage 1 Moderna

We compare the distribution of baseline covariates among Prototype (TrtB = 1) and 
Omicron-Containing (TrtB = 0) vaccinees restricted to Stage 1 (randomized) Moderna
participants. Covariates were well-balanced because of randomization among these participants. 

```{r comp B Stage 1 Table one, echo=FALSE, message=FALSE, warning=FALSE}
dt_W_Moderna = dtB %>%
  dplyr::select(ph1.D15, Age, Age65C, Sex, Asian, Black, NatAmer, PacIsl, Multiracial,  
                ethnicity, White, 
         naive, FOIstandardized, risk_score, treatment_actual, TrtB, stage,
        Bpseudoneutid50_BA.1, Bpseudoneutid50_Beta,
         Bpseudoneutid50_Delta, Bpseudoneutid50_D614G, Bpseudoneutid50_BA.4.BA.5,
         Bpseudoneutid50_MDW, primary_booster_type,
      Day15pseudoneutid50_BA.1, Day15pseudoneutid50_Beta,
         Day15pseudoneutid50_Delta, Day15pseudoneutid50_D614G, Day15pseudoneutid50_BA.4.BA.5,
         Day15pseudoneutid50_MDW) %>%
  filter(stage == 1)

tableone_Moderna = tableone::CreateTableOne(data = dt_W_Moderna, 
                         vars = c('Age', 'Age65C', 'Sex', 
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'FOIstandardized', 
                                  'risk_score', 'Bpseudoneutid50_BA.1',
                                  'Bpseudoneutid50_BA.4.BA.5',
                                  'Bpseudoneutid50_Beta', 'Bpseudoneutid50_Delta',
                                  'Bpseudoneutid50_D614G', 'Bpseudoneutid50_MDW',
                                  'primary_booster_type'),
                         factorVars = c('Sex', 'Age65C',
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'primary_booster_type'), 
                         strata = 'TrtB',
                         test = TRUE)
print(tableone_Moderna)

write.csv(print(tableone_Moderna), 'Balance_table_Moderna.csv')
```

```{r comp B Stage 1 Table one Pooled, echo=FALSE, message=FALSE, warning=FALSE}
tableone_Moderna_pooled = tableone::CreateTableOne(data = dt_W_Moderna, 
                         vars = c('Age', 'Age65C', 'Sex', 
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'FOIstandardized', 
                                  'risk_score', 'Bpseudoneutid50_BA.1',
                                  'Bpseudoneutid50_BA.4.BA.5',
                                  'Bpseudoneutid50_Beta', 'Bpseudoneutid50_Delta',
                                  'Bpseudoneutid50_D614G', 'Bpseudoneutid50_MDW',
                                  'primary_booster_type'),
                         factorVars = c('Sex', 'Age65C',
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'primary_booster_type'), 
                         test = TRUE)
print(tableone_Moderna_pooled)

write.csv(print(tableone_Moderna_pooled), 'Balance_table_Moderna_pooled.csv')

tableone_Moderna_by_arm = tableone::CreateTableOne(data = dt_W_Moderna, 
                         vars = c('Age', 'Age65C', 'Sex', 
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'FOIstandardized', 
                                  'risk_score', 'Bpseudoneutid50_BA.1',
                                  'Bpseudoneutid50_BA.4.BA.5',
                                  'Bpseudoneutid50_Beta', 'Bpseudoneutid50_Delta',
                                  'Bpseudoneutid50_D614G', 'Bpseudoneutid50_MDW',
                                  'primary_booster_type'),
                         factorVars = c('Sex', 'Age65C',
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'primary_booster_type'), 
                         strata = 'treatment_actual',
                         test = TRUE)
print(tableone_Moderna_by_arm)

write.csv(print(tableone_Moderna_by_arm), 'Balance_table_Moderna_by_arm.csv')
```



## Stage 2 Pfizer

We then compare the distribution of baseline covariates among Prototype (TrtB = 1) and 
Omicron-Containing (TrtB = 0) vaccinees restricted to Stage 2 (randomized) Pfizer
participants. Covariates were well-balanced because of randomization among these participants. 

```{r comp B Stage 2 Table one, echo=FALSE, message=FALSE, warning=FALSE}
dt_W_Pfizer = dtB %>%
  dplyr::select(ph1.D15, Age, Age65C, Sex, Asian, Black, NatAmer, PacIsl, Multiracial,  
                ethnicity, White, 
         naive, FOIstandardized, risk_score, treatment_actual, TrtB, stage,
        Bpseudoneutid50_BA.1, Bpseudoneutid50_Beta,
         Bpseudoneutid50_Delta, Bpseudoneutid50_D614G, Bpseudoneutid50_BA.4.BA.5,
         Bpseudoneutid50_MDW, primary_booster_type,
        Day15pseudoneutid50_BA.1, Day15pseudoneutid50_Beta,
         Day15pseudoneutid50_Delta, Day15pseudoneutid50_D614G, Day15pseudoneutid50_BA.4.BA.5,
         Day15pseudoneutid50_MDW) %>%
  filter(stage == 2)

tableone_Pfizer = tableone::CreateTableOne(data = dt_W_Pfizer, 
                         vars = c('Age', 'Age65C', 'Sex', 
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'FOIstandardized', 
                                  'risk_score', 'Bpseudoneutid50_BA.1',
                                  'Bpseudoneutid50_BA.4.BA.5',
                                  'Bpseudoneutid50_Beta', 'Bpseudoneutid50_Delta',
                                  'Bpseudoneutid50_D614G', 'Bpseudoneutid50_MDW',
                                  'primary_booster_type'),
                         factorVars = c('Sex', 'Age65C',
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'primary_booster_type'), 
                         strata = 'TrtB',
                         test = TRUE)
print(tableone_Pfizer)

write.csv(print(tableone_Pfizer), 'Balance_table_Pfizer.csv')

# Calculate incidence
dtB_cumulative_incidence %>%
  filter(stage == 2) %>%
  group_by(TrtB) %>%
  summarise(total_follow_up = sum(COVIDtimeD22toD181)/365,
            total_num = sum(COVIDIndD22toD181),
            incidence = total_num/total_follow_up)
```


```{r comp B Stage 2 Table one pooled, echo=FALSE, message=FALSE, warning=FALSE}
tableone_Pfizer_pooled = tableone::CreateTableOne(data = dt_W_Pfizer, 
                         vars = c('Age', 'Age65C', 'Sex', 
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'FOIstandardized', 
                                  'risk_score', 'Bpseudoneutid50_BA.1',
                                  'Bpseudoneutid50_BA.4.BA.5',
                                  'Bpseudoneutid50_Beta', 'Bpseudoneutid50_Delta',
                                  'Bpseudoneutid50_D614G', 'Bpseudoneutid50_MDW',
                                  'primary_booster_type'),
                         factorVars = c('Sex', 'Age65C',
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'primary_booster_type'), 
                         test = TRUE)
print(tableone_Pfizer_pooled)

write.csv(print(tableone_Pfizer_pooled), 'Balance_table_Pfizer_pooled.csv')

tableone_Pfizer_by_arm = tableone::CreateTableOne(data = dt_W_Pfizer, 
                         vars = c('Age', 'Age65C', 'Sex', 
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'FOIstandardized', 
                                  'risk_score', 'Bpseudoneutid50_BA.1',
                                  'Bpseudoneutid50_BA.4.BA.5',
                                  'Bpseudoneutid50_Beta', 'Bpseudoneutid50_Delta',
                                  'Bpseudoneutid50_D614G', 'Bpseudoneutid50_MDW',
                                  'primary_booster_type'),
                         factorVars = c('Sex', 'Age65C',
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'primary_booster_type'), 
                         strata = 'treatment_actual',
                         test = TRUE)
print(tableone_Pfizer_by_arm)

write.csv(print(tableone_Pfizer_by_arm), 'Balance_table_Pfizer_by_arm.csv')
```

## Compare immunogenicity
```{r immuno compare pooled}
library(boot)
dt_WB = rbind(dt_W_Moderna, dt_W_Pfizer)
mean_diff = function(data, indices){
  d = data[indices,]
  mdM = lm(Bpseudoneutid50_MDW ~ Age + Sex + naive + risk_score, 
         data = d,
         subset = (stage == 1))
  
  mdP = lm(Bpseudoneutid50_MDW ~ Age + Sex + naive + risk_score, 
         data = d,
         subset = (stage == 2))
  pred_M = predict(mdM, newdata = d[, c('Age', 'Sex', 'naive', 'risk_score')])
  pred_P = predict(mdP, newdata = d[, c('Age', 'Sex', 'naive', 'risk_score')])
  t = mean(pred_P) - mean(pred_M)
  return(t)
}

r = boot(data = dt_WB, statistic = mean_diff, R = 2000)
p = mean(r$t>=r$t0)
```


```{r immuno compare by trt}
library(boot)

dt_W_Moderna_P = dt_W_Moderna %>% filter(TrtB == 1)
dt_W_Moderna_OC = dt_W_Moderna %>% filter(TrtB == 0)
dt_W_Pfizer_P = dt_W_Pfizer %>% filter(TrtB == 1)
dt_W_Pfizer_OC = dt_W_Pfizer %>% filter(TrtB == 0)

dt_W_P = rbind(dt_W_Moderna_P, dt_W_Pfizer_P)
dt_W_OC = rbind(dt_W_Moderna_OC, dt_W_Pfizer_OC)

tableone::CreateTableOne(data = dt_W_P, 
                         vars = c('Age', 'Age65C', 'Sex', 
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'FOIstandardized', 
                                  'risk_score', 'Bpseudoneutid50_BA.1',
                                  'Bpseudoneutid50_BA.4.BA.5',
                                  'Bpseudoneutid50_Beta', 'Bpseudoneutid50_Delta',
                                  'Bpseudoneutid50_D614G', 'Bpseudoneutid50_MDW',
                                  'primary_booster_type'),
                         factorVars = c('Sex', 'Age65C',
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'primary_booster_type'), 
                         strata = 'stage',
                         test = TRUE)

tableone::CreateTableOne(data = dt_W_OC, 
                         vars = c('Age', 'Age65C', 'Sex', 
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'FOIstandardized', 
                                  'risk_score', 'Bpseudoneutid50_BA.1',
                                  'Bpseudoneutid50_BA.4.BA.5',
                                  'Bpseudoneutid50_Beta', 'Bpseudoneutid50_Delta',
                                  'Bpseudoneutid50_D614G', 'Bpseudoneutid50_MDW',
                                  'primary_booster_type'),
                         factorVars = c('Sex', 'Age65C',
                                  'Asian', 'Black', 'NatAmer', 'PacIsl', 'Multiracial', 'White',
                                  'ethnicity', 'naive', 'primary_booster_type'), 
                         strata = 'stage',
                         test = TRUE)


mean_diff = function(data, indices, v = 'Bpseudoneutid50_MDW'){
     d = data[indices,]
     mdM = lm( as.formula(paste(v, '~ Age + Sex + naive + risk_score')),  
              data = d,
              subset = (stage == 1))
     
     mdP = lm(as.formula(paste(v, '~ Age + Sex + naive + risk_score')), 
              data = d,
              subset = (stage == 2))
     pred_M = predict(mdM, newdata = d[, c('Age', 'Sex', 'naive', 'risk_score')])
     pred_P = predict(mdP, newdata = d[, c('Age', 'Sex', 'naive', 'risk_score')])
     t = mean(pred_P) - mean(pred_M)
     return(t)
}

r1 = boot(data = dt_W_OC, statistic = mean_diff, v = 'Bpseudoneutid50_BA.1', R = 2000)
mean(r1$t>=r1$t0)

r2 = boot(data = dt_W_P, statistic = mean_diff, v = 'Bpseudoneutid50_BA.1', R = 2000)
mean(r2$t>=r2$t0)
```



```{r immuno compare D15 by trt}
library(boot)

dt_W_Moderna_P = dt_W_Moderna %>% 
  filter(ph1.D15 == 1) %>%
  filter(TrtB == 1)
dt_W_Moderna_OC = dt_W_Moderna %>% 
  filter(TrtB == 0,
         ph1.D15 == 1)

dt_W_Pfizer_P = dt_W_Pfizer %>% 
  filter(TrtB == 1,
         ph1.D15 == 1)

dt_W_Pfizer_OC = dt_W_Pfizer %>% 
  filter(TrtB == 0,
         ph1.D15 == 1)

dt_W_P = rbind(dt_W_Moderna_P, dt_W_Pfizer_P)
dt_W_OC = rbind(dt_W_Moderna_OC, dt_W_Pfizer_OC)


mean_diff = function(data, indices, v = 'Bpseudoneutid50_MDW'){
     d = data[indices,]
     mdM = lm( as.formula(paste(v, '~ Age + Sex + naive + risk_score')),  
              data = d,
              subset = (stage == 1))
     
     mdP = lm(as.formula(paste(v, '~ Age + Sex + naive + risk_score')), 
              data = d,
              subset = (stage == 2))
     pred_M = predict(mdM, newdata = d[, c('Age', 'Sex', 'naive', 'risk_score')])
     pred_P = predict(mdP, newdata = d[, c('Age', 'Sex', 'naive', 'risk_score')])
     t = mean(pred_P) - mean(pred_M)
     return(t)
}

dt_W_OC %>% group_by(stage) %>% summarise(mean_D15BA45 = mean(Day15pseudoneutid50_BA.4.BA.5))
r1 = boot(data = dt_W_OC, statistic = mean_diff, v = 'Day15pseudoneutid50_BA.4.BA.5', R = 2000)
mean(r1$t>=r1$t0)


dt_W_P %>% group_by(stage) %>% summarise(mean_D15BA45 = mean(Day15pseudoneutid50_BA.4.BA.5))
r2 = boot(data = dt_W_P, statistic = mean_diff, v = 'Day15pseudoneutid50_BA.4.BA.5', R = 2000)
mean(r2$t>=r2$t0)
```



## Plot immunogenicity
```{r plot immuno}
plot_df = dtB_cumulative_incidence %>%
  filter(ph1.D15 == 1) %>%
  filter(stage == 1 | stage == 2) %>%
  filter(COVIDIndD22toD181 == 0) %>%
  select(Ptid, stage, TrtB, Bpseudoneutid50_BA.1, Day15pseudoneutid50_BA.1, Day29pseudoneutid50_BA.1,
         Day91pseudoneutid50_BA.1, Day181pseudoneutid50_BA.1,
         Bpseudoneutid50_D614G, Day15pseudoneutid50_D614G, Day29pseudoneutid50_D614G,
         Day91pseudoneutid50_D614G, Day181pseudoneutid50_D614G) %>%
  pivot_longer(!Ptid & !stage & !TrtB, names_to = 'Marker', values_to = 'Level' ) %>%
  group_by(Marker, stage, TrtB) %>%
  summarize(GM = 10^mean(Level, na.rm = T),
            low = 10^t.test(Level)$conf.int[1],
            high = 10^t.test(Level)$conf.int[2])
plot_df$Antigen = str_split(plot_df$Marker, '_', simplify = TRUE)[,2]
plot_df$Day = c(rep(c(0, 15, 181, 29, 91), each = 8))
plot_df = plot_df %>%
  mutate(Arm = ifelse(TrtB == 1, 'Prototype', 'Omicron-Containing'))
plot_df = plot_df %>%
  mutate(Antigen = ifelse(Antigen == 'BA.1', 'Omicron BA.1', 'Ancestral (D614G)'))

plot_df1 = plot_df %>%
 filter(stage == 1)

pd <- position_dodge(0.5) 
p1 = ggplot(plot_df1, aes(x = Day, y = GM, 
                          linetype = as.factor(Arm),
                          colour = as.factor(Arm))) + 
    geom_errorbar(aes(ymin = low, ymax = high), 
                  width = 2, linewidth = 1, position=pd) +
    geom_line(position=pd, linewidth = 1) +
    geom_point(position=pd) + 
  scale_y_log10('Geometric Mean \n Neutralization Titers (AU/ml)', limits = c(100, 33000)) +
  scale_x_continuous('Day', breaks = c(0, 15, 29, 91, 181)) +
  scale_color_viridis_d('Arm') +
  scale_linetype_manual('Arm', values=c("solid", "dotdash"))+
  facet_wrap(~Antigen, nrow = 2) +
  theme_bw(base_size = 25) + theme(legend.position = 'bottom') +
  ggtitle('Stage 1')
ggsave('Stage1_nAb_decay.pdf', p1, width = 12, height = 8, units = 'in')


plot_df2 = plot_df %>%
 filter(stage == 2)

p2 = ggplot(plot_df2, aes(x = Day, y = GM, linetype = as.factor(Arm),
                          colour = as.factor(Arm))) + 
    geom_errorbar(aes(ymin = low, ymax = high), 
                  width = 2, linewidth = 1, position=pd) +
    geom_line(position=pd, linewidth = 1) +
    geom_point(position=pd) + 
  scale_y_log10('Geometric Mean \n Neutralization Titers (AU/ml)', limits = c(100, 33000)) +
  scale_x_continuous('Day', breaks = c(0, 15, 29, 91, 181)) +
   scale_color_viridis_d('Arm') +
  scale_linetype_manual('Arm', values=c("solid", "dotdash"))+
  facet_wrap(~Antigen, nrow = 2) +
  theme_bw(base_size = 25) + theme(legend.position = 'bottom') +
    ggtitle('Stage 2')
ggsave('Stage2_nAb_decay.pdf', p2, width = 12, height = 8, units = 'in')
```

## Immunogenicity 

```{r immuni}
a = dtB_cumulative_incidence %>% 
  filter(ph1.D15 == 1) %>%
  group_by(stage, TrtB) %>%
  mutate(fold_rise = 10^Day15pseudoneutid50_BA.1/10^Bpseudoneutid50_BA.1) %>%
  mutate(diff = Day15pseudoneutid50_BA.1 - Bpseudoneutid50_BA.1) %>%
  summarise(mean_D1 = mean(Bpseudoneutid50_BA.1),
            mean_D15 = mean(Day15pseudoneutid50_BA.1),
            mean_diff = 10^mean(diff),
            low = 10^t.test(diff)$conf.int[1],
            high = 10^t.test(diff)$conf.int[2])


a2 = dtB_cumulative_incidence %>% 
  filter(ph1.D15 == 1) %>%
  group_by(stage, TrtB) %>%
  mutate(diff = Day15pseudoneutid50_BA.1 - Day181pseudoneutid50_BA.1) %>%
  summarise(mean_D15 = mean(Day15pseudoneutid50_BA.1),
            mean_D181 = mean(Day181pseudoneutid50_BA.1, na.rm = T),
            mean_diff = 10^mean(diff, na.rm = T),
            low = 10^t.test(diff)$conf.int[1],
            high = 10^t.test(diff)$conf.int[2])


b = dtB_cumulative_incidence %>% 
  filter(ph1.D15 == 1) %>%
  group_by(stage, TrtB) %>%
  mutate(diff = Day15pseudoneutid50_D614G - Bpseudoneutid50_D614G) %>%
  summarise(mean_D1 = mean(Bpseudoneutid50_D614G),
            mean_D15 = mean(Day15pseudoneutid50_D614G),
            mean_diff = 10^mean(diff),
            low = 10^t.test(diff)$conf.int[1],
            high = 10^t.test(diff)$conf.int[2])

b2 = dtB_cumulative_incidence %>% 
  filter(ph1.D15 == 1) %>%
  group_by(stage, TrtB) %>%
  mutate(diff = Day15pseudoneutid50_D614G - Day181pseudoneutid50_D614G) %>%
  summarise(mean_D15 = mean(Day15pseudoneutid50_D614G),
            mean_D181 = mean(Day181pseudoneutid50_D614G, na.rm = T),
            mean_diff = 10^mean(diff, na.rm = T),
            low = 10^t.test(diff)$conf.int[1],
            high = 10^t.test(diff)$conf.int[2])

c= dtB_cumulative_incidence %>% 
  filter(ph1.D15 == 1) %>%
  group_by(stage, TrtB) %>%
  mutate(diff_D614G = Day15pseudoneutid50_D614G - Bpseudoneutid50_D614G) %>%
  mutate(diff_BA1 = Day15pseudoneutid50_BA.1 - Bpseudoneutid50_BA.1) %>%
  mutate(diff_diff = diff_BA1 - diff_D614G) %>%
  summarise(mean_diff_diff = 10^mean(diff_diff),
            low = 10^t.test(diff_diff)$conf.int[1],
            high = 10^t.test(diff_diff)$conf.int[2])

d = dtB_cumulative_incidence %>% 
  filter(ph1.D15 == 1) %>%
  group_by(stage, TrtB) %>%
  mutate(diff = Day15pseudoneutid50_BA.1 - Day15pseudoneutid50_D614G) %>%
  summarise(mean_diff = 10^mean(diff),
            low = 10^t.test(diff)$conf.int[1],
            high = 10^t.test(diff)$conf.int[2])
```


## Number of cases 

```{r num cases, echo=FALSE, message=FALSE, warning=FALSE}
dtB_num_case_stage1 = dtB_cumulative_incidence %>%
  filter(stage == 1) %>%
  filter(COVIDIndD22toD181 == 1) %>%
  group_by(treatment_actual) %>%
  summarise(total_case = n(),
            BA2_case = sum(COVIDlineage == 'BA.2'),
            BA4_case = sum(COVIDlineage == 'BA.4'),
            BA5_case = sum(COVIDlineage == 'BA.5'),
            XBB_XZ_case = total_case - BA2_case - BA4_case - BA5_case,
            LineageObserved = sum(COVIDlineageObserved))

write.csv(dtB_num_case_stage1, 'Stage1_case_by_arm.csv')

dtB_num_case_stage2 = dtB_cumulative_incidence %>%
  filter(stage == 2) %>%
  filter(COVIDIndD22toD181 == 1) %>%
  group_by(treatment_actual) %>%
  summarise(total_case = n(),
            BA2_case = sum(COVIDlineage == 'BA.2'),
            BA4_case = sum(COVIDlineage == 'BA.4'),
            BA5_case = sum(COVIDlineage == 'BA.5'),
            XBB_XZ_case = total_case - BA2_case - BA4_case - BA5_case,
            LineageObserved = sum(COVIDlineageObserved))
write.csv(dtB_num_case_stage2, 'Stage2_case_by_arm.csv')
```


## Number of PP cases

```{r num PP cases, echo=FALSE, message=FALSE, warning=FALSE}
dtB_num_PP_case_stage1 = dtB %>%
  filter(ph1.D15 == 1) %>%
  filter(stage == 1) %>%
  filter(COVIDIndD22toD181 == 1) %>%
  group_by(treatment_actual) %>%
  summarise(total_case = n())

write.csv(dtB_num_PP_case_stage1, 'Stage1_PP_case_by_arm.csv')

dtB_num_PP_case_stage2 = dtB %>%
  filter(ph1.D15 == 1) %>%
  filter(stage == 2) %>%
  filter(COVIDIndD22toD181 == 1) %>%
  group_by(treatment_actual) %>%
  summarise(total_case = n())
write.csv(dtB_num_PP_case_stage2, 'Stage2_PP_case_by_arm.csv')
```





## Number of events and at-risk participants

### Moderna

```{r comp B Stage 1 by TrtB, echo=FALSE, message=FALSE, warning=FALSE}
dtB_cumulative_incidence = dtB_cumulative_incidence %>%
  mutate(TrtB_str = ifelse(TrtB == 1, 'Prototype', 'Omicron-Containing'))

dtB_Moderna = dtB_cumulative_incidence %>%
  filter(stage == 1)

# By Prototype or OC
km_Moderna = survfit(formula = Surv(ftime, COVIDIndD22toD181) ~ TrtB_str, 
             data = dtB_Moderna)

risk_M = ggrisktable(km_Moderna)
cumu_M = ggcumevents(km_Moderna)

ggsave('./Table/num_at_risk_Moderna_by_P_OC.pdf', 
       plot = risk_M, width = 12, height = 8)

ggsave('./Table/cumu_endpoints_Moderna_by_P_OC.pdf', 
       plot = cumu_M, width = 12, height = 8)

# By Arm
km_Moderna = survfit(formula = Surv(ftime, COVIDIndD22toD181) ~ treatment_actual, 
             data = dtB_Moderna)

risk_M = ggrisktable(km_Moderna)
cumu_M = ggcumevents(km_Moderna)

ggsave('./Table/num_at_risk_Moderna_by_Arm.pdf', 
       plot = risk_M, width = 12, height = 8)

ggsave('./Table/cumu_endpoints_Moderna_by_Arm.pdf', 
       plot = cumu_M, width = 12, height = 8)

```

### Pfizer

```{r comp B Stage 2 by TrtB, echo=FALSE, message=FALSE, warning=FALSE}
dtB_Pfizer = dtB_cumulative_incidence %>%
  filter(stage == 2)

# By Prototype or OC
km_Pfizer = survfit(formula = Surv(ftime, COVIDIndD22toD181) ~ TrtB_str, 
             data = dtB_Pfizer)

risk_M = ggrisktable(km_Pfizer)
cumu_M = ggcumevents(km_Pfizer)

ggsave('./Table/num_at_risk_Pfizer_by_P_OC.pdf', 
       plot = risk_M, width = 12, height = 8)

ggsave('./Table/cumu_endpoints_Pfizer_by_P_OC.pdf', 
       plot = cumu_M, width = 12, height = 8)

# By Arm
km_Pfizer = survfit(formula = Surv(ftime, COVIDIndD22toD181) ~ treatment_actual, 
             data = dtB_Pfizer)

risk_M = ggrisktable(km_Pfizer)
cumu_M = ggcumevents(km_Pfizer)

ggsave('./Table/num_at_risk_Pfizer_by_Arm.pdf', 
       plot = risk_M, width = 12, height = 8)

ggsave('./Table/cumu_endpoints_Pfizer_by_Arm.pdf', 
       plot = cumu_M, width = 12, height = 8)

```


\newpage

# Comparison of cumulative incidence among mRNA Prototype vs mRNA Omicron-Containing vaccinees

## Stage 1 Moderna platform

```{r helper function B, echo=FALSE}
subtrt_analysisB <- function(dtB_sub, trt1, trt2){
  dt_W_sub = dtB_sub %>%
    select(naive, FOIstandardized, risk_score)
  
  fit <- CFsurvival(time = dtB_sub$ftime, 
                    event = dtB_sub$COVIDIndD22toD181, 
                    treat = dtB_sub$TrtB, 
                    confounders = dt_W_sub, 
                    contrasts = c("surv.diff","surv.ratio", "risk.ratio"), 
                    verbose = TRUE, fit.times = seq(0, 15 + 188, by = 1), fit.treat = c(0,1),
                    nuisance.options = list(prop.SL.library = c("SL.mean", "SL.glm"),
                                            event.SL.library = c("survSL.km", "survSL.coxph",
                                                                 "survSL.gam", "survSL.rfsrc"),
                                            cens.SL.library = c("survSL.km", "survSL.coxph",
                                                                "survSL.gam", "survSL.rfsrc"),
                                            cross.fit =TRUE, V = 5, save.nuis.fits = TRUE), 
                    conf.band = TRUE, conf.level = .95)
  
  fit$surv.df$trt = 
    ifelse(fit$surv.df$trt == 1, 
           trt1, trt2)
  
  # Plot covariate-adjusted cumulative incidence in 1. Moderna and 3. Pfizer
  plot_cumu_inc = ggplot(fit$surv.df) +
    geom_step(aes(time, 1-surv, color=as.factor(trt), group=trt), size = 1.5) +
    geom_step(aes(time, 1-ptwise.lower, color=as.factor(trt), group=trt), 
              size = 1.2, linetype=2) +
    geom_step(aes(time, 1-ptwise.upper, color=as.factor(trt), group=trt), 
              size = 1.2, linetype=2) +
    scale_color_manual("Treatment", values = c('purple', 'gold')) +
    xlab("Study time (days)") +
    ylab("Covariate-adjusted cumulative incidence") +
    coord_cartesian(xlim=c(0, 15 + 188), ylim=c(0, 0.5)) +
    scale_y_continuous(labels = function(x) paste0(x*100, "%")) +
    theme_bw(base_size = 15) +
    theme(legend.position = 'top') +
    guides(color=guide_legend(nrow=2,byrow=TRUE))
  return(plot_cumu_inc)
}

```


```{r helper function B CIR, echo=FALSE}
subtrt_analysisB_CIR <- function(dtB_sub, trt1, trt2){
  dt_W_sub = dtB_sub %>%
    select(naive, FOIstandardized, risk_score)
  
  fit <- CFsurvival(time = dtB_sub$ftime, 
                    event = dtB_sub$COVIDIndD22toD181, 
                    treat = dtB_sub$TrtB, 
                    confounders = dt_W_sub, 
                    contrasts = c("surv.diff","surv.ratio", "risk.ratio"), 
                    verbose = TRUE, fit.times = seq(0, 15+188, by = 1), fit.treat = c(0,1),
                    nuisance.options = list(prop.SL.library = c("SL.mean", "SL.glm"),
                                            event.SL.library = c("survSL.km", "survSL.coxph",
                                                                 "survSL.gam", "survSL.rfsrc"),
                                            cens.SL.library = c("survSL.km", "survSL.coxph",
                                                                "survSL.gam", "survSL.rfsrc"),
                                            cross.fit =TRUE, V = 5, save.nuis.fits = TRUE), 
                    conf.band = TRUE, conf.level = .95)
  
  fit$surv.df$trt = 
    ifelse(fit$surv.df$trt == 1, 
           trt1, trt2)
  
  # Plot covariate-adjusted cumulative incidence in 1. Moderna and 3. Pfizer
  plot_CIR = ggplot(fit$risk.ratio.df[30:203,]) +
     geom_line(aes(time, log.risk.ratio), size = 1.3) +
  geom_line(aes(time, ptwise.lower.log), 
            size = 1.2, linetype = 2, color = 'gray') +
  geom_line(aes(time, ptwise.upper.log), 
            size = 1.2, linetype=2, color = 'gray') +
  geom_vline(xintercept = 15+91, linetype = 3, color = 'dark red', alpha = 0.5, size = 1.5)+
  geom_vline(xintercept = 15+7+181, linetype = 3, color = 'dark red', alpha = 0.5, size = 1.5)+
  xlab("Study time (days)") +
  ylab("Covariate-adjusted cumulative incidence ratio") 
  return(plot_CIR)
}

```

Next, we repeat the following analyses:

1. Covariate-adjusted cumulative incidence analysis (primary);

2. Cumulative incidence ratio analysis,

all restricted to randomized Stage 1 Moderna participants (n = 503). The covariate-adjusted cumulative incidence curves
were through 188 days post D15 (last COVID endpoint).


```{r comp B Moderna, fig.cap = "Covariate-adjusted cumulative incidence curves among Stage-1 Moderna participants who received the mRNA Prototype vaccines or Omicron-Containing vaccines. Solid lines are point estimates. Dashed lines are 95% confidence intervals.", echo=FALSE, warning=FALSE, message=FALSE}
dtB_Moderna = dtB_cumulative_incidence %>%
  filter(stage == 1)

plot_cumu_inc_B_Moderna = subtrt_analysisB(dtB_Moderna,
                                          trt1 = '1. Prototype (Moderna)',
                                          trt2 = '2. Omicron-Containing (Moderna)')
plot(plot_cumu_inc_B_Moderna)


plot_cumu_inc_B_Moderna = plot_cumu_inc_B_Moderna + theme_bw(base_size = 22) +
   theme(legend.position = 'top') +
    guides(color=guide_legend(nrow=2,byrow=TRUE))

ggsave('./Plot/CI_Prototype_vs_OC_Moderna.pdf', 
       plot = plot_cumu_inc_B_Moderna, width = 12, height = 8)
```


```{r comp B Moderna CIR, fig.cap = "Covariate-adjusted cumulative incidence ratio among Stage-1 Moderna participants who received the mRNA Prototype vaccines or Omicron-Containing vaccines. Solid lines are point estimates. Dashed lines are 95% confidence intervals.", echo=FALSE, warning=FALSE, message=FALSE}
dtB_Moderna = dtB_Moderna %>%
  filter(ph1.D15 == 1)

plot_CIR_B_Moderna = subtrt_analysisB_CIR(dtB_Moderna,
                                          trt1 = '1. Prototype (Moderna)',
                                          trt2 = '2. Omicron-Containing (Moderna)')

plot(plot_CIR_B_Moderna + theme_bw(base_size = 15) +
       coord_cartesian(xlim=c(0, 15+188), ylim=c(-1.5, 1.5)) +
     scale_y_continuous(breaks = c(log(0.25), log(0.5), log(1), log(2), log(4)), 
                        labels = function(x) exp(x)))


plot_CIR_B_Moderna = plot_CIR_B_Moderna +  theme_bw(base_size = 22) +
  coord_cartesian(xlim=c(0, 15+188), ylim=c(-1.5, 1.5)) +
     scale_y_continuous(breaks = c(log(0.25), log(0.5), log(1), log(2), log(4)), 
                        labels = function(x) exp(x))

ggsave('./Plot/CIR_Prototype_vs_OC_Moderna.pdf', 
       plot = plot_CIR_B_Moderna, width = 12, height = 8)
```

\newpage

## Stage 2 Pfizer platform

We further repeat the analysis restricted to the randomized Stage-2 Pfizer participants.

```{r comp B Pfizer 2, fig.cap = "Covariate-adjusted cumulative incidence curves among Stage-2 Pfizer participants who received the mRNA Prototype vaccines or Omicron-Containing vaccines. Solid lines are point estimates. Dashed lines are 95% confidence intervals.", echo=FALSE, warning=FALSE, message=FALSE}
dtB_Pfizer2 = dtB_cumulative_incidence %>%
  filter(stage == 2)

plot_cumu_inc_B_Pfizer2 = subtrt_analysisB(dtB_Pfizer2,
                                          trt1 = '1. Prototype (Pfizer)',
                                          trt2 = '2. Omicron-Containing (Pfizer)')
plot(plot_cumu_inc_B_Pfizer2) 

plot_cumu_inc_B_Pfizer2 = plot_cumu_inc_B_Pfizer2 + theme_bw(base_size = 22) +
   theme(legend.position = 'top') +
    guides(color=guide_legend(nrow=2,byrow=TRUE))

ggsave('./Plot/CI_Prototype_vs_OC_Pfizer.pdf', 
       plot = plot_cumu_inc_B_Pfizer2, width = 12, height = 8)
```


```{r comp B Pfizer 2 CIR, fig.cap = "Covariate-adjusted cumulative incidence ratio among Stage-2 Pfizer participants who received the mRNA Prototype vaccines or Omicron-Containing vaccines. Solid lines are point estimates. Dashed lines are 95% confidence intervals.", echo=FALSE, warning=FALSE, message=FALSE}
dtB_Pfizer2 = dtB_Pfizer2 %>%
  filter(ph1.D15 == 1)

plot_CIR_B_Pfizer2 = subtrt_analysisB_CIR(dtB_Pfizer2,
                                          trt1 = '1. Prototype (Pfizer)',
                                          trt2 = '2. Omicron-Containing (Pfizer)')

plot(plot_CIR_B_Pfizer2 + theme_bw(base_size = 15) + 
       coord_cartesian(xlim=c(0, 15+188), ylim=c(-1.5, 1.5)) +
      scale_y_continuous(breaks = c(log(0.25), log(0.5), log(1), log(2), log(4)), 
                         labels = function(x) exp(x)))

plot_CIR_B_Pfizer2 = plot_CIR_B_Pfizer2 + theme_bw(base_size = 23) + 
  coord_cartesian(xlim=c(0, 15+188), ylim=c(-1.5, 1.5)) +
      scale_y_continuous(breaks = c(log(0.25), log(0.5), log(1), log(2), log(4)), 
                         labels = function(x) exp(x)) 

ggsave('./Plot/CIR_Prototype_vs_OC_Pfizer.pdf', 
       plot = plot_CIR_B_Pfizer2, width = 12, height = 8)
```

\newpage

# Calendar-time-based Cox regression analyses

We first conduct a calendar-time-based Cox regression analysis restricted to
participants in the per-protocol correlates cohort. The time origin is the
minimum D22 among participants eligible for the Moderna vs Pfizer comparison. 
The analysis stratified on a participant's naive status and adjusted for the 
risk score and the Moderna vs Pfizer indicator.

```{r comp A D22-D181, echo=FALSE, warning=FALSE, message=FALSE}
dt = read.csv('covail_data_processed_20240313.csv')

dt_cox = dt %>%
  filter(ph1.D15 == 1) %>% # Cox analysis restricted to the PP correlates cohort
  select(studydose1date, Actual_visit_date_15.2,
         COVIDIndD22toD181, COVIDtimeD22toD181, 
         naive, Bpseudoneutid50_BA.1, risk_score, 
         TrtA, TrtB, TrtC, stage, treatment_actual) %>%
  mutate(Actual_visit_date_15.2 = as.Date(Actual_visit_date_15.2),
         studydose1date = as.Date(studydose1date))


process_p_val <- function(p_val){
  if (p_val < 0.001) return('<0.001')
  else return(p_val)
}

process_summary_table <- function(resA, trt_key){
  
  tbA = data.frame(HR = round(resA$conf.int[trt_key, 1], 2) ,
                 CI = paste0('(', round(resA$conf.int[trt_key, 3], 2),
                             ', ',
                             round(resA$conf.int[trt_key, 4], 2), ')'),
                 P.value = process_p_val(resA$coefficients[trt_key, 'Pr(>|z|)']))
  knitr::kable(tbA, digits = 3, 'latex',
               col.names = c('Hazard ratio', '95% CI', 'P-value'))
  return(tbA = data.frame(HR = round(resA$conf.int[trt_key, 1], 2) ,
                 CI_low = round(resA$conf.int[trt_key, 3], 2),
                 CI_high = round(resA$conf.int[trt_key, 4], 2),
                 P.value = process_p_val(resA$coefficients[trt_key, 'Pr(>|z|)'])))
}

```



## Comparison between Prototype and Omicron-Containing vaccines (2A vs. 2B in SAP)

### D22-D181 Period

We consider an analysis restricted to randomized Stage 1 Moderna participants. 
All HRs below are OC vs. P.

```{r comp B D22-D181 Moderna, echo=FALSE, warning=FALSE, message=FALSE}
# Focus on Comparison B
dtB_Moderna = dt_cox %>%
  filter(!is.na(TrtB)) %>%
  mutate(TrtB = 1 - TrtB) %>%
  filter(stage == 1)
  
# Time origin is min(D22)
dtB_Moderna = dtB_Moderna %>% 
  mutate(min_D15 = min(Actual_visit_date_15.2)) %>%
  mutate(day_since_min_D15 = Actual_visit_date_15.2 - min_D15) %>%
  mutate(ftime = as.numeric(day_since_min_D15 + COVIDtimeD22toD181))

# Stratify on naive and adjusted for risk_score
md_B_M = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score + strata(naive),
                  data = dtB_Moderna)

resB_M = summary(md_B_M)


# We also compare Prototype to each OC
# Beta + Omicron
dtB_Moderna1 = dtB_Moderna %>%
  filter(treatment_actual %in% c('1 Dose Prototype (Moderna)',
                                 '1 Dose Beta + Omicron (Moderna)'))
md_B_M1 = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score + strata(naive),
                  data = dtB_Moderna1)

resB_M1 = summary(md_B_M1)

# Delta + Omicron
dtB_Moderna2 = dtB_Moderna %>%
  filter(treatment_actual %in% c('1 Dose Prototype (Moderna)',
                                 '1 Dose Delta + Omicron (Moderna)'))
md_B_M2 = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score + strata(naive),
                  data = dtB_Moderna2)

resB_M2 = summary(md_B_M2)

# Omicron
dtB_Moderna3 = dtB_Moderna %>%
  filter(treatment_actual %in% c('1 Dose Prototype (Moderna)',
                                 '1 Dose Omicron (Moderna)'))
md_B_M3 = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score + strata(naive),
                  data = dtB_Moderna3)

resB_M3 = summary(md_B_M3)

# Omicron + Prototype
dtB_Moderna4 = dtB_Moderna %>%
  filter(treatment_actual %in% c('1 Dose Prototype (Moderna)',
                                 '1 Dose Omicron + Prototype (Moderna)'))
md_B_M4 = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score + strata(naive),
                  data = dtB_Moderna4)

resB_M4 = summary(md_B_M4)

tb_all = rbind(process_summary_table(resB_M, trt_key = 'TrtB'),
               process_summary_table(resB_M1, trt_key = 'TrtB'),
               process_summary_table(resB_M2, trt_key = 'TrtB'),
               process_summary_table(resB_M3, trt_key = 'TrtB'),
               process_summary_table(resB_M4, trt_key = 'TrtB'))

row.names(tb_all) = c('Moderna_pooled', 'Beta + Omicron', 'Delta + Omicron',
                      'Omicron', 'Omicron + Prototype')
write.csv(tb_all, './Table/Moderna_D22_D181.csv')

print(tb_all)
```
We then repeat the comparison but among baseline naive participants.

```{r comp B D22-D181 Moderna Naive, echo=FALSE, warning=FALSE, message=FALSE}
# Focus on Comparison B
dtB_Moderna_N = dtB_Moderna %>%
  filter(naive == 1)

# Stratify on naive and adjusted for risk_score
md_B_M_N = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Moderna_N)

resB_M_N = summary(md_B_M_N)


# We also compare Prototype to each OC
# Beta + Omicron
dtB_Moderna1_N = dtB_Moderna_N %>%
  filter(treatment_actual %in% c('1 Dose Prototype (Moderna)',
                                 '1 Dose Beta + Omicron (Moderna)'))
md_B_M1_N = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Moderna1_N)

resB_M1_N = summary(md_B_M1_N)

# Delta + Omicron
dtB_Moderna2_N = dtB_Moderna_N %>%
  filter(treatment_actual %in% c('1 Dose Prototype (Moderna)',
                                 '1 Dose Delta + Omicron (Moderna)'))
md_B_M2_N = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Moderna2_N)

resB_M2_N = summary(md_B_M2_N)

# Omicron
dtB_Moderna3_N = dtB_Moderna_N %>%
  filter(treatment_actual %in% c('1 Dose Prototype (Moderna)',
                                 '1 Dose Omicron (Moderna)'))
md_B_M3_N = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Moderna3_N)

resB_M3_N = summary(md_B_M3_N)

# Omicron + Prototype
dtB_Moderna4_N = dtB_Moderna_N %>%
  filter(treatment_actual %in% c('1 Dose Prototype (Moderna)',
                                 '1 Dose Omicron + Prototype (Moderna)'))
md_B_M4_N = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Moderna4_N)

resB_M4_N = summary(md_B_M4_N)

tb_all_N = rbind(process_summary_table(resB_M_N, trt_key = 'TrtB'),
               process_summary_table(resB_M1_N, trt_key = 'TrtB'),
               process_summary_table(resB_M2_N, trt_key = 'TrtB'),
               process_summary_table(resB_M3_N, trt_key = 'TrtB'),
               process_summary_table(resB_M4_N, trt_key = 'TrtB'))

row.names(tb_all_N) = c('Moderna_pooled', 'Beta + Omicron', 'Delta + Omicron',
                      'Omicron', 'Omicron + Prototype')
write.csv(tb_all_N, './Table/Moderna_D22_D181_N.csv')

print(tb_all_N)
```


We then repeat the comparison but among baseline non-naive participants.

```{r comp B D22-D181 Moderna Non-Naive, echo=FALSE, warning=FALSE, message=FALSE}
# Focus on Comparison B
dtB_Moderna_NN = dtB_Moderna %>%
  filter(naive == 0)

# Stratify on naive and adjusted for risk_score
md_B_M_NN = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Moderna_NN)

resB_M_NN = summary(md_B_M_NN)


# We also compare Prototype to each OC
# Beta + Omicron
dtB_Moderna1_NN = dtB_Moderna_NN %>%
  filter(treatment_actual %in% c('1 Dose Prototype (Moderna)',
                                 '1 Dose Beta + Omicron (Moderna)'))
md_B_M1_NN = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Moderna1_NN)

resB_M1_NN = summary(md_B_M1_NN)

# Delta + Omicron
dtB_Moderna2_NN = dtB_Moderna_NN %>%
  filter(treatment_actual %in% c('1 Dose Prototype (Moderna)',
                                 '1 Dose Delta + Omicron (Moderna)'))
md_B_M2_NN = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Moderna2_NN)

resB_M2_NN = summary(md_B_M2_NN)

# Omicron
dtB_Moderna3_NN = dtB_Moderna_NN %>%
  filter(treatment_actual %in% c('1 Dose Prototype (Moderna)',
                                 '1 Dose Omicron (Moderna)'))
md_B_M3_NN = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Moderna3_NN)

resB_M3_NN = summary(md_B_M3_NN)

# Omicron + Prototype
dtB_Moderna4_NN = dtB_Moderna_NN %>%
  filter(treatment_actual %in% c('1 Dose Prototype (Moderna)',
                                 '1 Dose Omicron + Prototype (Moderna)'))
md_B_M4_NN = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Moderna4_NN)

resB_M4_NN = summary(md_B_M4_NN)

tb_all_NN = rbind(process_summary_table(resB_M_NN, trt_key = 'TrtB'),
               process_summary_table(resB_M1_NN, trt_key = 'TrtB'),
               process_summary_table(resB_M2_NN, trt_key = 'TrtB'),
               process_summary_table(resB_M3_NN, trt_key = 'TrtB'),
               process_summary_table(resB_M4_NN, trt_key = 'TrtB'))

row.names(tb_all_NN) = c('Moderna_pooled', 'Beta + Omicron', 'Delta + Omicron',
                      'Omicron', 'Omicron + Prototype')
write.csv(tb_all_NN, './Table/Moderna_D22_D181_NN.csv')

print(tb_all_NN)
```








We consider an analysis restricted to randomized Stage 2 Pfizer participants.

```{r comp B D22-D181 Pfizer, echo=FALSE, warning=FALSE, message=FALSE}
# Focus on Comparison B
dtB_Pfizer = dt_cox %>%
  filter(!is.na(TrtB)) %>%
  mutate(TrtB = 1 - TrtB) %>%
  filter(stage == 2)

# Time origin is min(D22)
dtB_Pfizer = dtB_Pfizer %>% 
  mutate(min_D15 = min(Actual_visit_date_15.2)) %>%
  mutate(day_since_min_D15 = Actual_visit_date_15.2 - min_D15) %>%
  mutate(ftime = as.numeric(day_since_min_D15 + COVIDtimeD22toD181))

# Stratify on naive and adjusted for risk_score
md_B_P = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score + strata(naive),
                  data = dtB_Pfizer)

resB_P = summary(md_B_P)

# We also compare Prototype to each OC
# Beta + Omicron
dtB_Pfizer1 = dtB_Pfizer %>%
  filter(treatment_actual %in% c('Wildtype/Prototype (Pfizer 1)',
                                 'Beta + Omicron (Pfizer 1)'))
md_B_P1 = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score + strata(naive),
                  data = dtB_Pfizer1)

resB_P1 = summary(md_B_P1)

# Omicron
dtB_Pfizer2 = dtB_Pfizer %>%
  filter(treatment_actual %in% c('Wildtype/Prototype (Pfizer 1)',
                                 'Omicron (Pfizer 1)'))
md_B_P2 = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score + strata(naive),
                  data = dtB_Pfizer2)

resB_P2 = summary(md_B_P2)

# Omicron + Prototype
dtB_Pfizer3 = dtB_Pfizer %>%
  filter(treatment_actual %in% c('Wildtype/Prototype (Pfizer 1)',
                                 'Omicron + Wildtype/Prototype (Pfizer 1)'))
md_B_P3 = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score + strata(naive),
                  data = dtB_Pfizer3)

resB_P3 = summary(md_B_P3)

tb_all = rbind(process_summary_table(resB_P, trt_key = 'TrtB'),
               process_summary_table(resB_P1, trt_key = 'TrtB'),
               process_summary_table(resB_P2, trt_key = 'TrtB'),
               process_summary_table(resB_P3, trt_key = 'TrtB'))

row.names(tb_all) = c('Pfizer_pooled', 'Beta + Omicron',
                      'Omicron', 'Omicron + Prototype')
write.csv(tb_all, './Table/Pfizer_D22_D181.csv')

print(tb_all)

```


We then consider an analysis restricted to randomized naive Stage 2 Pfizer participants.

```{r comp B D22-D181 Pfizer Naive, echo=FALSE, warning=FALSE, message=FALSE}
# Focus on Comparison B
dtB_Pfizer_N = dtB_Pfizer %>%
  filter(naive == 1)

# Stratify on naive and adjusted for risk_score
md_B_P_N = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Pfizer_N)

resB_P_N = summary(md_B_P_N)

# We also compare Prototype to each OC
# Beta + Omicron
dtB_Pfizer1_N = dtB_Pfizer_N %>%
  filter(treatment_actual %in% c('Wildtype/Prototype (Pfizer 1)',
                                 'Beta + Omicron (Pfizer 1)'))
md_B_P1_N = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Pfizer1_N)

resB_P1_N = summary(md_B_P1_N)

# Omicron
dtB_Pfizer2_N = dtB_Pfizer_N %>%
  filter(treatment_actual %in% c('Wildtype/Prototype (Pfizer 1)',
                                 'Omicron (Pfizer 1)'))
md_B_P2_N = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Pfizer2_N)

resB_P2_N = summary(md_B_P2_N)

# Omicron + Prototype
dtB_Pfizer3_N = dtB_Pfizer_N %>%
  filter(treatment_actual %in% c('Wildtype/Prototype (Pfizer 1)',
                                 'Omicron + Wildtype/Prototype (Pfizer 1)'))
md_B_P3_N = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Pfizer3_N)

resB_P3_N = summary(md_B_P3_N)

tb_all_N = rbind(process_summary_table(resB_P_N, trt_key = 'TrtB'),
               process_summary_table(resB_P1_N, trt_key = 'TrtB'),
               process_summary_table(resB_P2_N, trt_key = 'TrtB'),
               process_summary_table(resB_P3_N, trt_key = 'TrtB'))

row.names(tb_all_N) = c('Pfizer_pooled', 'Beta + Omicron',
                      'Omicron', 'Omicron + Prototype')
write.csv(tb_all_N, './Table/Pfizer_D22_D181_N.csv')

print(tb_all_N)

```


We then consider an analysis restricted to randomized non-naive Stage 2 Pfizer participants.

```{r comp B D22-D181 Pfizer Non-Naive, echo=FALSE, warning=FALSE, message=FALSE}
# Focus on Comparison B
dtB_Pfizer_NN = dtB_Pfizer %>%
  filter(naive == 0)

# Stratify on naive and adjusted for risk_score
md_B_P_NN = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Pfizer_NN)

resB_P_NN = summary(md_B_P_NN)

# We also compare Prototype to each OC
# Beta + Omicron
dtB_Pfizer1_NN = dtB_Pfizer_NN %>%
  filter(treatment_actual %in% c('Wildtype/Prototype (Pfizer 1)',
                                 'Beta + Omicron (Pfizer 1)'))
md_B_P1_NN = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Pfizer1_NN)

resB_P1_NN = summary(md_B_P1_NN)

# Omicron
dtB_Pfizer2_NN = dtB_Pfizer_NN %>%
  filter(treatment_actual %in% c('Wildtype/Prototype (Pfizer 1)',
                                 'Omicron (Pfizer 1)'))
md_B_P2_NN = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Pfizer2_NN)

resB_P2_NN = summary(md_B_P2_NN)

# Omicron + Prototype
dtB_Pfizer3_NN = dtB_Pfizer_NN %>%
  filter(treatment_actual %in% c('Wildtype/Prototype (Pfizer 1)',
                                 'Omicron + Wildtype/Prototype (Pfizer 1)'))
md_B_P3_NN = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB + risk_score,
                  data = dtB_Pfizer3_NN)

resB_P3_NN = summary(md_B_P3_NN)

tb_all_NN = rbind(process_summary_table(resB_P_NN, trt_key = 'TrtB'),
               process_summary_table(resB_P1_NN, trt_key = 'TrtB'),
               process_summary_table(resB_P2_NN, trt_key = 'TrtB'),
               process_summary_table(resB_P3_NN, trt_key = 'TrtB'))

row.names(tb_all_NN) = c('Pfizer_pooled', 'Beta + Omicron',
                      'Omicron', 'Omicron + Prototype')
write.csv(tb_all_NN, './Table/Pfizer_D22_D181_NN.csv')

print(tb_all_NN)

```



Lastly, we conduct an interaction test. The interaction p-value is <0.001
in an analysis based on all Moderna (Stage-1) and Pfizer participants (Stage 2 and 4 pooled) 
and 0.007 in an analysis based on Stage-1 Moderna participants and Stage-2 Pfizer
participants.


```{r comp B D22-D181 interaction, echo=FALSE, warning=FALSE, message=FALSE}
# Focus on Comparison B
dtB_inter = dt_cox %>%
  filter(!is.na(TrtB)) %>%
  
  mutate(Moderna = ifelse(treatment_actual %in% c('1 Dose Beta + Omicron (Moderna)', 
             '1 Dose Delta + Omicron (Moderna)',
             '1 Dose Omicron (Moderna)',           
             '1 Dose Omicron + Prototype (Moderna)',
             '1 Dose Prototype (Moderna)'), 1, 0))

# Time origin is min(D22)
dtB_inter = dtB_inter %>% 
  mutate(min_D15 = min(Actual_visit_date_15.2)) %>%
  mutate(day_since_min_D15 = Actual_visit_date_15.2 - min_D15) %>%
  mutate(ftime = as.numeric(day_since_min_D15 + COVIDtimeD22toD181))

# Stratify on naive and adjusted for risk_score
md_B_inter = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB*Moderna + risk_score + strata(naive),
                  data = dtB_inter)

resB_inter = summary(md_B_inter)


dtB_inter2 = dt_cox %>%
  filter(!is.na(TrtB)) %>%
  filter(treatment_actual %in% 
           c('1 Dose Beta + Omicron (Moderna)', 
             '1 Dose Delta + Omicron (Moderna)',
             '1 Dose Omicron (Moderna)',           
             '1 Dose Omicron + Prototype (Moderna)',
             '1 Dose Prototype (Moderna)',
             'Beta + Omicron (Pfizer 1)', 
             'Omicron (Pfizer 1)', 
             'Omicron + Wildtype/Prototype (Pfizer 1)', 
             'Wildtype/Prototype (Pfizer 1)')) %>%
  mutate(Moderna = ifelse(treatment_actual %in% c('1 Dose Beta + Omicron (Moderna)', 
             '1 Dose Delta + Omicron (Moderna)',
             '1 Dose Omicron (Moderna)',           
             '1 Dose Omicron + Prototype (Moderna)',
             '1 Dose Prototype (Moderna)'), 1, 0))

# Time origin is min(D22)
dtB_inter2 = dtB_inter2 %>% 
  mutate(min_D15 = min(Actual_visit_date_15.2)) %>%
  mutate(day_since_min_D15 = Actual_visit_date_15.2 - min_D15) %>%
  mutate(ftime = as.numeric(day_since_min_D15 + COVIDtimeD22toD181))

# Stratify on naive and adjusted for risk_score
md_B_inter2 = coxph(Surv(ftime, COVIDIndD22toD181) ~ TrtB*Moderna + risk_score + strata(naive),
                  data = dtB_inter2)

resB_inter2 = summary(md_B_inter2)
```