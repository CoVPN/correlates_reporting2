---
title: "IB-201P and IB-202P Comparative Immunogenicity Study"
author: Fred Hutch Team
output: 
  pdf_document:
    includes:
      in_header: preamble.tex
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

library(copcor)
library(survey)
library(kyotil)
library(glue)
library(Hmisc)
library(knitr)
library(GGally)
library(Barnard)

dat_mapped_202=read.csv(config::get(config = "iliad_ib202p", file="/home/yfong/correlates_processing/config.yml")$mapped_data)
dat_proc_202=read.csv(config::get(config = "iliad_ib202p", file="/home/yfong/correlates_reporting2/config.yml")$data_cleaned)
dat_proc_202$Ptid = as.factor(dat_proc_202$Ptid) # need to make it a factor to use as id
dat_proc_202$Trt = factor(dat_proc_202$Trt, levels = c("PBO","BPZE1")) 

dat_mapped_201=read.csv(config::get(config = "iliad_ib201p", file="/home/yfong/correlates_processing/config.yml")$mapped_data)
dat_proc_201=read.csv(config::get(config = "iliad_ib201p", file="/home/yfong/correlates_reporting2/config.yml")$data_cleaned)

assay_metadata=read.csv(glue('~/correlates_reporting2/assay_metadata/iliad_ib202p_assay_metadata.csv'))
assays = assay_metadata$assay
panels = unique(assay_metadata$panel)
antigens = c("WCE", setdiff(unique(assay_metadata$antigen), c("WCE", NA)))
```

# Introduction

There are two treatment arms in 202. The distribution of the clinical outcome, EventIndC9_11_14, in the two arms is listed below. 

```{r, echo=F}
mytable(dat_proc_202$Trt, dat_proc_202$EventIndC9_11_14)

```

There are three treatment arms in 201. It is an immunogenicity study. The size of earh arm is about 6 times that in 201. The distribution of samples by arm is listed below:

```{r}
mytable(dat_proc_201$Trt)
```

There are 5 classes of assays: `r panels`. 

For the first 4 classes, there are 5 antigens: `r antigens`. For SBA, there are two markers in 202 and just one in 201 (PRN+ is missing).

The values in the dataset are on the log10 scale and censored by LLOQ. We do a spot-check here (results not shown).

```{r, echo=F, include=F}
# confirmed that min is half lloq
summary(10**(dat_proc_202$Day28FHA_Nasal_IgA)) 
summary(10**(dat_proc_201$Day28FHA_Nasal_IgA)) 
subset(assay_metadata, assay=="FHA_Nasal_IgA", lloq, drop=T)/2

# confirmed that min is half lloq
summary(10**(dat_proc_202$Day28FHA_Serum_IgA)) 
summary(10**(dat_proc_201$Day28FHA_Serum_IgA)) 
subset(assay_metadata, assay=="FHA_Serum_IgA", lloq, drop=T)/2

```

Marker missingness in 202: 

- At baseline, 1 ptid does not have BPRN_Neg_SBA, 11 ptids do not have BPRN_Pos_SBA   
- At Day 28, 1 ptid does not have BPRN_Neg_SBA, 6 ptids do not have BPRN_Pos_SBA    
- For Delta28overB, 2 ptids do not have BPRN_Neg_SBA, 16 ptids do not have BPRN_Pos_SBA    

```{r, include=F, echo=F}
summary(dat_proc_202[,glue("B{assays}")])
summary(dat_proc_202[,glue("Day28{assays}")])
summary(dat_proc_202[,glue("Delta28overB{assays}")])

```


Marker missingness in 201:

- At baseline, most markers have 3-4 missing, BPRN_Neg_SBA have 295 missing
- At Day 28, most markers have 10-13 missing, BPRN_Neg_SBA have 283 missing
- For Delta28overB, most markers have 13-17 missing, BPRN_Pos_SBA have 301 missing

```{r, include=F, echo=F}
summary(dat_proc_201[,glue("B{assays[-(len(assays))]}")])
summary(dat_proc_201[,glue("Day28{assays[-(len(assays))]}")])
summary(dat_proc_201[,glue("Delta28overB{assays[-(len(assays))]}")])

```




# Immune response and age

```{r scatterplot_age, fig.width=12, fig.height=5.5}

plot.marker.age = function(a, ylim) {
  
  xlim=range(dat_proc_201$Age, dat_proc_202$Age, na.rm=T)
  
  fits=list()
  
  # shrink_margin()
  plot(as.formula(glue("{a}~Age")), dat_proc_201[dat_proc_201$Trt=="BPZE1_PBO",], ylim=ylim, main="", xlim=xlim)
  fit=lm(as.formula(glue("{a}~Age")), dat_proc_201[dat_proc_201$Trt=="BPZE1_PBO",])
  abline(fit)
  fits[["BPZE1_PBO"]]=fit
  
  points(as.formula(glue("{a}~Age")), dat_proc_202[dat_proc_202$Trt=="BPZE1",], col="purple", xlim=xlim)
  fit=lm(as.formula(glue("{a}~Age")), dat_proc_202[dat_proc_202$Trt=="BPZE1",])
  abline(fit, col="purple")
  fits[["BPZE1"]]=fit
  
  mylegend(legend=c("BPZE1_PBO (201)", "BPZE1 (202)"), x=3, col=c("black", "purple"), lty=1)
  
  print(a)
  print(getFormattedSummary(fits, robust=F))
}

plot.marker.age.both=function(assay) {
  par(mfrow=c(1,2)); reduce_margin()
  ylim=range(dat_proc_201[["Day28"%.%assay]], dat_proc_201[["B"%.%assay]], na.rm=T)
  plot.marker.age(a="Day28"%.%assay, ylim)
  plot.marker.age(a="B"%.%assay, ylim)
}
  
plot.marker.age.both("FHA_Norm_Nasal_IgA")
plot.marker.age.both("WCE_Norm_Nasal_IgA")

```


\clearpage

# Boxplots by treatment groups 

Day28 WCE and FHA sIgA is slightly higher in the BPZE1_PBO arm of IB-201p than in the BPZE1 arm of IB-202p (P value 0.073 and 0.079, respectively). A similar but less pronounced trend is also seen when we compare all arms between the two trials at baseline (P value 0.176 and 0.275, respectively). PRN is significantly higher in 201 BPZE1_PBO than in 202 BPZE1 (P value 0.01 at Day 28 and <0.001 at baseline).
This is likely due to screening criteria differences per Stephanie. 



```{r boxplots}

make.boxplots = function(a) {
  ylim=range(c(dat_proc_201[["B"%.%a]], dat_proc_201[["Day28"%.%a]]), na.rm=T)
  
  par(mfrow=c(1,6)); par(mar = c(4, 3, 2, 1), mgp = c(2, 0.5, 0))
  
  # day 28
  myboxplot(as.formula(glue("Day28{a}~Trt")), dat_proc_201, ylim=ylim, xlab="", main="IB-201p", cex.axis=0.4)
  myboxplot(as.formula(glue("Day28{a}~Trt")), dat_proc_202, ylim=ylim, xlab="", main="IB-202p", cex.axis=0.6, test="w", simplified = T)
  myboxplot(list(
    dat_proc_201[["Day28"%.%a]][dat_proc_201$Trt=='BPZE1_PBO'], 
    dat_proc_202[["Day28"%.%a]][dat_proc_202$Trt=='BPZE1']), ylim=ylim, xlab="", ylab="Day28FHA_Norm_Nasal_IgA", main="BPZE1 Arms", cex.axis=0.6, test="w", names=c("201","202"), simplified = T)
  
  # baseline
  myboxplot(as.formula(glue("B{a}~Trt")), dat_proc_201, ylim=ylim, xlab="", main="IB-201p", cex.axis=0.4)
  myboxplot(as.formula(glue("B{a}~Trt")), dat_proc_202, ylim=ylim, xlab="", main="IB-202p", cex.axis=0.6, test="w", simplified = T)
  myboxplot(list(
    dat_proc_201[["B"%.%a]], 
    dat_proc_202[["B"%.%a]]), ylim=ylim, xlab="", ylab="BFHA_Norm_Nasal_IgA", main="All", cex.axis=0.6, test="w", names=c("201","202"), simplified = T)
}

make.boxplots(a="FHA_Norm_Nasal_IgA")
make.boxplots(a="WCE_Norm_Nasal_IgA")
make.boxplots(a="PRN_Norm_Nasal_IgA")

a="FHA_Norm_Nasal_IgA"
median(dat_proc_201[["Day28"%.%a]][dat_proc_201$Trt=='BPZE1_PBO'], na.rm=T)
median(dat_proc_202[["Day28"%.%a]][dat_proc_202$Trt=='BPZE1'])
mean(dat_proc_201[["Day28"%.%a]][dat_proc_201$Trt=='BPZE1_PBO'], na.rm=T)
mean(dat_proc_202[["Day28"%.%a]][dat_proc_202$Trt=='BPZE1'])

```

\clearpage

```{r, echo=F}
make_pairs=function(p, vaccine.only=F) {
  if (vaccine.only) {
    tmp1 = dat_proc_201[dat_proc_201$Trt=="BPZE1_PBO", glue("Day28{antigens}_{p}")]
    tmp2 = dat_proc_202[dat_proc_202$Trt=="BPZE1",     glue("Day28{antigens}_{p}")]
  } else {
    tmp1 = dat_proc_201[,glue("Day28{antigens}_{p}")]
    tmp2 = dat_proc_202[,glue("Day28{antigens}_{p}")]
  }
  
  tmp1 = tmp1[complete.cases(tmp1),]
  tmp2 = tmp2[complete.cases(tmp2),]
  
  r = range (tmp1, tmp2, na.rm=T)
  min_val = r[1]
  max_val = r[2]
  
  custom_continuous <- function(data, mapping, ...) {
    ggplot(data = data, mapping = mapping) +
      geom_point() +
      xlim(min_val, max_val) + ylim(min_val, max_val)  # adjust these limits as needed
  }

  capture.output(suppressWarnings(suppressMessages({  
    p2 <- ggpairs(tmp1,
      lower = list(continuous = custom_continuous))+ theme(
      strip.text = element_text(size = 7))
    p2
  })))
  
  capture.output(suppressWarnings(suppressMessages({  
    p1 <- ggpairs(tmp2,
      lower = list(continuous = custom_continuous)) + theme(
      strip.text = element_text(size = 7))
    p1
  })))
}


make_pairs_in_one=function(p, vaccine.only=F) {
  if (vaccine.only) {
    tmp1 = dat_proc_201[dat_proc_201$Trt=="BPZE1_PBO", glue("Day28{antigens}_{p}")]
    tmp2 = dat_proc_202[dat_proc_202$Trt=="BPZE1",     glue("Day28{antigens}_{p}")]
  } else {
    tmp1 = dat_proc_201[,glue("Day28{antigens}_{p}")]
    tmp2 = dat_proc_202[,glue("Day28{antigens}_{p}")]
  }
  
  tmp1 = tmp1[complete.cases(tmp1),]
  tmp2 = tmp2[complete.cases(tmp2),]
  
  r = range (tmp1, tmp2, na.rm=T)
  min_val = r[1]
  max_val = r[2]
  
  custom_continuous <- function(data, mapping, ...) {
    ggplot(data = data, mapping = mapping) +
      geom_point() +
      xlim(min_val, max_val) + ylim(min_val, max_val)  # adjust these limits as needed
  }

  tmp=rbind(tmp1, tmp2)
  tmp$col = factor(c(rep("201",nrow(tmp1)), rep("202", nrow(tmp2))))
  
  capture.output(p2 <- suppressWarnings(suppressMessages({  
    ggpairs(tmp,
      progress = FALSE,    # <--- stops the progress printing
      aes(color = col), 
      lower = list(continuous = custom_continuous)) + 
    theme(
      strip.text = element_text(size = 7)) +
      scale_color_manual(values = c("black", "cyan"))
  })))
  p2
}

```

# Correlation between antigens by panel



\clearpage
```{r fig.show='hold', fig.width=7.7, fig.height=7, out.width='49%', echo=F,  results='asis'}

make_pairs_in_one (panels[1], vaccine.only=T)
make_pairs_in_one (panels[2], vaccine.only=T)
make_pairs_in_one (panels[3], vaccine.only=T)
make_pairs_in_one (panels[4], vaccine.only=T)

```

\clearpage

# Correlation between assay types by antigen

Some observations:

- Correlations are higher in 201 than in 202, likely due to higher dynamic range.
- Nasal and serum markers of the same target antigen are not as highly correlated as nasal markers of different target antigens.


\clearpage

```{r, echo=F}
make_pairs2=function(a) {
  tmp1 = dat_proc_201[dat_proc_201$Trt=="BPZE1_PBO",glue("Day28{a}_{panels[1:4]}")]
  tmp1 = tmp1[complete.cases(tmp1),]
  
  tmp2 = dat_proc_202[dat_proc_202$Trt=="BPZE1",glue("Day28{a}_{panels[1:4]}")]
  tmp2 = tmp2[complete.cases(tmp2),]
  
  r = range(tmp1, tmp2, na.rm=T)
  min_val = r[1]
  max_val = r[2]
  
  custom_continuous <- function(data, mapping, ...) {
    ggplot(data = data, mapping = mapping) +
      geom_point() +
      xlim(min_val, max_val) + ylim(min_val, max_val)  # adjust these limits as needed
  }
  
  p2 <- ggpairs(tmp1,
    lower = list(continuous = custom_continuous)) + theme(strip.text = element_text(size = 7))
  print(p2)

  p2 <- ggpairs(tmp2,
    lower = list(continuous = custom_continuous)) + theme(strip.text = element_text(size = 7))
  print(p2)
  
}

make_pairs2_in_one=function(a) {
  tmp1 = dat_proc_201[dat_proc_201$Trt=="BPZE1_PBO",glue("Day28{a}_{panels[2:4]}")]
  tmp1 = tmp1[complete.cases(tmp1),]
  
  tmp2 = dat_proc_202[dat_proc_202$Trt=="BPZE1",glue("Day28{a}_{panels[2:4]}")]
  tmp2 = tmp2[complete.cases(tmp2),]
  
  r = range(tmp1, tmp2, na.rm=T)
  min_val = r[1]
  max_val = r[2]
  
  custom_continuous <- function(data, mapping, ...) {
    ggplot(data = data, mapping = mapping) +
      geom_point() +
      xlim(min_val, max_val) + ylim(min_val, max_val)  # adjust these limits as needed
  }
  
  tmp=rbind(tmp1, tmp2)
  tmp$col = factor(c(rep("201",nrow(tmp1)), rep("202", nrow(tmp2))))
  
  capture.output(p2 <- suppressWarnings(suppressMessages({  
    ggpairs(tmp,
      progress = FALSE,    # <--- stops the progress printing
      aes(color = col), 
      lower = list(continuous = custom_continuous)) + 
    theme(
      strip.text = element_text(size = 7)) +
      scale_color_manual(values = c("black", "cyan"))
  })))
  p2
}

```

```{r fig.show='hold', fig.width=7.7, fig.height=7, echo=F,  results='asis'}
make_pairs2_in_one (antigens[1])
make_pairs2_in_one (antigens[2])
make_pairs2_in_one (antigens[3])
make_pairs2_in_one (antigens[4])
make_pairs2_in_one (antigens[5])
```


```{r correlation_between_sIgA_and_norm_sIgA, echo=F, fig.cap='Top: 201; bottom: 202.', fig.height=5.3, fig.width=14}
# par(mfrow=c(2,5)); par(mar = c(4, 3, 2, 1), mgp = c(2, 0.5, 0))
# 
# xlim=range(c(dat_proc_201[,glue('Day28{antigens}_Nasal_IgA')], dat_proc_202[,glue('Day28{antigens}_Nasal_IgA')]), na.rm=T)
# ylim=range(c(dat_proc_201[,glue('Day28{antigens}_Norm_Nasal_IgA')], dat_proc_202[,glue('Day28{antigens}_Norm_Nasal_IgA')]), na.rm=T)
# 
# for (a in antigens) {
#   corplot(dat_proc_201[,glue('Day28{a}_Nasal_IgA')], dat_proc_201[,glue('Day28{a}_Norm_Nasal_IgA')], method="p", add.diagonal.line=F, main=a, xlab="Nasal IgA", ylab="Norm Nasal IgA", cex.main=1.2, xlim=xlim, ylim=ylim)
# }
# for (a in antigens) {
#   corplot(dat_proc_202[,glue('Day28{a}_Nasal_IgA')], dat_proc_202[,glue('Day28{a}_Norm_Nasal_IgA')], method="p", add.diagonal.line=F, main=a, xlab="Nasal IgA", ylab="Norm Nasal IgA", cex.main=1.4, xlim=xlim, ylim=ylim)
# }

```

\newpage

# Correlation between baseline and Day 28 markers

Some observations:

- Higher correlation between baseline and Day 28 markers are indicative of higher vaccine-elicited responses
- WCE serum IgA correlation between baseline and Day 28 is 0.20 in 201 and 0.62 in 202, suggesting higher vaccine-elicited response in 201.

\clearpage

```{r correlation_between_baseline_and_D28_201, echo=F, fig.width=10, fig.height=10, fig.cap="IB-201P BPZE1_PBO"}
par(mfrow=c(5,5)); shrink_margin()

for (a in assays[1:21]) {
  corplot(dat_proc_201[dat_proc_201$Trt=="BPZE1_PBO",glue("B{a}")], dat_proc_201[dat_proc_201$Trt=="BPZE1_PBO",glue("Day28{a}")], main=a, xlab="Baseline", ylab="Day 28", method="p", cex.main=1)  
}

```

\clearpage

```{r correlation_between_baseline_and_D28_202, echo=F, fig.width=10, fig.height=10, fig.cap="IB-202P BPZE1"}
par(mfrow=c(5,5)); shrink_margin()

for (a in assays[1:22]) {
  if (!all(is.na(dat_proc_202[,glue("B{a}")]))) {
    corplot(dat_proc_202[dat_proc_202$Trt=="BPZE1",glue("B{a}")], dat_proc_202[dat_proc_202$Trt=="BPZE1",glue("Day28{a}")], main=a, xlab="Baseline", ylab="Day 28", method="p", cex.main=1.1)  
  } else {
    empty.plot()
  }
}
```


