---
title: "IB-202P Posthoc Analyses"
author: Fred Hutch Team
date: "`r Sys.Date()`"
output: 
  pdf_document:
    number_sections: true
header-includes:
  - \usepackage{chngcntr}
  - \counterwithin{table}{section}
  - \counterwithin{figure}{section}
---


<!-- Make sure the working dir is cor_poisson because it writes png files to disk. -->

```{r data, include=FALSE}
knitr::opts_chunk$set(echo = F)
options(kableExtra.latex.table_environment="table")
knitr::opts_chunk$set(error = TRUE, message = TRUE, warning = TRUE) # for debug
knitr::opts_knit$set (progress = TRUE, verbose = TRUE) # for debug

library(copcor)
library(survey)
library(kyotil)
library(glue)
library(Hmisc)
library(knitr)
library(GGally)
library(saws)
library(kableExtra)
library(Barnard)

wilcox_test_quiet <- function(...) {
  suppressWarnings(wilcox.test(...))
}


library(geepack)
source("~/correlates_reporting2/cor_poisson/code/gee_bias_correction.R")

dat_mapped_202=read.csv(config::get(config = "iliad_ib202p", file="/home/yfong/correlates_processing/config.yml")$mapped_data)
dat_proc_202=read.csv(config::get(config = "iliad_ib202p", file="/home/yfong/correlates_reporting2/config.yml")$data_cleaned)
dat_proc_202$Ptid = as.factor(dat_proc_202$Ptid) # need to make it a factor to use as id
dat_proc_202$Trt = factor(dat_proc_202$Trt, levels = c("PBO","BPZE1")) 

dat_mapped_201=read.csv(config::get(config = "iliad_ib201p", file="/home/yfong/correlates_processing/config.yml")$mapped_data)
dat_proc_201=read.csv(config::get(config = "iliad_ib201p", file="/home/yfong/correlates_reporting2/config.yml")$data_cleaned)

assay_metadata=read.csv(glue('~/correlates_reporting2/assay_metadata/iliad_ib202p_assay_metadata.csv'))
assays = assay_metadata$assay

antigens = c("WCE", setdiff(unique(assay_metadata$antigen), c("WCE", NA)))

panels = unique(assay_metadata$panel)
panels = panels[c(1,2,3,4)] # "Norm_Nasal_IgA" "Nasal_IgA"      "Serum_IgA"  "Serum_IgG"
panel_names=c("NS-IgA", "AS-IgA", "Serum IgA", "Serum IgG")
```

```{r DiProPerm}
# cannot run on cosrv b/c of the package conflicts for the version of R
# run it on https://rstudio44.scharp.org/
```

# VE
```{r ve}

dat=subset(dat_proc_202, PPAI==1)

tab=mytable(dat$EventIndC9_11_14, dat$Trt)
fisher.test(tab)
barnard.test(tab[1,1], tab[1,2], tab[2,1], tab[2,2])

tab=mytable(dat$EventIndC14, dat$Trt)
# fisher.test(tab)
barnard.test(tab[1,1], tab[1,2], tab[2,1], tab[2,2])


dat=subset(dat_proc_202)

tab=mytable(dat$EventIndC9_11_14, dat$Trt)
# fisher.test(tab)
barnard.test(tab[1,1], tab[1,2], tab[2,1], tab[2,2])

tab=mytable(dat$EventIndC14, dat$Trt)
# fisher.test(tab)
barnard.test(tab[1,1], tab[1,2], tab[2,1], tab[2,2])
```


\clearpage
# Foldrise statistics
```{r is foldrise sig}
maketab=function(.PPAI, trt, digit) {
  tab = sapply (panels[1:4], function (p) {
        sapply(antigens, function(a) {
          dat.tmp = subset(dat_proc_202, Trt == trt & PPAI %in% c(1, if(!.PPAI) 0))[[glue("Delta28overB{a}_{p}")]]
          out=wilcox_test_quiet(dat.tmp)
          glue("{formatDouble(10**(mean(dat.tmp)),digit)} ({formatPvalues(out$p.value)})")
        })
  })
  colnames(tab)=panel_names[1:4]
  tab
}

tab1=maketab(T, "BPZE1", digit=2)
tab2=maketab(T, "PBO", digit=3)
tab=cbind(tab2, tab1)
kable(tab,
  format = "latex",
  booktabs = TRUE,
  align = "c",
  caption = "Foldrise in antibody responses by treatment group") %>% 
  column_spec(1:ncol(tab), extra_css = "padding-left:20px; padding-right:20px;") %>% 
  add_header_above(c(" "=1, "Placebo"=4, "Vaccine"=4)) %>%
  kable_styling(latex_options = "scale_down")

```

\newpage

\clearpage
# Covariates selection

```{r covariates selection with glm, echo=F}

fit1 = glm(EventIndC9_11_14 ~ Sex, subset(dat_proc_202, Trt=="BPZE1"), family=poisson(link = "log"))
fit2 = glm(EventIndC9_11_14 ~ Age, subset(dat_proc_202, Trt=="BPZE1"), family=poisson(link = "log"))
tab=getFormattedSummary(list(Sex=fit1, Age=fit2), robust=T, exp=T)[2,,drop=F]
rownames(tab)[1]=""
kable(tab, align="c", caption="Covariates selection.")
```

```{r covariates selection with two sample comparison}

# for Age

fcov = function(v) {
  pvals = c(
    wilcox_test_quiet(as.formula(glue("{v}~EventIndC9_11_14")), subset(dat_proc_202, Trt == "BPZE1"))$p.value,
    wilcox_test_quiet(as.formula(glue("{v}~EventIndC9_11_14")), subset(dat_proc_202, Trt == "PBO"))$p.value,
    wilcox_test_quiet(as.formula(glue("{v}~EventIndC9_11_14")), subset(dat_proc_202, PPAI ==1 & Trt == "BPZE1"))$p.value,
    wilcox_test_quiet(as.formula(glue("{v}~EventIndC9_11_14")), subset(dat_proc_202, PPAI ==1 & Trt == "PBO"))$p.value,

    t.test(as.formula(glue("{v}~EventIndC9_11_14")), subset(dat_proc_202, Trt == "BPZE1"))$p.value,
    t.test(as.formula(glue("{v}~EventIndC9_11_14")), subset(dat_proc_202, Trt == "PBO"))$p.value,
    t.test(as.formula(glue("{v}~EventIndC9_11_14")), subset(dat_proc_202, PPAI ==1 & Trt == "BPZE1"))$p.value,
    t.test(as.formula(glue("{v}~EventIndC9_11_14")), subset(dat_proc_202, PPAI ==1 & Trt == "PBO"))$p.value
  ); pvals

  tab = matrix(format.pval(pvals, digit=3), nr=2)
  rownames(tab) = c("BPZE1", "PBO")
  colnames(tab) = c("PP, Wilcox", "PPAI, Wilcox", "PP, t", "PPAI, t")
  tab
}

kable(fcov("Age"), caption="age")


par(mfrow=c(1,3))#, mgp = c(2, 1, 0))  # move label 1 line higher to make room for p value
ylim=c(20,50)
myboxplot(Age~EventIndC9_11_14, subset(dat_proc_202, Trt == "BPZE1"), ylim=ylim, main="BPZE1", xlab="case status", test="t")
myboxplot(Age~EventIndC9_11_14, subset(dat_proc_202, Trt == "PBO"), ylim=ylim, main="PBO", xlab="case status", test="t")
myboxplot(Age~Trt, dat_proc_202, ylim=ylim, main="All", xlab="Trt", test="t")


# for Sex

with (subset(dat_proc_202, Trt == "BPZE1"), fisher.test(table(Sex, EventIndC9_11_14)))$p.val
with (subset(dat_proc_202, Trt == "PBO"),   fisher.test(table(Sex, EventIndC9_11_14)))$p.val
with (dat_proc_202, fisher.test(table(Sex, Trt)))$p.val


# age and markers

par(mfrow=c(1,2)); reduce_margin()

plot(BFHA_Serum_IgG~Age, dat_proc_202, main="")
abline(lm(BFHA_Serum_IgG~Age, dat_proc_202))
getFormattedSummary(list(lm(BFHA_Serum_IgG~Age, dat_proc_202)), robust=F) 

plot(BFHA_Norm_Nasal_IgA~Age, dat_proc_202, main="")
abline(lm(BFHA_Norm_Nasal_IgA~Age, dat_proc_202))
getFormattedSummary(list(lm(BFHA_Norm_Nasal_IgA~Age, dat_proc_202)), robust=F) 


```

\newpage

\clearpage
# Some tables


```{r p values table}
# make a table of p values for different comparison
run.tests = function(assay, test, PPAI.only=T, endpoint="EventIndC9_11_14", do.fold.change=F) {
  if (test=="w") {
    pvals = c(
      wilcox_test_quiet(as.formula(glue("Day28{assay}~{endpoint}")), subset(dat_proc_202, Trt == "BPZE1"))$p.value,
      wilcox_test_quiet(as.formula(glue("B{assay}~{endpoint}")),     subset(dat_proc_202, Trt == "BPZE1"))$p.value,
      wilcox_test_quiet(as.formula(glue("Delta28overB{assay}~{endpoint}")), subset(dat_proc_202, Trt == "BPZE1"))$p.value,
      wilcox_test_quiet(as.formula(glue("Day28{assay}~{endpoint}")), subset(dat_proc_202, Trt == "PBO"))$p.value,
      wilcox_test_quiet(as.formula(glue("B{assay}~{endpoint}")),     subset(dat_proc_202, Trt == "PBO"))$p.value,
      wilcox_test_quiet(as.formula(glue("Delta28overB{assay}~{endpoint}")),     subset(dat_proc_202, Trt == "PBO"))$p.value,
      wilcox_test_quiet(as.formula(glue("Day28{assay}~{endpoint}")), subset(dat_proc_202, PPAI ==1 & Trt == "BPZE1"))$p.value,
      wilcox_test_quiet(as.formula(glue("B{assay}~{endpoint}")),     subset(dat_proc_202, PPAI ==1 & Trt == "BPZE1"))$p.value,
      wilcox_test_quiet(as.formula(glue("Delta28overB{assay}~{endpoint}")),     subset(dat_proc_202, PPAI ==1 & Trt == "BPZE1"))$p.value,
      wilcox_test_quiet(as.formula(glue("Day28{assay}~{endpoint}")), subset(dat_proc_202, PPAI ==1 & Trt == "PBO"))$p.value,
      wilcox_test_quiet(as.formula(glue("B{assay}~{endpoint}")),     subset(dat_proc_202, PPAI ==1 & Trt == "PBO"))$p.value,
      wilcox_test_quiet(as.formula(glue("Delta28overB{assay}~{endpoint}")),     subset(dat_proc_202, PPAI ==1 & Trt == "PBO"))$p.value
    ); 
    tab = matrix(format.pval(pvals, digit=3), nr=3)
  
  } else if (test=="t") {
    pvals = c(
      t.test(as.formula(glue("Day28{assay}~{endpoint}")), subset(dat_proc_202, Trt == "BPZE1"))$p.value,
      t.test(as.formula(glue("B{assay}~{endpoint}")),     subset(dat_proc_202, Trt == "BPZE1"))$p.value,
      t.test(as.formula(glue("Delta28overB{assay}~{endpoint}")),     subset(dat_proc_202, Trt == "BPZE1"))$p.value,
      t.test(as.formula(glue("Day28{assay}~{endpoint}")), subset(dat_proc_202, Trt == "PBO"))$p.value,
      t.test(as.formula(glue("B{assay}~{endpoint}")),     subset(dat_proc_202, Trt == "PBO"))$p.value,
      t.test(as.formula(glue("Delta28overB{assay}~{endpoint}")),     subset(dat_proc_202, Trt == "PBO"))$p.value,
      t.test(as.formula(glue("Day28{assay}~{endpoint}")), subset(dat_proc_202, PPAI ==1 & Trt == "BPZE1"))$p.value,
      t.test(as.formula(glue("B{assay}~{endpoint}")),     subset(dat_proc_202, PPAI ==1 & Trt == "BPZE1"))$p.value,
      t.test(as.formula(glue("Delta28overB{assay}~{endpoint}")),     subset(dat_proc_202, PPAI ==1 & Trt == "BPZE1"))$p.value,
      t.test(as.formula(glue("Day28{assay}~{endpoint}")), subset(dat_proc_202, PPAI ==1 & Trt == "PBO"))$p.value,
      t.test(as.formula(glue("B{assay}~{endpoint}")),     subset(dat_proc_202, PPAI ==1 & Trt == "PBO"))$p.value,
      t.test(as.formula(glue("Delta28overB{assay}~{endpoint}")),     subset(dat_proc_202, PPAI ==1 & Trt == "PBO"))$p.value
    ); 
    tab = matrix(format.pval(pvals, digit=3), nr=3)
  
  } else if (test=="MBN" | test=="MD" | test=="Poisson") {
    if (test=="Poisson") robust=F else robust=test
    
    pvals = c(
      getFormattedSummary(list(geeglm(as.formula(glue("{endpoint} ~ Day28{assay}")), data  = subset(dat_proc_202, Trt == "BPZE1"), family= poisson(link = "log"), id = Ptid, corstr= "independence")), robust=robust, type=10)[2,1],
      getFormattedSummary(list(geeglm(as.formula(glue("{endpoint} ~ B{assay}")),     data  = subset(dat_proc_202, Trt == "BPZE1"), family= poisson(link = "log"), id = Ptid, corstr= "independence")), robust=robust, type=10)[2,1],
      getFormattedSummary(list(geeglm(as.formula(glue("{endpoint} ~ Delta28overB{assay}")),     data  = subset(dat_proc_202, Trt == "BPZE1"), family= poisson(link = "log"), id = Ptid, corstr= "independence")), robust=robust, type=10)[2,1],
      getFormattedSummary(list(geeglm(as.formula(glue("{endpoint} ~ Day28{assay}")), data  = subset(dat_proc_202, Trt == "PBO"), family= poisson(link = "log"), id = Ptid, corstr= "independence")), robust=robust, type=10)[2,1],
      getFormattedSummary(list(geeglm(as.formula(glue("{endpoint} ~ B{assay}")),     data  = subset(dat_proc_202, Trt == "PBO"), family= poisson(link = "log"), id = Ptid, corstr= "independence")), robust=robust, type=10)[2,1],
      getFormattedSummary(list(geeglm(as.formula(glue("{endpoint} ~ Delta28overB{assay}")),     data  = subset(dat_proc_202, Trt == "PBO"), family= poisson(link = "log"), id = Ptid, corstr= "independence")), robust=robust, type=10)[2,1],
      getFormattedSummary(list(geeglm(as.formula(glue("{endpoint} ~ Day28{assay}")), data  = subset(dat_proc_202, PPAI ==1 & Trt == "BPZE1"), family= poisson(link = "log"), id = Ptid, corstr= "independence")), robust=robust, type=10)[2,1],
      getFormattedSummary(list(geeglm(as.formula(glue("{endpoint} ~ B{assay}")),     data  = subset(dat_proc_202, PPAI ==1 & Trt == "BPZE1"), family= poisson(link = "log"), id = Ptid, corstr= "independence")), robust=robust, type=10)[2,1],
      getFormattedSummary(list(geeglm(as.formula(glue("{endpoint} ~ Delta28overB{assay}")),     data  = subset(dat_proc_202, PPAI ==1 & Trt == "BPZE1"), family= poisson(link = "log"), id = Ptid, corstr= "independence")), robust=robust, type=10)[2,1],
      getFormattedSummary(list(geeglm(as.formula(glue("{endpoint} ~ Day28{assay}")), data  = subset(dat_proc_202, PPAI ==1 & Trt == "PBO"), family= poisson(link = "log"), id = Ptid, corstr= "independence")), robust=robust, type=10)[2,1],
      getFormattedSummary(list(geeglm(as.formula(glue("{endpoint} ~ B{assay}")),     data  = subset(dat_proc_202, PPAI ==1 & Trt == "PBO"), family= poisson(link = "log"), id = Ptid, corstr= "independence")), robust=robust, type=10)[2,1],
      getFormattedSummary(list(geeglm(as.formula(glue("{endpoint} ~ Delta28overB{assay}")),     data  = subset(dat_proc_202, PPAI ==1 & Trt == "PBO"), family= poisson(link = "log"), id = Ptid, corstr= "independence")), robust=robust, type=10)[2,1]
    ); 
    # no need to format p values, already string
    tab = matrix(pvals, nr=3)
    
  } else stop (glue("wrong test: {test}"))
  
  rownames(tab) = c("Day28", "B", "D28/B")
  colnames(tab) = c("BPZE1", "PBO", "BPZE1", "PBO")
  
  if (PPAI.only) tab = tab[,3:4]
  
  if (!do.fold.change) tab = tab[1:2,]
    
  tab
}

# compare tests

tab = run.tests(assay="FHA_Norm_Nasal_IgA", test="w", PPAI.only=F, do.fold.change=T)
kable(tab, align="c") %>% add_header_above(c("Wilcox"=1, "PP" = 2, "PPAI" = 2)) %>% column_spec(1:4, extra_css = "padding-left:20px; padding-right:20px;")

tab = run.tests(assay="FHA_Norm_Nasal_IgA", test="t", PPAI.only=F, do.fold.change=T)
kable(tab, align="c") %>% add_header_above(c("t test"=1, "PP" = 2, "PPAI" = 2)) %>% column_spec(1:4, extra_css = "padding-left:20px; padding-right:20px;")

tab = run.tests(assay="FHA_Norm_Nasal_IgA", test="MBN", PPAI.only=F, do.fold.change=T)
kable(tab, align="c") %>% add_header_above(c("Poisson MBN"=1, "PP" = 2, "PPAI" = 2)) %>% column_spec(1:4, extra_css = "padding-left:20px; padding-right:20px;")

tab = run.tests(assay="FHA_Norm_Nasal_IgA", test="MD", PPAI.only=F, do.fold.change=T)
kable(tab, align="c") %>% add_header_above(c("Poisson MD"=1, "PP" = 2, "PPAI" = 2)) %>% column_spec(1:4, extra_css = "padding-left:20px; padding-right:20px;")

tab = run.tests(assay="FHA_Norm_Nasal_IgA", test="Poisson", PPAI.only=F, do.fold.change=T)
kable(tab, align="c") %>% add_header_above(c("Poisson"=1, "PP" = 2, "PPAI" = 2)) %>% column_spec(1:4, extra_css = "padding-left:20px; padding-right:20px;")


# make p val table for a single assay 

make.p.tab = function(a, test="MBN") {
  tab = run.tests(assay=a, test=test, PPAI.only=T, do.fold.change=T)
  tab = matrix(tab[c(2,1,3),], nr=1); colnames(tab) = kyotil::escape_latex(c("BPZE1, B", "BPZE1, 28", "BPZE1, 28-B", "PBO, B", "PBO, 28", "PBO, 28-B"))
  rownames(tab)=a
  kable(tab)
  # the following generates an error when rendered with Rscript
  # kable(tab, align="c", col.names = NULL)  %>%  
  #   add_header_above(c("Poisson pval"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>%
  #   column_spec(1:ncol(tab), extra_css = "padding-left:20px; padding-right:20px;")
}

make.p.tab ("FHA_Norm_Nasal_IgA", test="w")
make.p.tab ("FHA_Norm_Nasal_IgA", test="t")
make.p.tab ("FHA_Norm_Nasal_IgA")
make.p.tab ("FHA_Serum_IgG")
make.p.tab ("PT_Serum_IgA")
make.p.tab ("WCE_Norm_Nasal_IgA")

```

```{r assay by antigen table function}
assay_antigen_table = function(dat, endpoint, timepoint, robust="MBN", adj.age=F) {

  pvals = sapply(assays[1:20], function(assay) {
    getFormattedSummary(list(geeglm(as.formula(glue("{endpoint} ~ {timepoint}{assay}{ifelse(adj.age,'+Age','')}")), data  = dat, family= poisson(link = "log"), id = Ptid, corstr= "independence")), robust=robust, type=10)[2,1]
  })
    
  # no need to format p values, already string
  tab = matrix(pvals, nr=5)
    
  rownames(tab) = antigens
  colnames(tab) = panels[1:4]
  colnames(tab)[2] = "Norm_sIgA" # make it shorter
  tab
}
```

```{r assay by antigen table BPZE1}

# BPZE1, Day 28, no age
tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1" & PPAI==1), endpoint="EventIndC9_11_14", timepoint="Day28"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PPAI prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1" & PPAI==1), endpoint="EventIndC14", timepoint="Day28"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PPAI alt"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1"), endpoint="EventIndC9_11_14", timepoint="Day28"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PP prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1"), endpoint="EventIndC14", timepoint="Day28"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PP alt"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")


# BPZE1, Day 28, adj age
tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1" & PPAI==1), endpoint="EventIndC9_11_14", timepoint="Day28", adj.age=T))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PPAI prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1" & PPAI==1), endpoint="EventIndC14", timepoint="Day28", adj.age=T))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PPAI alt"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1"), endpoint="EventIndC9_11_14", timepoint="Day28", adj.age=T))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PP prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1"), endpoint="EventIndC14", timepoint="Day28", adj.age=T))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PP alt"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")


# BPZE1, baseline
tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1" & PPAI==1), endpoint="EventIndC9_11_14", timepoint="B"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PPAI prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1" & PPAI==1), endpoint="EventIndC14", timepoint="B"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PPAI alt"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1"), endpoint="EventIndC9_11_14", timepoint="B"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PP prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1"), endpoint="EventIndC14", timepoint="B"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PP alt"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")


# BPZE1, fold change
tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1" & PPAI==1), endpoint="EventIndC9_11_14", timepoint="Delta28overB"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PPAI prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1" & PPAI==1), endpoint="EventIndC14", timepoint="Delta28overB"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PPAI alt"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1"), endpoint="EventIndC9_11_14", timepoint="Delta28overB"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PP prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "BPZE1"), endpoint="EventIndC14", timepoint="Delta28overB"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PP alt"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

```

```{r assay by antigen table PBO}

# PBO, Day 28, no age
tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "PBO" & PPAI==1), endpoint="EventIndC9_11_14", timepoint="Day28"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PPAI prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "PBO"), endpoint="EventIndC9_11_14", timepoint="Day28"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PP prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

# adj age
tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "PBO" & PPAI==1), endpoint="EventIndC9_11_14", timepoint="Day28", adj.age=T))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PPAI prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "PBO"), endpoint="EventIndC9_11_14", timepoint="Day28", adj.age=T))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PP prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")


# PBO, baseline
tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "PBO" & PPAI==1), endpoint="EventIndC9_11_14", timepoint="B"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PPAI prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "PBO"), endpoint="EventIndC9_11_14", timepoint="B"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PP prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

# adj age
tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "PBO" & PPAI==1), endpoint="EventIndC9_11_14", timepoint="B", adj.age=T))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PPAI prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "PBO"), endpoint="EventIndC9_11_14", timepoint="B", adj.age=T))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PP prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")



# PBO, fold rise, no age
tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "PBO" & PPAI==1), endpoint="EventIndC9_11_14", timepoint="Delta28overB"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PPAI prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "PBO"), endpoint="EventIndC9_11_14", timepoint="Delta28overB"))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PP prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

# adj age
tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "PBO" & PPAI==1), endpoint="EventIndC9_11_14", timepoint="Delta28overB", adj.age=T))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PPAI prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

tab = t(assay_antigen_table(dat=subset(dat_proc_202, Trt == "PBO"), endpoint="EventIndC9_11_14", timepoint="Delta28overB", adj.age=T))
kable(tab, align="c", col.names=NULL)%>%  add_header_above(c("PP prim"=1, setNames(rep(1,ncol(tab)), colnames(tab)))) %>% column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;")

```

```{r spot check p vals}
f1 = function(dat, a, endpoint="EventIndC9_11_14") {
  fit.gee <- geeglm(as.formula(glue("{endpoint} ~ {a}")), data  = dat, family= poisson(link = "log"),
    id = Ptid, corstr= "independence")
  # summary(fit.gee)   # robust (sandwich) SEs by default
  # ssase (fit.gee)
  # fit.glm <- glm(EventIndC9_11_14 ~ Day28FHA_Serum_IgG, data  = dat, family= poisson(link = "log"))

  print(list(
    getFormattedSummary(list(fit.gee), robust=T, type=12),
    getFormattedSummary(list(fit.gee), robust="MD", type=12),
    getFormattedSummary(list(fit.gee), robust="MBN", type=12)))
  
  myboxplot(as.formula(glue("{a}~{endpoint}")), dat, test="w")
  
  print(t.test(as.formula(glue("{a}~{endpoint}")), dat))
  
  # print(anova(lm(as.formula(glue("{a}~{endpoint}")), dat)))
}

dat.ppai = subset(dat_proc_202, Trt == "BPZE1" & PPAI==1)
f1(dat.ppai, a="Day28FHA_Serum_IgG")
f1(dat.ppai, a="Day28WCE_Serum_IgA")
f1(dat.ppai, a="Day28WCE_Nasal_IgA")
f1(dat.ppai, a="Day28WCE_Norm_Nasal_IgA")
f1(dat.ppai, a="BFHA_Norm_Nasal_IgA")

dat.pp = subset(dat_proc_202, Trt == "BPZE1")
f1(dat.pp, a="Day28FHA_Serum_IgG")
f1(dat.pp, a="Day28WCE_Serum_IgA")
f1(dat.pp, a="BFHA_Norm_Nasal_IgA")

f1(subset(dat_proc_202, Trt == "PBO" & PPAI==1), a="Day28FHA_Norm_Nasal_IgA")
f1(subset(dat_proc_202, Trt == "PBO" & PPAI==1), a="BFHA_Norm_Nasal_IgA")

```

```{r exploratory spot check wilcox robust binomial}
dat= subset(dat_proc_202, Trt=="PBO")

myboxplot(Delta28overBFHA_Norm_Nasal_IgA~EventIndC9_11_14, dat, test="w")

fit = glm(EventIndC9_11_14 ~ Delta28overBFHA_Norm_Nasal_IgA, dat, family=poisson(link = "log"))
getFormattedSummary(list(fit), robust=T)
getFormattedSummary(list(fit), robust=F)

fit = glm(EventIndC9_11_14 ~ Delta28overBFHA_Norm_Nasal_IgA, dat, family=binomial(link = "logit"))
getFormattedSummary(list(fit), robust=T)
getFormattedSummary(list(fit), robust=F)


myboxplot(BFHA_Norm_Nasal_IgA~EventIndC9_11_14, dat, test="w")

fit = glm(EventIndC9_11_14 ~ BFHA_Norm_Nasal_IgA, dat, family=poisson(link = "log"))
getFormattedSummary(list(fit), robust=T, type=2)
getFormattedSummary(list(fit), robust=F, type=2)

fit = geeglm(EventIndC9_11_14 ~ BFHA_Norm_Nasal_IgA, dat, family=poisson(link = "log"), id = Ptid, corstr= "independence")
ssase (fit)
getFormattedSummary(list(fit), robust=T, type=2)


fit = glm(EventIndC9_11_14 ~ BFHA_Norm_Nasal_IgA, dat, family=binomial(link = "logit"))
getFormattedSummary(list(fit), robust=T)
getFormattedSummary(list(fit), robust=F)

# getFormattedSummary(list(mgee(EventIndC9_11_14 ~ BFHA_Norm_Nasal_IgA, dat, family=poisson(link = "log"), id = Ptid, corstr= "independence")), robust=T, finite="dm", type=2)
# 
# getFormattedSummary(list(mgee(EventIndC9_11_14 ~ Delta28overBFHA_Norm_Nasal_IgA, dat, family=poisson(link = "log"), id = Ptid, corstr= "independence")), robust="d5", type=2)
# 
# getFormattedSummary(list(mgee(EventIndC9_11_14 ~ Delta28overBFHA_Norm_Nasal_IgA, dat, family=poisson(link = "log"), id = Ptid, corstr= "independence")), robust="d4", type=2)
# 
# getFormattedSummary(list(mgee(EventIndC9_11_14 ~ Delta28overBFHA_Norm_Nasal_IgA, dat, family=poisson(link = "log"), id = Ptid, corstr= "independence")), robust="d3", type=2)
# 
# getFormattedSummary(list(mgee(EventIndC9_11_14 ~ Delta28overBFHA_Norm_Nasal_IgA, dat, family=poisson(link = "log"), id = Ptid, corstr= "independence")), robust="d2", type=2)
# 
# getFormattedSummary(list(mgee(EventIndC9_11_14 ~ Delta28overBFHA_Norm_Nasal_IgA, dat, family=poisson(link = "log"), id = Ptid, corstr= "independence")), robust=T, type=2)
# 
# getFormattedSummary(list(mgee(EventIndC9_11_14 ~ Delta28overBFHA_Norm_Nasal_IgA, dat, family=poisson(link = "log"), id = Ptid, corstr= "independence")), robust=F, type=2)
# 
# getFormattedSummary(list(glm(EventIndC9_11_14 ~ Delta28overBFHA_Norm_Nasal_IgA, dat, family=poisson(link = "log"))), robust=T, type=2)


fit.mgee = mgee(EventIndC9_11_14 ~ BFHA_Norm_Nasal_IgA, dat, family=poisson(link = "log"), id = Ptid, corstr= "independence")

saws(fit.mgee,method="dm")$se
saws(fit.mgee,method=c("d1"),bound=.75)$se
saws(fit.mgee,method=c("d2"),bound=.75)$se
saws(fit.mgee,method=c("d3"),bound=.75)$se
saws(fit.mgee,method=c("d4"),bound=.75)$se
saws(fit.mgee,method=c("d5"),bound=.75)$se


fit.mgee = mgee(EventIndC9_11_14 ~ Delta28overBFHA_Norm_Nasal_IgA, dat, family=poisson(link = "log"), id = Ptid, corstr= "independence")
# saws(fit.mgee,method="dm")$se # model-based
saws(fit.mgee,method=c("d1"),bound=.75)$se
saws(fit.mgee,method=c("d2"),bound=.75)$se
saws(fit.mgee,method=c("d3"),bound=.75)$se
saws(fit.mgee,method=c("d4"),bound=.75)$se
saws(fit.mgee,method=c("d5"),bound=.75)$se


fit.mgee = mgee(EventIndC9_11_14 ~ Delta28overBFHA_Norm_Nasal_IgA, dat, family=gaussian, id = Ptid, corstr= "independence")
# saws(fit.mgee,method="dm")$se # model-based
saws(fit.mgee,method=c("d1"),bound=.75)$se
saws(fit.mgee,method=c("d2"),bound=.75)$se
saws(fit.mgee,method=c("d3"),bound=.75)$se
saws(fit.mgee,method=c("d4"),bound=.75)$se
saws(fit.mgee,method=c("d5"),bound=.75)$se

fit =    geeglm(EventIndC9_11_14 ~ Delta28overBFHA_Norm_Nasal_IgA, dat, family=gaussian, id = Ptid, corstr= "independence")
mysapply(ssase (fit), function (v) sqrt(diag(v)))


```

\newpage

\newpage

\clearpage
# PC1 score

```{r loadings, fig.height=7.5, fig.width=8, fig.cap="Loadings"}
par(mfrow=c(2,2))

# add PC1 for each panel
for (i in 1:4) {
  p=panels[i]
  # assays within panel p
  aa = glue("{antigens}_{p}")
  
  wt.B = princomp(dat_proc_202[, "B"%.%aa])$loadings[,1] 
  wt.Day28 = princomp(dat_proc_202[, "Day28"%.%aa])$loadings[,1] 
  
  corplot(wt.B, wt.Day28, asp=1, main=panel_names[i], xlab="Baseline PC1 loading", ylab="Day 28 PC1 loading")
  
}

```


```{r define pc1 scores}

# add PC1 for each panel
wt.Day28.mat = NULL
for (i in 1:4) {
  p=panels[i]
  # assays within panel p
  aa = glue("{antigens}_{p}")
  
  wt.B = princomp(dat_proc_202[, "B"%.%aa])$loadings[,1] 
  wt.Day28 = princomp(dat_proc_202[, "Day28"%.%aa])$loadings[,1] 
  
  # wt = (wt.B + wt.Day28)/2
  wt = wt.Day28
  
  for (t in c("B", "Day28", "Delta28overB")) {
    dat_proc_202[, glue("{t}{p}_PC1")] = as.matrix(dat_proc_202[, t%.%aa]) %*% wt
  }
  dat_proc_202[, glue("BDay28{p}_PC1")] = (dat_proc_202[, glue("B{p}_PC1")] + dat_proc_202[, glue("Day28{p}_PC1")]) / 2
  
  wt.Day28.mat = cbind(wt.Day28.mat, wt.Day28)
}

colnames(wt.Day28.mat)=panels[1:4]
rownames(wt.Day28.mat)=antigens
kable(wt.Day28.mat, digit=2, caption="PC1 Loading.")

```

```{r pc1 poission}
pc1_reg = function(endpoint, PPAI.only, trt) {
  tab = mysapply (c("B","Day28","Delta28overB"), function (t) {
    fits = lapply(panels[1:4], function(p) geeglm(as.formula(glue("{endpoint} ~ {t}{p}_PC1")), data  = subset(dat_proc_202, Trt == trt & PPAI %in% c(1, if(!PPAI.only) 0)), family= poisson(link = "log"), id = Ptid, corstr= "independence"))
    getFormattedSummary(fits, robust="MBN", exp=T, type=6, sig.level=0.1)[2,,drop=F]
  })
  
  colnames(tab)=panels[1:4]
  
  tab=t(tab)
  colnames(tab)=c("Baseline", "Day 28", "Foldrise")
  rownames(tab)=panel_names[1:4]
  
  tab
}

corner.text="PPAI prim"
tab1=pc1_reg (endpoint="EventIndC9_11_14", PPAI.only=T, trt="BPZE1")
tab2=pc1_reg (endpoint="EventIndC9_11_14", PPAI.only=T, trt="PBO")
tab=cbind(tab2, tab1)
kable(tab, align="c", caption="PC1 Poisson "%.%corner.text) %>% 
  column_spec(1:ncol(tab), extra_css = "padding-left:10px; padding-right:10px;") %>% 
  add_header_above(c(" "=1, "Placebo"=3, "Vaccine"=3))

corner.text="Vaccine, alt"
tab=pc1_reg (endpoint="EventIndC14", PPAI.only=T, trt="BPZE1")
kable(tab, align="c", col.names = NULL, caption="PC1 Poisson "%.%corner.text) %>% column_spec(1:ncol(tab), extra_css = "padding-left:20px; padding-right:20px;") %>% add_header_above(c(setNames(1, corner.text), setNames(rep(1,ncol(tab)), colnames(tab)))) # add text in corner cell


corner.text ="PP prim"
tab=pc1_reg (endpoint="EventIndC9_11_14", PPAI.only=F, trt="BPZE1")
kable(tab, align="c", col.names = NULL, caption="PC1 Poisson "%.%corner.text) %>% column_spec(1:ncol(tab), extra_css = "padding-left:20px; padding-right:20px;") %>% add_header_above(c(setNames(1, corner.text), setNames(rep(1,ncol(tab)), colnames(tab)))) # add text in corner cell

corner.text="PP alt"
tab=pc1_reg (endpoint="EventIndC14", PPAI.only=F, trt="BPZE1")
kable(tab, align="c", col.names = NULL, caption="PC1 Poisson "%.%corner.text) %>% column_spec(1:ncol(tab), extra_css = "padding-left:20px; padding-right:20px;") %>% add_header_above(c(setNames(1, corner.text), setNames(rep(1,ncol(tab)), colnames(tab)))) # add text in corner cell

corner.text="PP"
tab=pc1_reg (endpoint="EventIndC9_11_14", PPAI.only=F, trt="PBO")
kable(tab, align="c", col.names = NULL, caption="PC1 Poisson "%.%corner.text) %>% column_spec(1:ncol(tab), extra_css = "padding-left:20px; padding-right:20px;") %>% add_header_above(c(setNames(1, corner.text), setNames(rep(1,ncol(tab)), colnames(tab)))) # add text in corner cell


```

```{r pc1 scatterplot, fig.height=7.5, fig.width=8, fig.cap="PC1 scatterplots"}

par(mfrow=c(2,2)); reduce_margin()

dat = subset(dat_proc_202, PPAI==1)

plot(Day28Norm_Nasal_IgA_PC1 ~ BNorm_Nasal_IgA_PC1, dat, main="PPAI prim", col= ifelse(dat$EventIndC9_11_14==1, 2, 4), pch= ifelse(dat$Trt=="PBO", 1, 2), asp=1)
mylegend(pch=c(1,1,2,2), legend=c("PBO cases","PBO non-cases","BPZE1 cases","BPZE1 non-cases"), x=9, col=c(2,4,2,4), bty="y", cex=0.8); abline(0,1)

plot(Day28Norm_Nasal_IgA_PC1 ~ BNorm_Nasal_IgA_PC1, dat, main="PPAI alt", col= ifelse(dat$EventIndC14==1, 2, 4), pch= ifelse(dat$Trt=="PBO", 1, 2), asp=1)
mylegend(pch=c(1,1,2,2), legend=c("PBO cases","PBO non-cases","BPZE1 cases","BPZE1 non-cases"), x=9, col=c(2,4,2,4), bty="y", cex=0.8); abline(0,1)

dat = subset(dat_proc_202)

plot(Day28Norm_Nasal_IgA_PC1 ~ BNorm_Nasal_IgA_PC1, dat, main="PP prim", col= ifelse(dat$EventIndC9_11_14==1, 2, 4), pch= ifelse(dat$Trt=="PBO", 1, 2), asp=1)
mylegend(pch=c(1,1,2,2), legend=c("PBO cases","PBO non-cases","BPZE1 cases","BPZE1 non-cases"), x=9, col=c(2,4,2,4), bty="y", cex=0.8); abline(0,1)

plot(Day28Norm_Nasal_IgA_PC1 ~ BNorm_Nasal_IgA_PC1, dat, main="PP alt", col= ifelse(dat$EventIndC14==1, 2, 4), pch= ifelse(dat$Trt=="PBO", 1, 2), asp=1)
mylegend(pch=c(1,1,2,2), legend=c("PBO cases","PBO non-cases","BPZE1 cases","BPZE1 non-cases"), x=9, col=c(2,4,2,4), bty="y", cex=0.8); abline(0,1)

```

```{r pc1 foldrise in median}

pc1_median = function(endpoint, PPAI.only, trt) {
  tab = mysapply (c("B","Day28","BDay28","Delta28overB"), function (t) {
    sapply(panels[1:4], function(p) {
      out=aggregate(as.formula(glue("{t}{p}_PC1 ~ {endpoint}")), data  = subset(dat_proc_202, Trt == trt & PPAI %in% c(1, if(!PPAI.only) 0)), median)
      10**(out[1,2] - out[2,2])
    })
  })
  
  tab=t(tab)
  colnames(tab)=c("Baseline", "Day 28", "B_Day 28", "Foldrise")
  rownames(tab)=panel_names[1:4]
  
  tab
}

tab1=pc1_median (endpoint="EventIndC9_11_14", PPAI.only=T, trt="BPZE1")
tab2=pc1_median (endpoint="EventIndC9_11_14", PPAI.only=T, trt="PBO")
tab=cbind(tab2, tab1)
kable(tab, align="c", digits=2, caption="PC1 foldrise median") %>% 
  column_spec(1:ncol(tab), extra_css = "padding-left:20px; padding-right:20px;") %>% 
  add_header_above(c(" "=1, "Placebo"=ncol(tab1), "Vaccine"=ncol(tab1)))

```

```{r pc1 auc}

pc1_auc = function(endpoint, PPAI.only, trt) {
  tab = mysapply (c("B","Day28","Delta28overB"), function (t) {
    sapply(panels[1:4], function(p) {
      dat.tmp = subset(dat_proc_202, Trt == trt & PPAI %in% c(1, if(!PPAI.only) 0))
      fastauc(dat.tmp[[glue("{t}{p}_PC1")]], dat.tmp[[endpoint]]) 
    })
  })
  
  tab=t(tab)
  colnames(tab)=c("Baseline", "Day 28", "Foldrise")
  rownames(tab)=panel_names[1:4]
  
  tab
}

tab1=pc1_auc (endpoint="EventIndC9_11_14", PPAI.only=T, trt="BPZE1")
tab2=pc1_auc (endpoint="EventIndC9_11_14", PPAI.only=T, trt="PBO")
tab=cbind(tab2, tab1)
kable(tab, align="c", digits=2) %>% 
  column_spec(1:ncol(tab), extra_css = "padding-left:20px; padding-right:20px;") %>% 
  add_header_above(c(" "=1, "Placebo"=3, "Vaccine"=3))

```

```{r pc1 wilcox by time}

pc1_wilcox = function(PPAI.only, trt) {
  tab = sapply(panels[1:4], function(p) {
    dat.tmp = subset(dat_proc_202, Trt == trt & PPAI %in% c(1, if(!PPAI.only) 0))
    sapply(c("PC1",antigens), function(a) {
      tmp= glue(if (a=="PC1") "{p}_PC1" else "{a}_{p}")
      out=wilcox_test_quiet(dat.tmp[[glue("Day28{tmp}")]], dat.tmp[[glue("B{tmp}")]], paired=T)
      out$p.value
    })
  })
  tab
}

tab1=pc1_wilcox (PPAI.only=T, trt="BPZE1")
tab2=pc1_wilcox (PPAI.only=T, trt="PBO")
tab=cbind(PBO=tab2, BPZE1=tab1)
kable(formatPvalues(tab), align="c", caption="PC1 Wilcox test between baseline and Day 28.") %>%
  kable_styling(latex_options = "scale_down") 

```

```{r pc1 wilcox by case non-case}

pc1_wilcox = function(endpoint, PPAI.only, trt) {
  tab = mysapply (c("B","Day28","Delta28overB"), function (t) {
    sapply(panels[1:4], function(p) {
      out=wilcox_test_quiet(as.formula(glue("{t}{p}_PC1 ~ {endpoint}")), data  = subset(dat_proc_202, Trt == trt & PPAI %in% c(1, if(!PPAI.only) 0)))
      out$p.value
    })
  })
  
  tab=t(tab)
  colnames(tab)=c("Baseline", "Day 28", "Foldrise")
  rownames(tab)=panel_names[1:4]
  
  tab
}

tab1=pc1_wilcox (endpoint="EventIndC9_11_14", PPAI.only=T, trt="BPZE1")
tab2=pc1_wilcox (endpoint="EventIndC9_11_14", PPAI.only=T, trt="PBO")
tab=cbind(tab2, tab1)
kable(tab, align="c", digits=2) %>% 
  column_spec(1:ncol(tab), extra_css = "padding-left:20px; padding-right:20px;") %>% 
  add_header_above(c(" "=1, "Placebo"=3, "Vaccine"=3))

```

```{r pc1 boxplots ppai prim, fig.show='hold'}

png("../output/iliad_ib202p/C0iliad_ib202p_PPAI/ppai_pc1_boxplots.png", width=9, height=15, units="in", res=300)

par(mfrow=c(4,3), mar = c(5,2,4,2))

dat = subset(dat_proc_202, PPAI==1)

for (p in panels[1:4]){

  ylim =range(dat[[glue("B{p}_PC1")]], dat[[glue("Day28{p}_PC1")]])
  ylim1=range(dat[[glue("Delta28overB{p}_PC1")]])
  
  # make ylim1 and ylim have the same span
  if (p==panels[1] | p==panels[2]) {
    # ylim1 is bigger than or same as ylim
    ylim=ylim1 
  } else {
    # ylim1 needs to be shifted
    ylim1 = ylim + (ylim1[1] - ylim[1])
  }

  add_sig_bar <- function(x1, x2, ylim, offset=0.05, lwd=2, cex=1.5) {
    x1=x1+0.1
    x2=x2-0.1
    y=ylim[2]-diff(ylim)/20
    segments(x1, y, x2, y, lwd=lwd)
    segments(x1, y, x1, y - offset, lwd=lwd)
    segments(x2, y, x2, y - offset, lwd=lwd)
    text(mean(c(x1, x2)), y + offset, 
         labels = "*", cex=cex)
  }

  myboxplot(as.formula(glue("B{p}_PC1~EventIndC9_11_14 + Trt")), dat, col.points = ifelse(dat$EventIndC9_11_14==1, 2, 4), pch=ifelse(dat$Trt=="PBO", 1, 2), cex=1, col="white", ylim=ylim, ylab="",
            names=c("Non-cases","Cases", "Non-cases","Cases"), 
            main=glue("Baseline {panel_names[which(p==panels)]} PC1"))
  axis(1, at=c(1.5, 3.5), labels=c("Placebo", "Vaccine"), line=2, col="white")
  if (p==panels[1] | p==panels[2]) add_sig_bar(1, 2, ylim)

  myboxplot(as.formula(glue("Day28{p}_PC1~EventIndC9_11_14 + Trt")), dat, col.points = ifelse(dat$EventIndC9_11_14==1, 2, 4), pch=ifelse(dat$Trt=="PBO", 1, 2), cex=1, col="white", ylim=ylim, ylab="",
            names=c("Non-cases","Cases", "Non-cases","Cases"), 
            main=glue("Day 28 {panel_names[which(p==panels)]} PC1"))
  axis(1, at=c(1.5, 3.5), labels=c("Placebo", "Vaccine"), line=2, col="white")
  if (p==panels[1]) add_sig_bar(1, 2, ylim)
  if (p==panels[1] | p==panels[3]) add_sig_bar(3, 4, ylim)
  
  myboxplot(as.formula(glue("Delta28overB{p}_PC1~EventIndC9_11_14 + Trt")), dat, col.points = ifelse(dat$EventIndC9_11_14==1, 2, 4), pch=ifelse(dat$Trt=="PBO", 1, 2), cex=1, col="white", ylim=ylim1, 
            names=c("Non-cases","Cases", "Non-cases","Cases"), ylab="",
            main=glue("Foldrise {panel_names[which(p==panels)]} PC1"))
  axis(1, at=c(1.5, 3.5), labels=c("Placebo", "Vaccine"), line=2, col="white")

}

dev.off()
```
<!-- ![]("output/iliad_ib202p/C0iliad_ib202p_PPAI/ppai_pc1_boxplots.png") -->

```{r,fig.cap="PC1 boxplots by treatment group (PPAI population)"}
knitr::include_graphics(normalizePath("../output/iliad_ib202p/C0iliad_ib202p_PPAI/ppai_pc1_boxplots.png"))
```

```{r pc1 prentice criterion & ve}

prentice.f = function(endpoint, PPAI.only, corner.text, timepoint="Day28") {
  fits = lapply (panels[1:4], function (p) {
    geeglm(as.formula(glue("{endpoint} ~ Trt + {timepoint}{p}_PC1")), data  = subset(dat_proc_202, PPAI %in% c(1, if(!PPAI.only) 0)), family= poisson(link = "log"), id = Ptid, corstr= "independence")
  })
  
  tab = getFormattedSummary(fits, robust="MBN", exp=T, type=9) [-1,]
  colnames(tab)=panels[1:4]
  kable(tab, align="c", col.names = NULL, caption="Prentice criterion. "%.% escape_latex(endpoint) %.% " " %.% ifelse(PPAI.only, "PPAI", "PP")) %>% 
    column_spec(1:ncol(tab), extra_css = "padding-left:20px; padding-right:20px;") %>% 
    add_header_above(c(setNames(1, corner.text), setNames(rep(1,ncol(tab)), colnames(tab)))) # add text in corner cell
}

prentice.f(PPAI.only=T, endpoint="EventIndC9_11_14", corner.text="PPAI prim")
prentice.f(PPAI.only=T, endpoint="EventIndC14", corner.text="PPAI alt")
prentice.f(PPAI.only=F, endpoint="EventIndC9_11_14", corner.text="PP prim")
prentice.f(PPAI.only=F, endpoint="EventIndC14", corner.text="PP alt")
prentice.f(PPAI.only=T, endpoint="EventIndC9_11_14", corner.text="PPAI prim", timepoint="B")


tab = getFormattedSummary(list(
  geeglm(EventIndC9_11_14 ~ Trt, data  = subset(dat_proc_202, PPAI==1), family= poisson(link = "log"), id = Ptid, corstr= "independence"),
  geeglm(EventIndC14 ~ Trt,      data  = subset(dat_proc_202, PPAI==1), family= poisson(link = "log"), id = Ptid, corstr= "independence"),
  geeglm(EventIndC9_11_14 ~ Trt, data  = subset(dat_proc_202), family= poisson(link = "log"), id = Ptid, corstr= "independence"),
  geeglm(EventIndC14 ~ Trt,      data  = subset(dat_proc_202), family= poisson(link = "log"), id = Ptid, corstr= "independence")
), robust="MBN", exp=T, type=9)[-1,,drop=F]
colnames(tab)=c("PPAI prim", "PPAI alt", "PP prim", "PP alt")
tab=t(tab)
kable(tab, align="c", caption="No marker.") %>% column_spec(1:ncol(tab), extra_css = "padding-left:20px; padding-right:20px;") 

```





\clearpage
# Individual markers


```{r wilcox}

marker_wilcox = function(endpoint, PPAI.only, trt, panel) {
  tab = mysapply (c("B","Day28","Delta28overB"), function (t) {
    sapply(antigens, function(a) {
      # print(as.formula(glue("{t}{a}_{panel} ~ {endpoint}")))
      out=wilcox_test_quiet(as.formula(glue("{t}{a}_{panel} ~ {endpoint}")), data  = subset(dat_proc_202, Trt == trt & PPAI %in% c(1, if(!PPAI.only) 0)))
      out$p.value
    })
  })
  
  tab=t(tab)
  colnames(tab)=c("Baseline", "Day 28", "Foldrise")

  tab
}

tab1=marker_wilcox (endpoint="EventIndC9_11_14", PPAI.only=T, panel="Serum_IgG", trt="BPZE1")
tab2=marker_wilcox (endpoint="EventIndC9_11_14", PPAI.only=T, panel="Serum_IgG", trt="PBO")
tab=cbind(tab2, tab1)
kable(tab, align="c", digits=2) %>% 
  column_spec(1:ncol(tab), extra_css = "padding-left:20px; padding-right:20px;") %>% 
  add_header_above(c(" "=1, "Placebo"=3, "Vaccine"=3))

```


```{r marker boxplots ppai prim, fig.show='hold'} 

dat = subset(dat_proc_202, PPAI==1)

select_markers = "FHA_Norm_Nasal_IgA"

# select_markers = c("WCE_Norm_Nasal_IgA", 
#   "FHA_Norm_Nasal_IgA",
#   "WCE_Serum_IgA",
#   "FHA_Serum_IgG",
#   "PT_Serum_IgG"
# )

marker_names = c(FHA_Norm_Nasal_IgA="N-sIgA FHA")

# if needed, fig.height is defined dynamically
# knitr::opts_current$set(fig.height = 6.5 /4 * len(select_markers))

png("../output/iliad_ib202p/C0iliad_ib202p_PPAI/ppai_marker_boxplots.png", width=9, height=15/4*len(select_markers), units="in", res=300)

par(mfrow=c(len(select_markers),3), mar = c(5,2,4,2))

for (a in select_markers){

  ylim =range(dat[[glue("B{a}")]], dat[[glue("Day28{a}")]])
  ylim1=range(dat[[glue("Delta28overB{a}")]])
  
  # # make ylim1 and ylim have the same span
  # if (p==panels[1] | p==panels[2]) {
  #   # ylim1 is bigger than or same as ylim
  #   ylim=ylim1 
  # } else {
  #   # ylim1 needs to be shifted
  #   ylim1 = ylim + (ylim1[1] - ylim[1])
  # }

  add_sig_bar <- function(x1, x2, ylim, offset=0.05, lwd=2, cex=1.5) {
    x1=x1+0.1
    x2=x2-0.1
    y=ylim[2]-diff(ylim)/20
    segments(x1, y, x2, y, lwd=lwd)
    segments(x1, y, x1, y - offset, lwd=lwd)
    segments(x2, y, x2, y - offset, lwd=lwd)
    text(mean(c(x1, x2)), y + offset, 
         labels = "*", cex=cex)
  }

  myboxplot(as.formula(glue("B{a}~EventIndC9_11_14 + Trt")), dat, col.points = ifelse(dat$EventIndC9_11_14==1, 2, 4), pch=ifelse(dat$Trt=="PBO", 1, 2), cex=1, col="white", ylim=ylim, ylab="",
            names=c("Non-cases","Cases", "Non-cases","Cases"), 
            main=glue("Baseline {marker_names[a]}"))
  axis(1, at=c(1.5, 3.5), labels=c("Placebo", "Vaccine"), line=2, col="white")
  if (a=="FHA_Norm_Nasal_IgA") add_sig_bar(1, 2, ylim)

  myboxplot(as.formula(glue("Day28{a}~EventIndC9_11_14 + Trt")), dat, col.points = ifelse(dat$EventIndC9_11_14==1, 2, 4), pch=ifelse(dat$Trt=="PBO", 1, 2), cex=1, col="white", ylim=ylim, ylab="",
            names=c("Non-cases","Cases", "Non-cases","Cases"), 
            main=glue("Day 28 {marker_names[a]}"))
  axis(1, at=c(1.5, 3.5), labels=c("Placebo", "Vaccine"), line=2, col="white")
  if (a=="FHA_Norm_Nasal_IgA") add_sig_bar(1, 2, ylim)
  if (a=="FHA_Norm_Nasal_IgA") add_sig_bar(3, 4, ylim)
  
  myboxplot(as.formula(glue("Delta28overB{a}~EventIndC9_11_14 + Trt")), dat, col.points = ifelse(dat$EventIndC9_11_14==1, 2, 4), pch=ifelse(dat$Trt=="PBO", 1, 2), cex=1, col="white", ylim=ylim1, 
            names=c("Non-cases","Cases", "Non-cases","Cases"), ylab="",
            main=glue("Foldrise {marker_names[a]}"))
  axis(1, at=c(1.5, 3.5), labels=c("Placebo", "Vaccine"), line=2, col="white")

}

dev.off()
```
<!-- ![]("output/iliad_ib202p/ppai_pc1_boxplots.png") -->

```{r fig.cap="Individual marker boxplots by treatment group (PPAI population)", out.width="\\textwidth", fig.align="center"}
knitr::include_graphics(normalizePath("../output/iliad_ib202p/C0iliad_ib202p_PPAI/ppai_marker_boxplots.png"))
```

```{r marker prentice criterion}

PPAI.only=T
endpoint="EventIndC9_11_14"
timepoint="Day28"

aa=c("Norm_Nasal_IgA_PC1", "FHA_Norm_Nasal_IgA")
names(aa) = c("Day 28 N-sIgA PC1", "Day 28 N-sIgA FHA")

fit = geeglm(as.formula(glue("{endpoint} ~ Trt")), data  = subset(dat_proc_202, PPAI %in% c(1, if(!PPAI.only) 0)), family= poisson(link = "log"), id = Ptid, corstr= "independence")

fits = lapply (aa, function (a) {
  geeglm(as.formula(glue("{endpoint} ~ Trt + {timepoint}{a}")), data  = subset(dat_proc_202, PPAI %in% c(1, if(!PPAI.only) 0)), family= poisson(link = "log"), id = Ptid, corstr= "independence")
})

tab = getFormattedSummary(c(list(fit), fits), robust="MBN", exp=T, type=9) 
# remove intercept
tab = tab[-1,]
# combine last two rows
tab[2,3] = tab[3,3]
tab = tab[1:2, ]

tab=t(tab)
colnames(tab) = c("BPZE1 vs PBO", "Marker")
rownames(tab)[1] = c("No marker")

kable(tab, align="c") %>% 
  column_spec(1:ncol(tab), extra_css = "padding-left:20px; padding-right:20px;") 
```
