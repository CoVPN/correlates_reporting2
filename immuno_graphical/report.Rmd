---
output:
pdf_document: default
html_document: default

---
# Graphical Description of Immunogenicity Data {#immuno-graphical}
    
```{r immuno-graphical-setup, echo = FALSE, message = FALSE, include=FALSE}
library(here)
library(latex2exp)
library(knitr)
library(stringr) # str_extract

here::i_am("immuno_graphical/report.Rmd")

if (study_name == "NextGen_Mock") {
    trt.labels <- c("Comparator Vaccine", "Investigational Vaccine")
    trt.labels.2 <- c("comparator_vaccine", "investigational_vaccine")
} else {
    trt.labels <- c("Placebo", "Vaccine")
    trt.labels.2 <- c("placebo", "vaccine")
}
if (!study_name %in% c("VAT08", "NextGen_Mock")){
    bstatus.labels <- c("Baseline Neg", "Baseline Pos")
    bstatus.labels.2 <- c("BaselineNeg", "BaselinePos")
    bstatus.labels.3 <- c("baseline negative", "baseline positive")
} else {
    bstatus.labels <- c("Naive", "Non-naive")
    bstatus.labels.2 <- bstatus.labels.3 <- c("Naive", "Non-naive")
}

# repeat whatever in param.R here
times = c("B", paste0("Day", config$timepoints), paste0("Delta", config$timepoints, "overB"))
if(attr(config,"config")=="janssen_pooled_partA") {
    times_ = c("B","Day29","Delta29overB","Day71"); timepoints_=c(29,71)
    labels.time = c("Day 1", "Day 29","D29 fold-rise over D1", "Day 71"); names(labels.time) = times_
    timepoints_= timepoints
} else if (attr(config,"config")=="prevent19_stage2") {
    times_ = c("Day35","C1","BD1") 
    labels.time = c("Day 35", "Crossover Day 1", "Booster Day 1"); names(labels.time) = times_
    timepoints_= timepoints
} else if (attr(config,"config") == "nextgen_mock") {
    times_ = c("B", "Day31", "Delta31overB", "Day91", "Delta91overB", "Day181", "Delta181overB", "Day366", "Delta366overB")
    labels.time = c("Day 01","Day 31", "D31 fold-rise over D01", "Day 91", "D91 fold-rise over D01", 
                    "Day 181",  "D181 fold-rise over D01", "Day 366",  "D366 fold-rise over D01"); names(labels.time) = times_
    timepoints_= c(timepoints, 91, 181, 366)
} else {times_ = times; timepoints_ = timepoints}

# set time vectors based on times_ and timepoints_
tps_no_delta_over_tinterm <-  times_[!times_ %in% c(paste0("Delta",timepoints_[length(timepoints_)],"over",timepoints_[1]))] #c("B", "Day29", "Delta29overB", "Day57", "Delta57overB")
tps_no_B_and_delta_over_tinterm <-  times_[!times_ %in% c("B",paste0("Delta",timepoints_[length(timepoints_)],"over",timepoints_[1]))] #c("Day29", "Delta29overB", "Day57", "Delta57overB")
tps_no_fold_change <- times_[!grepl("Delta", times_)]
tps_no_B_and_fold_change <- times_[!grepl("Delta", times_) & times_!="B"]
tps_delta_over_B <- times_[grepl("overB",times_)]



if(include_bindN && grepl("bind", assays) && !grepl("bindN", assays) && !grepl("janssen_.+partA.*", attr(config,"config")) && !grepl("vat08|nextgen", attr(config,"config"))){
    assay_immuno <- c(assays, "bindN")
    labels.assays.all <- c("Binding Antibody to N", labels.assays)
    names(labels.assays.all)[1] <- "bindN"
    labels.assays <- labels.assays.all[assay_immuno]
} else {
    assay_immuno <- assays
}

if (study_name == "NextGen_Mock") {
    assays = assays[!grepl("nasal|saliva", assays)]
    assay_immuno = assay_immuno[!grepl("nasal|saliva", assay_immuno)]
    assay_metadata = assay_metadata %>% filter(!grepl("nasal|saliva", assay))
}
```

```{r immuno-graphical-caption-setup, echo = FALSE, message = FALSE, include=FALSE}

is.ensemble <- study_name=="ENSEMBLE" | study_name=="MockENSEMBLE" # only ENSEMBLE has by country and by HIV group figures

config <- config::get(config = Sys.getenv("TRIAL"))
if.pair <- ifelse(length(assays)>1, 1, 0)
if.pos.exist <- 1#ifelse(study_name=="AZD1222", 0, 1)

minority.disclaimer <- switch(study_name, 
                              "COVE"="",
                              "MockCOVE"="",
                              "ENSEMBLE"="These plots are restricted to only United States trial participants.",
                              "MockENSEMBLE"="These plots are restricted to only United States trial participants.",
                              "PREVENT19"="",
                              "AZD1222"="",
                              "VAT08"="",
                              "PROFISCOV"="",
                              "NextGen_Mock"="")

neut.marker.captions <- switch(study_name, 
                               "COVE"="The dashed lines in each figure are ULOQ, LLOQ, and positivity cutoffs for binding antibody assays, or ULOQ, LLOQ, and LLOD for neutralizing antibody assays, from top to bottom respectively.",
                               "MockCOVE"="The dashed lines in each figure are ULOQ, LLOQ, and positivity cutoffs for binding antibody assays, or ULOQ, LLOQ, and LLOD for neutralizing antibody assays, from top to bottom respectively.",
                               "ENSEMBLE"="The dashed lines in each figure are ULOQ and positivity cut-off from top to bottom for binding antibody assays, or ULOQ and LLOQ for neutralizing antibody assays, from top to bottom respectively.",
                               "MockENSEMBLE"="The dashed lines in each figure are ULOQ and positivity cut-off for binding antibody assays, or ULOQ and LLOQ for neutralizing antibody assays, from top to bottom respectively.",
                               #"PREVENT19"="The dashed lines in each figure are ULOQ, positivity cut-off and LLOQ for binding antibody assays, or ULOQ and LLOD for neutralizing antibody assays, from top to bottom respectively.",
                               "PREVENT19"="The dashed lines in each figure are ULOQ and LLOQ for binding antibody assays, or ULOQ and LLOD for neutralizing antibody assays, from top to bottom respectively.",
                               "AZD1222"="The dashed lines in each figure are ULOQ, positivity cut-off and LLOQ for binding antibody assays, or ULOQ and LLOD for neutralizing antibody assays, from top to bottom respectively.",
                               
                               "VAT08"="The dashed lines in each figure are ULOQ and LLOQ for binding antibody assays, or ULOQ and LLOD for neutralizing antibody assays, from top to bottom respectively.",
                               "PROFISCOV"="The dashed lines in each figure are ULOQ, positivity cut-off and LLOD for binding antibody assays, or LLOD/positivity cut-off for neutralizing antibody assays, from top to bottom respectively.",
                               # PROFISCOV nAb has a ULOQ value out of figure limit
                               "NextGen_Mock"="The dashed lines in each figure are ULOQ and LLOQ, from top to bottom respectively.")

immuno_postfix_label = switch(study_name, 
                              "VAT08"=" (Stage2)",
                              " " # default value
)

```

\clearpage
## Pairs plots of antibody markers for RIS or RIS-PBMC cohort

```{r, echo=FALSE, results='asis'}
## Pairs plots of antibody markers for overall per-protocal cohort

for (bsero in bstatus.labels.2) {
    
    bseroLabel <- bstatus.labels.3[match(bsero, bstatus.labels.2)]
    
    for (trt in c(trt.labels.2[2:1], if(study_name=="VAT08") "pooled")) {  
        
        if (study_name!="VAT08" && trt==trt.labels.2[1] && bsero==bstatus.labels.2[1]) next # only report for placebo baseline neg for VAT08
        if (attr(config,"config") %in% c("janssen_partA_VL","prevent19_stage2") && !(trt=="vaccine" && bsero==bstatus.labels.2[1])) next # only report for vaccine baseline neg for janssan_partA_VL
        
        for (country in c("Nvx_US_Mex", if(attr(config,"config")=="prevent19") "Nvx_US")){
            # only doable when there are >1 assays
            if (if.pair==1){
                
                for(tp in times_[!times_ %in% c(paste0("Delta",timepoints_[length(timepoints_)],"over",timepoints_[1]))]) {
                    
                    if (study_name == "NextGen_Mock") next # no single timepoint plot for NextGen
                    if (study_name=="VAT08" && grepl("Delta", tp)) next # do not report delta timepoints for VAT08
                    if (study_name=="VAT08" && trt=="pooled" && tp!="B") next # only report pooled at baseline for VAT08
                    if (attr(config,"config")=="janssen_partA_VL" && !grepl("Day", tp)) next # only report peak timepoint for janssen_partA_VL
                    
                    for (reg in if (attr(config,"config")=="janssen_partA_VL") {c("LATAM_","ZA_")} else {""}) {
                        
                        for (ab in if (attr(config,"config")=="janssen_partA_VL") {c("bAb_","nAb_","",
                                                                                     "Reference_","Mu_","Gamma_","Lambda_",
                                                                                     "Delta_","Beta_")
                        } else if (attr(config,"config")=="vat08_combined") {c("bAb_","nAb_", "")
                        } else {""}) {
                            
                            if (ab %in% c("Mu_","Gamma_","Lambda_") & reg == "ZA_") next # no these plots
                            if (ab %in% c("Delta_","Beta_") & reg == "LATAM_") next # no these plots
                            
                            tpLabel <- gsub("ay ", "", labels.time[tp])
                            regLabel <- case_when(reg=="LATAM_" ~ "Latin America",
                                                  reg=="ZA_" ~ "Southern Africa",
                                                  TRUE ~ "")
                            abLabel <- case_when(ab=="bAb_" ~ "bAb",
                                                 ab=="nAb_" ~ "nAb",
                                                 ab=="" ~ "Ab",
                                                 TRUE ~ paste0("bAb ", gsub("_", "", ab), " and nAb ", gsub("_", "", ab))
                            )
                            
                            res = knitr::knit_child(c(here::here('immuno_graphical', 'report_pair_by_time.Rmd')), quiet = TRUE)
                            cat(res, sep = '\n')
                            cat("\\clearpage", sep = '\n')
                        }
                    }
                    
                }
            }
            
            for (asy in assay_immuno){
                
                for (times_index in c("", if (study_name == "NextGen_Mock") "_2")){
                    
                    if (study_name == "NextGen_Mock" & bsero == bstatus.labels.2[1]) next # no naive for NextGen_Mock
                    
                    if (study_name=="VAT08" && trt=="pooled") next # do not report "pooled" for across timepoint plots
                    #if (study_name=="VAT08" && asy=="pseudoneutid50_mdw" && bsero=="naive") next # psv_mdw doesn't have any value for naive at baseline
                    if (attr(config,"config") %in% c("janssen_partA_VL")) next # no figure for janssen_partA_VL
                    
                    asyLabel <- gsub("%","\\\\%", labels.assays[asy])
                    
                    times_selected <- if(study_name=="VAT08") {list(tps_no_delta_over_tinterm[c(1,4,5)])
                        # "B", "Day22", "Day43", "Day22overB", "Day43overB", only show B and fold_change for Sanofi study
                    } else if (study_name == "NextGen_Mock") {list(
                        tps_no_delta_over_tinterm[c(1,2,6)], # "B", "Day31", "Day181"
                        tps_no_delta_over_tinterm[c(3,7)] # "Delta31overB", "Delta181overB"
                    ) 
                    } else {list(tps_no_fold_change)}
                    
                    #immuno_postfix_label <- case_when(
                    #    study_name == "NextGen_Mock" & grepl("T4|T8", asy) & !grepl("bind|pseudo", asy) ~ " (RIS-PBMC cohort)",
                    #    study_name == "NextGen_Mock" & !grepl("T4|T8", asy) & grepl("bind|pseudo", asy) ~ " (RIS cohort)",
                        #study_name == "NextGen_Mock" & !grepl("T4|T8", asy) & grepl("bind", asy) ~ " (RIS or RIS-PBMC cohort)",
                    #    TRUE ~ immuno_postfix_label)
                    bseroLabel <- ifelse(study_name == "NextGen_Mock", "", bseroLabel)
                    res = knitr::knit_child(c(here::here('immuno_graphical', 'report_pair_by_assay.Rmd')), quiet = TRUE)
                    cat(res, sep = '\n')
                    cat("\\clearpage", sep = '\n')
                    
                }
            }
            
        }
    }
}

```

\clearpage
## RCDF plots of antibody markers for RIS or RIS-PBMC cohort
```{r, echo=FALSE, results='asis'}
## RCDF plots of antibody markers for overall per-protocol cohort

if (attr(config,"config") %in% c("vat08_combined","prevent19_stage2")){
    for (tp in tps_no_fold_change){
        
        tp_lb = ifelse(tp=="B", "Day1", tp)
        
        res = knitr::knit_child(c(here::here('immuno_graphical', 'report_rcdf_all.Rmd')), quiet = TRUE)
        cat(res, sep = '\n')
        cat("\\clearpage", sep = '\n')
    }
}

 for(tp in if (study_name == "NextGen_Mock") {c(paste0(tps_no_fold_change, "_initial"), paste0(tps_no_fold_change[c(1,2,4)], "_final"))} else {times_[!times_ %in% c("B",paste0("Delta",timepoints_[length(timepoints_)],"over",timepoints_[1]))]}) {

    for (trt in c("trt_both", paste0("trt_", trt.labels.2[2]), if (study_name %in% c("VAT08", "NextGen_Mock")) paste0("trt_", trt.labels.2[1]))){
        
        if (attr(config,"config")=="prevent19_stage2") next # no these figures for prevent19_stage2
        
        trtLabel <- ifelse(trt=="trt_both", "x randomization arm", paste0(gsub("_", " ", gsub("trt_","", trt)), " arm"))
        
        for (bsero in c("bstatus_both", "bstatus_Neg", "bstatus_Pos")){
            if (bsero=="bstatus_Pos" && if.pos.exist==0) next
            if (bsero != "bstatus_both" & study_name == "NextGen_Mock") next # NextGen_Mock only have bstatus_both plot which only contains non-naive 
            if (trt=="trt_both" && bsero!="bstatus_both" && study_name!="VAT08") next # trt_both is only for bstatus both if the study is VAT08
            if (attr(config,"config")=="janssen_partA_VL" && !(trt==paste0("trt_", trt.labels.2[2]) && bsero=="bstatus_Neg")) next # only report for vaccine baseline neg for janssan_partA_VL
            
            bseroLabel <- ifelse(bsero=="bstatus_both", "by serostatus", ifelse(bsero=="bstatus_Neg", bstatus.labels.3[1], bstatus.labels.3[2]))
        
       
            
            if (study_name %in% c("VAT08") && grepl("Delta", tp)) next # only report main timepoints for VAT08
            if (attr(config,"config")=="janssen_partA_VL" && !grepl("Day", tp)) next # only report peak timepoint for janssen_partA_VL
            
            tpLabel <- gsub("ay ", "", labels.time[gsub("_initial|_final", "", tp)])
            
            for (asy in if(study_name=="VAT08" | attr(config,"config")=="janssen_partA_VL") {c("bAb","nAb")
            } else if (study_name == "NextGen_Mock") {c("bAb_sera", "nAb_sera", "ics")
            } else {c("","bAb","nAb","other")}){ # for VAT08 and janssen_partA_VL, only report for bAb and nAb
                if ( (sum(grepl("bind", assays))==0 & asy=="bAb") | (sum(grepl("neut", assays))==0 & asy=="nAb") | (sum(grepl("ADCP", assays))==0 & asy=="other")) next
                if (asy=="" & (trt!="trt_both" | bsero!="bstatus_both")) next  # trt_both & bstatus_both are only for all assays
                if (asy!="" & trt=="trt_both" & bsero=="bstatus_both") next  # assay subset do not report for trt_both & bstatus_both
                if (study_name=="VAT08" && trt!="trt_both" && bsero!="bstatus_both") next # for VAT08, only report plots with one "both"
                
                
                for (reg in if (attr(config,"config")=="janssen_partA_VL") {c("LATAM_","ZA_")} else {""}) {
                    
                    regLabel <- case_when(reg=="LATAM_" ~ "Latin America",
                                          reg=="ZA_" ~ "Southern Africa",
                                          TRUE ~ "")
                    
                    #immuno_postfix_label <- case_when(
                    #    study_name == "NextGen_Mock" & tp %in% c("Day91", "Day366") ~ " (Track A RIS-PBMC cohort)",
                    #    study_name == "NextGen_Mock" & asy %in% c("bAb", "nAb") ~ " (RIS cohort)",
                    #    study_name == "NextGen_Mock" & asy == "ics" ~ " (RIS-PBMC cohort)",
                    #    TRUE ~ immuno_postfix_label)
                    bseroLabel <- ifelse(study_name == "NextGen_Mock", "", bseroLabel)
                    res = knitr::knit_child(c(here::here('immuno_graphical', 'report_rcdf.Rmd')), quiet = TRUE)
                    cat(res, sep = '\n')
                    cat("\\clearpage", sep = '\n')
                }
            }
        }
    }
}
```


\clearpage
<!-- ## Violin plots of antibody markers for overall per-protocol cohort -->
    ```{r, echo=FALSE, results='asis'}
if (attr(config,"config")=="janssen_partA_VL"){
    
    for (ab in c("bAb","nAb")){
        for (reg in c("LATAM","ZA")){
            
            regLabel <- case_when(reg=="LATAM" ~ "Latin America",
                                  reg=="ZA" ~ "Southern Africa",
                                  TRUE ~ "")
            
            res = knitr::knit_child(c(here::here('immuno_graphical', 'report_violin.Rmd')), quiet = TRUE)
            cat(res, sep = '\n')
            cat("\\clearpage", sep = '\n')
        }
    }
}
```

\clearpage
<!-- ## Scatter plots of antibody markers versus age for overall per-protocol cohort -->
    
    ```{r, echo=FALSE, results='asis'}

if (!study_name  %in% c("VAT08", "NextGen_Mock")) { # VAT08 and NextGen_Mock don't report this
    for (bsero in bstatus.labels.2){
        
        bseroLabel <- gsub("baseline ", "", bstatus.labels.3[match(bsero, bstatus.labels.2)])
        
        for (trt in c("Vaccine", "Placebo")){
            
            trtLabel = tolower(trt)
            
            for(tp in times[!grepl("Delta", times)]) {
                
                tpLabel <- gsub("ay ", "", labels.time[tp])
                
                res = knitr::knit_child(c(here::here('immuno_graphical', 'report_scatter.Rmd')), quiet = TRUE)
                cat(res, sep = '\n')
                cat("\\clearpage", sep = '\n')
            }
        }
    }
}

```


## Box plots of antibody markers for RIS or RIS-PBMC cohort

```{r, echo=FALSE, results='asis'}
## Box plots of antibody markers for overall per-protocol cohort

### Vaccine vs. Placebo (2 arms x 1 baseline status in each plot)
### (VAT08) Baseline neg/pos vs. vaccine/placebo (2 arms x 2 baseline statuses in each plot)
### (VAT08) Baseline neg/pos vs. vaccine/placebo vs. female/male (2 arms x 2 baseline statuses x 2 gender in each plot)

for (bsero in c(bstatus.labels.2, if(study_name=="VAT08") c("bstatus"#, "bstatus_gender"
) )) { # only VAT08 report 2 extra kind of plots
    
    if (attr(config,"config")=="NextGen_Mock" & bsero==bstatus.labels.2[1]) next # NextGen_Mock only has non-naive
    if (attr(config,"config")=="janssen_partA_VL") next # janssen_partA_VL do not report this
    if (attr(config,"config")=="prevent19_stage2" & bsero==bstatus.labels.2[2]) next # prevent19_stage2 only has baseline neg
    
    bseroLabel <- c(bstatus.labels.3, if(study_name=="VAT08") c("naive + non-naive", "naive + non-naive") )[match(bsero, c(bstatus.labels.2, if(study_name=="VAT08") c("bstatus"#, "bstatus_gender"
    )))]
    
    if (bsero=="bstatus_gender") {gender_lb = " females + males"
    } else {gender_lb=""}
    
    for(tp in times_[!times_ %in% c(paste0("Delta",timepoints_[length(timepoints_)],"over",timepoints_[1]))]) {
        
        for (pn in if (study_name != "NextGen_Mock") {""} else {unique(assay_metadata$panel)}) {
        
        if (study_name %in% c("VAT08", "NextGen_Mock") && grepl("Delta", tp)) next # only report main timepoints for VAT08, NextGen_Mock
        if (study_name == "NextGen_Mock" & bsero == bstatus.labels.2[1]) next # NextGen_Mock doesn't have naive ppts
        
        tpLabel <- gsub("ay ", "", labels.time[tp])
        
        immuno_postfix_label <- ifelse(study_name == "NextGen_Mock" & tp %in% c("B", "Day31", "Day181"), " (RIS or RIS-PBMC cohort)",
                                       ifelse(study_name == "NextGen_Mock" & tp %in% c("Day91", "Day366"), " (Track A RIS-PBMC cohort)",
                                              immuno_postfix_label)) 
        bseroLabel <- ifelse(study_name == "NextGen_Mock", "", bseroLabel)
        res = knitr::knit_child(c(here::here('immuno_graphical', 'report_box.Rmd')), quiet = TRUE)
        cat(res, sep = '\n')
        cat("\\clearpage", sep = '\n')
        }
    }
}

### Baseline negative vs. positive (2 baseline statuses x 1 arm in each plot)

for (trt in c("vaccine_arm","placebo_arm")) {
    
    if (attr(config,"config") %in% c("janssen_partA_VL", "prevent19_stage2", "nextgen_mock")) next # nextgen_mock, janssen_partA_VL and prevent19_stage2 do not report this
    
    for(tp in times[!times %in% c(paste0("Delta",timepoints[length(timepoints)],"over",timepoints[1]))]) {
        
        if (study_name=="VAT08" && grepl("Delta", tp)) next # only report main timepoints for VAT08
        
        tpLabel <- gsub("ay ", "", labels.time[tp])
        
        res = knitr::knit_child(c(here::here('immuno_graphical', 'report_box_neg_vs_pos.Rmd')), quiet = TRUE)
        cat(res, sep = '\n')
        cat("\\clearpage", sep = '\n')
    }
}

```


<!-- ## Spaghetti plots of antibody markers over time for overall per-protocol cohort -->
    
    ```{r, fig.cap = paste0("Spaghetti plots of Ab markers over time: baseline negative vaccine + placebo arm"), eval = any(c("B", paste0("Day",timepoints[1]), "Day57") %in% times & study_name!="VAT08" & study_name!="ENSEMBLE" & study_name!="PREVENT19" & study_name!="NextGen_Mock")}
include_graphics(here(
    "immuno_graphical", "output", attr(config,"config"), 
    paste0("spaghetti_plot_BaselineNeg_", study_name, ".pdf")
))
```


```{r, fig.cap = paste0("Spaghetti plots of Ab markers over time: baseline positive vaccine + placebo arm"), eval = any(c("B", paste0("Day",timepoints[1]), "Day57") %in% times & if.pos.exist==1 & study_name!="VAT08" & study_name!="ENSEMBLE" & study_name!="PREVENT19" & study_name!="NextGen_Mock")}
include_graphics(here(
    "immuno_graphical", "output", attr(config,"config"),
    paste0("spaghetti_plot_BaselinePos_", study_name, ".pdf")
))
```

<!-- ## RCDF plots of antibody markers by demographics for per-protocol cohort -->
    
    ```{r, echo=FALSE, results='asis'}

if_no_minority = attr(config,"config") %in% c("janssen_la_partA","janssen_sa_partA",
                                              "janssen_la_partAsenior","janssen_la_partAnonsenior",
                                              "janssen_sa_partAnonsenior")
demos <- c("age_group","risk_group","age_risk_group","sex_group","age_sex_group","ethnicity","race",if(!if_no_minority)c("minority_group","age_minority_group"),if(study_name=="ENSEMBLE")"country", if(study_name=="ENSEMBLE")"hiv_group")

demoLabels <- c("age groups","high-risk condition","age and high-risk condition","sex assigned at birth","age and sex assgined at birth","ethnicity","race",if(!if_no_minority)c("dichotomous classification of
race and ethnic group","age and dichotomous classification of
race and ethnic group"),if(study_name=="ENSEMBLE")"country of residence", if(study_name=="ENSEMBLE")"HIV
positivity")
names(demoLabels) <- demos

if (!study_name %in% c("VAT08", "NextGen_Mock")) {
    for (bsero in c("BaselineNeg", if (if.pos.exist==1) "BaselinePos")){
        
        for (trt in c("Vaccine", "Placebo")){
            bseroLabel <- ifelse(bsero=="BaselineNeg", "negative", "positive")
            trtLabel=tolower(trt)
            
            if (trt=="Placebo" && bsero=="BaselineNeg") next # do not report Negative Placebo Arm
            
            for (dm in demos){
                for(tp in times[!times %in% c("B",paste0("Delta",timepoints[length(timepoints)],"over",timepoints[1]))]) {
                    
                    tpLabel <- gsub("ay ", "", labels.time[tp])
                    dmLabel <- demoLabels[dm]
                    
                    res = knitr::knit_child(c(here::here('immuno_graphical', 'report_rcdf_demographic.Rmd')), quiet = TRUE)
                    cat(res, sep = '\n')
                    cat("\\clearpage", sep = '\n')
                }
            }
        }
    }
}

```

<!-- ## Boxplots of antibody markers by demographics for per-protocol cohort -->
    
    ```{r, echo=FALSE, results='asis'}

if_no_minority = attr(config,"config") %in% c("janssen_la_partA","janssen_sa_partA",
                                              "janssen_la_partAsenior","janssen_la_partAnonsenior",
                                              "janssen_sa_partAnonsenior")
demos <- c("age_group","risk_group","age_x_risk_group","sex","age_x_sex_group","ethnicity","race",if(!if_no_minority)c("minority_group","age_x_minority"),if(study_name=="ENSEMBLE")"country", if(study_name=="ENSEMBLE")"hiv_group")

demoLabels <- c("age groups","high-risk condition","age and high-risk condition","sex assigned at birth","age and sex assgined at birth","ethnicity","race",if(!if_no_minority)c("dichotomous classification of
race and ethnic group","age and dichotomous classification of
race and ethnic group"),if(study_name=="ENSEMBLE")"country of residence", if(study_name=="ENSEMBLE")"HIV
positivity")
names(demoLabels) <- demos

if (!study_name %in% c("VAT08", "NextGen_Mock")) {
    for (bsero in c("BaselineNeg", if (if.pos.exist==1) "BaselinePos")){
        
        for (trt in c("Vaccine", "Placebo")){
            bseroLabel <- ifelse(bsero=="BaselineNeg", "negative", "positive")
            trtLabel=tolower(trt)
            
            if (trt=="Placebo" && bsero=="BaselineNeg") next # do not report Negative Placebo Arm
            
            for (dm in demos){
                for(tp in times[!times %in% c("B",paste0("Delta",timepoints[length(timepoints)],"over",timepoints[1]))]) {
                    
                    tpLabel <- gsub("ay ", "", labels.time[tp])
                    dmLabel <- demoLabels[dm]
                    
                    res = knitr::knit_child(c(here::here('immuno_graphical', 'report_box_demographic.Rmd')), quiet = TRUE)
                    cat(res, sep = '\n')
                    cat("\\clearpage", sep = '\n')
                }
            }
        }
    }
}


```


<!-- ## Spaghetti plots of antibody markers over time for overall per-protocol cohort -->
    ```{r, echo=FALSE, results='asis'}
if (attr(config,"config")=="janssen_partA_VL"){
    for (ind in c(1:4)){
        
        res = knitr::knit_child(c(here::here('immuno_graphical', 'report_spaghetti.Rmd')), quiet = TRUE)
        cat(res, sep = '\n')
        cat("\\clearpage", sep = '\n')
    }
}
```

## Spider plot of antibody markers for RIS or RIS-PBMC cohort
```{r, echo=FALSE, results='asis'}
## Spider plot of antibody markers for overall per-protocol cohort

if(study_name %in% c("VAT08", "NextGen_Mock") | attr(config,"config")=="janssen_partA_VL"){
    for (tp in #if(study_name=="VAT08") {c("Day", "Delta")} else {
         c(if(attr(config,"config") != "nextgen_mock") "Day", 
           if(attr(config,"config") == "nextgen_mock") "Day initial", # "Day91", "Day366" Track A
           if(attr(config,"config") == "nextgen_mock") "Day whole" # "B", "Day31", "Day181" whole
           #, if (attr(config,"config")!="janssen_partA_VL") "Delta"
         )#}
    ) {
        
        for (asy in c("bAb" ,"nAb", if (study_name == "NextGen_Mock") "ics")){
            if (study_name == "NextGen_Mock" & tp %in% c("Day whole", "Day initial") & asy == "ics") next # do not have these plots
            
            for (bsero in bstatus.labels.2) {
                if (study_name == "NextGen_Mock" & bsero == bstatus.labels.2[1]) next # NextGen_Mock only has non-naive
                
                for (trt in trt.labels.2[2:1]) {
                    
                    for (reg in if(attr(config,"config")=="janssen_partA_VL") {c("LATAM_","ZA_")} else {""}){
                        
                        if (attr(config,"config")=="janssen_partA_VL" & (trt=="placebo" | bsero=="Pos")) next
                        
                        tpLabel <- case_when(tp == "Day" ~ paste0("Day 01, ", paste0("Day ", timepoints_,  collapse = ", ")), 
                                             tp == "Delta" ~"fold-rise", 
                                             tp == "Day initial" ~ "Day 01, Day 31, Day 91, Day 181 and D366",
                                             tp == "Day whole" ~ "Day 01, Day 31 and Day 181",
                                             TRUE ~ paste0("Day ", timepoints_,  collapse = ", "))
                        
                        regLabel <- case_when(reg=="LATAM_" ~ "Latin America",
                                              reg=="ZA_" ~ "Southern Africa",
                                              TRUE ~ "")
                        baseLabel <- case_when(bsero=="Neg" ~ bstatus.labels.3[1],
                                               bsero=="Pos" ~ bstatus.labels.3[2],
                                               TRUE ~ "")
                        
                        #immuno_postfix_label <- case_when(
                        #    study_name == "NextGen_Mock" & tp %in% c("Day initial") ~ " (Track A RIS-PBMC cohort)",
                        #    study_name == "NextGen_Mock" & asy %in% c("bAb", "nAb") ~ " (RIS cohort)",
                        #    study_name == "NextGen_Mock" & asy == "ics" ~ " (RIS-PBMC cohort)",
                        #    TRUE ~ immuno_postfix_label)
                        res = knitr::knit_child(c(here::here('immuno_graphical', 'report_spider.Rmd')), quiet = TRUE)
                        cat(res, sep = '\n')
                        cat("\\clearpage", sep = '\n')
                    }
                }
            }
        }
    }
}
```


\clearpage
## Set 1 plots: D01, D31, D91, D181, D366 Ab distributions
```{r, echo=FALSE, results='asis', eval=study_name %in% c("VAT08", "NextGen_Mock")}

for (a in if (study_name == "NextGen_Mock") {c("IgG", "pseudoneutid50_sera", "T4", "T8")
} else {c("bindSpike","pseudoneutid50")}){
    
    for (tp in if (study_name == "NextGen_Mock") {tps_no_fold_change} else {tps_no_delta_over_tinterm}){
        
        tpLabel = ifelse(tp=="B", "Day01", tp)
        
        #immuno_postfix_label <- case_when(
        #    study_name == "NextGen_Mock" & tp %in% c("Day91", "Day366") ~ " (Track A RIS-PBMC cohort)",
        #    study_name == "NextGen_Mock" & grepl("bind|pseudo", asy) ~ " (RIS cohort)",
        #    study_name == "NextGen_Mock" & asy == "tcell" ~ " (RIS-PBMC cohort)",
        #    TRUE ~ immuno_postfix_label) 
        res = knitr::knit_child(c(here::here('immuno_graphical', 'report_set1.Rmd')), quiet = TRUE)
        cat(res, sep = '\n')
        cat("\\clearpage", sep = '\n')
    }
}

```

\clearpage
## Set 2 plots: Longitudinal plots D01, D31, D91, D181, D366
```{r, echo=FALSE, results='asis', eval=study_name %in% c("VAT08", "NextGen_Mock")}

for (assay_grp in if (study_name == "NextGen_Mock") {
    gsub("\\|", "__", gsub("\\$", "", c("bindSpike_IgG_sera$|bindSpike_IgG_sera_delta_AY.4$",
     "bindSpike_IgG_sera_BA.5$|bindSpike_IgG_sera_BA.2.86$",
     "bindSpike_IgG_sera_XBB.1.5$|bindSpike_IgG_sera_JN.1$",
     "bindSpike_IgG_sera_KP.2$|bindSpike_IgG_sera_KP.3$",
     "bindSpike_IgG_sera_LB.1$|bindN_IgG_sera$",
     
     "bindSpike_IgA_sera$|bindSpike_IgA_sera_delta_AY.4$",
     "bindSpike_IgA_sera_BA.5$|bindSpike_IgA_sera_BA.2.86$",
     "bindSpike_IgA_sera_XBB.1.5$|bindSpike_IgA_sera_JN.1$",
     "bindSpike_IgA_sera_KP.2$|bindSpike_IgA_sera_KP.3$",
     "bindSpike_IgA_sera_LB.1$",
     
     "pseudoneutid50_sera_KP.2$|pseudoneutid50_sera_XBB.1.5$", 
     
     "T4_IFNg_OR_IL2_N_BA.4.5$|T4_IFNg_OR_IL2_Spike_BA.4.5$",
     
     "T8_IFNg_OR_IL2_N_BA.4.5$|T8_IFNg_OR_IL2_Spike_BA.4.5$")))
} else {c("bAb","bAb_mdw","nAb","nAb_mdw")}){
    details = ""
    details_lb = ""
    #immuno_postfix_label <- ifelse(study_name == "NextGen_Mock", " (RIS or RIS-PBMC cohort at Day01, Day31, Day181, Track A RIS-PBMC cohort at Day91, Day366)", immuno_postfix_label)
    
    assay_grp_lb = sub("^(.*?nAb ID50 )(.*?)(nAb ID50 )", "\\1\\2", # delete the second nab ID50
                       paste0(gsub("^Serum |^ |Serum IgG Spike | \\(AU/ml\\)", "", gsub("Serum IgG Spike D614 ", "bAb-IgG Spike Index", labels.assays.short[strsplit(assay_grp, "__")[[1]]])), collapse = " and ")
    )
    res = knitr::knit_child(c(here::here('immuno_graphical', 'report_set2.Rmd')), quiet = TRUE)
    cat(res, sep = '\n')
    cat("\\clearpage", sep = '\n')
    
}

```

\clearpage
## Set 3 plots: Correlation plots across the markers at a given time point
```{r, echo=FALSE, results='asis', eval=study_name %in% c("VAT08", "NextGen_Mock")}

for (bsero in c("non_naive")){
    
    for (trt in c("vac_pla", if (study_name == "NextGen_Mock") "vac", if (study_name == "NextGen_Mock") "pla")){
        
        for (tp in tps_no_fold_change){
            
            if (study_name == "NextGen_Mock" & tp %in% c("Day91", "Day366")) next # skip for now
            
            if (study_name == "NextGen_Mock" & trt == "vac_pla" & tp != "B") next # NextGen_Mock has pooled outputs at baseline and separate outputs post baseline
            if (study_name == "NextGen_Mock" & trt %in% c("vac", "pla") & tp == "B") next # NextGen_Mock has pooled outputs at baseline and separate outputs post baseline
            
            tpLabel = ifelse(tp=="B", "Day01", tp)
            
            for (asy in if (study_name != "NextGen_Mock") {""} else {
                c("IgG_sera", "bindSpike_IgA_sera", "pseudoneutid50_sera", "T4", "T8", 
                  "IgG_sera|bindSpike_IgA_sera", "IgG_sera|pseudoneutid50_sera", "IgG_sera|T4", "IgG_sera|T8",
                  "bindSpike_IgA_sera|pseudoneutid50_sera", "bindSpike_IgA_sera|T4", "bindSpike_IgA_sera|T8",
                  "pseudoneutid50_sera|T4", "pseudoneutid50_sera|T8", "T4|T8")
                }) {
                assay_n = length(assays)

                asy_lb = case_when(asy == "IgG_sera" ~ "bAb-IgG Spike and bAb-IgG Nucleocapsid concentrations",
                                   asy == "bindSpike_IgA_sera" ~ "bAb-IgA Spike concentrations",
                                   asy == "pseudoneutid50_sera" ~ "",
                                   asy == "T4" ~ "",
                                   asy == "T8" ~ "",
                                   asy == "IgG_sera|bindSpike_IgA_sera" ~ "",
                                   asy == "IgG_sera|pseudoneutid50_sera" ~ "",
                                   asy == "IgG_sera|T4" ~ "",
                                   asy == "IgG_sera|T8" ~ "",
                                   asy == "bindSpike_IgA_sera|pseudoneutid50_sera" ~ "",
                                   asy == "bindSpike_IgA_sera|T4" ~ "",
                                   asy == "bindSpike_IgA_sera|T8" ~ "",
                                   asy == "pseudoneutid50_sera|T4" ~ "",
                                   asy == "pseudoneutid50_sera|T8" ~ "",
                                   asy == "T4|T8" ~ "")
                
                #immuno_postfix_label <- case_when(
                #    study_name == "NextGen_Mock" & tp %in% c("B", "Day31", "Day181") ~ " (RIS or RIS-PBMC cohort)",
                #    study_name == "NextGen_Mock" & tp %in% c("Day91", "Day366") ~ " (Track A RIS-PBMC cohort)",
                #    TRUE ~ immuno_postfix_label)
                res = knitr::knit_child(c(here::here('immuno_graphical', 'report_set3.Rmd')), quiet = TRUE)
                cat(res, sep = '\n')
                cat("\\clearpage", sep = '\n')
            }
        }
    }
}

for (bsero in c("naive")){
    if (study_name == "NextGen_Mock") next # NextGen_Mock doesn't have naive ppts
    
    for (trt in c("vac")){
        
        for (tp in tps_no_B_and_fold_change){
            
            tpLabel = ifelse(tp=="B", "Day01", tp)
            res = knitr::knit_child(c(here::here('immuno_graphical', 'report_set3.Rmd')), quiet = TRUE)
            cat(res, sep = '\n')
            cat("\\clearpage", sep = '\n')
        }
    }
}

```

\clearpage
## Set 4 plots: Correlation plots for a given marker across time points
```{r, echo=FALSE, results='asis', eval=study_name %in% c("VAT08", "NextGen_Mock")}

for (a in assays){
    
    immuno_postfix_label <- case_when(
        study_name == "NextGen_Mock" & grepl("bind|pseudo", a) ~ " (RIS cohort)",
        study_name == "NextGen_Mock" & grepl("T4|T8", a) ~ " (RIS-PBMC cohort)",
        TRUE ~ immuno_postfix_label)
    res = knitr::knit_child(c(here::here('immuno_graphical', 'report_set4.Rmd')), quiet = TRUE)
    cat(res, sep = '\n')
    cat("\\clearpage", sep = '\n')
    
}

```

\clearpage

```{r, echo=FALSE, results='asis', eval=study_name=="VAT08" & grepl("Stage1", immuno_postfix_label)}
## Set 5 plots: Longitudinal plots D01, D22, D43, D78, D134, D202, D292, D387, 
## Non-naive Stage 1 and Stage 2 Participants

for (assay_grp in assays){
    
    immuno_postfix_label = " (Stage 1 and Stage 2)"
    details = "_nonnaive_stage1stage2"
    details_lb = ", D78, D134, D202, D292, D387, Non-naive Stage 1 and Stage 2 Participants"
    res = knitr::knit_child(c(here::here('immuno_graphical', 'report_set2.Rmd')), quiet = TRUE)
    cat(res, sep = '\n')
    cat("\\clearpage", sep = '\n')
}

for (assay_grp in assays){
    details = "_gmr_nonnaive_stage1stage2"
    details_lb = ", D78, D134, D202, D292, D387, Non-naive Stage 1 and Stage 2 Participants"
    res = knitr::knit_child(c(here::here('immuno_graphical', 'report_set2.Rmd')), quiet = TRUE)
    cat(res, sep = '\n')
    cat("\\clearpage", sep = '\n')
}

```
