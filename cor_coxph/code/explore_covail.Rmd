---
title: "Covail"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(copcor)
library(survey)
library(kyotil)
library(glue)
library(Hmisc)
library(knitr)

TRIAL="covail"

config.processing <- config::get(config = TRIAL, file="/home/yfong/correlates_processing/config.yml") 
dat_mapped=read.csv(config.processing$mapped_data)

config.reporting  <- config::get(config = TRIAL, file="/home/yfong/correlates_reporting2/config.yml") 
dat_proc=read.csv(config.reporting$data_cleaned)

dat=subset(dat_proc, ph1.D15 & TrtonedosemRNA==1) 

assay_metadata=read.csv('~/correlates_reporting2/assay_metadata/covail_assay_metadata.csv')
assays=assay_metadata$assay
tmp=assay_metadata$assay[8:nrow(assay_metadata)]
S1=tmp[!endsWith(tmp, ".N")]%.%"1"; S1
S2=tmp[!endsWith(tmp, ".N")]%.%"2"; S2
N=tmp[endsWith(tmp, "Wuhan.N")]; N
tcellvv=c(S1, S2, N)

f=Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ FOIstandardized + standardized_risk_score

dat.ocp.pfizer=subset(dat_proc, ph1.D15==1 & treatment_assigned %in% c(
    "Wildtype/Prototype (Pfizer 1)"
  , "Omicron (Pfizer 1)"
  , "Omicron + Wildtype/Prototype (Pfizer 1)"
  # , "Omicron BA.4/5 + Prototype (Pfizer 2)"
  # , "Omicron BA.1 + Prototype (Pfizer 2)"
  )
)
dat.ocp.pfizer$Trt=ifelse(dat.ocp.pfizer$treatment_assigned == "Wildtype/Prototype (Pfizer 1)", 0, 1)


dat.ocp.moderna=subset(dat_proc, ph1.D15==1 & treatment_assigned %in% c(
    "1 Dose Prototype (Moderna)" # 50 ug
  , "1 Dose Omicron (Moderna)"
  , "1 Dose Omicron + Prototype (Moderna)"
  )
)
dat.ocp.moderna$Trt=ifelse(dat.ocp.moderna$treatment_assigned == "1 Dose Prototype (Moderna)", 0, 1)

dat.ocp=rbind(cbind(dat.ocp.pfizer, company="Pfz"), cbind(dat.ocp.moderna, company="Mdn"))

dat.1=subset(dat.ocp.pfizer, naive==1)
dat.1.moderna=subset(dat.ocp.moderna, naive==1)

dat.sanofi = subset(dat_mapped, TrtSanofi==1) #treatment_actual %in% c("Beta (Sanofi)", "Beta + Prototype (Sanofi)", "Prototype (Sanofi)")


dat.mRNA1=subset(dat_proc, ph1.D15==1 & treatment_assigned %in% c(
  "1 Dose Beta + Omicron (Moderna)",
  "2 Dose Beta + Omicron (Moderna)",
  "1 Dose Delta + Omicron (Moderna)",
  "Beta (Pfizer 1)",
  "Beta + Omicron (Pfizer 1)",
  "Beta + Wildtype/Prototype (Pfizer 1)"
# "Beta + Prototype (Sanofi)",
# "Beta (Sanofi)"                          
# "Omicron BA.4/5 + Prototype (Pfizer 2)"  
# "Omicron BA.1 + Prototype (Pfizer 2)" )
))

convert2IU=function(tmp) {
  tmp$Day15pseudoneutid50_D614G = copcor::MNG2IU_pseudoneutid50_D614G(tmp$Day15pseudoneutid50_D614G)
  tmp$Bpseudoneutid50_D614G     = copcor::MNG2IU_pseudoneutid50_D614G(tmp$Bpseudoneutid50_D614G)
  
  tmp$Day15pseudoneutid50_BA.1 = copcor::MNG2imputedIU_pseudoneutid50_BA1(tmp$Day15pseudoneutid50_BA.1)
  tmp$Bpseudoneutid50_BA.1     = copcor::MNG2imputedIU_pseudoneutid50_BA1(tmp$Bpseudoneutid50_BA.1)
  
  tmp
}

mytable(dat_proc$treatment_assigned)

```

```{r FS scatterplots, fig.height=6, fig.width=6}
par(mfrow=c(2,2)); reduce_margin()
corplot(Day15cd4_FS_Wuhan.N~Bcd4_FS_Wuhan.N,  dat_mapped)
corplot(Day15cd4_FS_BA.4.5.S1~Bcd4_FS_BA.4.5.S1,  dat_mapped)
hist(dat_mapped$Bcd4_FS_Wuhan.N, main="")
hist(dat_mapped$Bcd4_FS_BA.4.5.S1, main="")

```


```{r compute weighted response rate using _resp variables}
dat.onedosemRNA =    subset(dat_proc, ph1.D15 & TrtonedosemRNA==1 & !arm %in% c(16,17)) 
dat.sanofi = subset(dat_proc, ph1.D15 & TrtSanofi==1)

primary = c("Bcd4_IFNg.IL2_Wuhan.N", "Bcd4_IFNg.IL2_BA.4.5.S", "Day15cd4_IFNg.IL2_BA.4.5.S")
secondary = c("Bcd8_IFNg.IL2_Wuhan.N",         "Bcd8_IFNg.IL2_BA.4.5.S", 
              "Bcd4_IFNg.IL2.154_Wuhan.N",     "Bcd4_IFNg.IL2.154_BA.4.5.S", 
              "Bcd4_IL4.IL5.IL13.154_Wuhan.N", "Bcd4_IL4.IL5.IL13.154_BA.4.5.S", 
              "Bcd4_IL21_Wuhan.N",             "Bcd4_IL21_BA.4.5.S", 
              "Day15cd8_IFNg.IL2_BA.4.5.S",
              "Day15cd4_IFNg.IL2.154_BA.4.5.S",
              "Day15cd4_IL4.IL5.IL13.154_BA.4.5.S", 
              "Day15cd4_IL21_BA.4.5.S")

res=sapply (0:3, function(.naive) {
  
  if (.naive<2) {
    dat=subset(dat.onedosemRNA, ph2.D15.tcell & naive==.naive )
  } else {
    dat=subset(dat.sanofi, ph2.D15.tcell & naive==.naive %% 2)
  }
  sapply (c(primary, secondary), function(a) sum(dat[[a%.%"_resp"]]*dat$wt.D15.tcell)/sum(dat$wt.D15.tcell))
})
colnames(res)=c("mRNA NN","mRNA N", "Sanofi NN", "Sanofi N")
round(res,3)
```

All the CD8 values for positive responders are above -1.5.
```{r}
par(mfrow=c(1,4)); reduce_margin()
lim=c(-3,1)
myboxplot(Bcd8_IFNg.IL2_BA.4.5.S~Bcd8_IFNg.IL2_BA.4.5.S_resp, dat_proc[dat_proc$naive==0,], ylim=lim, xlab="response call", main="D01"); abline(h=-1.7, col=2)
myboxplot(Day15cd8_IFNg.IL2_BA.4.5.S~Day15cd8_IFNg.IL2_BA.4.5.S_resp, dat_proc[dat_proc$naive==0,], ylim=lim, xlab="response call", main="D15"); abline(h=-1.7, col=2)
mtext("NNaive", side=3, at=0, line=0.8)
myboxplot(Bcd8_IFNg.IL2_BA.4.5.S~Bcd8_IFNg.IL2_BA.4.5.S_resp, dat_proc[dat_proc$naive==1,], ylim=lim, xlab="response call", main="D01"); abline(h=-1.7, col=2)
myboxplot(Day15cd8_IFNg.IL2_BA.4.5.S~Day15cd8_IFNg.IL2_BA.4.5.S_resp, dat_proc[dat_proc$naive==1,], ylim=lim, xlab="response call", main="D15"); abline(h=-1.7, col=2)
mtext("Naive", side=3, at=0, line=0.8)

par(mfrow=c(1,2));  par(mar=c(4,3,2,1), mgp = c(1.5, 0.5, 0))
lim=c(-3,1)
myboxplot(Bcd4_IFNg.IL2_BA.4.5.S~naive, dat_proc, ylim=lim, xlab="naive", main="D01", test='w');# abline(h=-1.7, col=2)
myboxplot(Day15cd4_IFNg.IL2_BA.4.5.S~naive, dat_proc, ylim=lim, xlab="naive", main="D15", test="w");# abline(h=-1.7, col=2)
```


```{r stratify by stage}
nAbs=subset(assay_metadata, panel=="id50", assay, drop=T)

# compare all Pfizer and all Moderna and onedosemRNA to decide whether to stratify by stage or not
dat.onedosemRNA =    subset(dat_proc, ph1.D15 & TrtonedosemRNA==1 & !arm %in% c(16,17)) 
dat.onedoseModerna = subset(dat.onedosemRNA, arm<=6)
dat.onedosePfizer  = subset(dat.onedosemRNA, arm> 6)

for (.naive in 1:0) {
  
  markers=nAbs[2]

  res=sapply(1:4, function (i) {
    fits=lapply(markers, function (a) {
      if (i==1) dat=subset(dat.onedoseModerna, naive==.naive)
      if (i==2) dat=subset(dat.onedosePfizer, naive==.naive)
      if (i==3 | i==4) dat=subset(dat.onedosemRNA, naive==.naive)
      
      dat[["Day15"%.%a]]=scale(dat[["Day15"%.%a]])
      formula = as.formula(glue("Surv(COVIDtimeD22toD91, COVIDIndD22toD91) ~ FOIstandardized + standardized_risk_score + B{a} + Day15{a}"))
      if (i==4) {
        formula = update(formula, ~ . + strata(stage))
      } 
      coxph(formula, dat)
    })
    names(fits)=markers
    getFormattedSummary(fits, robust=F, type=5)[,]
  })
  colnames(res)=c("Moderna","Pfizer","all","all stratified")
  print(kable(res))
  
}

```


### T cell data

```{r check missing _resp, fig.width=8, fig.height=8}
par(mfrow=c(2,2)); reduce_margin()
mytable(is.na(dat_proc$Bcd4_IFNg.IL2_COV2.CON.S1_resp[dat_proc$ph2.D15.tcell==1]))
mytable(is.na(dat_proc$Bcd4_IFNg.IL2_COV2.CON.S1[dat_proc$ph2.D15.tcell==1]))

dat_proc$Bcd4_IFNg.IL2_COV2.CON.S1[is.na(dat_proc$Bcd4_IFNg.IL2_COV2.CON.S1_resp) & dat_proc$ph2.D15.tcell==1]
dat_proc$Bcd4_IFNg.IL2_BA.4.5.S1[is.na(dat_proc$Bcd4_IFNg.IL2_COV2.CON.S1_resp) & dat_proc$ph2.D15.tcell==1]

corplot(Bcd4_IFNg.IL2_COV2.CON.S1~ Bcd4_IFNg.IL2_BA.4.5.S1, dat_proc[dat_proc$ph2.D15.tcell==1,], ylim=c(-3,0), xlim=c(-3,0), asp=1)
abline(h=-1, col=2)

myboxplot(Bcd4_IFNg.IL2_COV2.CON.S1~ Bcd4_IFNg.IL2_COV2.CON.S1_resp, dat_proc[dat_proc$ph2.D15.tcell==1,], ylim=c(-3,0))
myboxplot(Bcd4_IFNg.IL2_BA.4.5.S1~ Bcd4_IFNg.IL2_BA.4.5.S1_resp, dat_proc[dat_proc$ph2.D15.tcell==1,], ylim=c(-3,0))

# myboxplot(Day15cd4_IFNg.IL2_COV2.CON.S1~ Day15cd4_IFNg.IL2_COV2.CON.S1_resp, dat_proc[dat_proc$ph2.D15.tcell==1,], ylim=c(-3,0))

```

```{r check weights}
mytable(dat_proc$ph1.D15.tcell, dat_proc$Wstratum.tcell)
mytable(dat_proc[dat_proc$ph1.D15.tcell==1, "wt.D15.tcell"])
tab=t(mytable(dat_proc[dat_proc$ph1.D15.tcell==1, "Wstratum.tcell"], dat_proc[dat_proc$ph1.D15.tcell==1, "ph2.D15.tcell"]))
names(dimnames(tab))=c("ph2","stratum")
kable(tab)
```

```{r}
par(mfrow=c(3,3)); reduce_margin()
corplot(Day15cd4_IFNg.IL2_COV2.CON.S1~ Bcd4_IFNg.IL2_COV2.CON.S1, subset(dat_proc, naive==1), asp=1)
corplot(Day15cd4_IFNg.IL2_COV2.CON.S2~ Bcd4_IFNg.IL2_COV2.CON.S2, subset(dat_proc, naive==1), asp=1)
corplot(Day15cd4_IFNg.IL2_COV2.CON.S ~ Bcd4_IFNg.IL2_COV2.CON.S , subset(dat_proc, naive==1), asp=1)
corplot(Day15pseudoneutid50_D614G ~ Bpseudoneutid50_D614G , subset(dat_proc, naive==1), asp=1)
corplot(Day15pseudoneutid50_D614G ~ Day15cd4_IFNg.IL2_COV2.CON.S , subset(dat_proc, naive==1))
corplot(Bpseudoneutid50_D614G ~ Bcd4_IFNg.IL2_COV2.CON.S , subset(dat_proc, naive==1))
corplot(Day15cd4_IFNg.IL2_COV2.CON.S2~ Day15cd4_IFNg.IL2_COV2.CON.S1, subset(dat_proc, naive==1), asp=1)
corplot(Bcd4_IFNg.IL2_COV2.CON.S2    ~ Bcd4_IFNg.IL2_COV2.CON.S1, subset(dat_proc, naive==1), asp=1)
```


```{r Day 15 correlation between S1 and S2, fig.height=8, fig.width=8}

x=log10(dat_mapped[dat_mapped$ph1.D15==1 & dat_mapped$naive==1,c("Bcd4_IFNg.IL2_Wuhan.N")]); y=log10(dat_mapped[dat_mapped$ph1.D15==1 & dat_mapped$naive==1,c("Day15cd4_IFNg.IL2_Wuhan.N")])
x[x<=-2]=-2; y[y<= -2]=-2
mypairs(cbind(x,y), gap=0, xlim=c(-3,0), ylim=c(-3,0), show.data.only=T, asp=1, cor.method="p")

x=log10(dat_mapped[dat_mapped$ph1.D15==1 & dat_mapped$naive==0,c("Bcd4_IFNg.IL2_Wuhan.N")]); y=log10(dat_mapped[dat_mapped$ph1.D15==1 & dat_mapped$naive==0,c("Day15cd4_IFNg.IL2_Wuhan.N")])
x[x<=-2]=-2; y[y<= -2]=-2
mypairs(cbind(x,y), gap=0, xlim=c(-3,0), ylim=c(-3,0), show.data.only=T, asp=1, cor.method="p")


mypairs(log10(dat_mapped[,c(glue("Day15{c(rbind(S1[1:2], S2[1:2]))}"))]), gap=0)

mypairs(log10(dat_mapped[,c("Day15cd4_IFNg.IL2_COV2.CON.S1", "Day15cd4_IFNg.IL2_BA.4.5.S1")]), gap=0)



tab=mysapply (1:length(S1), function(i) {
  c(mytable(!is.na(dat_mapped[[glue("Day15{S1[i]}")]]), !is.na(dat_mapped[[glue("Day15{S2[i]}")]])))
})
rownames(tab)=sub(".S1", "", S1)
tab

i=2; mytable(!is.na(dat_mapped[[glue("Day15{S1[i]}")]]), !is.na(dat_mapped[[glue("Day15{S2[i]}")]]))

i=1; mytable(!is.na(dat_mapped[[glue("B{S1[i]}")]]), !is.na(dat_mapped[[glue("Day15{S1[i]}")]]), dat_mapped$COVIDIndD22toD181)

i=1; mytable(!is.na(dat_mapped[[glue("Day15{S2[i]}")]]), !is.na(dat_mapped[["Day15cd4_IFNg.IL2_Wuhan.N"]]), 
dat_mapped$COVIDIndD22toD91)

mytable(rowSums(!is.na(dat_mapped[glue("Day15{tcellvv}")])))
             
# t(dat_mapped[which(rowSums(!is.na(dat_mapped[glue("Day15{tcellvv}")]))==36),201:300])
```


```{r B correlation between S1 and S2}

mypairs(dat_mapped[,c(glue("B{c(rbind(S1[1:2], S2[1:2]))}"))], gap=0)

tab=mysapply (1:length(S1), function(i) {
  c(mytable(!is.na(dat_mapped[[glue("B{S1[i]}")]]), !is.na(dat_mapped[[glue("B{S2[i]}")]])))
})
rownames(tab)=sub(".S1", "", S1)
tab

i=2; mytable(!is.na(dat_mapped[[glue("B{S1[i]}")]]), !is.na(dat_mapped[[glue("B{S2[i]}")]]))

i=1; mytable(!is.na(dat_mapped[[glue("B{S1[i]}")]]), !is.na(dat_mapped[[glue("B{S2[i]}")]]), dat_mapped$COVIDIndD22toD91)

i=1; mytable(!is.na(dat_mapped[[glue("B{S2[i]}")]]), !is.na(dat_mapped[["Day15cd4_IFNg.IL2_Wuhan.N"]]), 
dat_mapped$COVIDIndD22toD91)

i=1; mytable(!is.na(dat_mapped[[glue("B{S2[i]}")]]), !is.na(dat_mapped[["Bcd4_IFNg.IL2_Wuhan.N"]]), 
dat_mapped$COVIDIndD22toD91)

i=1; mytable(!is.na(dat_mapped[[glue("Bcd4_IFNg.IL2_Wuhan.N")]]), !is.na(dat_mapped[["Day15cd4_IFNg.IL2_Wuhan.N"]]), 
dat_mapped$COVIDIndD22toD91)

mytable(rowSums(!is.na(dat_mapped[glue("B{tcellvv}")])))
             
# t(dat_mapped[which(rowSums(!is.na(dat_mapped[glue("B{tcellvv}")]))==36),201:300])

# cross-tabulate missingness between baseline and D15
tab=mysapply (1:length(S1), function(i) {
  c(mytable(!is.na(dat_mapped[[glue("B{S1[i]}")]]), !is.na(dat_mapped[[glue("Day15{S1[i]}")]])))
})
rownames(tab)=sub(".S1", "", S1); tab

mypairs(log10(dat_mapped[dat_mapped$naive==0,c(glue("B{c(rbind(S1[1]))}"), glue("Day15{c(rbind(S1[1]))}"))]), gap=0)
mypairs(log10(dat_mapped[dat_mapped$naive==1,c(glue("B{c(rbind(S1[1]))}"), glue("Day15{c(rbind(S1[1]))}"))]), gap=0)

```


```{r Day91 correlation between S1 and S2}

mypairs(log10(dat_mapped[,c(glue("Day91{c(rbind(S1[1:2], S2[1:2]))}"))]), gap=0)

tab=mysapply (1:length(S1), function(i) {
  c(mytable(!is.na(dat_mapped[[glue("Day91{S1[i]}")]]), !is.na(dat_mapped[[glue("Day91{S2[i]}")]])))
})
rownames(tab)=sub(".S1", "", S1)
tab

i=1; mytable(!is.na(dat_mapped[[glue("B{S2[i]}")]]), !is.na(dat_mapped[["Day91cd4_IFNg.IL2_Wuhan.N"]]), 
dat_mapped$COVIDIndD22toD91)

i=1; mytable(!is.na(dat_mapped[[glue("Day15{S2[i]}")]]), !is.na(dat_mapped[["Day91cd4_IFNg.IL2_Wuhan.N"]]), 
dat_mapped$COVIDIndD22toD91)

mytable(rowSums(!is.na(dat_mapped[glue("B{tcellvv}")])))
             
# t(dat_mapped[which(rowSums(!is.na(dat_mapped[glue("B{tcellvv}")]))==36),201:300])

# cross-tabulate missingness between baseline and D91
tab=mysapply (1:length(S1), function(i) c(mytable(!is.na(dat_mapped[[glue("B{S1[i]}")]]), !is.na(dat_mapped[[glue("Day91{S1[i]}")]]))))
rownames(tab)=sub(".S1", "", S1); tab
tab=mysapply (1:length(S1), function(i) c(mytable(!is.na(dat_mapped[[glue("Day15{S1[i]}")]]), !is.na(dat_mapped[[glue("Day91{S1[i]}")]]))))
rownames(tab)=sub(".S1", "", S1); tab

mypairs(log10(dat_mapped[,c(glue("B{c(rbind(S1[1:2]))}"), glue("Day91{c(rbind(S1[1:2]))}"))]), gap=0)

```


```{r Day181 correlation between S1 and S2}

mypairs(log10(dat_mapped[,c(glue("Day181{c(rbind(S1[1:2], S2[1:2]))}"))]), gap=0)

tab=mysapply (1:length(S1), function(i) c(mytable(!is.na(dat_mapped[[glue("Day181{S1[i]}")]]), !is.na(dat_mapped[[glue("Day181{S2[i]}")]]))))
rownames(tab)=sub(".S1", "", S1); tab

i=1; mytable(!is.na(dat_mapped[[glue("B{S2[i]}")]]), !is.na(dat_mapped[["Day181cd4_IFNg.IL2_Wuhan.N"]]), 
dat_mapped$COVIDIndD22toD181)

i=1; mytable(!is.na(dat_mapped[[glue("Day15{S2[i]}")]]), !is.na(dat_mapped[["Day181cd4_IFNg.IL2_Wuhan.N"]]), 
dat_mapped$COVIDIndD22toD181)

i=1; mytable(!is.na(dat_mapped[[glue("Day91{S2[i]}")]]), !is.na(dat_mapped[["Day181cd4_IFNg.IL2_Wuhan.N"]]), 
dat_mapped$COVIDIndD92toD181)

i=1; mytable(!is.na(dat_mapped[[glue("Day91{S2[i]}")]]), !is.na(dat_mapped[[glue("Day181{S2[i]}")]]), 
dat_mapped$COVIDIndD92toD181)
i=1; mytable(!is.na(dat_mapped[[glue("Day91{S2[i]}")]][dat_mapped$ph1.D92==1]), !is.na(dat_mapped[[glue("Day181{S2[i]}")]][dat_mapped$ph1.D92==1]), 
dat_mapped$COVIDIndD92toD181[dat_mapped$ph1.D92==1])

i=1; mytable(!is.na(dat_mapped[[glue("Day91{S2[i]}")]]), !is.na(dat_mapped[["Day91cd4_IFNg.IL2_Wuhan.N"]]), 
dat_mapped$COVIDIndD22toD181)

i=1; mytable(!is.na(dat_mapped[[glue("Day181{S2[i]}")]]), !is.na(dat_mapped[["Day181cd4_IFNg.IL2_Wuhan.N"]]), 
dat_mapped$COVIDIndD92toD181)

mytable(rowSums(!is.na(dat_mapped[glue("B{tcellvv}")])))
             
# t(dat_mapped[which(rowSums(!is.na(dat_mapped[glue("B{tcellvv}")]))==36),201:300])

# cross-tabulate missingness between baseline and D181
tab=mysapply (1:length(S1), function(i) c(mytable(!is.na(dat_mapped[[glue("B{S1[i]}")]]), !is.na(dat_mapped[[glue("Day181{S1[i]}")]]))))
rownames(tab)=sub(".S1", "", S1); tab
tab=mysapply (1:length(S1), function(i) c(mytable(!is.na(dat_mapped[[glue("Day15{S1[i]}")]]), !is.na(dat_mapped[[glue("Day181{S1[i]}")]]))))
rownames(tab)=sub(".S1", "", S1); tab
tab=mysapply (1:length(S1), function(i) c(mytable(!is.na(dat_mapped[[glue("Day91{S1[i]}")]]), !is.na(dat_mapped[[glue("Day181{S1[i]}")]]))))
rownames(tab)=sub(".S1", "", S1); tab

print("D15/D91")
i=1; table(!is.na(dat_mapped[[glue("Day15{S1[i]}")]]), !is.na(dat_mapped[[glue("Day91{S1[i]}")]]), 
dat_mapped$COVIDIndD22toD181)
print("D91/D181")
# note that COVIDIndD92toD181 is used below because for cases in D15toD91, their markers at D91 and D181 are not needed
i=1; table(!is.na(dat_mapped[[glue("Day91{S1[i]}")]]), !is.na(dat_mapped[[glue("Day181{S1[i]}")]]), 
dat_mapped$COVIDIndD92toD181) 
print("D15/D181")
i=1; table(!is.na(dat_mapped[[glue("Day15{S1[i]}")]]), !is.na(dat_mapped[[glue("Day181{S1[i]}")]]), 
dat_mapped$COVIDIndD22toD181)

subset(dat_mapped, is.na(Day15cd4_IFNg.IL2_COV2.CON.S1) & !is.na(Day91cd4_IFNg.IL2_COV2.CON.S1))[,200:300]

mypairs(log10(dat_mapped[,c(glue("Day91{c(rbind(S1[1:2]))}"), glue("Day181{c(rbind(S1[1:2]))}"))]), gap=0)

```


### explore the second order effect

```{r}

coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ FOIstandardized + standardized_risk_score + scale(Bpseudoneutid50_MDW, scale=F) + I(scale(Day15pseudoneutid50_MDW, scale=F)^2) + scale(Day15pseudoneutid50_MDW, scale=F), subset(dat, naive==1))

coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ scale(Bpseudoneutid50_MDW, scale=F) + I(scale(Day15pseudoneutid50_MDW, scale=F)^2) + scale(Day15pseudoneutid50_MDW, scale=F), subset(dat, naive==1))


plot(Day15pseudoneutid50_MDW~Bpseudoneutid50_MDW, subset(dat, naive==1), col=subset(dat, naive==1)$COVIDIndD22toD181+1)
plot(Day15pseudoneutid50_MDW~Bpseudoneutid50_MDW, subset(dat, naive==0), col=subset(dat, naive==0)$COVIDIndD22toD181+1)

```



### scatterplot of D15 and B 

- Make all plots in IU.
- COVAIL is dose 4. COVE booster is dose 3.

```{r helper functions}
plot_anc_BA1=function(tmp, main) {
  par(mfrow=c(1,2), oma=c(0,2.5,3,0.5), mar=c(3,0,2,0), mgp = c(2, .5, 0))
  lim=c(0,4.5)
  
  plot(Day15pseudoneutid50_D614G~Bpseudoneutid50_D614G, tmp, col=ifelse(tmp$naive==1,1,2), main="Ancestral ID50", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1)
  plot(Day15pseudoneutid50_BA.1~Bpseudoneutid50_BA.1,   tmp, col=ifelse(tmp$naive==1,1,2), main="BA1 ID50", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1)
  title(ylab="D15 (IU/ml)", outer=T, line=1.5)
  
  title(main=main, outer=T, line=0)
}
```


BA1 DI50 in one row and Ancestral ID50 in second row, three columns for three vaccines
```{r}
tmp=convert2IU(subset(dat_proc, ph1.D15==1 & treatment_assigned %in% c(
    "1 Dose Prototype (Moderna)" # 50 ug
 ,  "1 Dose Omicron (Moderna)" # BA1
 , "Beta (Sanofi)", "Beta + Prototype (Sanofi)", "Prototype (Sanofi)"
  )
))
tmp$col=ifelse(tmp$naive==1,1,2); lim=c(0,4.5)
par(mfrow=c(2,3), oma=c(2.5,3.5,3,0.5), mar=c(0,0,2,0), mgp = c(2, .5, 0))

kp=tmp$treatment_assigned=="1 Dose Prototype (Moderna)";                                              plot(Day15pseudoneutid50_BA.1~Bpseudoneutid50_BA.1,   tmp[kp,], col=tmp$col[kp], main="", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1); title(main="Moderna Prototype", line=1)
kp=tmp$treatment_assigned=="1 Dose Omicron (Moderna)";                                                plot(Day15pseudoneutid50_BA.1~Bpseudoneutid50_BA.1,   tmp[kp,], col=tmp$col[kp], main="", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1); title(main="Moderna BA.1", line=1)
kp=tmp$treatment_assigned %in% c("Beta (Sanofi)", "Beta + Prototype (Sanofi)", "Prototype (Sanofi)"); plot(Day15pseudoneutid50_BA.1~Bpseudoneutid50_BA.1,   tmp[kp,], col=tmp$col[kp], main="", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1); title(main="Sanofi", line=1)

par(mar=c(0,0,0,0))
kp=tmp$treatment_assigned=="1 Dose Prototype (Moderna)";                                              plot(Day15pseudoneutid50_D614G~Bpseudoneutid50_D614G, tmp[kp,], col=tmp$col[kp], main="", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1)
kp=tmp$treatment_assigned=="1 Dose Omicron (Moderna)";                                                plot(Day15pseudoneutid50_D614G~Bpseudoneutid50_D614G, tmp[kp,], col=tmp$col[kp], main="", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1)
kp=tmp$treatment_assigned %in% c("Beta (Sanofi)", "Beta + Prototype (Sanofi)", "Prototype (Sanofi)"); plot(Day15pseudoneutid50_D614G~Bpseudoneutid50_D614G, tmp[kp,], col=tmp$col[kp], main="", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1)

title(ylab="Ancestral ID50                              BA.1 ID50", outer=T, line=2.5, font.lab=2)
title(ylab="D15 (IU/ml)", outer=T, line=1.5)
title(xlab="D1 (IU/ml)", outer=T, line=1.5) 

```


COVAIL Sanofi 
```{r}
tmp=convert2IU(dat.sanofi)
plot_anc_BA1(tmp, main="COVAIL Sanofi")
```


Three Sanofi arms plotted separately
```{r}
tmp=convert2IU(subset(dat_proc, ph1.D15==1 & treatment_assigned %in% c(
 "Beta (Sanofi)", "Beta + Prototype (Sanofi)", "Prototype (Sanofi)"
  )
))
tmp$col=ifelse(tmp$naive==1,1,2); lim=c(0,4.5)
par(mfrow=c(2,3), oma=c(2.5,3.5,3,0.5), mar=c(0,0,2,0), mgp = c(2, .5, 0))

kp=tmp$treatment_assigned %in% c("Prototype (Sanofi)"); plot(Day15pseudoneutid50_BA.1~Bpseudoneutid50_BA.1,   tmp[kp,], col=tmp$col[kp], main="", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1); title(main="Prototype", line=1)
kp=tmp$treatment_assigned=="Beta (Sanofi)";             plot(Day15pseudoneutid50_BA.1~Bpseudoneutid50_BA.1,   tmp[kp,], col=tmp$col[kp], main="", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1); title(main="Beta", line=1)
kp=tmp$treatment_assigned=="Beta + Prototype (Sanofi)"; plot(Day15pseudoneutid50_BA.1~Bpseudoneutid50_BA.1,   tmp[kp,], col=tmp$col[kp], main="", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1); title(main="Prototype + Beta", line=1)

par(mar=c(0,0,0,0))
kp=tmp$treatment_assigned %in% c("Prototype (Sanofi)"); plot(Day15pseudoneutid50_D614G~Bpseudoneutid50_D614G, tmp[kp,], col=tmp$col[kp], main="", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1)
kp=tmp$treatment_assigned=="Beta (Sanofi)";             plot(Day15pseudoneutid50_D614G~Bpseudoneutid50_D614G, tmp[kp,], col=tmp$col[kp], main="", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1)
kp=tmp$treatment_assigned=="Beta + Prototype (Sanofi)"; plot(Day15pseudoneutid50_D614G~Bpseudoneutid50_D614G, tmp[kp,], col=tmp$col[kp], main="", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1)

title(ylab="Ancestral ID50                              BA.1 ID50", outer=T, line=2.5, font.lab=2)
title(ylab="D15 (IU/ml)", outer=T, line=1.5)
title(xlab="D1 (IU/ml)", outer=T, line=1.5) 
title(main="Sanoifi", outer=T, line=1.5) 

```

COVAIL moderna prototype 
```{r}
tmp=convert2IU(subset(dat_proc, ph1.D15==1 & treatment_assigned %in% c(
    "1 Dose Prototype (Moderna)" # 50 ug
  )
))
plot_anc_BA1(tmp, main="COVAIL Moderna Prototype (50ug)") # COVAIL mRNA-1273 Prototype Dose 4 (50ug)
```

COVAIL moderna Omicron BA1 
```{r}
tmp=convert2IU(subset(dat_proc, ph1.D15==1 & treatment_assigned %in% c(
  "1 Dose Omicron (Moderna)" # BA1
  )
))
plot_anc_BA1(tmp, main="COVAIL Moderna BA.1 (50ug)") # COVAIL mRNA-1273 BA.1 Dose 4 (50ug)
```

COVAIL moderna prototype and BA1 together
```{r}
tmp=convert2IU(subset(dat_proc, ph1.D15==1 & treatment_assigned %in% c(
    "1 Dose Prototype (Moderna)" # 50 ug
   ,"1 Dose Omicron (Moderna)" # BA1
  )
))
tmp$trt=ifelse(tmp$treatment_assigned=="1 Dose Prototype (Moderna)",1,0)
main="COVAIL Moderna (50ug)"

par(mfrow=c(1,2), oma=c(0,2.5,3,0.5), mar=c(3,0,2,0), mgp = c(2, .5, 0))
lim=c(0,4.5)

plot(Day15pseudoneutid50_D614G~Bpseudoneutid50_D614G, tmp, pch=ifelse(tmp$naive==1,1,2), col=ifelse(tmp$trt==1,1,2), main="Ancestral ID50", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1)
plot(Day15pseudoneutid50_BA.1~Bpseudoneutid50_BA.1,   tmp, pch=ifelse(tmp$naive==1,1,2), col=ifelse(tmp$trt==1,1,2), main="BA1 ID50", xlab="D1 (IU/ml)", xlim=lim, ylim=lim, asp=1); abline(0,1)
# mylegend(legend=c())

title(ylab="D15 (IU/ml)", outer=T, line=1.5)

title(main=main, outer=T, line=0)
```





COVAIL mRNA 
```{r}
tmp=convert2IU(dat.ocp)
plot_anc_BA1(tmp, main="COVAIL Omi/Prot 1 dose mRNA")
```


Cox model using a generated marker based on baseline

```{r}

tmp=convert2IU(subset(dat_proc, ph1.D15==1 & treatment_assigned %in% c(
   "1 Dose Omicron (Moderna)" # BA1
)))

tmp1 = subset(tmp, Bpseudoneutid50_D614G>0.5 & Day15pseudoneutid50_D614G<4)

fit=lm(Day15pseudoneutid50_D614G~Bpseudoneutid50_D614G+I(Bpseudoneutid50_D614G^2)+I(Bpseudoneutid50_D614G^3), tmp1)

tmp$pred=predict(fit,newdata=tmp)
tmp$resid=tmp$Day15pseudoneutid50_D614G-tmp$pred
tmp1$pred=predict(fit,newdata=tmp1)

plot(Day15pseudoneutid50_D614G~Bpseudoneutid50_D614G, tmp, xlim=c(0,5), ylim=c(0,5), asp=1); mylines(tmp$Bpseudoneutid50_D614G, tmp$pred, col=2)

par(mfrow=c(1,2))
lim=NULL
corplot(Day15pseudoneutid50_D614G~resid, tmp, xlim=NULL, ylim=c(0,5), asp=1)
corplot(Bpseudoneutid50_D614G~resid, tmp, xlim=NULL, ylim=c(0,5), asp=1)

coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ naive + Day15pseudoneutid50_D614G, tmp)
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ naive + Bpseudoneutid50_D614G, tmp)
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ naive + pred, tmp)
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ naive + resid, tmp)

coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ pred + resid, tmp)
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ pred * resid, tmp)
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ Bpseudoneutid50_D614G + resid, tmp)
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ Bpseudoneutid50_D614G * resid, tmp)
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ Day15pseudoneutid50_D614G + resid, tmp)

# coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ naive + Day15pseudoneutid50_D614G, tmp1)
# coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ naive + pred, tmp1)

coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ naive + Bpseudoneutid50_D614G * resid, tmp)
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ naive * resid, tmp)
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ naive + pred + resid, tmp)


```

repeat for BA1 marker. not significant

```{r}

tmp=convert2IU(subset(dat_proc, ph1.D15==1 & treatment_assigned %in% c(
   "1 Dose Omicron (Moderna)" # BA1
)))

fit=lm(Day15pseudoneutid50_BA.1~Bpseudoneutid50_BA.1+I(Bpseudoneutid50_BA.1^2), subset(tmp, Day15pseudoneutid50_BA.1>1))
tmp$pred=predict(fit,newdata=tmp)

plot(Day15pseudoneutid50_BA.1~Bpseudoneutid50_BA.1, tmp, xlim=c(0,5), ylim=c(0,5), asp=1); mylines(tmp$Bpseudoneutid50_BA.1, tmp$pred, col=2)

coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ Day15pseudoneutid50_BA.1 + naive, tmp)

coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ Bpseudoneutid50_BA.1 + naive, tmp)

coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ pred + naive, tmp)

```


### For manuscript revision

compute median value for each category 
```{r}
tmp=subset(dat_proc, ph1.D15==1 & TrtonedosemRNA==1 & Day15pseudoneutid50_BA.1 <= 3.44762) # naive==1 & 
10**(wtd.quantile(tmp$Day15pseudoneutid50_BA.1, weights = tmp$wt.D15, probs = c(1/2)))
tmp=subset(dat_proc, ph1.D15==1 & TrtonedosemRNA==1 & Day15pseudoneutid50_BA.1 > 3.44762 & Day15pseudoneutid50_BA.1 <= 3.95012) # & naive==1 
10**(wtd.quantile(tmp$Day15pseudoneutid50_BA.1, weights = tmp$wt.D15, probs = c(1/2)))
tmp=subset(dat_proc, ph1.D15==1 & TrtonedosemRNA==1 & Day15pseudoneutid50_BA.1 > 3.95012) # & naive==1 
10**(wtd.quantile(tmp$Day15pseudoneutid50_BA.1, weights = tmp$wt.D15, probs = c(1/2)))
```


Relationship between risk score and age

```{r}
plot(dat_proc$Age, dat_proc$risk_score)

```

### Difference in risk between prototype and Omicon vaccines

Summary: Between Pfz Prototype, Pfz Omicron, Mdn P, and Mdn O,

* Pfizer O has lower risk than the other three arms.
* Moderna P is the only arm in terms of BA4BA5 ID50 not being a correlate.



Risk is similar between Pfizer and Moderna in the prototype arms. Moderna P and O have similar risks, but Pfizer O has lower risk than P. 
```{r}
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ company, subset(dat.ocp,naive==1 & Trt==0))
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ standardized_risk_score + company + Day15pseudoneutid50_BA.4.BA.5 + FOIstandardized, subset(dat.ocp,naive==1 & Trt==1))
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ Trt, subset(dat.ocp,naive==1 & company=="Pfz"))
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ Trt, subset(dat.ocp,naive==1 & company=="Mdn"))
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ Trt * company, subset(dat.ocp, naive==1))
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ I(1-Trt) * company, subset(dat.ocp, naive==1))
```


#### Pfizer

OC v P is significant among the naive but not among the non-naive.

```{r}

coxph(update(f, ~. + naive + Trt), dat.ocp.pfizer)
coxph(update(f, ~. + Trt), subset(dat.ocp.pfizer, naive==0))
coxph(update(f, ~. + Trt), subset(dat.ocp.pfizer, naive==1))

coxph(update(f, ~. + naive + Trt), dat.ocp.moderna)
coxph(update(f, ~. + Trt), subset(dat.ocp.moderna, naive==0))
coxph(update(f, ~. + Trt), subset(dat.ocp.moderna, naive==1))

coxph(update(f, ~. + Trt), subset(dat.ocp.moderna, naive==1))
coxph(update(f, ~. + Trt), subset(dat.ocp.pfizer, naive==1))


```




```{r}
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ I(1-Trt)*scale(standardized_risk_score), subset(dat.ocp.moderna, naive==1))
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ I(1-Trt)*scale(standardized_risk_score), subset(dat.ocp.pfizer, naive==1))

```

D15 marker 

```{r}
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ I(1-Trt)*scale(standardized_risk_score) + I(1-Trt)*scale(Day15pseudoneutid50_BA.4.BA.5), subset(dat.ocp.moderna, naive==1))
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ I(1-Trt)*scale(standardized_risk_score) + I(1-Trt)*scale(Day15pseudoneutid50_BA.4.BA.5), subset(dat.ocp.pfizer, naive==1))

coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ Trt*scale(standardized_risk_score) + Trt*scale(Day15pseudoneutid50_BA.4.BA.5), subset(dat.ocp.moderna, naive==1))
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ Trt*scale(standardized_risk_score) + Trt*scale(Day15pseudoneutid50_BA.4.BA.5), subset(dat.ocp.pfizer, naive==1))

coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ Trt*scale(standardized_risk_score) + scale(Day15pseudoneutid50_BA.4.BA.5), subset(dat.ocp.moderna, naive==1))
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ Trt+scale(standardized_risk_score) + scale(Day15pseudoneutid50_BA.4.BA.5), subset(dat.ocp.pfizer, naive==1))
```

BA4BA5-specific ID50 is significant correlate but not ancestral ID50.

```{r}

coxph(update(f, ~. + Trt * Bpseudoneutid50_BA.4.BA.5), dat.1)
coxph(update(f, ~. + Trt + Bpseudoneutid50_BA.4.BA.5), dat.1)

coxph(update(f, ~. + Trt * Day15pseudoneutid50_BA.4.BA.5), dat.1)
coxph(update(f, ~. + Trt + Day15pseudoneutid50_BA.4.BA.5), dat.1)


coxph(update(f, ~. + Trt * Bpseudoneutid50_D614G), dat.1)
coxph(update(f, ~. + Trt + Bpseudoneutid50_D614G), dat.1)

coxph(update(f, ~. + Trt * Day15pseudoneutid50_D614G), dat.1)
coxph(update(f, ~. + Trt + Day15pseudoneutid50_D614G), dat.1)

```

Distribution of D15 BA4BA5-specific ID50 is different between P and OC

```{r}
par(mfrow=c(1,2))
myboxplot(Bpseudoneutid50_BA.4.BA.5~Trt, dat.1, test="w")
myboxplot(Day15pseudoneutid50_BA.4.BA.5~Trt, dat.1, test="w")
```

Additional marker models

```{r}

coxph(update(f, ~. + Trt + Bpseudoneutid50_D614G + Day15pseudoneutid50_D614G + I(Day15pseudoneutid50_D614G^2)), dat.1)

coxph(update(f, ~. + Trt + Bpseudoneutid50_D614G * Day15pseudoneutid50_D614G), dat.1)

coxph(update(f, ~. + Trt + Bpseudoneutid50_D614G + Day15pseudoneutid50_D614G), dat.1)

coxph(update(f, ~. + Trt + Bpseudoneutid50_D614G), dat.1)

coxph(update(f, ~. + Trt + Day15pseudoneutid50_D614G), dat.1)



coxph(update(f, ~. + Trt + Bpseudoneutid50_BA.4.BA.5 + Day15pseudoneutid50_BA.4.BA.5 + I(Day15pseudoneutid50_BA.4.BA.5^2)), dat.1)

coxph(update(f, ~. + Trt + Bpseudoneutid50_BA.4.BA.5 * Day15pseudoneutid50_BA.4.BA.5), dat.1)

coxph(update(f, ~. + Trt + Bpseudoneutid50_BA.4.BA.5 + Day15pseudoneutid50_BA.4.BA.5), dat.1)

coxph(update(f, ~. + Trt + Bpseudoneutid50_BA.4.BA.5), dat.1)

coxph(update(f, ~. + Trt + Day15pseudoneutid50_BA.4.BA.5), dat.1)


```


#### Moderna
No treatment effect in either naive or non-naive.

```{r}
coxph(update(f, ~. + naive + Trt), dat.ocp.moderna)
coxph(update(f, ~. + naive + Trt), subset(dat.ocp.moderna, naive==0))
coxph(update(f, ~. + naive + Trt), subset(dat.ocp.moderna, naive==1))
```

Distribution of D15 BA4BA5-specific ID50 is different between P and OC

```{r}
par(mfrow=c(1,2))
myboxplot(Bpseudoneutid50_BA.4.BA.5~Trt, dat.1.moderna, test="w")
myboxplot(Day15pseudoneutid50_BA.4.BA.5~Trt, dat.1.moderna, test="w")
```

Among naive, there is significant interaction between Trt and D1 BA4BA5 ID50

```{r}

coxph(update(f, ~. + Trt * Bpseudoneutid50_BA.4.BA.5), dat.1.moderna)
coxph(update(f, ~. + Trt + Bpseudoneutid50_BA.4.BA.5), dat.1.moderna)

coxph(update(f, ~. + Trt * Day15pseudoneutid50_BA.4.BA.5), dat.1.moderna)
coxph(update(f, ~. + Trt + Day15pseudoneutid50_BA.4.BA.5), dat.1.moderna)


coxph(update(f, ~. + Trt * Bpseudoneutid50_D614G), dat.1.moderna)
coxph(update(f, ~. + Trt + Bpseudoneutid50_D614G), dat.1.moderna)

coxph(update(f, ~. + Trt * Day15pseudoneutid50_D614G), dat.1.moderna)
coxph(update(f, ~. + Trt + Day15pseudoneutid50_D614G), dat.1.moderna)

```


Additional marker models

```{r}

coxph(update(f, ~. + Trt + Bpseudoneutid50_D614G + Day15pseudoneutid50_D614G + I(Day15pseudoneutid50_D614G^2)), dat.1.moderna)

coxph(update(f, ~. + Trt + Bpseudoneutid50_D614G * Day15pseudoneutid50_D614G), dat.1.moderna)

coxph(update(f, ~. + Trt + Bpseudoneutid50_D614G + Day15pseudoneutid50_D614G), dat.1.moderna)

coxph(update(f, ~. + Trt + Bpseudoneutid50_D614G), dat.1.moderna)

coxph(update(f, ~. + Trt + Day15pseudoneutid50_D614G), dat.1.moderna)



coxph(update(f, ~. + Trt + Bpseudoneutid50_BA.4.BA.5 + Day15pseudoneutid50_BA.4.BA.5 + I(Day15pseudoneutid50_BA.4.BA.5^2)), dat.1.moderna)

coxph(update(f, ~. + Trt + Bpseudoneutid50_BA.4.BA.5 * Day15pseudoneutid50_BA.4.BA.5), dat.1.moderna)

coxph(update(f, ~. + Trt + Bpseudoneutid50_BA.4.BA.5 + Day15pseudoneutid50_BA.4.BA.5), dat.1.moderna)

coxph(update(f, ~. + Trt + Bpseudoneutid50_BA.4.BA.5), dat.1.moderna)

coxph(update(f, ~. + Trt + Day15pseudoneutid50_BA.4.BA.5), dat.1.moderna)


```


```{r}
coxph(update(f, ~.  + Day15pseudoneutid50_BA.4.BA.5), subset(dat.1.moderna, Trt==1))
coxph(update(f, ~.  + Day15pseudoneutid50_D614G), subset(dat.1.moderna, Trt==1))
```

#### Putting Pfizer and Moderna side by side

Omicron-specific antibodies are similar at D1, rise at D15, and more so when vaccines contain Omicron strains.

```{r}
par(mfrow=c(1,2))
myboxplot(Bpseudoneutid50_BA.4.BA.5~Trt+company, subset(dat.ocp, naive==1), cex.axis=.8)
myboxplot(Day15pseudoneutid50_BA.4.BA.5~Trt+company, subset(dat.ocp, naive==1), cex.axis=.8)
```

Ancestral antibodies are not quite similar at D1, rise at D15, but not more so when vaccines contain Omicron strains.

```{r}
par(mfrow=c(1,2))
myboxplot(Bpseudoneutid50_D614G~Trt+company, subset(dat.ocp, naive==1), cex.axis=.8)
myboxplot(Day15pseudoneutid50_D614G~Trt+company, subset(dat.ocp, naive==1), cex.axis=.8)
```


```{r}
fits=list()
fits[["Pfz,P"]] = coxph(update(f, ~.  + Day15pseudoneutid50_D614G), subset(dat.ocp, naive==1 & company=="Pfz" & Trt==0))
fits[["Pfz,O"]] = coxph(update(f, ~.  + Day15pseudoneutid50_D614G), subset(dat.ocp, naive==1 & company=="Pfz" & Trt==1))
fits[["Mdn,P"]] = coxph(update(f, ~.  + Day15pseudoneutid50_D614G), subset(dat.ocp, naive==1 & company=="Mdn" & Trt==0))
fits[["Mdn,O"]] = coxph(update(f, ~.  + Day15pseudoneutid50_D614G), subset(dat.ocp, naive==1 & company=="Mdn" & Trt==1))
tab = getFormattedSummary(fits, robust=F, type=5)
tab
```

Are risk scores distribution different?

```{r}
myboxplot(standardized_risk_score    ~Trt+company, subset(dat.ocp, naive==1), cex.axis=.8)
```
```{r}
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ standardized_risk_score*Trt, subset(dat.ocp, naive==1 & company=="Mdn"))
```

BA4BA5 marker. Three out of the four effect sizes are comparable to each other, but in the Moderna prototype arm there is no association between BA4BA5 marker and risk. This is quite intriguing - if we view each column above as a correlates analysis, we have three positive results and one negative result. 

```{r}
fits=list()
fits[["Pfz,P"]] = coxph(update(f, ~.  + Day15pseudoneutid50_BA.4.BA.5), subset(dat.ocp, naive==1 & company=="Pfz" & Trt==0))
fits[["Pfz,O"]] = coxph(update(f, ~.  + Day15pseudoneutid50_BA.4.BA.5), subset(dat.ocp, naive==1 & company=="Pfz" & Trt==1))
fits[["Mdn,P"]] = coxph(update(f, ~.  + Day15pseudoneutid50_BA.4.BA.5), subset(dat.ocp, naive==1 & company=="Mdn" & Trt==0))
fits[["Mdn,O"]] = coxph(update(f, ~.  + Day15pseudoneutid50_BA.4.BA.5), subset(dat.ocp, naive==1 & company=="Mdn" & Trt==1))
tab = getFormattedSummary(fits, robust=F, type=5)
tab
```

Correlation between ancestral and BA4BA5 ID50s in Pfz,P and Pfz,O separately
```{r}
par(mfrow=c(1,2))
lim=c(2.5,5.3)
corplot(Day15pseudoneutid50_BA.4.BA.5~Day15pseudoneutid50_D614G, subset(dat.ocp, naive==1 & company=="Pfz" & Trt==0), asp=1, xlim=lim, ylim=lim, main="Pfz, Prototype")
corplot(Day15pseudoneutid50_BA.4.BA.5~Day15pseudoneutid50_D614G, subset(dat.ocp, naive==1 & company=="Pfz" & Trt==1), asp=1, xlim=lim, ylim=lim, main="Pfz, Omicron")
```

### Risk models

ID50 Score
```{r}
dat$D1_id50=scale(dat$Bpseudoneutid50_MDW,scale=F)
dat$Day15_id50=scale(dat$Day15pseudoneutid50_MDW,scale=F)

coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ FOIstandardized + standardized_risk_score + naive + Day15_id50, dat)

coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ standardized_risk_score + naive + D1_id50 + Day15_id50 + I(Day15_id50^2), dat)
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ standardized_risk_score + naive + naive*(D1_id50 + Day15_id50 + I(Day15_id50^2)), dat)
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ standardized_risk_score + naive + naive*D1_id50 + Day15_id50 + I(Day15_id50^2), dat)
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ standardized_risk_score + naive + D1_id50 + naive*Day15_id50 + naive*I(Day15_id50^2), dat)
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ standardized_risk_score + naive + D1_id50 + Day15_id50 + naive*I(Day15_id50^2), dat)
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ standardized_risk_score + naive + D1_id50 + naive*Day15_id50 + I(Day15_id50^2), dat)
```


ID50 BA4BA5
```{r}
dat$D1_id50=scale(dat$Bpseudoneutid50_BA.4.BA.5,scale=F)
dat$Day15_id50=scale(dat$Day15pseudoneutid50_BA.4.BA.5,scale=F)

coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ standardized_risk_score + naive + naive*D1_id50 + Day15_id50 + I(Day15_id50^2), dat)
# filter out those with undetectable D1
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ standardized_risk_score + naive + naive*D1_id50 + Day15_id50 + I(Day15_id50^2), subset(dat, D1_id50 > -1.06))

# fit model to get inference for D1_id50 in the naive
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ standardized_risk_score + I(1-naive)*D1_id50 + Day15_id50 + I(Day15_id50^2), dat)
# filter out those with undetectable D1
coxph(Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ standardized_risk_score + I(1-naive)*D1_id50 + Day15_id50 + I(Day15_id50^2), subset(dat, D1_id50 > -1.06))

```

The effect of risk score is different between models with and without double naive (naive and with undetectable D1_id50).
```{r}
dat$D1_id50=scale(dat$Bpseudoneutid50_BA.4.BA.5,scale=F)

myboxplot(standardized_risk_score~I(1-naive)*I(D1_id50 > -1.06), dat, ylab="standardized_risk_score", names=c("N, D1 undet", "NN, D1 undet", "N, D1 det", "NN, D1 det"))

fit=lm(standardized_risk_score ~ I(1-naive) * I(D1_id50 > -1.06), dat); summary(fit)
fit=lm(standardized_risk_score ~ I(1-naive), subset(dat, D1_id50 <= -1.06)); summary(fit)
```




```{r}
f=Surv(COVIDtimeD22toD181, COVIDIndD22toD181) ~ FOIstandardized + standardized_risk_score

dat.ocp2=subset(dat_proc, ph1.D15==1 & treatment_assigned %in% c(
    "Wildtype/Prototype (Pfizer 1)"
  , "Omicron (Pfizer 1)"
  , "Omicron + Wildtype/Prototype (Pfizer 1)"
  # , "Omicron BA.4/5 + Prototype (Pfizer 2)"
  # , "Omicron BA.1 + Prototype (Pfizer 2)"
  )
)
dat.ocp2$Trt=ifelse(dat.ocp2$treatment_assigned == "Wildtype/Prototype (Pfizer 1)", 0, 1)

coxph(update(f, ~. + naive + Trt), dat.ocp2)
coxph(update(f, ~. + naive + Trt), subset(dat.ocp2, naive==0))
coxph(update(f, ~. + naive + Trt), subset(dat.ocp2, naive==1))

dat.1=subset(dat.ocp2, naive==1)
```




### B and D15 marker
```{r}

table(dat$Bpseudoneutid50_MDWcat, dat$Day15pseudoneutid50_MDWcat)

corplot(Day15pseudoneutid50_MDW~Bpseudoneutid50_MDW, dat, col=ifelse(dat$naive==1,1,2))

# fit demming regression
dat.n=subset(dat, naive==1)
dat.nn=subset(dat, naive==0)

fit.n =  Deming(dat.n$Bpseudoneutid50_MDW,  dat.n$Day15pseudoneutid50_MDW,  boot = TRUE)
fit.nn = Deming(dat.nn$Bpseudoneutid50_MDW, dat.nn$Day15pseudoneutid50_MDW, boot = TRUE)

summary(fit.n)
summary(fit.nn)

par(mfrow=c(2,1), mar=c(3,4,2,2))
lim=range(c(dat$Bpseudoneutid50_MDW, dat$Day15pseudoneutid50_MDW))
corplot(Day15pseudoneutid50_MDW~Bpseudoneutid50_MDW, dat.n, add.deming.fit = T, xlim=lim, ylim=lim, xlab="", main="Naive", method="pearson")
corplot(Day15pseudoneutid50_MDW~Bpseudoneutid50_MDW, dat.nn, add.deming.fit = T, xlim=lim, ylim=lim, main="Non-naive", method="pearson")
title(xlab="Bpseudoneutid50_MDW", line=2)
```


### distribution 

```{r}

table(dat$Bpseudoneutid50_MDWcat, dat$Day15pseudoneutid50_MDWcat)
table(dat$Bpseudoneutid50_MDWcat, dat$Day15pseudoneutid50_MDWcat, dat$naive)

# all cases have covid lineage observed
mytable(dat_proc$COVIDlineageObserved, dat_proc$COVIDlineage)
mytable(dat_proc$COVIDlineageObserved, dat_proc$COVIDIndD22toend)
```



### save the risk score from covail_data_processed_20240205.csv as a separate file that will be treated as the source of risk score

```{r}
dat1=read.csv("/trials/covpn/COVAILcorrelates/analysis/correlates/adata/covail_data_processed_20240205.csv")
write.csv(subset(dat1, select=c(Ptid, risk_score, standardized_risk_score)), row.names=F, file="/trials/covpn/COVAILcorrelates/analysis/correlates/adata/risk_score.csv")
```

There is a difference in risk score between 0205 and 0206 analysis ready datasets
```
dat1=read.csv("/trials/covpn/COVAILcorrelates/analysis/mapping_immune_correlates/adata/covail_mapped_data_20240205.csv")
dat2=read.csv("/trials/covpn/COVAILcorrelates/analysis/mapping_immune_correlates/adata/covail_mapped_data_20240206.csv")
nrow(dat1)
nrow(dat2)

cbind(dat1$COVIDIndD22toD181, dat2$COVIDIndD22toD181)[1:100,]


dat1=read.csv("/trials/covpn/COVAILcorrelates/analysis/correlates/adata/covail_data_processed_20240205.csv")
dat2=read.csv("/trials/covpn/COVAILcorrelates/analysis/correlates/adata/covail_data_processed_20240206.csv")
dat3=read.csv("/trials/covpn/COVAILcorrelates/analysis/correlates/adata/covail_data_processed_20240211.csv")
nrow(dat1)
nrow(dat2)
nrow(dat3)

with(subset(dat1,ph1.D15==1), fastauc(risk_score, COVIDIndD22toD181))
with(subset(dat2,ph1.D15==1), fastauc(risk_score, COVIDIndD22toD181))


dat1=read.csv("/trials/covpn/COVAILcorrelates/analysis/mapping_immune_correlates/adata/covail_mapped_data_20240208.csv")
dat2=read.csv("/trials/covpn/COVAILcorrelates/analysis/mapping_immune_correlates/adata/covail_mapped_data_20240211.csv")

rbind(dat1[16,-182],dat2[16,]) # COVIDtimeD22toend

setdiff(names(dat1), names(dat2))

mytable(dat2$COVIDIndD92toD181, dat2$COVIDtimeD92toD181)
```

### sanofi markers

```{r}
with(dat_mapped, table(treatment_actual %in% c("Beta (Sanofi)", "Beta + Prototype (Sanofi)", "Prototype (Sanofi)"), TrtSanofi))

summary(dat.sanofi[,c("Day29"%.%assays[1:5])])

summary(dat.sanofi[,c("Day15"%.%assays[1:5])])

with(subset(dat_mapped, TrtSanofi==1), mytable(naive, COVIDIndD36toD181))
with(subset(dat_mapped, TrtSanofi==1), mytable(naive, COVIDIndD22toD181))

```

Correlation is high between BA4BA5 ID50 and ancestral ID50 in both naive and nnaive (higher in the latter)

```{r}
par(mfrow=c(1,2))
lim=c(2.5,5.3)
corplot(Day15pseudoneutid50_BA.4.BA.5~Day15pseudoneutid50_D614G, subset(dat.sanofi, naive==1), asp=1, xlim=lim, ylim=lim, main="COVAIL Sanofi Naive")
corplot(Day15pseudoneutid50_BA.4.BA.5~Day15pseudoneutid50_D614G, dat.sanofi, asp=1, xlim=lim, ylim=lim, main="COVAIL Sanofi")
# corplot(Day15pseudoneutid50_BA.4.BA.5~Day15pseudoneutid50_D614G, subset(dat.sanofi, naive==0), asp=1, xlim=lim, ylim=lim)
```

Comparing with Pfz,P in the naive
```{r}
par(mfrow=c(2,2))
lim=c(1.2,5.5)
myboxplot(list(subset(dat.sanofi, naive==1, Day15pseudoneutid50_D614G, drop=T),
               subset(dat.ocp, naive==1 & company=="Pfz" & Trt==0,Day15pseudoneutid50_D614G, drop=T)), test="w", main="D15 Ancestral ID50", ylim=lim, names=c("Sanofi, naive", "Pfz,P, naive"), ylab="")
myboxplot(list(subset(dat.sanofi, naive==1, Day15pseudoneutid50_BA.4.BA.5, drop=T),
               subset(dat.ocp, naive==1 & company=="Pfz" & Trt==0,Day15pseudoneutid50_BA.4.BA.5, drop=T)), test="w", main="D15 BA4BA5 ID50", ylim=lim, names=c("Sanofi, naive", "Pfz,P, naive"), ylab="")

corplot(Day15pseudoneutid50_BA.4.BA.5~Day15pseudoneutid50_D614G, subset(dat.sanofi, naive==1), asp=1, xlim=lim, ylim=lim, main="Sanofi Naive")
corplot(Day15pseudoneutid50_BA.4.BA.5~Day15pseudoneutid50_D614G, subset(dat.ocp, naive==1 & company=="Pfz" & Trt==0, c(Day15pseudoneutid50_D614G, Day15pseudoneutid50_BA.4.BA.5)), asp=1, xlim=lim, ylim=lim, main="Pfz,P Naive")

```


Comparing with Pfz,P in the naive, separately by Sanofi,P and Sanofi,NP
```{r}
par(mfrow=c(1,3))
corplot(Day15pseudoneutid50_BA.4.BA.5~Day15pseudoneutid50_D614G, subset(dat.sanofi, naive==1 & treatment_actual=="Prototype (Sanofi)"), asp=1, xlim=lim, ylim=lim, main="Sanofi,P Naive")
corplot(Day15pseudoneutid50_BA.4.BA.5~Day15pseudoneutid50_D614G, subset(dat.sanofi, naive==1 & treatment_actual!="Prototype (Sanofi)"), asp=1, xlim=lim, ylim=lim, main="Sanofi,NP Naive")
corplot(Day15pseudoneutid50_BA.4.BA.5~Day15pseudoneutid50_D614G, subset(dat.ocp, naive==1 & company=="Pfz" & Trt==0, c(Day15pseudoneutid50_D614G, Day15pseudoneutid50_BA.4.BA.5)), asp=1, xlim=lim, ylim=lim, main="Pfz,P Naive")

```


Comparing with Pfz,P in the non-naive
```{r}
par(mfrow=c(2,2))
lim=c(1.2,5.5)
myboxplot(list(subset(dat.sanofi, naive==0, Day15pseudoneutid50_D614G, drop=T),
               subset(dat.ocp, naive==0 & company=="Pfz" & Trt==0,Day15pseudoneutid50_D614G, drop=T)), test="w", main="D15 Ancestral ID50", ylim=lim, names=c("Sanofi, Non-naive", "Pfz,P, Non-naive"), ylab="")
myboxplot(list(subset(dat.sanofi, naive==0, Day15pseudoneutid50_BA.4.BA.5, drop=T),
               subset(dat.ocp, naive==0 & company=="Pfz" & Trt==0,Day15pseudoneutid50_BA.4.BA.5, drop=T)), test="w", main="D15 BA4BA5 ID50", ylim=lim, names=c("Sanofi, Non-naive", "Pfz,P, Non-naive"), ylab="")

corplot(Day15pseudoneutid50_BA.4.BA.5~Day15pseudoneutid50_D614G, subset(dat.sanofi, naive==0), asp=1, xlim=lim, ylim=lim, main="Sanofi Non-naive")
corplot(Day15pseudoneutid50_BA.4.BA.5~Day15pseudoneutid50_D614G, subset(dat.ocp, naive==0 & company=="Pfz" & Trt==0, c(Day15pseudoneutid50_D614G, Day15pseudoneutid50_BA.4.BA.5)), asp=1, xlim=lim, ylim=lim, main="Pfz,P Non-naive")

```

Baseline correlation, in the naive

```{r}
par(mfrow=c(2,2))
lim=c(1.2,5.5)
myboxplot(list(subset(dat.sanofi, naive==1, Bpseudoneutid50_D614G, drop=T),
               subset(dat.ocp, naive==1 & company=="Pfz" & Trt==0,Bpseudoneutid50_D614G, drop=T)), test="w", main="D1 Ancestral ID50", ylim=lim, names=c("Sanofi, naive", "Pfz,P, naive"), ylab="")
myboxplot(list(subset(dat.sanofi, naive==1, Bpseudoneutid50_BA.4.BA.5, drop=T),
               subset(dat.ocp, naive==1 & company=="Pfz" & Trt==0,Bpseudoneutid50_BA.4.BA.5, drop=T)), test="w", main="D1 BA4BA5 ID50", ylim=lim, names=c("Sanofi, naive", "Pfz,P, naive"), ylab="")

corplot(Bpseudoneutid50_BA.4.BA.5~Bpseudoneutid50_D614G, subset(dat.sanofi, naive==1), asp=1, xlim=lim, ylim=lim, main="Sanofi Naive")
corplot(Bpseudoneutid50_BA.4.BA.5~Bpseudoneutid50_D614G, subset(dat.ocp, naive==1 & company=="Pfz" & Trt==0, c(Bpseudoneutid50_D614G, Bpseudoneutid50_BA.4.BA.5)), asp=1, xlim=lim, ylim=lim, main="Pfz,P Naive")

```


Baseline correlation, in the non-naive
```{r}
par(mfrow=c(2,2))
lim=c(1.2,5.5)
myboxplot(list(subset(dat.sanofi, naive==0, Bpseudoneutid50_D614G, drop=T),
               subset(dat.ocp, naive==0 & company=="Pfz" & Trt==0,Bpseudoneutid50_D614G, drop=T)), test="w", main="D1 Ancestral ID50", ylim=lim, names=c("Sanofi, Non-naive", "Pfz,P, Non-naive"), ylab="")
myboxplot(list(subset(dat.sanofi, naive==0, Bpseudoneutid50_BA.4.BA.5, drop=T),
               subset(dat.ocp, naive==0 & company=="Pfz" & Trt==0,Bpseudoneutid50_BA.4.BA.5, drop=T)), test="w", main="D1 BA4BA5 ID50", ylim=lim, names=c("Sanofi, Non-naive", "Pfz,P, Non-naive"), ylab="")

corplot(Bpseudoneutid50_BA.4.BA.5~Bpseudoneutid50_D614G, subset(dat.sanofi, naive==0), asp=1, xlim=lim, ylim=lim, main="Sanofi Non-naive")
corplot(Bpseudoneutid50_BA.4.BA.5~Bpseudoneutid50_D614G, subset(dat.ocp, naive==0 & company=="Pfz" & Trt==0, c(Bpseudoneutid50_D614G, Bpseudoneutid50_BA.4.BA.5)), asp=1, xlim=lim, ylim=lim, main="Pfz,P Non-naive")

```


Interaction plot, naive
```{r}
par(mfrow=c(1,2))
lim=c(1.2,4.8)
# myboxplot(subset(dat.sanofi, naive==1, c(Day15pseudoneutid50_D614G, Day15pseudoneutid50_BA.4.BA.5)), names=c("ancestral", "BA4BA5"), main="Sanofi, naive", add.interaction=T)
# myboxplot(subset(dat.ocp, naive==1 & company=="Pfz" & Trt==0, c(Day15pseudoneutid50_D614G, Day15pseudoneutid50_BA.4.BA.5)), names=c("ancestral", "BA4BA5"), main="Pfz,P, naive", add.interaction=T)

```

Correlation of fold change between ancestral and BA4BA5

```{r}
dat.sanofi$Day15overBpseudoneutid50_BA.4.BA.5 = dat.sanofi$Day15pseudoneutid50_BA.4.BA.5 - dat.sanofi$Bpseudoneutid50_BA.4.BA.5
dat.sanofi$Day15overBpseudoneutid50_D614G = dat.sanofi$Day15pseudoneutid50_D614G - dat.sanofi$Bpseudoneutid50_D614G
dat.ocp$Day15overBpseudoneutid50_BA.4.BA.5 = dat.ocp$Day15pseudoneutid50_BA.4.BA.5 - dat.ocp$Bpseudoneutid50_BA.4.BA.5
dat.ocp$Day15overBpseudoneutid50_D614G = dat.ocp$Day15pseudoneutid50_D614G - dat.ocp$Bpseudoneutid50_D614G
dat.sanofi$Day29overBpseudoneutid50_BA.4.BA.5 = dat.sanofi$Day29pseudoneutid50_BA.4.BA.5 - dat.sanofi$Bpseudoneutid50_BA.4.BA.5
dat.sanofi$Day29overBpseudoneutid50_D614G = dat.sanofi$Day29pseudoneutid50_D614G - dat.sanofi$Bpseudoneutid50_D614G
dat.ocp$Day29overBpseudoneutid50_BA.4.BA.5 = dat.ocp$Day29pseudoneutid50_BA.4.BA.5 - dat.ocp$Bpseudoneutid50_BA.4.BA.5
dat.ocp$Day29overBpseudoneutid50_D614G = dat.ocp$Day29pseudoneutid50_D614G - dat.ocp$Bpseudoneutid50_D614G
```

Correlation between D15 over D1 fold change in ancestral and BA4BA5 ID50.

```{r}
par(mfrow=c(1,3))
lim1=c(0,3.3)
corplot(Day15overBpseudoneutid50_BA.4.BA.5~Day15overBpseudoneutid50_D614G, subset(dat.sanofi, naive==1 & treatment_actual=="Prototype (Sanofi)"), asp=1, xlim=lim1, ylim=lim1, main="Sanofi Prototype Naive")
corplot(Day15overBpseudoneutid50_BA.4.BA.5~Day15overBpseudoneutid50_D614G, subset(dat.sanofi, naive==1 & treatment_actual!="Prototype (Sanofi)" & Day15overBpseudoneutid50_D614G<3), asp=1, xlim=lim1, ylim=lim1, main="Sanofi Beta-containing Naive")
corplot(Day15overBpseudoneutid50_BA.4.BA.5~Day15overBpseudoneutid50_D614G, subset(dat.ocp, naive==1 & company=="Pfz" & Trt==0), asp=1, xlim=lim1, ylim=lim1, main="Pfz,P, naive")

```

D29 over D1

```{r}
par(mfrow=c(1,3))
lim1=c(0,3.3)
corplot(Day29overBpseudoneutid50_BA.4.BA.5~Day29overBpseudoneutid50_D614G, subset(dat.sanofi, naive==1 & treatment_actual=="Prototype (Sanofi)"), asp=1, xlim=lim1, ylim=lim1, main="Sanofi Prototype Naive")
corplot(Day29overBpseudoneutid50_BA.4.BA.5~Day29overBpseudoneutid50_D614G, subset(dat.sanofi, naive==1 & treatment_actual!="Prototype (Sanofi)" & Day29overBpseudoneutid50_D614G<3), asp=1, xlim=lim1, ylim=lim1, main="Sanofi Beta-containing Naive")
corplot(Day29overBpseudoneutid50_BA.4.BA.5~Day29overBpseudoneutid50_D614G, subset(dat.ocp, naive==1 & company=="Pfz" & Trt==0), asp=1, xlim=lim1, ylim=lim1, main="Pfz,P, naive")

```


comparing fold change between different Sanofi arms
```{r}
par(mfrow=c(1,2))
myboxplot(list(
  subset(dat.sanofi, naive==1 & treatment_actual=="Prototype (Sanofi)", Day15overBpseudoneutid50_BA.4.BA.5, drop=T),
  subset(dat.sanofi, naive==1 & treatment_actual!="Prototype (Sanofi)", Day15overBpseudoneutid50_BA.4.BA.5, drop=T)), test="w", names=c("Prototype", "Non-prototype"))

myboxplot(list(
  subset(dat.sanofi, naive==1 & treatment_actual=="Prototype (Sanofi)", Day15overBpseudoneutid50_D614G, drop=T),
  subset(dat.sanofi, naive==1 & treatment_actual!="Prototype (Sanofi)", Day15overBpseudoneutid50_D614G, drop=T)), test="w", names=c("Prototype", "Non-prototype"))


```

Comparing D29 and D15. Quite comparable

```{r}
par(mfrow=c(1,2))
lim1=NULL
corplot(Day29pseudoneutid50_BA.4.BA.5~Day15pseudoneutid50_BA.4.BA.5, subset(dat.sanofi, naive==1 & treatment_actual=="Prototype (Sanofi)"), asp=1, xlim=lim1, ylim=lim1, main="Sanofi,P Naive")
corplot(Day29pseudoneutid50_BA.4.BA.5~Day15pseudoneutid50_BA.4.BA.5, subset(dat.sanofi, naive==1 & treatment_actual!="Prototype (Sanofi)"), asp=1, xlim=lim1, ylim=lim1, main="Sanofi,NP Naive")

```


### correlation between m15 and baseline markers

```{r}
# mypairs(dat[,paste0("B",assays)])

# mypairs(dat[,paste0("Day15",assays)])

# mypairs(dat[,paste0(c("B","Day15", "Delta15overB"),assays[1])])
```


### marker missingness

```{r}
table(dat_proc$AsympInfectIndD15to29, dat_proc$ph1.D15)

table(dat_proc$arm, dat_proc$ph1.D15)

table(dat_mapped$ph1.D15, dat_mapped$Immunemarkerset, dat_mapped$arm==3)


# across assays, all or none
summary(subset(dat_mapped, ph1.D15==1)["Day15"%.%assays[1:5]])
summary(subset(dat_mapped, ph1.D15==1)["Day29"%.%assays[1:5]])
summary(subset(dat_mapped, ph1.D15==1)["Day91"%.%assays[1:5]])
summary(subset(dat_mapped, ph1.D15==1)["Day181"%.%assays[1:5]])

summary(subset(dat_proc, ph1.D15 & is.na(Day29pseudoneutid50_D614G))["Day29"%.%assays[1:5]])
summary(subset(dat_proc, ph1.D15 & is.na(Day91pseudoneutid50_D614G))["Day91"%.%assays[1:5]])
summary(subset(dat_proc, ph1.D15 & is.na(Day181pseudoneutid50_D614G))["Day181"%.%assays[1:5]])

dat_proc$kp = dat_proc$ph1.D15==1 & dat_proc$COVIDIndD22toend!=1 & dat_proc$AsympInfectIndD15to271!=1 
dat_proc$kp = dat_proc$ph1.D15==1 
for (i in 1:1) {
  with(dat_proc[dat_proc$kp,], print(table(!is.na(get("Day29"%.%assays[i])), !is.na(get("Day15"%.%assays[i])))))
  with(dat_proc[dat_proc$kp,], print(table(!is.na(get("Day91"%.%assays[i])), !is.na(get("Day15"%.%assays[i])))))
  with(dat_proc[dat_proc$kp,], print(table(!is.na(get("Day181"%.%assays[i])), !is.na(get("Day15"%.%assays[i])))))
}


myboxplot(
list(dat_proc$Day15pseudoneutid50_MDW[dat_proc$treatment_actual=="Omicron + Wildtype/Prototype (Pfizer 1)"], 
     dat_proc$Day15pseudoneutid50_MDW[dat_proc$treatment_actual=="1 Dose Omicron + Prototype (Moderna)"])
)

myboxplot(
  list(dat_proc$Day15pseudoneutid50_D614G[dat_proc$treatment_actual=="Omicron + Wildtype/Prototype (Pfizer 1)"], 
       dat_proc$Day15pseudoneutid50_D614G[dat_proc$treatment_actual=="1 Dose Omicron + Prototype (Moderna)"])
)
# my.interaction.plot(subset(dat_proc, ph1==1, 
#                            c(Bpseudoneutid50_BA.1, Day15pseudoneutid50_BA.1)), 
#                     x.ori = 0, xaxislabels = c("B", "D15"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  
# 
# my.interaction.plot(subset(dat_proc, ph1==1, 
#                            c(Day15pseudoneutid50_BA.1, Day29pseudoneutid50_BA.1)), 
#                     x.ori = 1, xaxislabels = c("D15", "D29"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  
# 
# my.interaction.plot(subset(dat_proc, ph1==1, 
#                            c(Day29pseudoneutid50_BA.1, Day91pseudoneutid50_BA.1)), 
#                     x.ori = 2, xaxislabels = c("D29", "D91"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  
# 
# my.interaction.plot(subset(dat_proc, ph1==1, 
#                            c(Day91pseudoneutid50_BA.1, Day181pseudoneutid50_BA.1)), 
#                     x.ori = 3, xaxislabels = c("D91", "D181"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  
# 
```





### marker level over time
```{r}

par(mfrow=c(4,1), mar=c(2,4,1,1))

dat_proc$ph1 = dat_proc$ph1.D15==1 & dat_proc$COVIDIndD22toend!=1 & dat_proc$AsympInfectIndD15to181!=1 & dat_proc$AsympInfectIndD182to271!=1

plot(0,0,type='n', xlim=c(1,5), ylim=c(1,5), xaxt="n", xlab="", ylab="ID50_BA.1")

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1<1.5, 
                           c(Bpseudoneutid50_BA.1, Day15pseudoneutid50_BA.1)), 
                    x.ori = 0, xaxislabels = c("B", "D15"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1<1.5, 
                           c(Day15pseudoneutid50_BA.1, Day29pseudoneutid50_BA.1)), 
                    x.ori = 1, xaxislabels = c("D15", "D29"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1<1.5, 
                           c(Day29pseudoneutid50_BA.1, Day91pseudoneutid50_BA.1)), 
                    x.ori = 2, xaxislabels = c("D29", "D91"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1<1.5, 
                           c(Day91pseudoneutid50_BA.1, Day181pseudoneutid50_BA.1)), 
                    x.ori = 3, xaxislabels = c("D91", "D181"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  


plot(0,0,type='n', xlim=c(1,5), ylim=c(1,5), xaxt="n", xlab="", ylab="ID50_BA.1")

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1>1.5, 
                           c(Bpseudoneutid50_BA.1, Day15pseudoneutid50_BA.1)), 
                    x.ori = 0, xaxislabels = c("B", "D15"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1>1.5, 
                           c(Day15pseudoneutid50_BA.1, Day29pseudoneutid50_BA.1)), 
                    x.ori = 1, xaxislabels = c("D15", "D29"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1>1.5, 
                           c(Day29pseudoneutid50_BA.1, Day91pseudoneutid50_BA.1)), 
                    x.ori = 2, xaxislabels = c("D29", "D91"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1>1.5, 
                           c(Day91pseudoneutid50_BA.1, Day181pseudoneutid50_BA.1)), 
                    x.ori = 3, xaxislabels = c("D91", "D181"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  



dat_proc$ph1 = dat_proc$ph1.D92 & dat_proc$ph1.D15==1 & dat_proc$COVIDIndD22toend!=1 & dat_proc$AsympInfectIndD15to181!=1 & dat_proc$AsympInfectIndD182to271!=1

plot(0,0,type='n', xlim=c(1,5), ylim=c(1,5), xaxt="n", xlab="", ylab="ID50_BA.1")

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1<1.5, 
                           c(Bpseudoneutid50_BA.1, Day15pseudoneutid50_BA.1)), 
                    x.ori = 0, xaxislabels = c("B", "D15"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1<1.5, 
                           c(Day15pseudoneutid50_BA.1, Day29pseudoneutid50_BA.1)), 
                    x.ori = 1, xaxislabels = c("D15", "D29"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1<1.5, 
                           c(Day29pseudoneutid50_BA.1, Day91pseudoneutid50_BA.1)), 
                    x.ori = 2, xaxislabels = c("D29", "D91"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1<1.5, 
                           c(Day91pseudoneutid50_BA.1, Day181pseudoneutid50_BA.1)), 
                    x.ori = 3, xaxislabels = c("D91", "D181"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  


plot(0,0,type='n', xlim=c(1,5), ylim=c(1,5), xaxt="n", xlab="", ylab="ID50_BA.1")

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1>1.5, 
                           c(Bpseudoneutid50_BA.1, Day15pseudoneutid50_BA.1)), 
                    x.ori = 0, xaxislabels = c("B", "D15"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1>1.5, 
                           c(Day15pseudoneutid50_BA.1, Day29pseudoneutid50_BA.1)), 
                    x.ori = 1, xaxislabels = c("D15", "D29"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1>1.5, 
                           c(Day29pseudoneutid50_BA.1, Day91pseudoneutid50_BA.1)), 
                    x.ori = 2, xaxislabels = c("D29", "D91"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  

my.interaction.plot(subset(dat_proc, ph1==1 & Bpseudoneutid50_BA.1>1.5, 
                           c(Day91pseudoneutid50_BA.1, Day181pseudoneutid50_BA.1)), 
                    x.ori = 3, xaxislabels = c("D91", "D181"), cex.axis = 1, add = T, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  




sum(dat_proc$ph1.D15==1)

dat_proc$kp = dat_proc$ph1.D15==1 & dat_proc$COVIDIndD22toend!=1 & dat_proc$AsympInfectIndD15to271!=1 &
  !is.na(dat_proc$Day29pseudoneutid50_D614G) & !is.na(dat_proc$Day91pseudoneutid50_D614G) & !is.na(dat_proc$Day181pseudoneutid50_D614G) 

nrow(subset(dat_proc, kp))

nrow(subset(dat_proc, kp & Bpseudoneutid50_BA.1>1.5))

nrow(subset(dat_proc, kp & Bpseudoneutid50_BA.1<1.5))
```


### Misc

```{r check data processing}
datold = read.csv("~/correlates_processing/data_clean/csv/covail_data_processed_20241007.csv")
datnew = read.csv("~/correlates_processing/data_clean/csv/covail_data_processed_20250423.csv")

assays = c("pseudoneutid50_D614G", "pseudoneutid50_Delta", "pseudoneutid50_Beta", "pseudoneutid50_BA.1", "pseudoneutid50_BA.4.BA.5", "pseudoneutid50_MDW")
all.markers = c("B"%.%assays, "Day15"%.%assays, "Delta15overB"%.%assays)

sapply (all.markers, function (a) {
  all(datold[[a]]==datnew[[a]], na.rm=T)
})
```

```{r}
myboxplot(dat_mapped[, c("B"%.%assays[1:5], "Day15"%.%assays[1:5])], names=sub("pseudoneutid50_", "", rep(assays[1:5],2)))



summary(dat_mapped)
sort(names(dat_mapped))

table(dat_mapped$treatment_actual, dat_mapped$stage)

with(subset(dat, ph1.D15==1 & COVIDIndD22toD181), mytable(treatment_actual, COVIDlineageObserved))

table(dat_mapped$Immunemarkerset, dat_mapped$Perprotocol, useNA='ifany')
table(dat_mapped$Immunemarkerset, dat_mapped$eligibility_deviation, useNA='ifany')



```
