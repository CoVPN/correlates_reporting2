---
title: "PREVENT-19 Correlates"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(survey)
library(kyotil)
library(readxl)

dat_mapped=read.csv('/trials/covpn/p3004/analysis/mapping_immune_correlates/stage1/adata/COVID_Novavax_realdata_20240305.csv')
dat_mapped$EarlyendpointD35 <- with(dat_mapped, EarlyinfectionD35==1 | (EventIndPrimaryD1==1 & EventTimePrimaryD1 < NumberdaysD1toD35 + 7),1,0)
dat_mapped$ph1.D35 = with(dat_mapped, EarlyendpointD35==0 & Perprotocol==1 & EventTimePrimaryD35 >= 7)

dat_proc=read.csv('/trials/covpn/p3004/analysis/correlates/Part_A_Blinded_Phase_Data/adata/prevent19_data_processed_20240307.csv')

dat_raw=read_excel('/trials/covpn/p3004/download_data/formatted_for_fred_hutch.xlsx')
```

## Stage 1 bindNVXIgG correlate

A decision is made to use the same clinical database that was used in the original correlates paper, and not use the updated clinical database. The updated database includes some late changes, e.g. US147-0424 is a case in the new database. For the stage 2 study, we will use the updated clinical database. 
```{r}
subset(dat_mapped, Subjectid=="2019nCoV301-US147-0424")
```

There are 1750 subjects (with the new marker), of which 1710 belong to the original Stage 1 dataset. 
```{r}
mytable(!is.na(dat_raw[,"IGG Day 35"]))
sum(("2019nCoV301-"%.%dat_raw[,1,drop=T]) %in% dat_mapped$Subjectid)
```

There are 15 cases in the vaccine arm, US, baseline negative, 12 out of which are in ph1.D35 and have both bindSpike and bindNVXIgG. For the non-cases, 186 from the subcohort have bindNVXIgG, but 1462 outside the subcohort have bindNVXIgG. 
```{r}
with(subset(dat_proc, ph1.D35 & Trt==1 & Bserostatus==0 & Country==0), mytable(!is.na(Day35bindSpike), !is.na(Day35bindNVXIgG), EventIndPrimaryD1))
```
Because the sampling for bindNVXIgG factors in the strata for the subcohort sampling, we will use 1648 non-cases and compute weights 
```{r}
with(subset(dat_proc, ph1.D35 & Trt==1 & Country==0 & Bserostatus==0), mytable(ph2.D35NVX, Wstratum))
```



Correlation between bindNVXIgG and USG bindSpike
```{r}
with(subset(dat_mapped, ph1.D35 & Trt==1), mypairs(cbind(Day35bindSpike, Day35bindNVXIgG)))
```


The smallest value of NVX IgG is 100, consistent with LLOQ being 200. The unit EU (ELISA Unit), which can be divided by 22 to get IU. Should we? Pos.cutoff is set to 500 according to Iksung, ULOQ is set to 2,904,275 EU/mL.
```{r}
10**(sort(dat_mapped$Day35bindNVXIgG)[1:20])
```

