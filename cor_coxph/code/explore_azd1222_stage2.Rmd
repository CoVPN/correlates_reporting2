---
title: "AZD1222 Stage 2"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(survey)
library(kyotil)

dat_mapped=read.csv('/trials/covpn/p3002/analysis/mapping_immune_correlates/stage2/adata/COVID_AstraZeneca_stage2_mapped_20240313.csv')
dat_mapped_stage1=read.csv('/trials/covpn/p3002/analysis/mapping_immune_correlates/stage1/adata/COVID_AstraZeneca_realdata_20221208.csv')
 
dat_mapped$EarlyendpointD57 <- with(dat_mapped, EarlyinfectionD57==1 | (EventIndPrimaryD1==1 & EventTimePrimaryD1 < NumberdaysD1toD57 + 7),1,0)
dat_mapped$ph1.D57 = with(dat_mapped, EarlyendpointD57==0 & Perprotocol==1 & EventTimePrimaryD57 >= 7)

assay_metadata=read.csv('~/correlates_reporting2/assay_metadata/azd1222_stage2_assay_metadata.csv')
assays=assay_metadata$assay

# dat_proc = read.csv('/trials/covpn/p3003/analysis/correlates/Part_A_Blinded_Phase_Data/adata/janssen_partA_VL_data_processed_20240126.csv')

```


Only the vaccine arm is sampled. 
```{r}
mytable(dat_mapped$ph1.indicator, dat_mapped$Stage2_sampling_list, dat_mapped$Trt)
```

Verifying marker values are subject to lower limits
```{r}
print(sort(unique(dat_mapped$Day57pseudoneutid50_D614G))[1:5])
print(sort(unique(dat_mapped$Day57pseudoneutid50_Delta))[1:5])
```

Correlation between ancestral ID50 and Delta ID50

```{r}
corplot(Day57pseudoneutid50_D614G~Day57pseudoneutid50_Delta, dat_mapped, asp=1)
```


Number of severe cases in ph1 and ph2
```{r}
with(subset(dat_mapped, EarlyinfectionD57==0 & Perprotocol==1 & Bserostatus==0 & Trt==1), mytable(!is.na(Day57bindSpike_Delta3), SevereEventIndD57_7to303))
with(subset(dat_mapped, EarlyinfectionD57==0 & Perprotocol==1 & Bserostatus==0 & Trt==1), mytable(!is.na(Day57bindSpike_Delta3), SevereEventIndD57_7to119))
with(subset(dat_mapped, EarlyinfectionD57==0 & Perprotocol==1 & Bserostatus==0 & Trt==1), mytable(!is.na(Day57bindSpike_Delta3), SevereEventIndD57_120to303))
```

Number of Delta cases in D57_120to303 in ph1 and ph2
```{r}
with(subset(dat_mapped, EarlyinfectionD57==0 & Perprotocol==1 & Bserostatus==0 & Trt==1), mytable(!is.na(Day57bindSpike_Delta3), DeltaEventIndD57_120to303))
```


\vspace{1in}

Distribution of event time by variant types. Severe cases are red, cases with markers are green. Will add another plot using calendar date when that info is added to the mapped data

```{r, echo=F}
dat_mapped$EventIndPrimaryType_short=substr(dat_mapped$EventIndPrimaryType,1,3)
dat_mapped$EventIndPrimaryType_short=ifelse(dat_mapped$EventIndPrimaryType_short=="", NA,dat_mapped$EventIndPrimaryType_short)
dat_mapped$EventIndPrimaryType_short=ifelse(is.na(dat_mapped$EventIndPrimaryType_short) & dat_mapped$EventIndPrimaryD1==1, "Unk",dat_mapped$EventIndPrimaryType_short)

dat.tmp=subset(dat_mapped, EarlyinfectionD57==0 & Perprotocol==1 & Bserostatus==0 & Trt==1)
myboxplot(EventTimePrimaryD57~EventIndPrimaryType_short, dat.tmp, ylab="EventTimePrimary57", col=ifelse(dat.tmp$SevereEventIndD57_7to303==1,2,ifelse(!is.na(dat.tmp$Day57bindSpike_Delta3),3,1)), cex.axis=0.8)
abline(h=120, lty=2) 

# subset(dat_mapped,EventIndPrimaryType_short=="Del" & as.Date(DateDD1)<as.Date("2021-01-01"), c(Subjectid, EventTimePrimaryDate, DateDD1))
```

We chose 120 days post D57 to break the follow-up period into two because all Delta cases happened after that.
```{r}
min(subset(dat_mapped,EventIndPrimaryType_short=="Del",EventTimePrimaryD57),na.rm=T)
```


Note that DateDD1 is defined by Yiwen and corresponds to the first illness visit in the clinical database. It does not seem to match the primary event date. 