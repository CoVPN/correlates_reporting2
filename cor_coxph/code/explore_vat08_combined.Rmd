---
title: "VAT08 Stage 1 and 2 Data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)

library(survey)
library(kyotil)

country.codes=c("Colombia", "Ghana", "Honduras", "India", "Japan", "Kenya", "Nepal", "United States", "Mexico", "Uganda", "Ukraine")
region.1 = c( # stage 1
  "United States" = 1, "Japan" = 1, 
  "Colombia" = 2, "Honduras" = 2, 
  "Ghana" = 3, "Kenya" = 3, 
  "Nepal" = 4, "India" = 4)
region.2 = c( # stage 2
  "Colombia" = 1, "Mexico" = 1, 
  "Ghana" = 2, "Kenya" = 2, "Uganda" = 2,
  "Nepal" = 3, "India" = 3)


dat_mapped=read.csv('/trials/covpn/p3005/analysis/mapping_immune_correlates/combined/adata/COVID_Sanofi_stage1and2_mapped_20240807_hotdeck.csv')
dat_mapped$EventIndPrimaryD1 = dat_mapped$EventIndFirstInfectionD1
dat_mapped$EventTimePrimaryD1 = dat_mapped$EventTimeFirstInfectionD1
dat_mapped$EventIndPrimaryD43= dat_mapped$EventIndFirstInfectionD43
dat_mapped$EventTimePrimaryD43= dat_mapped$EventTimeFirstInfectionD43
dat_mapped$EarlyendpointD43 <- with(dat_mapped, EarlyinfectionD43==1 | (EventIndPrimaryD1==1 & EventTimePrimaryD1 < NumberdaysD1toD43 + 7),1,0)
dat_mapped$ph1.D43= with(dat_mapped, EarlyendpointD43==0 & Perprotocol==1 & EventTimePrimaryD43 >= 7)
dat_mapped$ph1.D22= with(dat_mapped, EarlyinfectionD22==0 & Perprotocol==1 & EventTimeFirstInfectionD22 >= 7)
dat_mapped$Senior=ifelse(dat_mapped$Age>=60,1,0)
dat_mapped$cc = country.codes[dat_mapped$Country]
# first set it to stage 1 region, then change the region for stage 2 countries
dat_mapped$region = region.1[dat_mapped$cc] 
dat_mapped$region = ifelse(dat_mapped$Trialstage==2, region.2[dat_mapped$cc], dat_mapped$region)
dat_mapped$SUBJID = sub("VAT00008-","",dat_mapped$Subjectid)
dat_mapped$SUBJID = gsub("-","",dat_mapped$SUBJID,)
# add batch 0
dat_mapped$nAbBatch1=dat_mapped$nAbBatch
dat_mapped$nAbBatch1[is.na(dat_mapped$Day43pseudoneutid50_B.1.351) & !is.na(dat_mapped$Day43pseudoneutid50)]=0

dat_proc = read.csv('/trials/covpn/p3005/analysis/correlates/Part_A_Blinded_Phase_Data/adata/vat08_combined_data_processed_20240808.csv')
dat_proc$SUBJID = sub("VAT00008-","",dat_proc$Ptid)
dat_proc$SUBJID = gsub("-","",dat_proc$SUBJID,)
dat_proc$EnrollmentDate = with(dat_proc, as.Date(FirstEnrollmentDate)+CalendarDateEnrollment)

assay_metadata=read.csv('~/correlates_reporting2/assay_metadata/vat08_combined_assay_metadata.csv')
assays=assay_metadata$assay
assays0=assays
bassays=assays0[startsWith(assays0,"bindSpike")][1:8]
print(bassays)
nassays=assays0[startsWith(assays0,"pseudoneutid50")][1:5]
print(nassays)

# SamplingStep supercede previous step indicators
mytable(dat_proc$SamplingStep, dat_proc$nAbBatch, dat_proc$Trialstage)


```

### For manuscript

Admin censoring dates
```{r}
tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43)
summary(tmp$EnrollmentDate + tmp$EventTimeOmicronD43M6hotdeck10)

tmp=subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43)
summary(tmp$EnrollmentDate + tmp$EventTimeOmicronD43M6hotdeck10)

```

Baseline immunity pattern

```{r}
st=2
myfigure(mfrow=c(2,4), mar=c(4,2,2,1), oma=c(0,1,2,0), width=10, height=5.5)
par(mgp=c(2,1,0))

dat=subset(dat_proc, Trialstage==st & Bserostatus==1 & ph2.D22.nAb)
wt=dat$wt.D22.nAb/sum(dat$wt.D22.nAb)
lim=c(0.9,5.3)

xlim=c()
plot(density(dat$Bpseudoneutid50, weights=wt), main="nAb-ID50 Reference", xlab="")
title(ylab="    density                                                              density", line=0, outer=T)
plot(density(dat$Bpseudoneutid50_BA.1,   weights=wt), main="nAb-ID50 BA.1", xlab="")
plot(density(dat$Bpseudoneutid50_BA.2,   weights=wt), main="nAb-ID50 BA.2", xlab="")
plot(density(dat$Bpseudoneutid50_BA.4.5, weights=wt), main="nAb-ID50 BA.4.5", xlab="")

dat=subset(dat_proc, Trialstage==st & Bserostatus==1 & ph2.D22.bAb)
wt=dat$wt.D22.bAb/sum(dat$wt.D22.bAb)
lim=c(1.9,6.3)

plot(density(dat$BbindSpike,         weights=wt), main="bAb Index", xlab="")
plot(density(dat$BbindSpike_delta1,  weights=wt), main="bAb Delta", xlab="")
plot(density(dat$BbindSpike_omicron, weights=wt), main="bAb Omicron", xlab="")

title(main="Distribution of Baseline Markers in Stage 2", outer=T)

mydev.off(file="~/correlates_reporting2/cor_coxph/output/vat08_combined/stage2_baseline_marker_dist")
```


```{r}
myfigure(mfrow=c(2,3), mar=c(4,2,2,1), oma=c(0,1,2,0), width=8, height=5.5)
par(mgp=c(2,1,0))
lim=c(1.9,6.3)

st=1
dat=subset(dat_proc, Trialstage==st & Bserostatus==1 & ph2.D22.bAb)
wt=dat$wt.D22.bAb/sum(dat$wt.D22.bAb)

plot(density(dat$BbindSpike,         weights=wt), main="bAb Index", xlab="", xlim=lim)
title(ylab="       Stage 2 density                                         Stage 1 density", line=0, outer=T)
plot(density(dat$BbindSpike_delta1,  weights=wt), main="bAb Delta", xlab="", xlim=lim)
plot(density(dat$BbindSpike_omicron, weights=wt), main="bAb Omicron", xlab="", xlim=lim)

st=2
dat=subset(dat_proc, Trialstage==st & Bserostatus==1 & ph2.D22.bAb)
wt=dat$wt.D22.bAb/sum(dat$wt.D22.bAb)

plot(density(dat$BbindSpike,         weights=wt), main="bAb Index", xlab="", xlim=lim)
plot(density(dat$BbindSpike_delta1,  weights=wt), main="bAb Delta", xlab="", xlim=lim)
plot(density(dat$BbindSpike_omicron, weights=wt), main="bAb Omicron", xlab="", xlim=lim)

title(main="Distribution of Baseline bAb Markers in Stage 1 and 2", outer=T)

mydev.off(file="~/correlates_reporting2/cor_coxph/output/vat08_combined/stage1_2_baseline_bAb_dist")

```



```{r}
myfigure(mfrow=c(2,4), mar=c(4,2,2,1), oma=c(0,1,2,0), width=10, height=5.5)
par(mgp=c(2,1,0))
lim=c(0.9,5.3)

st=1
dat=subset(dat_proc, Trialstage==st & Bserostatus==1 & ph2.D22.st1.nAb.batch0and1)
wt=dat$wt.D22.st1.nAb.batch0and1/sum(dat$wt.D22.st1.nAb.batch0and1)

plot(density(dat$Bpseudoneutid50,         weights=wt), main="nAb-ID50 Reference", xlab="", xlim=lim)
title(ylab="       Stage 2 density                                         Stage 1 density", line=0, outer=T)
# plot(density(dat$Bpseudoneutid50_BA.1,  weights=wt), main="nAb-ID50 BA.1", xlab="", xlim=lim)
# plot(density(dat$Bpseudoneutid50_BA.2, weights=wt), main="nAb-ID50 BA.2", xlab="", xlim=lim)
# plot(density(dat$Bpseudoneutid50_BA.4.5, weights=wt), main="nAb-ID50 BA.4.5", xlab="", xlim=lim)
empty.plot()
empty.plot()
empty.plot()

st=2
dat=subset(dat_proc, Trialstage==st & Bserostatus==1 & ph2.D22.nAb)
wt=dat$wt.D22.nAb/sum(dat$wt.D22.nAb)

plot(density(dat$Bpseudoneutid50,         weights=wt), main="nAb-ID50 Reference", xlab="", xlim=lim)
title(ylab="       Stage 2 density                                         Stage 1 density", line=0, outer=T)
plot(density(dat$Bpseudoneutid50_BA.1,  weights=wt), main="nAb-ID50 BA.1", xlab="", xlim=lim)
plot(density(dat$Bpseudoneutid50_BA.2, weights=wt), main="nAb-ID50 BA.2", xlab="", xlim=lim)
plot(density(dat$Bpseudoneutid50_BA.4.5, weights=wt), main="nAb-ID50 BA.4.5", xlab="", xlim=lim)

title(main="Distribution of Baseline nAb Markers in Stage 1 and 2", outer=T)

mydev.off(file="~/correlates_reporting2/cor_coxph/output/vat08_combined/stage1_2_baseline_nAb_dist")

 
# par(mfrow=c(2,3), mgp=c(2,1,0), oma=c(0,0,0.7,0))
# 
# dat=subset(dat_proc, Trialstage==st & Bserostatus==1 & ph2.D43.st1.nAb.batch0and1)
# 
# plot(density(dat$Bpseudoneutid50_BA.1, na.rm=T), main="Bpseudoneutid50_BA.1")
# plot(density(dat$Bpseudoneutid50, na.rm=T), main="Bpseudoneutid50")
# 
# # plot(dat$Bpseudoneutid50_BA.1, dat$Bpseudoneutid50)
# 
# plot(density(dat$BbindSpike_omicron, na.rm=T), main="BbindSpike_omicron")
# plot(density(dat$BbindSpike, na.rm=T), main="BbindSpike")
# plot(dat$BbindSpike_omicron, dat$BbindSpike)
# 
# title(main="Stage "%.%st, outer=T)

```


Estimating proportion of the Stage 2 participants that were likely infected with omicron at enrollment.
```{r}
library(Hmisc)

st=2

# myfigure(mfrow=c(2,4), mar=c(4,2,2,1), oma=c(0,1,2,0), width=10, height=5.5)
par(mgp=c(2,1,0))

dat=subset(dat_proc, Trialstage==st & Bserostatus==1 & ph2.D22.bAb)
wt=dat$wt.D22.bAb/sum(dat$wt.D22.bAb)
# lim=c(1.9,6.3) # bAb
# lim=c(0.9,5.3) # nAb


dat2=subset(dat_proc, Trialstage==st & Bserostatus==1 & ph2.D22.nAb)
wt=dat2$wt.D22.nAb/sum(dat2$wt.D22.nAb)
lim=c(0.9,5.3) # nAb

summary(dat2$Bpseudoneutid50_BA.1)

wtd.mean(dat2$Bpseudoneutid50_BA.1>1.302, wt)
wtd.mean(dat2$Bpseudoneutid50_BA.2>1.302, wt)
wtd.mean(dat2$Bpseudoneutid50_BA.4.5>1.302, wt)

wtd.mean(dat2$Bpseudoneutid50_BA.1>1.302 | dat2$Bpseudoneutid50_BA.2>1.302 | dat2$Bpseudoneutid50_BA.4.5>1.302, wt)
wtd.mean(dat2$Bpseudoneutid50_BA.1>1.302 & dat2$Bpseudoneutid50_BA.2>1.302 & dat2$Bpseudoneutid50_BA.4.5>1.302, wt)

kp  = dat2$Bpseudoneutid50_BA.1>1.302 & dat2$Bpseudoneutid50_BA.2>1.302 & dat2$Bpseudoneutid50_BA.4.5>1.302
kp2 = dat2$Bpseudoneutid50_BA.1>1.302 | dat2$Bpseudoneutid50_BA.2>1.302 | dat2$Bpseudoneutid50_BA.4.5>1.302

par(mfrow=c(3,2))
for (l in seq(15,40,by=5)) wtd.hist(dat2$Bpseudoneutid50, breaks=seq(lim[1], lim[2], length=l), weight=wt)


par(mfrow=c(1,2))
lab="Baseline nAb-ID50 ancestral"
l=40
wtd.hist(dat2$Bpseudoneutid50, breaks=seq(lim[1], lim[2], length=l), weight=wt, freq=T, main="BA.1 & BA.2 & BA.4.5 POS", xlab=lab)
title(main="in Green: 35% ", line=-0.2)
wtd.hist(dat2$Bpseudoneutid50[!kp], breaks=seq(lim[1], lim[2], length=l), weight=wt[!kp], freq=T, col=rgb(1,0,0,.5), add=T)
wtd.hist(dat2$Bpseudoneutid50[kp], breaks=seq(lim[1], lim[2], length=l), weight=wt[kp], freq=T, col=rgb(0,1,0,.5), add=T)
l=40
wtd.hist(dat2$Bpseudoneutid50, breaks=seq(lim[1], lim[2], length=l), weight=wt, freq=T, main="BA.1 or BA.2 or BA.4.5 POS", xlab=lab)
title(main="in Green: 43%", line=-0.2)
wtd.hist(dat2$Bpseudoneutid50[!kp2], breaks=seq(lim[1], lim[2], length=l), weight=wt[!kp2], freq=T, col=rgb(1,0,0,.5), add=T)
wtd.hist(dat2$Bpseudoneutid50[kp2], breaks=seq(lim[1], lim[2], length=l), weight=wt[kp2], freq=T, col=rgb(0,1,0,.5), add=T)

```

```{r}
library(Hmisc)

st=2

# myfigure(mfrow=c(2,4), mar=c(4,2,2,1), oma=c(0,1,2,0), width=10, height=5.5)
par(mgp=c(2,1,0))

dat=subset(dat_proc, Trialstage==st & Bserostatus==1 & ph2.D22.bAb)
wt=dat$wt.D22.bAb/sum(dat$wt.D22.bAb)

lim=c(1.9,6.3) # bAb

summary(dat$BbindSpike_omicron)

wtd.mean(dat$BbindSpike_omicron>2.402, wt)

kp  = dat$BbindSpike_omicron>2.402

# find the right number of breaks
par(mfrow=c(3,2))
for (l in seq(30,55,by=5)) wtd.hist(dat$BbindSpike, breaks=seq(lim[1], lim[2], length=l), weight=wt)

par(mfrow=c(1,2))
lab="Baseline bindSpike ancestral"
l=40
wtd.hist(dat$BbindSpike, breaks=seq(lim[1], lim[2], length=l), weight=wt, freq=T, main="bindSpike_Omicron POS", xlab=lab)
title(main="in Green: 66% ", line=-0.2)
wtd.hist(dat$BbindSpike[!kp], breaks=seq(lim[1], lim[2], length=l), weight=wt[!kp], freq=T, col=rgb(1,0,0,.5), add=T)
wtd.hist(dat$BbindSpike[kp], breaks=seq(lim[1], lim[2], length=l), weight=wt[kp], freq=T, col=rgb(0,1,0,.5), add=T)

```


### Predictiveness of demographics variables

Region is quite predictive. By itself, it has an AUC of 0.8. FOI is highly dependent on region. Risk score is also dependent on region.

```{r}

tmp=subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43 & Trt==1)

mytable(tmp$region, tmp$cc)
mytable(tmp$region, tmp$EventIndOmicronD43M5hotdeck10)

fit=coxph(Surv(EventTimeOmicronD43M5hotdeck10,EventIndOmicronD43M5hotdeck10) ~  FOI + risk_score + as.factor(region), tmp) ; summary(fit)

fit=glm(EventIndOmicronD43M5hotdeck10 ~  FOI + risk_score + as.factor(region), tmp, family=binomial) ; summary(fit)

fastauc(predict(fit), tmp$EventIndOmicronD43M5hotdeck10)

myboxplot(FOI~EventIndOmicronD43M5hotdeck10, tmp)


fit=glm(EventIndOmicronD43M5hotdeck10 ~  I(region==2)+I(region==1), tmp, family=binomial) ; summary(fit)
fastauc(predict(fit), tmp$EventIndOmicronD43M5hotdeck10)

myboxplot(FOI~region, tmp)


fit=glm(EventIndOmicronD43M5hotdeck10 ~  risk_score, tmp, family=binomial) ; summary(fit)
fastauc(predict(fit), tmp$EventIndOmicronD43M5hotdeck10)

myboxplot(risk_score~region, tmp)

```


stage 1 trt. similar results

```{r}

tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==1)

mytable(tmp$region, tmp$cc)
mytable(tmp$region, tmp$EventIndOmicronD43M5hotdeck10)
   

fit=coxph(Surv(EventTimeOmicronD43M5hotdeck10,EventIndOmicronD43M5hotdeck10) ~  FOI + risk_score + as.factor(region), tmp) ; summary(fit)

fit=glm(EventIndOmicronD43M5hotdeck10 ~  FOI + risk_score + as.factor(region), tmp, family=binomial) ; summary(fit)
fastauc(predict(fit), tmp$EventIndOmicronD43M5hotdeck10)

myboxplot(FOI~EventIndOmicronD43M5hotdeck10, tmp)


fit=glm(EventIndOmicronD43M5hotdeck10 ~  I(region==2)+I(region==1), tmp, family=binomial) ; summary(fit)
fastauc(predict(fit), tmp$EventIndOmicronD43M5hotdeck10)

myboxplot(FOI~region, tmp)


fit=glm(EventIndOmicronD43M5hotdeck10 ~  risk_score, tmp, family=binomial) ; summary(fit)
fastauc(predict(fit), tmp$EventIndOmicronD43M5hotdeck10)

myboxplot(risk_score~region, tmp)

```

stage 2 placebo


```{r}

tmp=subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43 & Trt==0)

mytable(tmp$region, tmp$cc)
mytable(tmp$region, tmp$EventIndOmicronD43M5hotdeck10)

fit=coxph(Surv(EventTimeOmicronD43M5hotdeck10,EventIndOmicronD43M5hotdeck10) ~  FOI + risk_score + as.factor(region), tmp) ; summary(fit)

fit=glm(EventIndOmicronD43M5hotdeck10 ~  FOI + risk_score + as.factor(region), tmp, family=binomial) ; summary(fit)

fastauc(predict(fit), tmp$EventIndOmicronD43M5hotdeck10)

myboxplot(FOI~EventIndOmicronD43M5hotdeck10, tmp)


fit=glm(EventIndOmicronD43M5hotdeck10 ~  I(region==2)+I(region==1), tmp, family=binomial) ; summary(fit)
fastauc(predict(fit), tmp$EventIndOmicronD43M5hotdeck10)

myboxplot(FOI~region, tmp)


fit=glm(EventIndOmicronD43M5hotdeck10 ~  risk_score, tmp, family=binomial) ; summary(fit)
fastauc(predict(fit), tmp$EventIndOmicronD43M5hotdeck10)

myboxplot(risk_score~region, tmp)

```

stage 2, vaccine arm, ph2, weighted* (fastauc does not support weights)


```{r}
library(WeightedROC)
# tp.fp <- WeightedROC(y.hat, y, w)
# (wauc <- WeightedAUC(tp.fp))

tmp=subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph2.D43.bAb & Trt==1)

mytable(tmp$region, tmp$cc)
mytable(tmp$region, tmp$EventIndOmicronD43M5hotdeck10)


fit=glm(EventIndOmicronD43M5hotdeck10 ~  FOI + risk_score + as.factor(region), tmp, family=binomial, weights=tmp$wt.D43.bAb) ; summary(fit)

fastauc(predict(fit), tmp$EventIndOmicronD43M5hotdeck10)

myboxplot(FOI~EventIndOmicronD43M5hotdeck10, tmp)


fit=glm(EventIndOmicronD43M5hotdeck10 ~  I(region==2)+I(region==1), tmp, family=binomial, weights=tmp$wt.D43.bAb) ; summary(fit)
fastauc(predict(fit), tmp$EventIndOmicronD43M5hotdeck10)

myboxplot(FOI~region, tmp)


fit=glm(EventIndOmicronD43M5hotdeck10 ~  risk_score, tmp, family=binomial, weights=tmp$wt.D43.bAb) ; summary(fit)
fastauc(predict(fit), tmp$EventIndOmicronD43M5hotdeck10)

myboxplot(risk_score~region, tmp)

```

### Batch0and1 weights definition check

```{r}

tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D22.st1.nAb.batch0and1)

summary(tmp$wt.D22.st1.nAb.batch0and1)

```

### Some ptids in placebo have large fold rise from baseline to D22/D43

```{r}
tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==0 & ph2.D43.st1.nAb.batch0and1, c(EventIndFirstInfectionD1, BbindSpike, Day22bindSpike, Day43bindSpike))
mymatplot(t(tmp[,-1]), legend=F, col=ifelse(tmp$EventIndFirstInfectionD1==1,2,1), lty=1, pch=1)

tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==0 & ph2.D43.st1.nAb.batch0and1, c(EventIndFirstInfectionD1, Bpseudoneutid50, Day22pseudoneutid50, Day43pseudoneutid50))
tmp=tmp[sample(nrow(tmp),100),]
mymatplot(t(tmp[,-1]), legend=F, col=ifelse(tmp$EventIndFirstInfectionD1==1,"purple","darkgray"), lty=1, pch=1)


tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==0, c(EventIndFirstInfectionD1, BbindSpike_omicron, Day22bindSpike_omicron, Day43bindSpike_omicron, Day78bindSpike_omicron, Day134bindSpike_omicron, Day202bindSpike_omicron, Day292bindSpike_omicron, Day387bindSpike_omicron))
tmp2=subset(dat_proc, Trialstage==1 & Bserostatus==0 & Trt==0, c(EventIndFirstInfectionD1, BbindSpike_omicron, Day22bindSpike_omicron, Day43bindSpike_omicron, Day78bindSpike_omicron, Day134bindSpike_omicron, Day202bindSpike_omicron, Day292bindSpike_omicron, Day387bindSpike_omicron))
# tmp=tmp[complete.cases(tmp),]
par(mfrow=c(4,1), mar=c(1,1,1,1),mgp=c(1,0,0))
mymatplot(t(tmp[tmp$EventIndFirstInfectionD1==0,-1]), legend=F, lty=1, pch=1, col=1, main="Non-naive, Non-cases, Placebo")
mymatplot(t(tmp[tmp$EventIndFirstInfectionD1==1,-1]), legend=F, lty=1, pch=1, col=1, main="Non-naive, Cases, Placebo")
mymatplot(t(tmp2[tmp2$EventIndFirstInfectionD1==0,-1]), legend=F, lty=1, pch=1, col=1, main="Naive, Non-cases, Placebo")
mymatplot(t(tmp2[tmp2$EventIndFirstInfectionD1==1,-1]), legend=F, lty=1, pch=1, col=1, main="Naive, Cases, Placebo")


# filter by ph1.D43
tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==0 & ph1.D43, c(EventIndFirstInfectionD1, BbindSpike_omicron, Day22bindSpike_omicron, Day43bindSpike_omicron, Day78bindSpike_omicron, Day134bindSpike_omicron, Day202bindSpike_omicron, Day292bindSpike_omicron, Day387bindSpike_omicron))
tmp2=subset(dat_proc, Trialstage==1 & Bserostatus==0 & Trt==0 & ph1.D43, c(EventIndFirstInfectionD1, BbindSpike_omicron, Day22bindSpike_omicron, Day43bindSpike_omicron, Day78bindSpike_omicron, Day134bindSpike_omicron, Day202bindSpike_omicron, Day292bindSpike_omicron, Day387bindSpike_omicron))
# tmp=tmp[complete.cases(tmp),]
par(mfrow=c(4,1), mar=c(1,1,1,1),mgp=c(1,0,0))
mymatplot(t(tmp[tmp$EventIndFirstInfectionD1==0,-1]), legend=F, lty=1, pch=1, col=1, main="Non-naive, Non-cases, Placebo")
mymatplot(t(tmp[tmp$EventIndFirstInfectionD1==1,-1]), legend=F, lty=1, pch=1, col=1, main="Non-naive, Cases, Placebo")
mymatplot(t(tmp2[tmp2$EventIndFirstInfectionD1==0,-1]), legend=F, lty=1, pch=1, col=1, main="Naive, Non-cases, Placebo")
mymatplot(t(tmp2[tmp2$EventIndFirstInfectionD1==1,-1]), legend=F, lty=1, pch=1, col=1, main="Naive, Cases, Placebo")


# vaccinees
# filter by ph1.D43
tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43, c(EventIndFirstInfectionD1, BbindSpike_omicron, Day22bindSpike_omicron, Day43bindSpike_omicron, Day78bindSpike_omicron, Day134bindSpike_omicron, Day202bindSpike_omicron, Day292bindSpike_omicron, Day387bindSpike_omicron))
tmp2=subset(dat_proc, Trialstage==1 & Bserostatus==0 & Trt==1 & ph1.D43, c(EventIndFirstInfectionD1, BbindSpike_omicron, Day22bindSpike_omicron, Day43bindSpike_omicron, Day78bindSpike_omicron, Day134bindSpike_omicron, Day202bindSpike_omicron, Day292bindSpike_omicron, Day387bindSpike_omicron))
# tmp=tmp[complete.cases(tmp),]
par(mfrow=c(4,1), mar=c(1,1,1,1),mgp=c(1,0,0))
mymatplot(t(tmp[tmp$EventIndFirstInfectionD1==0,-1]), legend=F, lty=1, pch=1, col=1, main="Non-naive, Non-cases, Vaccine")
mymatplot(t(tmp[tmp$EventIndFirstInfectionD1==1,-1]), legend=F, lty=1, pch=1, col=1, main="Non-naive, Cases, Vaccine")
mymatplot(t(tmp2[tmp2$EventIndFirstInfectionD1==0,-1]), legend=F, lty=1, pch=1, col=1, main="Naive, Non-cases, Vaccine")
mymatplot(t(tmp2[tmp2$EventIndFirstInfectionD1==1,-1]), legend=F, lty=1, pch=1, col=1, main="Naive, Cases, Vaccine")


```


### number of cases by Bhigh

for Stage 1, for bAb Spike, stratified by (Vaccine, Placebo), how many cases have bAb data that are in the undetectable subgroup and how many cases have bAb data that are in the detectable subgroup?  Then the same question for batch 0 + 1 nab titer data. 


```{r}
tmp=subset(dat_proc, ph2.D43.bAb & Trialstage==1 & Bserostatus==1 & EventIndOmicronD43M6hotdeck10)
with(tmp, mytable(Bhigh, Trt))


tmp=subset(dat_proc, ph2.D43.st1.nAb.batch0and1 & Trialstage==1 & Bserostatus==1 & EventIndOmicronD43M6hotdeck10)
with(tmp, mytable(Bhigh, Trt))

```
D22

```{r}
tmp=subset(dat_proc, ph2.D22.bAb & Trialstage==1 & Bserostatus==1 & EventIndOmicronD22M6hotdeck10)
with(tmp, mytable(Bhigh, Trt))


tmp=subset(dat_proc, ph2.D22.st1.nAb.batch0and1 & Trialstage==1 & Bserostatus==1 & EventIndOmicronD22M6hotdeck10)
with(tmp, mytable(Bhigh, Trt))

```

Cox model

```{r}
tmp=subset(dat_proc, ph1.D43 & Trialstage==1 & Bserostatus==1 & Trt==1)

models=lapply(1:10, function(imp) {

  f=as.formula(paste0("Surv(EventTimeOmicronD43M6hotdeck",imp,",EventIndOmicronD43M6hotdeck",imp,") ~ FOI + risk_score + Sex + Day43bindSpike_omicron*Bhigh + strata(cc)"))

  fit = svycoxph(f, twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.bAb, data=tmp))
  
})

betas<-MIextract(models, fun=coef)
vars<- MIextract(models, fun=vcov)

fits=list()
fits[[1]]=MIcombine(betas,vars)  

rows=4:6
tps=T
est=getFormattedSummary(fits, exp=T, robust=tps, rows=rows, type=1)
ci= getFormattedSummary(fits, exp=T, robust=tps, rows=rows, type=7)
p=  getFormattedSummary(fits, exp=T, robust=tps, rows=rows, type=10)

myboxplot(Day43bindSpike_omicron~Bhigh, tmp, col=tmp$EventIndOmicronD43M6hotdeck10+1, cex=1.5, pch=ifelse(tmp$EventIndOmicronD43M6hotdeck10==1,3,1), xlab="Baseline Detectable")


tmp=subset(dat_proc, ph1.D43.st1.nAb.batch0and1 & Trialstage==1 & Bserostatus==1 & Trt==1)

imp=10
f=as.formula(paste0("Surv(EventTimeOmicronD43M6hotdeck",imp,",EventIndOmicronD43M6hotdeck",imp,") ~ FOI + risk_score + Sex + Day43pseudoneutid50_BA.1_10*Bhigh + strata(cc)"))

fit = svycoxph(f, twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.st1.nAb.batch0and1, data=tmp))
fit

myboxplot(Day43pseudoneutid50_10~Bhigh, tmp, col=tmp$EventIndOmicronD43M6hotdeck10+1, cex=1.5, pch=ifelse(tmp$EventIndOmicronD43M6hotdeck10==1,3,1), xlab="Baseline Detectable")


#D22
tmp=subset(dat_proc, ph1.D22.st1.nAb.batch0and1 & Trialstage==1 & Bserostatus==1 & Trt==1)

imp=10
f=as.formula(paste0("Surv(EventTimeOmicronD22M6hotdeck",imp,",EventIndOmicronD22M6hotdeck",imp,") ~ FOI + risk_score + Sex + Day22pseudoneutid50_BA.1_10*Bhigh + strata(cc)"))

fit = svycoxph(f, twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D22.st1.nAb.batch0and1, data=tmp))
fit

myboxplot(Day22pseudoneutid50_10~Bhigh, tmp, col=tmp$EventIndOmicronD22M6hotdeck10+1, cex=1.5, pch=ifelse(tmp$EventIndOmicronD22M6hotdeck10==1,3,1), xlab="Baseline Detectable")

subset(tmp, EventIndOmicronD22M6hotdeck10==1)
```


Checking weights ...

```{r}
tmp=subset(dat_proc, ph1.D43 & Trialstage==1 & Bserostatus==1 & EventIndPrimaryD22 & Trt==0)
with(tmp, mytable(ph2.D43.bAb, RAPDIAG))
with(subset(tmp), mytable(wt.D43.bAb, RAPDIAG))

tmp=subset(dat_proc, ph1.D43 & Trialstage==1 & Bserostatus==1 & EventIndOmicronD43M6hotdeck10 & Trt==0)
with(tmp, mytable(ph2.D43.bAb, RAPDIAG))
with(subset(tmp), mytable(wt.D43.bAb, RAPDIAG))

```



```{r}
tmp=subset(dat_proc, ph1.D43.st1.nAb.batch0and1 & Trialstage==1 & Bserostatus==1 & EventIndPrimaryD22 & Trt==0)
with(tmp, mytable(ph2.D43.st1.nAb.batch0and1, RAPDIAG))
with(subset(tmp), mytable(wt.D43.st1.nAb.batch0and1, RAPDIAG))

tmp=subset(dat_proc, ph1.D43.st1.nAb.batch0and1 & Trialstage==1 & Bserostatus==1 & EventIndOmicronD43M6hotdeck10 & Trt==0)
with(tmp, mytable(ph2.D43.st1.nAb.batch0and1, RAPDIAG))
with(subset(tmp), mytable(wt.D43.st1.nAb.batch0and1, RAPDIAG))

```


For stage 2


```{r}
tmp=subset(dat_proc, ph2.D43.bAb & Trialstage==2 & Bserostatus==1 & EventIndOmicronD43M5hotdeck10)
with(tmp, mytable(Bhigh, Trt))


tmp=subset(dat_proc, ph2.D43.nAb & Trialstage==2 & Bserostatus==1 & EventIndOmicronD43M5hotdeck10)
with(tmp, mytable(Bhigh, Trt))

```



### Checking imputed variants ID50 for batch 0

There are more baseline naive in US/JPN and more baseline non-naive in Asia and LatAm.

```{r}

with(subset(dat_proc, batch0), mytable(Trt, cc, Bserostatus, Trialstage))

with(subset(dat_proc, batch0), mytable(Trt, Region4, Bserostatus, Trialstage))

mytable(dat_proc$batch0, !is.na(dat_proc$Bpseudoneutid50_B.1.351_1))

subset(dat_proc, batch0)[1:5,c("Bpseudoneutid50","Bpseudoneutid50_B.1.351","Bpseudoneutid50_B.1.351_1", "Day22pseudoneutid50","Day22pseudoneutid50_B.1.351","Day22pseudoneutid50_B.1.351_1", "Day43pseudoneutid50","Day43pseudoneutid50_B.1.351","Day43pseudoneutid50_B.1.351_1")]

mypairs(subset(dat_proc, Bserostatus==1 & Trialstage==1 & Trt==1)[,"Day43" %.% nAb])
mypairs(subset(dat_proc, Bserostatus==1 & Trialstage==1 & Trt==0)[,"Day43" %.% nAb])

mypairs(subset(dat_proc, batch0)[,c("Bpseudoneutid50","Bpseudoneutid50_B.1.351_1", "Bpseudoneutid50_B.1.351_2", 
                                    "Day22pseudoneutid50","Day22pseudoneutid50_B.1.351_1", "Day22pseudoneutid50_B.1.351_2", 
                                    "Day43pseudoneutid50","Day43pseudoneutid50_B.1.351_1","Day43pseudoneutid50_B.1.351_2")])

mytable(dat_proc$Trt, dat_proc$Bpseudoneutid50_1cat, dat_proc$Bserostatus)
mytable(dat_proc$Trt, dat_proc$Bpseudoneutid50_mdw_1cat, dat_proc$Bserostatus)
mytable(dat_proc$Trt, dat_proc$Day22pseudoneutid50_1cat, dat_proc$Bserostatus)
mytable(dat_proc$Trt, dat_proc$Day22pseudoneutid50_mdw_1cat, dat_proc$Bserostatus)
mytable(dat_proc$Trt, dat_proc$Day22pseudoneutid50_2cat, dat_proc$Bserostatus)
mytable(dat_proc$Trt, dat_proc$Day22pseudoneutid50_mdw_2cat, dat_proc$Bserostatus)

```

```{r}
dat_proc_old = read.csv('/trials/covpn/p3005/analysis/correlates/Part_A_Blinded_Phase_Data/adata/vat08_combined_data_processed_20240801.csv')

par(mfrow=c(1,2))
lim=c(1,6)

tmp=subset(dat_proc, Trt==1 & Bserostatus==1 & Trialstage==1 )

# col=ifelse(tmp$batch0,"red","red")
# col[tmp$nAbBatch==2]="blue"
# plot(tmp$Day43pseudoneutid50, tmp$Day43pseudoneutid50_B.1.351, col=col, pch=ifelse(tmp$nAbBatch==2,3,1), asp=1, xlim=lim, ylim=lim); abline(0,1)

tmp=subset(tmp, batch0 | nAbBatch==2)
col=ifelse(tmp$batch0,"blue","blue")
col[tmp$batch0]="red"
plot(tmp$Day43pseudoneutid50, tmp$Day43pseudoneutid50_B.1.351_1, col=col, pch=ifelse(tmp$batch0,1,3), asp=1, xlim=lim, ylim=lim, main="Deming"); abline(0,1)

tmp=subset(dat_proc_old, Trt==1 & Bserostatus==1 & Trialstage==1 )

tmp=subset(tmp, batch0 | nAbBatch==2)
col=ifelse(tmp$batch0,"blue","blue")
col[tmp$batch0]="red"
plot(tmp$Day43pseudoneutid50, tmp$Day43pseudoneutid50_B.1.351_1, col=col, pch=ifelse(tmp$batch0,1,3), asp=1, xlim=lim, ylim=lim, main="mice::pmm"); abline(0,1)


title(main="NN, Stage 1, Vaccine", outer=T)


```

### Tweaking end of followup

```{r}

tmp=subset(dat_proc, Bserostatus==1 & Trialstage==1 & ph1.D22 & EventIndOmicronD43M12hotdeck10==1)
sort(tmp$EventTimeOmicronD43M12hotdeck10)

tmp=subset(dat_proc, Bserostatus==1 & Trialstage==2 & ph1.D22 & EventIndOmicronD43M12hotdeck10==1)
sort(tmp$EventTimeOmicronD43M12hotdeck10)

```

### Feedback from 1st BARDA presentation

1. Dean recommended focusing on understanding better why the D43 absolute level nAb titer results for Stage 1 are weird
(i.e., direct CoR for vaccine, albeit with exception nAb D614G).
Things look good for Stage 2.  For the why-weird analyses Dean recommended exploring results under alternative covariate adjustments,
including no adjustments.

```{r}

f1=Surv(EventTimeOmicronD43M6hotdeck10,EventIndOmicronD43M6hotdeck10) ~ FOI + risk_score + Sex + Day43pseudoneutid50_BA.1 + strata(cc)
f2=Surv(EventTimeOmicronD43M6hotdeck10,EventIndOmicronD43M6hotdeck10) ~ Sex + Day43pseudoneutid50_BA.1 + strata(cc)
f3=Surv(EventTimeOmicronD43M6hotdeck10,EventIndOmicronD43M6hotdeck10) ~ risk_score + Day43pseudoneutid50_BA.1 + strata(cc)
f4=Surv(EventTimeOmicronD43M6hotdeck10,EventIndOmicronD43M6hotdeck10) ~ Day43pseudoneutid50_BA.1 + strata(cc)
f5=Surv(EventTimeOmicronD43M6hotdeck10,EventIndOmicronD43M6hotdeck10) ~ Day43pseudoneutid50_BA.1
  
fits=lapply(list(f1, f2, f3, f4, f5), function (f) svycoxph(f, twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.nAb, data=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==1))))

tab=getFormattedSummary(fits, robust=T)
tab

```

2. For vaccine arm interaction analyses, consider defining 2 baseline subgroups in a single way, instead of
antigen-specific like what was done.  Also, consider defining it based on nAb ID50 D614G, because it matches a vaccine strain
for both Stage 1 and 2 trials, and this antigen has the greatest dynamic range in a sense (and doesn't have the
issue of a high undetectable response frequency that some antigens have, especially BA.4/BA.5).  So, what if used the < median
vs. >= median nAb ID50 D614G response for all analyses?  There is the question of how to deal with the 2 trials.
perhaps using the median of the Stage 2 trial, as that vaccine is better and more important to learn about.


```{r}
dat1=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph2.D43)
dat2=subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43)

mypairs(dat1[,paste0("B",c(nassays,bassays))])
mypairs(dat2[,paste0("B",c(nassays,bassays))])

```

```{r}
dat_proc$Bhigh = ifelse(dat_proc$Bpseudoneutid50>log10(20+0.1), 1, 0) # cut point is LOD

with(subset(dat_proc, Bserostatus==1 & Trialstage==1 & ph2.D43.nAb), Hmisc::wtd.mean(Bhigh, wt.D43.nAb))
with(subset(dat_proc, Bserostatus==1 & Trialstage==1 & ph2.D43.bAb), Hmisc::wtd.mean(Bhigh, wt.D43.bAb))
with(subset(dat_proc, Bserostatus==1 & Trialstage==2 & ph2.D43.nAb), Hmisc::wtd.mean(Bhigh, wt.D43.nAb))
with(subset(dat_proc, Bserostatus==1 & Trialstage==2 & ph2.D43.bAb), Hmisc::wtd.mean(Bhigh, wt.D43.bAb))
```

```{r}
dat_proc$Bhigh = ifelse(dat_proc$Bpseudoneutid50>log10(160), 1, 0) # cut point is pos threshold, i.e. 4xLOD

with(subset(dat_proc, Bserostatus==1 & Trialstage==1 & ph2.D43.nAb), Hmisc::wtd.mean(Bhigh, wt.D43.nAb))
with(subset(dat_proc, Bserostatus==1 & Trialstage==1 & ph2.D43.bAb), Hmisc::wtd.mean(Bhigh, wt.D43.bAb))
with(subset(dat_proc, Bserostatus==1 & Trialstage==2 & ph2.D43.nAb), Hmisc::wtd.mean(Bhigh, wt.D43.nAb))
with(subset(dat_proc, Bserostatus==1 & Trialstage==2 & ph2.D43.bAb), Hmisc::wtd.mean(Bhigh, wt.D43.bAb))
```

6. plot assay run dates by D43 neut titer for each non-naive cohort of interest (Stage 1, Stage 2) x (V, P) x (cases, non-cases).

```{r}
dat_proc$D43PSVRunDate=as.Date(dat_proc$D43PSVRunDate)

par(mfrow=c(2,2))

with(subset(dat_proc, Bserostatus==1 & Trialstage==1 & ph2.D43.nAb), plot(Day43pseudoneutid50~D43PSVRunDate, col="white", main="Stage 1 NN Vaccine"))
with(subset(dat_proc, Bserostatus==1 & Trialstage==1 & ph2.D43.nAb & Trt==1 & EventIndOmicronD43M6hotdeck10==1), points(Day43pseudoneutid50~D43PSVRunDate,  col=2))
with(subset(dat_proc, Bserostatus==1 & Trialstage==1 & ph2.D43.nAb & Trt==1 & EventIndOmicronD43M6hotdeck10==0), points(Day43pseudoneutid50~D43PSVRunDate))

with(subset(dat_proc, Bserostatus==1 & Trialstage==1 & ph2.D43.nAb), plot(Day43pseudoneutid50~D43PSVRunDate, col="white", main="Stage 1 NN Placebo"))
with(subset(dat_proc, Bserostatus==1 & Trialstage==1 & ph2.D43.nAb & Trt==0 & EventIndOmicronD43M6hotdeck10==1), points(Day43pseudoneutid50~D43PSVRunDate,  col=2))
with(subset(dat_proc, Bserostatus==1 & Trialstage==1 & ph2.D43.nAb & Trt==0 & EventIndOmicronD43M6hotdeck10==0), points(Day43pseudoneutid50~D43PSVRunDate))

with(subset(dat_proc, Bserostatus==1 & Trialstage==2 & ph2.D43.nAb), plot(Day43pseudoneutid50~D43PSVRunDate, col="white", main="Stage 2 NN Vaccine"))
with(subset(dat_proc, Bserostatus==1 & Trialstage==2 & ph2.D43.nAb & Trt==1 & EventIndOmicronD43M6hotdeck10==1), points(Day43pseudoneutid50~D43PSVRunDate,  col=2))
with(subset(dat_proc, Bserostatus==1 & Trialstage==2 & ph2.D43.nAb & Trt==1 & EventIndOmicronD43M6hotdeck10==0), points(Day43pseudoneutid50~D43PSVRunDate))

with(subset(dat_proc, Bserostatus==1 & Trialstage==2 & ph2.D43.nAb), plot(Day43pseudoneutid50~D43PSVRunDate, col="white", main="Stage 2 NN Placebo"))
with(subset(dat_proc, Bserostatus==1 & Trialstage==2 & ph2.D43.nAb & Trt==0 & EventIndOmicronD43M6hotdeck10==1), points(Day43pseudoneutid50~D43PSVRunDate,  col=2))
with(subset(dat_proc, Bserostatus==1 & Trialstage==2 & ph2.D43.nAb & Trt==0 & EventIndOmicronD43M6hotdeck10==0), points(Day43pseudoneutid50~D43PSVRunDate))



```

```{r}

tb <- rgb(255, 255, 255, maxColorValue = 255, alpha = 100)  # with transparency

for (iSt in 1:2) {
for (trt in 1:0) {
  
  myboxplot(Day43pseudoneutid50~D43PSVRunDate, subset(dat_proc, Bserostatus==1 & Trialstage==iSt & ph2.D43.nAb & Trt==trt & EventIndOmicronD43M6hotdeck10==0), col="white", col.points=1, border=1, main=paste0("Stage ", iSt, " NN ", ifelse(trt==1,"Vaccine", "Placebo")), cex.axis=0.8)
  myboxplot(Day43pseudoneutid50~D43PSVRunDate, subset(dat_proc, Bserostatus==1 & Trialstage==iSt & ph2.D43.nAb & Trt==trt & EventIndOmicronD43M6hotdeck10==1), col=tb, col.points=2, border=2, add=T, xaxt="n")
  
}
}

```

10. For Sanofi Stage 1 -- did we ever try a correlates analysis only including the Batch within which were all the cases

```{r}

dat=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph2.D43.nAb & Trt==1)
table(dat$nAbBatch, dat$EventIndOmicronD43M6hotdeck10) 

myboxplot(Day43pseudoneutid50~nAbBatch, dat, col=dat$EventIndOmicronD43M6hotdeck1+1)


```


we’d need proof that for D614G neuts, responses are lower for batch 2 vs. batches 0 and 1 after accounting for the baseline factors that we adjusted for in correlates analyses.
```{r}
dat_proc$batch2=dat_proc$nAbBatch==2

fit=lm(Day43pseudoneutid50 ~ FOI + risk_score + Sex + Region4 + batch2, subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43 & EventIndOmicronD43M6hotdeck10==0)); summary(fit)

fit=lm(Day43pseudoneutid50 ~ FOI + risk_score + Sex + batch2, subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43 & EventIndOmicronD43M6hotdeck10==0)); summary(fit)

fit=lm(Day43pseudoneutid50 ~ FOI + risk_score + Sex + batch2, subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43 & EventIndOmicronD43M6hotdeck10==0 & region==2)); summary(fit)

fit=lm(Day43pseudoneutid50 ~ batch2, subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43 & EventIndOmicronD43M6hotdeck10==0 & region==2)); summary(fit)

```

Re-run for both cases and non-cases

```{r}
dat_proc$batch2=dat_proc$nAbBatch==2

fit=lm(Day43pseudoneutid50 ~ FOI + risk_score + Sex + Region4 + batch2, subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43)); summary(fit)

fit=lm(Day43pseudoneutid50 ~ FOI + risk_score + Sex + batch2, subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43 & region==2)); summary(fit)

fit=lm(Day43pseudoneutid50 ~ FOI + risk_score + Sex + batch2, subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43 & region==2 & EventIndOmicronD43M6hotdeck10==0)); summary(fit)


```


Placebo

```{r}
dat_proc$batch2=dat_proc$nAbBatch==2
dat_proc$nAbBatch1=dat_proc$nAbBatch
dat_proc$nAbBatch1[is.na(dat_proc$Day43pseudoneutid50_B.1.351)]=0

tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==0 & ph1.D43 & region==2)
fit=lm(Day43pseudoneutid50 ~ FOI + risk_score + Sex + batch2, tmp); summary(fit)

tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==0 & ph1.D43 & region==2 & EventIndOmicronD43M6hotdeck10==0)
fit=lm(Day43pseudoneutid50 ~ FOI + risk_score + Sex + batch2, tmp); summary(fit)


tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & region==2)
myboxplot(Day43pseudoneutid50~nAbBatch1+Trt, tmp[!is.na(tmp$Day43pseudoneutid50),], col=ifelse(tmp[!is.na(tmp$Day43pseudoneutid50),]$EventIndOmicronD43M6hotdeck10==1, 2, 1), ylim=NULL, main="Anc ID50 by Batch 0,1,2 in Mono NN (Left: Placebo, Right: Vaccine)")

```




Consider the Cox model regressing on batch2 + Sex + strata(cc) + FOI + riskscore (the same baseline factors adjusted for in corcoxph analyses). Pooling over all regions.

I suppose doing this for the placebo arm as well as for the vaccine arm is informative.

```{r}

dat_proc$batch2=dat_proc$nAbBatch==2

fit = coxph(Surv(EventTimeOmicronD43M6hotdeck10,EventIndOmicronD43M6hotdeck10) ~ FOI + risk_score + Sex + strata(Country) + batch2, subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==1))
fit

fit = coxph(Surv(EventTimeOmicronD43M6hotdeck10,EventIndOmicronD43M6hotdeck10) ~ FOI + risk_score + Sex + strata(Country) + batch2, subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==0))
fit

# region 2
fit = coxph(Surv(EventTimeOmicronD43M6hotdeck10,EventIndOmicronD43M6hotdeck10) ~ FOI + risk_score + Sex + strata(Country) + batch2, subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==1 & region==2))
fit

fit = coxph(Surv(EventTimeOmicronD43M6hotdeck10,EventIndOmicronD43M6hotdeck10) ~ FOI + risk_score + Sex + strata(Country) + batch2, subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==0 & region==2))
fit

```


### lack of cases in asiapac in stage 2

```{r}

fit = svycoxph(Surv(EventTimeOmicronD43M6hotdeck7,EventIndOmicronD43M6hotdeck7) ~ Day43bindSpike_omicron + FOI + risk_score + Sex + strata(Region3), twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.bAb, data=subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43 & Trt==0)))
fit

fit2 = svycoxph(Surv(EventTimeOmicronD43M6hotdeck7,EventIndOmicronD43M6hotdeck7) ~ Day43bindSpike_omicron + FOI + risk_score + Sex + Region3, twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.bAb, data=subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43 & Trt==0)))
fit2

with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43 & Trt==0), mytable(Region3, EventIndOmicronD43M6hotdeck7))

```


### VE separately for low and high baseline marker group

VE for Stage 1 NN for D01 nAb D614G < median, and then again for >= median

```{r}

fit=svycoxph(Surv(EventTimeOmicronD43M6hotdeck10,EventIndOmicronD43M6hotdeck10) ~ Trt*Bpseudoneutid50dich, twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.nAb, data=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43))); fit



```



### Fit a model with both nAb and bAb in stage 1 NN Vacc

```{r}
fit = svycoxph(Surv(EventTimeOmicronD43M6hotdeck10,EventIndOmicronD43M6hotdeck10) ~ Day43bindSpike_omicron + Day43pseudoneutid50_BA.1 + FOI + risk_score + Sex + strata(Country), twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.bAb, data=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==1)))
fit

```


### How many sampled were measured from US/JPN

```{r}

tmp=subset(dat_proc, Trialstage==1 & region==1)
mytable(tmp$cc, !is.na(tmp$Day43pseudoneutid50), tmp$Bserostatus, tmp$Trt)
mytable(tmp$cc, !is.na(tmp$Day43pseudoneutid50_B.1.351), tmp$Bserostatus, tmp$Trt)
mytable(tmp$cc, !is.na(tmp$Day43pseudoneutid50_BA.1), tmp$Bserostatus, tmp$Trt)

```

### Comparing before and after removing ID50 transformation

There are differences, due to imputation.

```{r}

dat_mapped1=read.csv('/trials/covpn/p3005/analysis/mapping_immune_correlates/combined/adata/COVID_Sanofi_stage1and2_mapped_20240620_hotdeck.csv')
dat_mapped2=read.csv('/trials/covpn/p3005/analysis/mapping_immune_correlates/combined/adata/COVID_Sanofi_stage1and2_mapped_20240720_hotdeck.csv')

tmp1=subset(dat_mapped1, Trialstage==1 & Bserostatus==1 & Trt==0)
tmp2=subset(dat_mapped2, Trialstage==1 & Bserostatus==1 & Trt==0)

mytable(tmp1$Day43pseudoneutid50_BA.1)
mytable(tmp2$Day43pseudoneutid50_BA.1)

dat_proc1 = read.csv('/trials/covpn/p3005/analysis/correlates/Part_A_Blinded_Phase_Data/adata/vat08_combined_data_processed_20240717.csv')
dat_proc2 = read.csv('/trials/covpn/p3005/analysis/correlates/Part_A_Blinded_Phase_Data/adata/vat08_combined_data_processed_20240721.csv')
dat_proc3 = read.csv('/trials/covpn/p3005/analysis/correlates/Part_A_Blinded_Phase_Data/adata/vat08_combined_data_processed_20240720.csv')

tmp3=subset(dat_proc1, Trialstage==1 & Bserostatus==1 & Trt==0 & ph1.D43)
tmp4=subset(dat_proc2, Trialstage==1 & Bserostatus==1 & Trt==0 & ph1.D43)

mytable(tmp3$Day43pseudoneutid50_BA.1cat)
mytable(tmp4$Day43pseudoneutid50_BA.1cat)

identical(dat_proc1$Day43pseudoneutid50_BA.1, dat_proc2$Day43pseudoneutid50_BA.1)
identical(dat_proc3$Day43pseudoneutid50_BA.1, dat_proc2$Day43pseudoneutid50_BA.1)
```

### Number of cases between D22 and D43


```{r}
with(subset(dat_proc, baseline.bAb & !D22.bAb & D43.bAb ), mytable(Trt, EventIndOmicronD43M12hotdeck1, Trialstage, Bserostatus))
```

```{r}
with(subset(dat_proc, baseline.nAb & !D22.nAb & D43.nAb ), mytable(Trt, EventIndOmicronD43M12hotdeck1, Trialstage, Bserostatus))

```


```{r}

with(subset(dat_proc, baseline.bAb & Bserostatus==1), mytable(D22.bAb, D43.bAb, EventIndOmicronD22M12hotdeck1))

with(subset(dat_proc, baseline.nAb & Bserostatus==1), mytable(D22.nAb, D43.nAb, EventIndOmicronD22M12hotdeck1))

```


```{r}
# M6
nrow(subset(dat_proc, Trialstage==2 & Trt==1 & Bserostatus==0 & TwophasesampIndbAb & EventIndOmicronD22M6hotdeck1 & ph1.D22))
nrow(subset(dat_proc, Trialstage==2 & Trt==1 & Bserostatus==0 & TwophasesampIndbAb & EventIndOmicronD22M6hotdeck1 & ph1.D43))
# M12
nrow(subset(dat_proc, Trialstage==2 & Trt==1 & Bserostatus==0 & TwophasesampIndbAb & EventIndOmicronD22M12hotdeck1 & ph1.D22))
nrow(subset(dat_proc, Trialstage==2 & Trt==1 & Bserostatus==0 & TwophasesampIndbAb & EventIndOmicronD22M12hotdeck1 & ph1.D43))

```


### Stratum size

For each of nAb and bAb, for each of Stage 1 NN and Stage 2 NN, cross-tabulation of numbers of ptids in the D43 marker per-protocol correlates cohort by sampling cell, and for completeness the same thing repeated for the D22 marker per-protocol correlates cohort by sampling cells. 


```{r}
with(subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph2.D43.nAb), mytable(Trt, region, Senior))
with(subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph2.D43.bAb), mytable(Trt, region, Senior))

with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph2.D43.nAb), mytable(Trt, region, Senior))
with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph2.D43.bAb), mytable(Trt, region, Senior))

```

```{r}

with(subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph2.D43.st1.nAb.batch0and1), mytable(Trt, region, Senior))

```

From batch 0, there are plenty of non-cases

```{r}
with(subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph2.D43.nAb), mytable(Trt, region, Senior))
with(subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph2.D43.nAb & nAbBatch==1), mytable(Trt, region, Senior))
with(subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph2.D43.nAb & nAbBatch==2), mytable(Trt, region, Senior))
with(subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & !ph2.D43.nAb & !is.na(Bpseudoneutid50)), mytable(Trt, region, Senior))
```

### Number of cases by region

```{r}
with(subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43), mytable(EventIndOmicronD43M6hotdeck1, Trt, region))
```


```{r}
with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43), mytable(EventIndOmicronD43M6hotdeck1, Trt, region))
```



### Should baseline be dichotomized for interaction analysis?

The reason to dichotomize instead of trichotomize baseline markers for interaction analysis is for the small number of endpoints.

```{r}

tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43)

par(mfrow=c(1,2))
hist(tmp$BbindSpike, main="Stage 1 NN, Both Arms")
hist(tmp$Bpseudoneutid50, main="Stage 1 NN, Both Arms")


```


### Can a panel of markers predict variants?

Not likely 

```{r}

dat_proc$Day43pseudoneutid50_1 = rowMeans(dat_proc[,"Day43"%.%nassays[1:2]])
dat_proc$Day43pseudoneutid50_2 = rowMeans(dat_proc[,"Day43"%.%nassays[3:5]])

tmp=subset(dat_proc, Bserostatus==1 & Trt==0)
plot(Day43pseudoneutid50_1~Day43pseudoneutid50_2, tmp, col=tmp$Trialstage); abline(0,1)

lim=c(0,3.5)

par(mfrow=c(1,2))
plot(Day43pseudoneutid50_1~Day43pseudoneutid50_2, tmp[tmp$Trialstage==1,], main="Stage 1", xlim=lim, ylim=lim, asp=1); abline(0,1)
plot(Day43pseudoneutid50_1~Day43pseudoneutid50_2, tmp[tmp$Trialstage==2,], main="Stage 2", xlim=lim, ylim=lim, asp=1); abline(0,1)

mypairs(subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==0)[,"Day43"%.%nassays])
            
```




### Number of cases in between d22 and d43

```{r}

nrow(subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & EventIndFirstInfectionD22==1 & is.na(EventIndFirstInfectionD43)))
nrow(subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==0 & EventIndFirstInfectionD22==1 & is.na(EventIndFirstInfectionD43)))
nrow(subset(dat_proc, Trialstage==1 & Bserostatus==0 & Trt==1 & EventIndFirstInfectionD22==1 & is.na(EventIndFirstInfectionD43)))
nrow(subset(dat_proc, Trialstage==1 & Bserostatus==0 & Trt==0 & EventIndFirstInfectionD22==1 & is.na(EventIndFirstInfectionD43)))

# mytable(subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1, EventIndFirstInfectionD43, drop=T))
# mytable(subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1, EventIndFirstInfectionD22, drop=T))


```


### Comparing correlates in placebo in the two trials

D43 is direct correlate in stage 1 and inverse correlate in stage 2 in each region

```{r}

tab=sapply (1:3, function (iReg) {
  myprint(iReg)
  # stage 1
  fit.1 = svycoxph(Surv(EventTimeOmicronD43M6hotdeck1,EventIndOmicronD43M6hotdeck1) ~ Day43bindSpike + FOI + risk_score + Sex + strata(Country), twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.bAb, data=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==0 & region==iReg+1)))
  # stage 2
  fit.2 = svycoxph(Surv(EventTimeOmicronD43M6hotdeck1,EventIndOmicronD43M6hotdeck1) ~ Day43bindSpike + FOI + risk_score + Sex + strata(Country), twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.bAb, data=subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43 & Trt==0 & region==iReg)))

  print(fit.1)
  print(fit.2)
  getFormattedSummary(list(fit.1, fit.2), robust=T ) [1,]
  
})
t(tab)
```


Compare followup time

```{r}

for (iReg in 1:3) {
  myprint(iReg)
  print(summary(with(subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==0 & region==iReg+1 & EventIndOmicronD43M6hotdeck1==1), as.Date(EnrollmentDate)+EventTimeOmicronD1M12hotdeck1)))
  print(summary(with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43 & Trt==0 & region==iReg   & EventIndOmicronD43M6hotdeck1==1), as.Date(EnrollmentDate)+EventTimeOmicronD1M12hotdeck1)))
}

```


Break down by country

```{r}
# Stage 1 region 4
svycoxph(Surv(EventTimeOmicronD43M6hotdeck1,EventIndOmicronD43M6hotdeck1) ~ BbindSpike + FOI + risk_score + Sex, twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.bAb, data=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==0 & cc%in%c("Nepal","India"))))



```


### Cox models

crude VE D43
```{r}

with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43), table.prop(EventIndOmicronD43M6hotdeck1, Trt))
with(subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43), table.prop(EventIndOmicronD43M6hotdeck1, Trt))
with(subset(dat_proc, Trialstage==2 & Bserostatus==0 & ph1.D43), table.prop(EventIndOmicronD43M6hotdeck1, Trt))
with(subset(dat_proc, Trialstage==1 & Bserostatus==0 & ph1.D43), table.prop(EventIndOmicronD43M6hotdeck1, Trt))

```

crude VE D22
```{r}

with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D22), table.prop(EventIndOmicronD22M6hotdeck1, Trt))
with(subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D22), table.prop(EventIndOmicronD22M6hotdeck1, Trt))
with(subset(dat_proc, Trialstage==2 & Bserostatus==0 & ph1.D22), table.prop(EventIndOmicronD22M6hotdeck1, Trt))
with(subset(dat_proc, Trialstage==1 & Bserostatus==0 & ph1.D22), table.prop(EventIndOmicronD22M6hotdeck1, Trt))

```
Comparing D22 and D43
```{r}
with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43), table.prop(EventIndOmicronD43M6hotdeck10, Trt))
with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D22), table.prop(EventIndOmicronD22M6hotdeck10, Trt))
```
Comparing EventIndKnownLineageOmicronOrMissingLineageD22 and EventIndOmicronD22M6hotdeck10

```{r}
with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D22), table.prop(EventIndKnownLineageOmicronOrMissingLineageD22, Trt))
with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D22), table.prop(EventIndKnownLineageOmicronD22, Trt))
with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D22), table.prop(EventIndOmicronD22M6hotdeck10, Trt))
```

Comparing M6 and d150
```{r}
with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D22), table.prop(EventIndOmicronD22M6hotdeck10, Trt))
with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D22), table.prop(EventIndOmicronD22d150hotdeck10, Trt))
with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43), table.prop(EventIndOmicronD43M6hotdeck10, Trt))
with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43), table.prop(EventIndOmicronD43d150hotdeck10, Trt))
with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph2.D43.nAb), table(EventIndOmicronD43M6hotdeck10, Trt))
with(subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph2.D43.nAb), table(EventIndOmicronD43d150hotdeck10, Trt))
```



```{r}
coxph(Surv(EventTimeOmicronD22M6hotdeck1,EventIndOmicronD22M6hotdeck1) ~ Trt, subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43))

coxph(Surv(EventTimeOmicronD22M6hotdeck1,EventIndOmicronD22M6hotdeck1) ~ Trt, subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43))
```

Baseline spike as correlates in stage 1 NN placebo
```{r}
svycoxph(Surv(EventTimeOmicronD22M6hotdeck1,EventIndOmicronD22M6hotdeck1) ~ BbindSpike, twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.bAb, data=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==0)))

svycoxph(Surv(EventTimeOmicronD22M6hotdeck1,EventIndOmicronD22M6hotdeck1) ~ BbindSpike, twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.bAb, data=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==0 & region==1)))

svycoxph(Surv(EventTimeOmicronD22M6hotdeck1,EventIndOmicronD22M6hotdeck1) ~ BbindSpike, twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.bAb, data=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==0 & region==2)))

svycoxph(Surv(EventTimeOmicronD22M6hotdeck1,EventIndOmicronD22M6hotdeck1) ~ BbindSpike, twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.bAb, data=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==0 & region==3)))

svycoxph(Surv(EventTimeOmicronD22M6hotdeck1,EventIndOmicronD22M6hotdeck1) ~ BbindSpike, twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.bAb, data=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43 & Trt==0 & region==4)))

```


Baseline titer by country in stage 1
```{r}
tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & ph1.D43)
myboxplot(BbindSpike~region, tmp, col=tmp$EventIndOmicronD22M6hotdeck1+1)

tmp=subset(dat_proc, Trialstage==2 & Bserostatus==1 & ph1.D43)
myboxplot(BbindSpike~region, tmp, col=tmp$EventIndOmicronD22M6hotdeck1+1)

```


The scatterplot of the D43 and B titers show that no matter what the baseline titer is, titer after vaccination is about the same.

```{r}
dat=subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43.st2)

plot(Day43pseudoneutid50_mdw~Bpseudoneutid50_mdw, dat, col=dat$EventIndOmicronD43M6hotdeck1+1, pch=ifelse(dat$EventIndOmicronD43M6hotdeck1==1, 2, 1))        

design<-twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.st2.nAb.sen, data=dat)

svycoxph(Surv(EventTimeOmicronD43M6hotdeck1, EventIndOmicronD43M6hotdeck1)~ FOI + risk_score + Sex + strata(Country) + scale(Bpseudoneutid50_mdw,scale=FALSE)*scale(Delta43overBpseudoneutid50_mdw,scale=FALSE), design=design) 

svycoxph(Surv(EventTimeOmicronD43M6hotdeck1, EventIndOmicronD43M6hotdeck1)~ FOI + risk_score + Sex + strata(Country) + Bpseudoneutid50_mdw*Delta43overBpseudoneutid50_mdw, design=design) 

svycoxph(Surv(EventTimeOmicronD43M6hotdeck1, EventIndOmicronD43M6hotdeck1)~ FOI + risk_score + Sex + strata(Country) + scale(Bpseudoneutid50_mdw,scale=FALSE)*scale(Day43pseudoneutid50_mdw,scale=FALSE), design=design) 

svycoxph(Surv(EventTimeOmicronD43M6hotdeck1, EventIndOmicronD43M6hotdeck1)~ FOI + risk_score + Sex + strata(Country) + Bpseudoneutid50_mdw*Day43pseudoneutid50_mdw, design=design) 

        
```


Stage 1 region x b marker interaction model

```{r}
dat=subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43)

design<-twophase(id=list(~1,~1), strata=list(NULL,~Wstratum), subset=~ph2.D43.bAb, data=dat)

svycoxph(Surv(EventTimeOmicronD43M6hotdeck1, EventIndOmicronD43M6hotdeck1)~ FOI + risk_score + Sex + strata(Country) + BbindSpike, design=design) 

svycoxph(Surv(EventTimeOmicronD43M6hotdeck1, EventIndOmicronD43M6hotdeck1)~ FOI + risk_score + Sex + BbindSpike*region, design=design) 

        
```




#### Titers at baseline, D22 and D43

Stage 2 NN Vac. 
D22 titer is inversely correlated with baseline titer among those with detectable baseline titers.

```{r}
tmp=subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph2.D43.nAb)
tmp$b_detectable = ifelse (tmp$Bpseudoneutid50<0.2, 0, 1)

mytable(tmp$b_detectable)

mypairs(tmp[,c("B","Day22","Day43")%.%nassays[1]])

plot(tmp$Day22pseudoneutid50, tmp$Day43pseudoneutid50, col=ifelse(tmp$b_detectable, 1, 2)); abline(0,1)

# nAb
par(mfrow=c(1,2))
lim=c(0,4)
plot(tmp$Bpseudoneutid50, tmp$Day22pseudoneutid50, col=ifelse(tmp$EventIndFirstInfectionD1, 2, 1), xlim=lim, ylim=lim); abline(0,1)
abline(lm(Day22pseudoneutid50~Bpseudoneutid50, tmp[tmp$b_detectable==1,]), lty=2)
plot(tmp$Bpseudoneutid50, tmp$Day43pseudoneutid50, col=ifelse(tmp$EventIndFirstInfectionD1, 2, 1), xlim=lim, ylim=lim); abline(0,1)
abline(lm(Day43pseudoneutid50~Bpseudoneutid50, tmp[tmp$b_detectable==1,]), lty=2)


# bAb
par(mfrow=c(1,2))
lim=c(0,4)
plot(tmp$BbindSpike, tmp$Day22bindSpike, col=ifelse(tmp$EventIndFirstInfectionD1, 2, 1), xlim=lim, ylim=lim); abline(0,1)
# abline(lm(Day22bindSpike~BbindSpike, tmp[tmp$b_detectable==1,]), lty=2)
plot(tmp$BbindSpike, tmp$Day43bindSpike, col=ifelse(tmp$EventIndFirstInfectionD1, 2, 1), xlim=lim, ylim=lim); abline(0,1)
# abline(lm(Day43bindSpike~BbindSpike, tmp[tmp$b_detectable==1,]), lty=2)

```



Stage 2 NN Pla.

```{r}
tmp=subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==0 & ph2.D43.bAb)
tmp$b_detectable = ifelse (tmp$Bpseudoneutid50<0.2, 0, 1)

mytable(tmp$b_detectable)

mypairs(tmp[,c("B","Day22","Day43")%.%nassays[1]])



# bAb
par(mfrow=c(1,2))
lim=c(0,4)
plot(tmp$BbindSpike, tmp$Day22bindSpike, col=ifelse(tmp$EventIndFirstInfectionD1, 2, 1), xlim=lim, ylim=lim); abline(0,1)
# abline(lm(Day22bindSpike~BbindSpike, tmp[tmp$b_detectable==1,]), lty=2)
plot(tmp$BbindSpike, tmp$Day43bindSpike, col=ifelse(tmp$EventIndFirstInfectionD1, 2, 1), xlim=lim, ylim=lim); abline(0,1)
# abline(lm(Day43bindSpike~BbindSpike, tmp[tmp$b_detectable==1,]), lty=2)

```




Stage 1 NN Vac

```{r}
tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph2.D43.nAb)
tmp$b_detectable = ifelse (tmp$Bpseudoneutid50<0.2, 0, 1)

mytable(tmp$b_detectable)

mypairs(tmp[,c("B","Day22","Day43")%.%nassays[1]])

plot(tmp$Day22pseudoneutid50, tmp$Day43pseudoneutid50, col=ifelse(tmp$b_detectable, 1, 2)); abline(0,1)

# nAb
par(mfrow=c(1,2))
lim=c(0,4)
plot(tmp$Bpseudoneutid50, tmp$Day22pseudoneutid50, col=ifelse(tmp$EventIndFirstInfectionD1, 2, 1), xlim=lim, ylim=lim); abline(0,1)
abline(lm(Day22pseudoneutid50~Bpseudoneutid50, tmp[tmp$b_detectable==1,]), lty=2)
plot(tmp$Bpseudoneutid50, tmp$Day43pseudoneutid50, col=ifelse(tmp$EventIndFirstInfectionD1, 2, 1), xlim=lim, ylim=lim); abline(0,1)
abline(lm(Day43pseudoneutid50~Bpseudoneutid50, tmp[tmp$b_detectable==1,]), lty=2)



# nAb, color code nAb detectable
par(mfrow=c(1,2))
lim=c(0,4)
plot(tmp$Bpseudoneutid50, tmp$Day22pseudoneutid50, col=ifelse(tmp$b_detectable, 1, 2), xlim=lim, ylim=lim); abline(0,1)
abline(lm(Day22pseudoneutid50~Bpseudoneutid50, tmp[tmp$b_detectable==1,]), lty=2)
plot(tmp$Bpseudoneutid50, tmp$Day43pseudoneutid50, col=ifelse(tmp$b_detectable, 1, 2), xlim=lim, ylim=lim); abline(0,1)
abline(lm(Day43pseudoneutid50~Bpseudoneutid50, tmp[tmp$b_detectable==1,]), lty=2)



# bAb
par(mfrow=c(1,2))
lim=c(0,4)
plot(tmp$BbindSpike, tmp$Day22bindSpike, col=ifelse(tmp$EventIndFirstInfectionD1, 2, 1), xlim=lim, ylim=lim); abline(0,1)
# abline(lm(Day22bindSpike~BbindSpike+I(BbindSpike^2), tmp[tmp$b_detectable==1,]), lty=2)
plot(tmp$BbindSpike, tmp$Day43bindSpike, col=ifelse(tmp$EventIndFirstInfectionD1, 2, 1), xlim=lim, ylim=lim); abline(0,1)
# abline(lm(Day43bindSpike~BbindSpike+I(BbindSpike^2), tmp[tmp$b_detectable==1,]), lty=2)

```


Stage 1 NN Pla
```{r}
tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==0 & ph2.D43.nAb)
tmp$b_detectable = ifelse (tmp$Bpseudoneutid50<0.2, 0, 1)

mytable(tmp$b_detectable)

mypairs(tmp[,c("B","Day22","Day43")%.%nassays[1]])

plot(tmp$Day22pseudoneutid50, tmp$Day43pseudoneutid50, col=ifelse(tmp$b_detectable, 1, 2)); abline(0,1)

# nAb
par(mfrow=c(1,2))
lim=c(0,4)
plot(tmp$Bpseudoneutid50, tmp$Day22pseudoneutid50, col=ifelse(tmp$EventIndFirstInfectionD1, 2, 1), xlim=lim, ylim=lim); abline(0,1)
abline(lm(Day22pseudoneutid50~Bpseudoneutid50, tmp[tmp$b_detectable==1,]), lty=2)
plot(tmp$Bpseudoneutid50, tmp$Day43pseudoneutid50, col=ifelse(tmp$EventIndFirstInfectionD1, 2, 1), xlim=lim, ylim=lim); abline(0,1)
abline(lm(Day43pseudoneutid50~Bpseudoneutid50, tmp[tmp$b_detectable==1,]), lty=2)



# nAb, color code nAb detectable
par(mfrow=c(1,2))
lim=c(0,4)
plot(tmp$Bpseudoneutid50, tmp$Day22pseudoneutid50, col=ifelse(tmp$b_detectable, 1, 2), xlim=lim, ylim=lim); abline(0,1)
abline(lm(Day22pseudoneutid50~Bpseudoneutid50, tmp[tmp$b_detectable==1,]), lty=2)
plot(tmp$Bpseudoneutid50, tmp$Day43pseudoneutid50, col=ifelse(tmp$b_detectable, 1, 2), xlim=lim, ylim=lim); abline(0,1)
abline(lm(Day43pseudoneutid50~Bpseudoneutid50, tmp[tmp$b_detectable==1,]), lty=2)



# bAb
par(mfrow=c(1,2))
lim=c(0,4)
plot(tmp$BbindSpike, tmp$Day22bindSpike, col=ifelse(tmp$EventIndFirstInfectionD1, 2, 1), xlim=lim, ylim=lim); abline(0,1)
# abline(lm(Day22bindSpike~BbindSpike+I(BbindSpike^2), tmp[tmp$b_detectable==1,]), lty=2)
plot(tmp$BbindSpike, tmp$Day43bindSpike, col=ifelse(tmp$EventIndFirstInfectionD1, 2, 1), xlim=lim, ylim=lim); abline(0,1)
# abline(lm(Day43bindSpike~BbindSpike+I(BbindSpike^2), tmp[tmp$b_detectable==1,]), lty=2)

```


### Fold rise from baseline to D22


Stage 1 NN Vac

```{r}
tmp=subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43)
col=1
# nAb
par(mfrow=c(2,2), oma=c(0,.5,3,.5), mar=c(2.1, 0.1, 2.1, 0.1), mgp = c(2, 1, 0))
lim=c(0,4)
plot(tmp$Bpseudoneutid50, tmp$Day22pseudoneutid50, col=col, xlim=lim, ylim=lim, main="Anc ID50", asp=1); abline(0,1)
plot(tmp$Bpseudoneutid50, tmp$Day43pseudoneutid50_BA.4.5, col=col, xlim=lim, ylim=lim, main="Omi ID50", asp=1); abline(0,1)
# bAb
lim=c(0,4)
plot(tmp$BbindSpike, tmp$Day22bindSpike, col=col, xlim=lim, ylim=lim, main="Anc bAb", asp=1); abline(0,1)
plot(tmp$BbindSpike, tmp$Day22bindSpike_omicron, col=col, xlim=lim, ylim=lim, main="Omi bAb", asp=1); abline(0,1)
#
title(main="VAT08 Monovalent Non-Naive", outer=T, line=0)
```


Stage 2 NN Vac

```{r}
tmp=subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43)
col=1
# nAb
par(mfrow=c(2,2), oma=c(0,0.5,3,0.5), mar=c(2.1, 0.1, 2.1, 0.1), mgp = c(2, 1, 0))
lim=c(0,4)
plot(tmp$Bpseudoneutid50_save, tmp$Day22pseudoneutid50_save, col=col, xlim=lim, ylim=lim, main="Ancestral ID50", asp=1); abline(0,1)
plot(tmp$Bpseudoneutid50_save, tmp$Day43pseudoneutid50_BA.4.5_save, col=col, xlim=lim, ylim=lim, main="Omicron ID50", asp=1); abline(0,1)
# bAb
lim=c(0,4)
plot(tmp$BbindSpike, tmp$Day22bindSpike, col=col, xlim=lim, ylim=lim, main="Ancestral bAb", asp=1); abline(0,1)
plot(tmp$BbindSpike, tmp$Day22bindSpike_omicron, col=col, xlim=lim, ylim=lim, main="Omicron bAb", asp=1); abline(0,1)
#
title(main="VAT08 Bivalent Non-Naive", outer=T, line=0)
```

Stage 2 NN Vac, using nAbBatch 2 only

```{r}
tmp=subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph2.D22.st2.nAb.sen)
col=1
# nAb
par(mfrow=c(2,2), oma=c(0,0.5,3,0.5), mar=c(2.1, 0.1, 2.1, 0.1), mgp = c(2, 1, 0))
lim=c(0,4)
plot(tmp$Bpseudoneutid50_save, tmp$Day22pseudoneutid50_save, col=col, xlim=lim, ylim=lim, main="Ancestral ID50", asp=1); abline(0,1)
plot(tmp$Bpseudoneutid50_save, tmp$Day43pseudoneutid50_BA.4.5_save, col=col, xlim=lim, ylim=lim, main="Omicron ID50", asp=1); abline(0,1)
# bAb
lim=c(0,4)
plot(tmp$BbindSpike, tmp$Day22bindSpike, col=col, xlim=lim, ylim=lim, main="Ancestral bAb", asp=1); abline(0,1)
plot(tmp$BbindSpike, tmp$Day22bindSpike_omicron, col=col, xlim=lim, ylim=lim, main="Omicron bAb", asp=1); abline(0,1)
#
title(main="VAT08 Bivalent Non-Naive", outer=T, line=0)
```


### Make tables for SAP

Sec 6.1

```{r}
# bAb
with(subset(dat_proc, SubcohortIndbAb==1 & Trialstage==1 & Bserostatus==0),
     mytable(tps.stratum.immuno))
```

### Reverse-engineer SubcohortInd for stage 1

```{r}
tmp=subset(dat_proc, Trialstage==1 & Trt==1 & ph1.D43 & Bserostatus==1)
```

All bAb and all variants ID50 data are in the two nAbBatch. Some ancestral ID50 are in batch 0 only, but we won't use them since they are from another study, has its own batch effect.
```{r}
mytable(!is.na(tmp$Day43pseudoneutid50_B.1.351), tmp$nAbBatch)
mytable(!is.na(tmp$Day43bindSpike), tmp$nAbBatch)
```

A subset of ptids with ID50 has bAb. Most ptids with bAb have ID50.
```{r}
mytable(!is.na(tmp$Day43bindSpike), !is.na(tmp$Day43pseudoneutid50_B.1.351), tmp$EventIndFirstInfectionD1)
```
Expand to both arms and both NN and N
```{r}
mytable(!is.na(subset(dat_proc, Trialstage==1)$Day43bindSpike), !is.na(subset(dat_proc, Trialstage==1)$Day43pseudoneutid50_B.1.351), subset(dat_proc, Trialstage==1)$Trt, subset(dat_proc, Trialstage==1)$Bserostatus)
```


A total of 69 cases were assayed across the two batches, and a total of 207 non-cases were sampled.
```{r}
mytable(tmp$EventIndFirstInfectionD1, tmp$nAbBatch)
```
Most of the assayed ptids are not on the pick list (step 1+2), and most of the pick list were not assayed.
```{r}
mytable(tmp$SamplingStep, tmp$nAbBatch)
```



```{r}
mytable(tmp$EventIndFirstInfectionD1, tmp$tps.stratum)
mytable(tmp$nAbBatch, tmp$tps.stratum)
mytable(tmp$nAbBatch[tmp$EventIndFirstInfectionD1==1], tmp$tps.stratum[tmp$EventIndFirstInfectionD1==1])
mytable(!is.na(tmp$nAbBatch), tmp$tps.stratum, tmp$EventIndFirstInfectionD1)
```


```{r}
mytable(!is.na(tmp$Day43bindSpike), tmp$tps.stratum, tmp$EventIndFirstInfectionD1)
```




```{r}

tmp=subset(dat_mapped, Trialstage==1 & Trt==1 & ph1.D43 & Bserostatus==1)
tmp$SubcohortInd1=tmp$SubcohortInd
tmp$SubcohortInd1[tmp$cc=="Japan" | tmp$cc=="United States"]=1


tmp$tmp = is.na(tmp$Day43pseudoneutid50_B.1.351) & !is.na(tmp$Day43pseudoneutid50)
tmp$nAbBatch1=tmp$nAbBatch
tmp$nAbBatch1[tmp$tmp]=0
```


```{r}

mytable(!is.na(tmp$Day43bindSpike_beta), !is.na(tmp$Day43bindSpike), tmp$nAbBatch, tmp$SubcohortInd1)

mytable(!is.na(tmp$Day43pseudoneutid50_B.1.351), !is.na(tmp$Day43pseudoneutid50), tmp$nAbBatch, tmp$SubcohortInd1)

mytable(!is.na(tmp$Day43pseudoneutid50_B.1.351), !is.na(tmp$Day43pseudoneutid50), tmp$nAbBatch, tmp$SubcohortInd1, tmp$EventIndFirstInfectionD1)


mytable(tmp$SubcohortInd, tmp$nAbBatch)

mytable(tmp$SubcohortInd, tmp$nAbBatch, tmp$EventIndFirstInfectionD1)


mytable(tmp$SubcohortInd1, tmp$nAbBatch)

mytable(tmp$SubcohortInd1, tmp$nAbBatch1, tmp$EventIndFirstInfectionD1)


mytable(tmp$SubcohortInd, tmp$SamplingStep)

```



```{r}
mytable(!is.na(tmp$Day43bindSpike_beta), !is.na(tmp$Day43bindSpike), tmp$nAbBatch)
mytable(!is.na(tmp$Day43bindSpike_beta)[tmp$SubcohortInd==1], !is.na(tmp$Day43bindSpike)[tmp$SubcohortInd==1], tmp$nAbBatch[tmp$SubcohortInd==1])

```


```{r}
mytable(!is.na(tmp$Day43pseudoneutid50_B.1.351), !is.na(tmp$Day43pseudoneutid50), tmp$nAbBatch)
mytable(!is.na(tmp$Day43pseudoneutid50_B.1.351)[tmp$SubcohortInd==1], !is.na(tmp$Day43pseudoneutid50)[tmp$SubcohortInd==1], tmp$nAbBatch[tmp$SubcohortInd==1])

```


in stage 1, 
```{r}
tmp=subset(dat_mapped, Trialstage==1 & Trt==1 & ph1.D43 & Bserostatus==1)
tmp$tmp = is.na(tmp$Day43pseudoneutid50_B.1.351)
tmp$nAbBatch1=tmp$nAbBatch
tmp$nAbBatch1[tmp$tmp]=0

mytable(tmp$tmp, tmp$nAbBatch)
mytable(!is.na(tmp$Day43pseudoneutid50_B.1.351), !is.na(tmp$Day43pseudoneutid50))
mytable(!is.na(tmp$Day43pseudoneutid50_B.1.351), !is.na(tmp$Day43pseudoneutid50), tmp$nAbBatch)
mytable(!is.na(tmp$Day43pseudoneutid50_B.1.351)[tmp$SubcohortInd==1], !is.na(tmp$Day43pseudoneutid50)[tmp$SubcohortInd==1], tmp$nAbBatch[tmp$SubcohortInd==1])



mytable(!is.na(tmp$Day43pseudoneutid50_B.1.351), tmp$nAbBatch)
mytable(!is.na(tmp$Day43pseudoneutid50), tmp$nAbBatch)

```






Stage 1: Is it reasonable to assume that the cases in the subcohortid are subchort? 

```{r}
tmp=subset(dat_proc, Trialstage==1 & Trt==1 & ph1.D43 & Bserostatus==1)

table.prop(tmp$EventIndFirstInfectionD1, tmp$SubcohortInd)
fisher.test(table(tmp$EventIndFirstInfectionD1, tmp$SubcohortIndbAb)) 

table.prop(tmp$EventIndFirstInfectionD1[tmp$region==1], tmp$SubcohortInd[tmp$region==1])
table.prop(tmp$EventIndFirstInfectionD1[tmp$region!=1], tmp$SubcohortInd[tmp$region!=1])

mytable(tmp$SubcohortIndbAb, !is.na(tmp$Day43pseudoneutid50_B.1.351), tmp$EventIndFirstInfectionD1)
```



### Reverse-engineer SubcohortInd for Stage 2

```{r}
tmp=subset(dat_mapped, Trialstage==2 & Trt==1 & ph1.D43 & Bserostatus==1)
```

In stage 2, Batch 1 perfectly corresponds to the step 2 pick list, which is a good news. If we have the step 1 pick list, we can compare it to batch 2. If batch 2 turns out to the sum of step 1 pick list and cases, then we know the subcohort = step 1 + step 2.
```{r}
mytable(tmp$SamplingStep, tmp$nAbBatch, tmp$EventIndFirstInfectionD1)

```

One puzzling observation is that step 2 case rate is 4.6%, while outside of step 2, it is 1.3% (Fisher test p value <0.001). Could this be explained by, e.g., the sampling plan favors senior?

Another observation is that step 2 sampling doc indicates 500 ptids, but the csv file has ~700 ptids. I recall there was an explanation for that, but I cannot remember now.

```{r}
table.prop(tmp$EventIndFirstInfectionD1, tmp$stage2step2)
fisher.test(table(tmp$EventIndFirstInfectionD1, tmp$SamplingStep))
```

About half of the ptids with nAb also has bAb. The ptids with bAb mostly have nAb as well.

```{r}
mytable(!is.na(tmp$Day43bindSpike_omicron), !is.na(tmp$Day43pseudoneutid50_BA.4.5), tmp$nAbBatch)


```





### Stage 1 batch effects

```{r}
tmp=subset(dat_proc, Trialstage==1 & Trt==1 & ph1.D43 & Bserostatus==1)
tmp$nAbBatch1=tmp$nAbBatch
tmp$nAbBatch1[is.na(tmp$Day43pseudoneutid50_B.1.351)]=0
```



```{r}
# mytable(tmp$tmp, tmp$nAbBatch)
mytable(!is.na(tmp$Day43pseudoneutid50_B.1.351), !is.na(tmp$Day43pseudoneutid50))

# myboxplot(Day43pseudoneutid50~tmp, tmp, test="w", names=c("has variant ID50", "no variant ID50"))

myboxplot(Day43pseudoneutid50~nAbBatch1, tmp[tmp$nAbBatch1==0 | tmp$nAbBatch1==2,], test="w")


par(mfrow=c(1,2))
myboxplot(Day43pseudoneutid50~nAbBatch1, tmp[!is.na(tmp$Day43pseudoneutid50),], col=ifelse(tmp[!is.na(tmp$Day43pseudoneutid50),]$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5)+1, main="Anc ID50 by Batch in Mono NN")
myboxplot(Day43bindSpike~nAbBatch, tmp[!is.na(tmp$Day43pseudoneutid50),], col=ifelse(tmp[!is.na(tmp$Day43pseudoneutid50),]$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="Anc Spike by Batch in Mono NN")


par(mfrow=c(1,1))
myboxplot(Day43pseudoneutid50~region+nAbBatch1, tmp[!is.na(tmp$Day43pseudoneutid50),], col=ifelse(tmp[!is.na(tmp$Day43pseudoneutid50),]$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="Anc ID50 by Batch in Mono NN")

subset(tmp, !is.na(Day43pseudoneutid50) & region==3 & batch0)
mytable(tmp$EventIndOmicronD43M6hotdeck10, tmp$region, tmp$nAbBatch)

par(mfrow=c(1,2))
myboxplot(Day43pseudoneutid50_B.1.351~nAbBatch, tmp[!is.na(tmp$Day43pseudoneutid50_B.1.351),], col=ifelse(tmp[!is.na(tmp$Day43pseudoneutid50_B.1.351),]$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="B.1 ID50 by Batch in Mono NN")
myboxplot(Day43bindSpike_beta~nAbBatch, tmp[!is.na(tmp$Day43pseudoneutid50_B.1.351),], col=ifelse(tmp[!is.na(tmp$Day43pseudoneutid50_B.1.351),]$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="Beta Spike by Batch in Mono NN")


par(mfrow=c(1,1))
# myboxplot(Day43pseudoneutid50~region+nAbBatch, tmp[!is.na(tmp$Day43pseudoneutid50),], col=ifelse(tmp[!is.na(tmp$Day43pseudoneutid50),]$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="Anc ID50 by Batch in Mono NN", cex.main=1.1)
myboxplot(Day43pseudoneutid50_B.1.351~region+nAbBatch, tmp[!is.na(tmp$Day43pseudoneutid50_B.1.351),], col=ifelse(tmp[!is.na(tmp$Day43pseudoneutid50_B.1.351),]$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="B.1 ID50 by Batch in Mono NN")

par(mfrow=c(1,1))
# myboxplot(Day43bindSpike~region+nAbBatch, tmp[!is.na(tmp$Day43pseudoneutid50),], col=ifelse(tmp[!is.na(tmp$Day43pseudoneutid50),]$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="Anc Spike by Batch in Mono NN", cex.main=1.1)
myboxplot(Day43bindSpike_beta~region+nAbBatch, tmp[!is.na(tmp$Day43pseudoneutid50_B.1.351),], col=ifelse(tmp[!is.na(tmp$Day43pseudoneutid50_B.1.351),]$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="Beta Spike by Batch in Mono NN")

coxph(Surv(EventTimeOmicronD43M6hotdeck2,EventIndOmicronD43M6hotdeck2)~FOI + risk_score + Sex + strata(Country)+Day43bindSpike_beta, tmp[tmp$ph2.D43.bAb==1,], weights=tmp$wt.D43.bAb[tmp$ph2.D43.bAb==1])

coxph(Surv(EventTimeOmicronD43M6hotdeck1,EventIndOmicronD43M6hotdeck1)~FOI + risk_score + Sex + strata(Country)+Day43pseudoneutid50_B.1.351, tmp[tmp$ph2.D43.nAb==1,], weights=tmp$wt.D43.bAb[tmp$ph2.D43.nAb==1])


mytable(!is.na(tmp$Day43pseudoneutid50), tmp$nAbBatch1)
mytable(!is.na(tmp$Day43pseudoneutid50_B.1.351), tmp$nAbBatch1)

```

Repeat boxplots for different variants
```{r}
par(mfrow=c(1,5), mar=c(4,1,4,1))
myboxplot(Day43pseudoneutid50~nAbBatch, tmp, col=ifelse(tmp$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="")
myboxplot(Day43pseudoneutid50_B.1.351~nAbBatch, tmp, col=ifelse(tmp$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="")
myboxplot(Day43pseudoneutid50_BA.1~nAbBatch, tmp, col=ifelse(tmp$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="")
myboxplot(Day43pseudoneutid50_BA.2~nAbBatch, tmp, col=ifelse(tmp$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="")
myboxplot(Day43pseudoneutid50_BA.4.5~nAbBatch, tmp, col=ifelse(tmp$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="")
title(out=T, main="ID50 by Batch in Mono NN: Anc, Beta, BA1, BA2, BA4.5", line=-2)
```


Define a calendar period of enrollment indicator that approximately or fully separates batch 1 vs. batch 2 for Stage 1 Columbia + Honduras, and then adjust for that calendar time variable.  This could be a way to adjust for potential bias without mentioning a potential batch effect

```{r}
x1=tmp[tmp$region==2 & tmp$nAbBatch==1 & tmp$EventIndOmicronD43M6hotdeck1==1, "EnrollmentDate"]
x2=tmp[tmp$region==2 & tmp$nAbBatch==1 & tmp$EventIndOmicronD43M6hotdeck1==0, "EnrollmentDate"]
x3=tmp[tmp$region==2 & tmp$nAbBatch==2 & tmp$EventIndOmicronD43M6hotdeck1==1, "EnrollmentDate"]
x4=tmp[tmp$region==2 & tmp$nAbBatch==2 & tmp$EventIndOmicronD43M6hotdeck1==0, "EnrollmentDate"]
tab=data.frame(
  n=c(sum(!is.na(x1)), sum(!is.na(x2)), sum(!is.na(x3)), sum(!is.na(x4))),
  "min EnrollmentDate"=c(min(x1), min(x2,na.rm=T), min(x3,na.rm=T), min(x4,na.rm=T)),
  "median EnrollmentDate"=c(median(x1), median(x2,na.rm=T), median(x3,na.rm=T), median(x4,na.rm=T)),
  "max EnrollmentDate"=c(max(x1), max(x2,na.rm=T), max(x3,na.rm=T), max(x4,na.rm=T))
)
rownames(tab)=c("batch 1 cases", "batch 1 non-cases", "batch 2 cases", "batch 2 non-cases")
tab
```




### Stage 2 batch effects

```{r}
tmp=subset(dat_proc, Trialstage==2 & Trt==1 & ph1.D43 & Bserostatus==1)

mytable(tmp$nAbBatch, tmp$EventIndOmicronD43M6hotdeck1)

par(mfrow=c(1,2))
myboxplot(Day43pseudoneutid50~nAbBatch, tmp[!is.na(tmp$Day43pseudoneutid50),], col=ifelse(tmp[!is.na(tmp$Day43pseudoneutid50),]$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="Anc ID50 by Batch in Bi NN")
# myboxplot(Day43pseudoneutid50_B.1.351~nAbBatch, tmp[!is.na(tmp$Day43pseudoneutid50_B.1.351),], col=ifelse(tmp[!is.na(tmp$Day43pseudoneutid50_B.1.351),]$EventIndFirstInfectionD1==1, 2, 1), ylim=c(0,4.5), main="B.1 ID50 by Batch in Bi NN")
myboxplot(Day43bindSpike~nAbBatch, tmp[!is.na(tmp$Day43pseudoneutid50),], col=ifelse(tmp[!is.na(tmp$Day43pseudoneutid50),]$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="Anc Spike by Batch in Bi NN") 


par(mfrow=c(1,1))
myboxplot(Day43pseudoneutid50~region+nAbBatch, tmp[!is.na(tmp$Day43pseudoneutid50),], col=ifelse(tmp[!is.na(tmp$Day43pseudoneutid50),]$EventIndOmicronD43M6hotdeck1==1, 2, 1), ylim=c(0,4.5), main="Anc ID50 by Batch in Bi NN")

```



### nAb missingness

Many ptids only have the ancestral marker measured. The missingness pattern is explained by the fact that samples from different steps have different set of markers measured. We will use one weight for ancestral ID50 and another for variant ID50s.

```{r}
dat1=dat_mapped
# the pattern in cases is un-remarkable
# dat1=subset(dat_mapped, 1==EventIndPrimaryD1)
for (t in 2:1) {
  cat(paste0("stage ", t, '\n'))
  for (tp in c("B", "Day22", "Day43")) {
    for(trt in 1) { # placebo has a similar pattern
      myprint(tp, trt)
      dat=subset(dat1, Trialstage==t & ph1.D43 & Trt==trt) # pattern is independent of Bserostatus
      for (i in 1:5) {
        dat[['tmp'%.%i]]=ifelse(is.na(dat[[tp%.%nassays[i]]]), 0, 1)
      }
      dat$tmp=with(dat,paste0(tmp1,tmp2,tmp3,tmp4,tmp5))
      print(table(dat$tmp))
      cat("\n")
    }
  }
}
```


After imputation, 
```{r}
dat1=dat_proc
# the pattern in cases is un-remarkable
# dat1=subset(dat_mapped, 1==EventIndPrimaryD1)
for (t in 2:1) {
  cat(paste0("stage ", t, '\n'))
  for (tp in c("B", "Day22", "Day43")) {
    for(trt in 1) { # placebo has a similar pattern
      myprint(tp, trt)
      dat=subset(dat1, Trialstage==t & ph2.D22.nAb & Trt==trt) # pattern is independent of Bserostatus
      for (i in 1:5) {
        dat[['tmp'%.%i]]=ifelse(is.na(dat[[tp%.%nassays[i]]]), 0, 1)
      }
      dat$tmp=with(dat,paste0(tmp1,tmp2,tmp3,tmp4,tmp5))
      print(table(dat$tmp))
      cat("\n")
    }
  }
}
```

Missingness across baseline, d22 and d43, for the ancestral markers in the vaccine arms. The results support the decision "**to keep it simple and require for RIS membership availability of data at all 3 time points**" (Peter).


```{r}
for(trt in 1:0) {
  myprint(trt)
  for (i in 2:1) {
    cat(paste0("stage ", i, '\n'))
    dat=subset(dat_proc, Trialstage==i & Trt==trt & ph1.D43)
    times=c("B","Day22","Day43")
    for (i in 1:3) {
      dat[['tmp'%.%i]]=ifelse(is.na(dat[[times[i]%.%'pseudoneutid50']]), 0, 1)
    }
    dat$tmp=with(dat,paste0(tmp1,tmp2,tmp3))
    print(table(dat$tmp))
    cat("\n")
  }
}
```


```{r}
# a more detailed look at missingness by batch
# for (tp in c("B")) {
# #for (tp in c("B", "Day22", "Day43")) {
#   # before imputation
#   dat1=dat_mapped
#   # after imputation
#   # dat1=dat_proc
#   
#   for(trt in 1) {
#     myprint(tp, trt)
#     for (i in 2:1) { # stage
#       cat(paste0("stage ", i, '\n'))
#       if (trt==2) {
#         # pool over arms
#         dat=subset(dat1, Trialstage==i & ph1.D43)
#       } else {
#         dat=subset(dat1, Trialstage==i & ph1.D43 & Trt==trt)
#       }
#       for (i in 1:5) {
#         dat[['tmp'%.%i]]=ifelse(is.na(dat[[tp%.%nassays[i]]]), 0, 1)
#       }
#       dat$tmp=with(dat,paste0(tmp1,tmp2,tmp3,tmp4,tmp5))
#       print(mytable(dat$EventIndPrimaryD43, dat$tmp, dat$nAbBatch, dat$Bserostatus))
#     }
#   }
# 
# }
```


The number of D43 nAb ph2 samples by Bserostatus 0/1 (row) and Case 1/0 (column) and broken down by treatment arms (vaccine, placebo).
```{r}
dat1=dat_proc

f=function(tab2, tab1, tab0) {
  for (i in 1:2) {
    print(paste0(tab2[i,1], " (", tab1[i,1], ", ", tab0[i,1], ") ", tab2[i,2], " (", tab1[i,2], ", ", tab0[i,2], ")"))
  }
}

for (i in 2:1) {
  cat(paste0("stage ", i, '\n'))
  dat=subset(dat1, Trialstage==i & ph1.D43 & TwophasesampIndnAb)
  tab2 = table(dat$Bserostatus, dat$EventIndPrimaryD43)[,2:1] # [,2:1] moves cases before non-cases
  dat=subset(dat1, Trialstage==i & ph1.D43 & Trt==1 & TwophasesampIndnAb)
  tab1 = table(dat$Bserostatus, dat$EventIndPrimaryD43)[,2:1] # [,2:1] moves cases before non-cases
  dat=subset(dat1, Trialstage==i & ph1.D43 & Trt==0 & TwophasesampIndnAb)
  tab0 = table(dat$Bserostatus, dat$EventIndPrimaryD43)[,2:1] # [,2:1] moves cases before non-cases
  f(tab2, tab1, tab0)
}
```
### nAb and bAb correlation


Correlation is high between variant markers in Stage 2 non-naive, vaccine arm at both baseline and D43 
```{r}
mypairs(subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43)[,"Day43"%.%c(nassays[1:3], bassays[c(1,2,8)])])
```

### Connecting pairs of nAb and bAb markers
Using D43 assays to find matches. 
There are 5 nAb assays and 8 bAb assays. For each nAb assay, 

       nAb                       bAb
[1,] "pseudoneutid50"         "bindSpike"        
[2,] "pseudoneutid50_B.1.351" "bindSpike_beta"   
[3,] "pseudoneutid50_BA.1"    "bindSpike_omicron"  
[4,] "pseudoneutid50_BA.2"    "bindSpike_omicron"  
[5,] "pseudoneutid50_BA.4.5"  "bindSpike_omicron" 
[6,] NA                       "bindSpike_delta1" 
[6,] NA                       "bindSpike_delta2" 
[6,] NA                       "bindSpike_delta3" 
[6,] NA                       "bindSpike_gamma" 
[6,] NA                       "bindSpike_alpha" 



```{r}
summary(subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43)[,"Day43"%.%c(bassays)])
```


### nAb correlation


Correlation is high between variant markers in Stage 2 non-naive, vaccine arm at both baseline and D43 
```{r}
mypairs(subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43)[,"B"%.%nassays])
mypairs(subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43)[,"Day43"%.%nassays])
mypairs(subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43)[,"B"%.%nassays])
mypairs(subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43)[,"Day43"%.%nassays])
```


Correlation is medium between variant markers at D43 in Stage 2 naive, vaccine arm. (The correlation between the ancestral marker and the other markers range between 0.63 and 0.67.)
```{r}
mypairs(subset(dat_proc, Trialstage==2 & Bserostatus==0 & Trt==1 & ph1.D43)[,"Day43"%.%nassays])
```

In stage 1, correlation is medium between ancestral markers and other markers. Correlation is high between BA4BA5 and BA1 among non-naive, but medium among naive. 
```{r}
mypairs(subset(dat_proc, Trialstage==1 & Bserostatus==1 & Trt==1 & ph1.D43)[,"Day22"%.%nassays])
mypairs(subset(dat_proc, Trialstage==1 & Bserostatus==0 & Trt==1 & ph1.D43)[,"Day22"%.%nassays])
```


A closer look at the relationship between baseline and Day 43 markers in the baseline positive. Note that the D43 markers appear saturated since level seems flat across different baseline marker levels.

```{r}
par(mfrow=c(2,4))
  # ancestral marker
  corplot(Day43pseudoneutid50~Bpseudoneutid50, subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43), ylim=c(0,4))
  myboxplot(Day43pseudoneutid50~I(Bpseudoneutid50>0.2), subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43), names=c("Undetectable at B","Detectable at B"), ylab="D43", ylim=c(0,4))
  my.interaction.plot(subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43 & !is.na(Bpseudoneutid50) & !is.na(Day43pseudoneutid50), c(Bpseudoneutid50, Day43pseudoneutid50)), 
                      x.ori = 0, xaxislabels = c("B", "D43"), cex.axis = 1, add = FALSE, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  
  corplot(Delta43overBpseudoneutid50~Bpseudoneutid50, subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43))
  
  # BA.1
  corplot(Day43pseudoneutid50_BA.1~Bpseudoneutid50_BA.1, subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43), ylim=c(0,4))
  myboxplot(Day43pseudoneutid50_BA.1~I(Bpseudoneutid50_BA.1>0.2), subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43), names=c("Undetectable at B","Detectable at B"), ylab="D43", ylim=c(0,4))
  my.interaction.plot(subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43 & !is.na(Bpseudoneutid50_BA.1) & !is.na(Day43pseudoneutid50_BA.1), c(Bpseudoneutid50_BA.1, Day43pseudoneutid50_BA.1)), 
                      x.ori = 0, xaxislabels = c("B", "D43"), cex.axis = 1, add = FALSE, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  
  corplot(Delta43overBpseudoneutid50_BA.1~Bpseudoneutid50_BA.1, subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43))
```






### bAb missingness

Missingness across variants is mostly all or none. We decide to impute all variants if one variant marker exists.

```{r}
# before imputation
dat1=dat_mapped
# after imputation
# dat1=dat_proc
for (t in 2:1) {
  cat(paste0("stage ", t, '\n'))
  # for (tp in c("B")) {
  for (tp in c("B", "Day22", "Day43")) {
    
    # placebo has a similar patten
    for(trt in 1) {
      myprint(tp, trt)
      if (trt==2) {
        # pool over arms
        dat=subset(dat1, Trialstage==t & ph1.D43)
      } else {
        dat=subset(dat1, Trialstage==t & ph1.D43 & Trt==trt)
      }
      for (i in 1:8) {
        dat[['tmp'%.%i]]=ifelse(is.na(dat[[tp%.%bassays[i]]]), 0, 1)
      }
      dat$tmp=with(dat,paste0(tmp1,tmp2,tmp3,tmp4,tmp5,tmp6,tmp7,tmp8))
      print(table(dat$tmp))
      cat("\n")
      # print(table(dat$EventIndPrimaryD43, dat$tmp, dat$Bserostatus))
    }
  }

}
```  
  
Missingness across baseline, d22 and d43, for the ancestral markers in the vaccine arms. 

```{r}
for(trt in 1:0) {
  myprint(trt)
  for (i in 2:1) {
    cat(paste0("stage ", i, '\n'))
    dat=subset(dat_proc, Trialstage==i & Trt==trt & ph1.D43)
    times=c("B","Day22","Day43")
    for (i in 1:3) {
      dat[['tmp'%.%i]]=ifelse(is.na(dat[[times[i]%.%'bindSpike']]), 0, 1)
    }
    dat$tmp=with(dat,paste0(tmp1,tmp2,tmp3))
    print(table(dat$tmp))
    cat("\n")
  }
}
```
  


### bAb correlation


Correlation is high between variant markers in Stage 2 non-naive, vaccine arm at baseline
```{r}
mypairs(subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43)[,"B"%.%bassays])
```

and D43 

```{r}
mypairs(subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43)[,"Day43"%.%bassays])
```
 
Correlation is still high between variant markers at D43 in Stage 2 naive, vaccine arm. (The correlation between the ancestral marker and the other markers range between 0.63 and 0.67.)
```{r}
mypairs(subset(dat_proc, Trialstage==2 & Bserostatus==0 & Trt==1 & ph1.D43)[,"Day43"%.%bassays])
```

Correlation is low between baseline and D22 or D43 in Stage 2 non-naive, vaccine arm.
```{r}
mypairs(subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43)[,c("B","Day22","Day43")%.%bassays[1]])
mypairs(subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43)[,c("B","Day22","Day43")%.%bassays[8]])
```

A closer look at the relationship between baseline and Day 43 markers in the baseline positive. Note that the D43 markers appear saturated since level seems flat across different baseline marker levels.

```{r}
par(mfrow=c(2,4))
  # ancestral marker
  corplot(Day43bindSpike~BbindSpike, subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43), ylim=c(0,4))
  myboxplot(Day43bindSpike~I(BbindSpike>0.5), subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43), names=c("Undetectable at B","Detectable at B"), ylab="D43", ylim=c(0,4))
  my.interaction.plot(subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43 & !is.na(BbindSpike) & !is.na(Day43bindSpike), c(BbindSpike, Day43bindSpike)), 
                      x.ori = 0, xaxislabels = c("B", "D43"), cex.axis = 1, add = FALSE, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  
  corplot(Delta43overBbindSpike~BbindSpike, subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43))
  
  # omicron
  corplot(Day43bindSpike_omicron~BbindSpike_omicron, subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43), ylim=c(0,4))
  myboxplot(Day43bindSpike_omicron~I(BbindSpike_omicron>0.5), subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43), names=c("Undetectable at B","Detectable at B"), ylab="D43", ylim=c(0,4))
  my.interaction.plot(subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43 & !is.na(BbindSpike_omicron) & !is.na(Day43bindSpike_omicron), c(BbindSpike_omicron, Day43bindSpike_omicron)), 
                      x.ori = 0, xaxislabels = c("B", "D43"), cex.axis = 1, add = FALSE, xlab = "", ylab = "", pcol = NULL, lcol = NULL)  
  corplot(Delta43overBbindSpike_omicron~BbindSpike_omicron, subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43))
```  
  


### Misc


missingness pattern across nAb and bAb markers shows that there is no overlap in pattern between nAb and nAb in stage 1 or 2. 
```{r}
  # prev.vacc = get.marginalized.risk.no.marker(form.0, subset(dat_proc, Trt==1 & ph1), tfinal.tpeak)
  # prev.plac = get.marginalized.risk.no.marker(form.0, subset(dat_proc, Trt==0 & ph1), tfinal.tpeak)   
  # overall.ve = c(1 - prev.vacc/prev.plac) 
  # myprint(prev.plac, prev.vacc, overall.ve)



dat1=dat_mapped
for (t in 2:1) {
  cat(paste0("stage ", t, '\n'))
  for (tp in c("Day43")) {

    # placebo has a similar pattern
    for(trt in 1) {
      myprint(tp, trt)
      dat=subset(dat1, Trialstage==t & ph1.D43 & Trt==trt)
      
      dat$tmp1 = ifelse(is.na(dat$Day43pseudoneutid50), 0, 1)
      dat$tmp2 = ifelse(is.na(dat$Day43pseudoneutid50_B.1.351), 0, 1)
      dat$tmp3 = ifelse(is.na(dat$Day43bindSpike), 0, 1)
      
      dat$tmp=with(dat,paste0(tmp1,tmp2))
      print(table(dat$tmp))
      dat$tmp=with(dat,paste0(tmp1,tmp3))
      print(table(dat$tmp))
      dat$tmp=with(dat,paste0(tmp2,tmp3))
      print(table(dat$tmp))
      cat("\n")
    }
  }
}
```






Omicron bAb ULOQ may be too low.

```{r}
corplot(Day43bindSpike_omicron~Day43bindSpike, subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43), add.diagonal.line = F, method="pearson")
corplot(Day43pseudoneutid50_BA.4.5~Day43pseudoneutid50, subset(dat_proc, Trialstage==2 & Bserostatus==1 & Trt==1 & ph1.D43), add.diagonal.line = F, method="pearson")
```

correlation and missingness across bAb and nAb

```{r}
  for (sero in c(0,1)) {    
    for (trt in c(0,1)) {
      for (stage in c(1,2)) {
        myprint(stage, trt, sero)
        dat=subset(dat_mapped, Trialstage==stage & Trt==trt & Bserostatus==sero)
        corplot(Day43bindSpike~Day43pseudoneutid50, dat)
        print(table(!is.na(dat$Day43bindSpike), !is.na(dat$Day43pseudoneutid50), dat$EventIndPrimaryD43))
      }
    }
}
```



Note that the marker level in the NN, placebo is higher in Stage 2 than in Stage 1, probably reflecting different countries.
```{r}
myboxplot(Day43bindSpike~Trt+Bserostatus+Trialstage, dat_mapped, ylab="D43 bAb Spike",
  names=rep(c("N,pla", "N,vac", "NN,pla", "NN,vac"),2),
  main="Stage 1                                        Stage 2",
  cex.axis=0.8)
abline(v=4.5)
```


  
### Check which ptids are in which batch

We have lists of ptids sampled in step 2 in both stages of the trial.

Stage 2, nAb. batch 1 = step2 for both cases and noncases
```{r}
with(subset(dat_proc, Trt==1 & Trialstage==2 & ph2.D43.nAb & EventIndPrimaryD1==1), table(SamplingStep, nAbBatch, Bserostatus))
```

Check timing of cases in the two batches
```{r}
myboxplot(EventTimePrimaryD1~nAbBatch+Trt, subset(dat_proc, Trialstage==2 & EventIndPrimaryD1==1 & ph2.D43.nAb & Bserostatus==1), 
          names=c(outer(c("Batch 1,","Batch 2,"), c("Plac","Vacc"), paste)), main="Stage 2 Non-Naive Ph2.D43 Cases")
```


for slide 27
```{r}
with(subset(dat_proc, Trialstage==1 & ph2.D43.nAb & Bserostatus==1), mytable(nAbBatch, 1-EventIndOmicronD43M6hotdeck10, Trt))
with(subset(dat_proc, Trialstage==1 & ph1.D43 & Bserostatus==1 & batch0), mytable(Trt, 1-EventIndOmicronD43M6hotdeck10))
```


Stage 1, nAb. Most non-cases are done in batch 2, most cases are done in batch 1. Step 1 and 2 are spread mostly equally between batches.
Step 1 has ancestral only and no variants

batch NA/step 1 has 706 ptids who have ancestral ID50 but no variant ID50

```{r}

with(subset(dat_proc, Trialstage==1 & ph2.D43.nAb & Bserostatus==1 & Trt==1), mytable(nAbBatch, EventIndOmicronD43M12hotdeck1, SamplingStep))

with(subset(dat_proc, Trialstage==1 & ph2.D43.nAb), table(SamplingStep))


with(subset(dat_proc, Trialstage==1 & EventIndOmicronD43M12hotdeck1==1), mytable(SamplingStep, nAbBatch))

with(subset(dat_proc, Trialstage==1 & EventIndOmicronD43M12hotdeck1==0 & ph2.D43.nAb), mytable(SamplingStep, nAbBatch))


with(subset(dat_proc, Trialstage==1), mytable(SamplingStep, nAbBatch))



mypairs(subset(dat_proc, Trialstage==1 & ph2.D43.nAb & Bserostatus==1 & Trt==1 & nAbBatch==1)[,"Day22"%.%nassays])

mypairs(subset(dat_proc, Trialstage==1 & ph2.D43.nAb & Bserostatus==1 & Trt==1 & nAbBatch==2)[,"Day22"%.%nassays])
myboxplot(Day22pseudoneutid50~nAbBatch, subset(dat_proc, Trialstage==1 & ph2.D43.nAb & EventIndPrimaryD1==0 & Trt==1 & Bserostatus==1))

with(subset(dat_proc, Trialstage==1 & EventIndPrimaryD1==0 & ph2.D43.nAb), table(SamplingStep, Bserostatus, Trt))


```

bAb.

```{r}
# stage 1
with(subset(dat_proc, Trialstage==1 & ph2.D22.bAb), table(SamplingStep, EventIndPrimaryD1))

# stage 2
with(subset(dat_proc, Trialstage==2 & ph2.D22.bAb), table(SamplingStep, EventIndPrimaryD1))
```

Some ptids have samples assayed in different batches.
```{r}
subset(dat_proc, Ptid=="VAT00008-170-0003-11007", c(Trialstage, Bserostatus)) # naive
subset(dat_proc, Ptid=="VAT00008-840-0011-10001", c(Trialstage, Bserostatus)) # naive
subset(dat_proc, Ptid=="VAT00008-840-0012-16001", c(Trialstage, Bserostatus)) # naive


```

