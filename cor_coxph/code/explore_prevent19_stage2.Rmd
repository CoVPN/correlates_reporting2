---
title: "PREVENT-19 Stage 2 Delta Correlates"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(survey)
library(kyotil)

dat_mapped=read.csv('/trials/covpn/p3004/analysis/mapping_immune_correlates/stage2/adata/COVID_Novavax_stage2_mapped_20240313.csv')

# extract the first variant. empty string to empty string
dat_mapped$VARTYPE_first1 = sapply(strsplit(dat_mapped$VARTYPE_first,","), function (x) ifelse(length(x)==0, "Unk", x[1]))
dat_mapped$VARTYPE_first1 = ifelse(dat_mapped$EventIndFirstD1==0, NA, dat_mapped$VARTYPE_first1)
dat_mapped$VARTYPE_first1 = ifelse(dat_mapped$EventIndFirstD1==1 & is.na(dat_mapped$VARTYPE_first1), "Unk", dat_mapped$VARTYPE_first1)

dat_mapped$VARTYPE_second1 = sapply(strsplit(dat_mapped$VARTYPE_second,","), function (x) ifelse(length(x)==0, "Unknown", x[1]))
dat_mapped$VARTYPE_second1 = ifelse(dat_mapped$EventIndFirstD1==0, NA, dat_mapped$VARTYPE_second1)
dat_mapped$VARTYPE_second1 = ifelse(dat_mapped$EventIndFirstD1==1 & is.na(dat_mapped$VARTYPE_second1), "Unk", dat_mapped$VARTYPE_second1)

dat_mapped$EarlyendpointD35 <- with(dat_mapped, EarlyinfectionD35==1 | (DeltaEventIndD1==1 & DeltaEventTimeD1 < NumberdaysD1toD35 + 7),1,0)
dat_mapped$ph1.D35 = with(dat_mapped, EarlyendpointD35==0 & Perprotocol==1 & DeltaEventTimeD35 >= 7)

dat_proc=read.csv('/trials/covpn/p3004/analysis/correlates/Part_A_Blinded_Phase_Data/adata/prevent19_stage2_data_processed_20240314.csv')

assay_metadata=read.csv('~/correlates_reporting2/assay_metadata/prevent19_stage2_assay_metadata.csv')
assays=assay_metadata$assay
assays

times=c("Day35","C1","BD1","DD1")
```


### Data descriptives

This dataset uses the updated clinical database, which is slightly different from the Stage 1 dataset. 

The dataset contains vaccine arm only and seroneg only, but has both US and MEX.
```{r, include=F}
mytable(dat_mapped$Trt)
mytable(dat_mapped$Bserostatus)
mytable(dat_mapped$Country)
```


**Case definitions**

The 17-month BLA analysis primary endpoint definition and the case definition we are using now are different. Is it censored at C1? Does include less than mild?


There are 16 severe cases, of which 9 have markers. The number is not sufficient to study severe correlates.
```{r}
with(subset(dat_mapped, ph1.D35==1 & Country==0 & EventIndFirstD35==1), mytable(Severity_first, !is.na(Day35bindSpike_Delta3)))
```


**Booster dose**

- Getting COVID did not disqualify a person from getting the booster, but there are other eligibility criteria. About half of the ptids have missing BD1 date, and presumably not getting booster. 

- Sampling was done regardless of having BD1 dates. 

- There are no cases infected after BD. 

- There were 10 non-cases censored after BD before we applied censoring by BD. 
```{r, echo=T}
mytable(dat_mapped$NumberdaysD1toBD1 - dat_mapped$DeltaEventTimeD1 < 0, dat_mapped$DeltaEventIndD1)
with(subset(dat_mapped, ph1.D35==1 & Country==0 & DeltaEventIndD1==1), mytable(is.na(NumberdaysD1toBD1), !is.na(Day35bindSpike_Delta3)))
```


### COVID variants

Distribution of variant first (variant of the first COVID event). Not all Delta have markers b/c sampling requires DD1 samples.
```{r}
with(subset(dat_mapped, ph1.D35==1 & Country==0 ), mytable(VARTYPE_first1, !is.na(Day35bindSpike_Delta3)))
```

Distribution of variant second:
```{r}
with(subset(dat_mapped, ph1.D35==1 & Country==0 ), mytable(VARTYPE_second1, !is.na(Day35bindSpike_Delta3)))
```


Distribution of variants type between the first and second COVID events shows that Delta is always the first.
```{r}
with (subset(dat_mapped, !is.na(VARTYPE_second1)), mytable(paste(VARTYPE_first1, VARTYPE_second1, sep=",")))
```

Distribution of severity and variants. Note that less than mild are not counted as cases.
```{r}
with(subset(dat_mapped, ph1.D35==1), mytable(Severity_first, VARTYPE_first1, DeltaEventIndD35)) 

```


### Adjusting followup period

Comparing timing of events of different variants, first using time since D35, second using calendar time. Ptids with markers are colored green. The plots suggest that we move the censoring date back by 3 months. That way we avoid the Omicron wave near the beginning of 2022.

```{r}
dat.tmp = subset(dat_mapped, ph1.D35==1 & Country==0)
myboxplot(EventTimeFirstD35~VARTYPE_first1, dat.tmp, ylab="EventTimeFirstD35", col=ifelse(!is.na(dat.tmp$Day35bindSpike_Delta3),3,1))

dat.tmp = subset(dat_mapped, ph1.D35==1 & Country==0 & !is.na(DateDD1))
myboxplot(as.Date(DateDD1)~VARTYPE_first1, dat.tmp, ylab="DateDD1", col=ifelse(!is.na(dat.tmp$Day35bindSpike_Delta3),3,1))
abline(h=as.Date("2022-03-26")) # data cut
abline(h=as.Date("2021-12-16"), lty=2) 
```
 
 Some ptids apparently have inconsistent case status in stage 1 and 2 datasets, e.g.
 ```{r}
 subset(dat_mapped, Subjectid=="2019nCoV-301-US049-0039")
 subset(dat_mapped, Subjectid=="2019nCoV-301-US159-0063")
```


### Missingness and imputation

Correlation is high among bAb markers and high between the two nAb markers.
```{r}
dat=dat_mapped[,"Day35"%.%assays]
names(dat)=sub("Day35","",names(dat))
mypairs(dat)
```

Missingness across markers at D35
```{r}
dat=subset(dat_mapped)
for (i in 1:length(assays)) {
  dat[['tmp'%.%i]]=ifelse(is.na(dat[['Day35'%.%assays[i]]]), 0, 1)
}
dat$tmp=with(dat,paste0(tmp1,tmp2,tmp3,tmp4,tmp5,tmp6,tmp7,tmp8,tmp9,tmp10))
print(table(dat$tmp, dat$DeltaEventIndD35))
```

Because the correlation between ancestral and Delta ID50s is 0.9, we will impute them if only one is missing. The bAb is all or none. We then restrict the ph2 samples to be the ptids with both bAb and nAb. Doing this allows us to compare nAb and bAb and avoid any batch effect in nAb.
```{r}
dat=subset(dat_mapped)
dat$tmp1 = !is.na(dat$Day35pseudoneutid50_D614G) | !is.na(dat$Day35pseudoneutid50_Delta)
dat$tmp2 = !is.na(dat$Day35bindSpike_Alpha)
dat$tmp=with(dat,paste0(as.integer(tmp1),as.integer(tmp2)))
print(table(dat$tmp, dat$DeltaEventIndD35))
subset(dat, tmp=="10" & Country==0, c(Subjectid))[1:10,]
```


***Stage 2 sampling lists***:

- For the 402 cases,  the time points of interest are D35 (after primary series in initial period),  the acute illness visit associated with the Delta case, and crossover 1 (if applicable for subject).   D35 may or may not be already tested earlier at the USG labs.

- For the 649 non-case, the D35 blood sample should already be at the USG lab from earlier.

- The list of 279 non-cases is a subset of the list of 649. For the 279 subjects, the time points of interest are D35, crossover 1 and booster D0 - the database says these subjects should have all 3 visits/blood sample.  



Correlation between ancestral and Delta ID50s is high at each time point, and highest at BD1 (0.97) and DD1 (0.98).
```{r}
dat=dat_mapped[,c(rbind(times%.%"pseudoneutid50_D614G",times%.%"pseudoneutid50_Delta"))]
names(dat)=sub("pseudoneutid50","",names(dat))
mypairs(dat)
```

A closer look at the correlation between ancestral ID50 and Delta ID50

```{r}
corplot(Day35pseudoneutid50_D614G~Day35pseudoneutid50_Delta, dat_mapped, asp=1)
```


Delta ID50 readouts are lower than ancestral ID50.
```{r}
dat=dat_mapped[,c(rbind(times%.%"pseudoneutid50_D614G",times%.%"pseudoneutid50_Delta"))]
names(dat)=sub("pseudoneutid50","",names(dat))
myboxplot(dat)
```


Missingness across two time points, D35 and C1, for ancestral id50
```{r}
for (j in 1:2){
  # change the comments to focus on different subsets
  dat=subset(dat_mapped)
  # dat=subset(dat_mapped, D35ancestralnAbBatch==23) # remove batch 1
  # dat=subset(dat_mapped, VARTYPE=="Delta") # delta cases
  
  v=ifelse(j==1,"D614G","Delta")
  print(v)
  
  for (i in 1:2) {
    dat[['tmp'%.%i]]=ifelse(is.na(dat[[times[i]%.%'pseudoneutid50_'%.%v]]), 0, 1)
  }
  dat$tmp=with(dat,paste0(tmp1,tmp2))
  print(table(dat$tmp))
  cat("\n")
}
```


### Batch effect

679 D35 samples (including cases and non-cases) have ID50s measured twice by Monogram, once in Dec 21 in the Stage 1 work and once in July 23 in the Stage 2 work.
The Pearson correlation is 0.88 between the two. Two-sample test by wilcoxon paired test p value is 6.046e-16. 
Applications that are sensitives to a shift of ~20% fold change in titers could be impacted.

```{r}
dat.2=read.csv('/trials/covpn/p3004/download_data/2019nCoV2-301_ nAB_D614G_27Oct2023 - 2.csv')

dat.2$batch=substr(dat.2$Monogram.Accession, 1, 2)
mytable(dat.2$batch)

mytable(dat.2$PVC, dat.2$Test.Method)

# find duplicated measurement of the same samples
dat.2.anc=subset(dat.2, Test.Method=='SARS-COV-2 D614G NEUT' & PVC=='D35')
dat.2.anc=dat.2.anc[order(dat.2.anc$Patient.Number),]

tmp = mytable(dat.2.anc$Patient.Number)
mytable(tmp)
tmp[tmp==3] # US097-0021
subset(dat.2.anc, Patient.Number=='US097-0021')

dat.2.anc=subset(dat.2.anc, Patient.Number %in% names(tmp[tmp==2]))
dat.2.anc$batch = ifelse(startsWith(dat.2.anc$Monogram.Accession,'23'),2,1)

subset(dat.2.anc, Patient.Number=='US152-0064')

dat.n=myreshapewide(Titer.Result~batch, dat.2.anc, 'Accession.Container')

clean=function(x) {
  x[x=='< 40']=20
  x[x=='ZNG40']=20
  as.integer((x))
}

dat.n$Titer.Result.1=clean(dat.n$Titer.Result.1)
dat.n$Titer.Result.2=clean(dat.n$Titer.Result.2)

dat.n$dif=log10(dat.n$Titer.Result.1)-log10(dat.n$Titer.Result.2)
summary(dat.n$dif)
summary(10**dat.n$dif)
myboxplot(list(dat.n$dif))

corplot(Titer.Result.1~Titer.Result.2,dat.n, log='xy', method='p')
# abline(h=(8282), lty=2)
# abline(v=(26859), lty=2)
abline(a=-log10(2),b=1, lty=2) # 2 fold difference
abline(a=log10(2),b=1, lty=2)

myboxplot(dat.n[,c('Titer.Result.1','Titer.Result.2')], log='y', test='w')

wilcox.test(dat.n$Titer.Result.1, dat.n$Titer.Result.2,paired=T)

nrow(dat.n)
```


We use the later measurements when there are duplicates. 

D35ancestralnAbBatch is the first two digits in the Monogram accession number and represents year. Most nAb were measured in 2023. Earlier samples may be from Stage 1 study.
```{r}
mytable(dat_mapped$D35ancestralnAbBatch)
```
