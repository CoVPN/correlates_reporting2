---
header-includes:
  - \usepackage{float}
output:
  pdf_document: default
html_document: default
citation_package: natbib
number_sections: true
extra_dependencies: ["caption", "subcaption", "graphicx"]
toc: true
---

\maxdeadcycles=200

<!-- \clearpage -->
<!-- \section{Overview} -->


<!-- \clearpage -->
\section{Multivariable marker Super Learner modeling} 

```{r load-objects, warning=FALSE, echo=FALSE, message=FALSE}
library(tidyverse, quietly = T)
library(kableExtra, quietly = T)
library(conflicted, quietly = T)
library(glue, quietly = T)
conflicted::conflict_prefer("filter", "dplyr")
conflict_prefer("summarise", "dplyr")
#load(here("output/", Sys.getenv("TRIAL"), "/objects_for_running_SL.rda"))
load(here(Sys.getenv('file_path'), "objects_for_running_SL.rda"))

# if(endpoint=="EventIndPrimaryD57")
#   day = "Day 57"
# if(endpoint %in% c("EventIndPrimaryD29", "EventIndPrimaryIncludeNotMolecConfirmedD29"))
#   day = "Day 29"
```

\vspace{2cm}


Cohort:  `r paste0("**", exposureStatus, "**")`     
Treatment arms: `r paste0("**", trt_arms, "**")`      
Cases considered for analysis: `r paste0("**", caseType, "**")`         
Risk factors considered for analysis:  `r paste0("**", briskfactors, collapse = ", ", "**")`

\vspace{2cm}

The data file used in this analysis is `r paste0("**", sub("^\\.\\./\\.\\./data/", "", data_cleaned), "**")`



\clearpage

```{r learner-screens, warning=FALSE, echo=FALSE, message=FALSE}

read.csv(here(Sys.getenv('file_path'), "learner-screens.csv"), row.names = 1, header = TRUE) %>%
  rename(Screen = `Screen.`) %>%
  { 
    kable(
      .,
      booktabs = TRUE,
      linesep = "",
      caption = glue("All learner-screen combinations ({nrow(.)} in total) used as input to the Super Learner.")
    ) %>%
    kable_styling(
      latex_options = c("hold_position"),
      font_size = 9
    )
  }

```




```{r cvsl-args, warning=FALSE, echo=FALSE}
caption <- "Arguments supplied to CV.Superlearner."

cvsl_args <- read.csv(here(Sys.getenv('file_path'), "cvsl_args.csv"),
                      row.names = 1, header = TRUE) 
# %>%
#   mutate(Argument = if_else(Argument == "Cases/Total Subjects in vaccine group (%)", "Cases/Total Subjects in phase 2 (%)", Argument)) 

cases_phase1 <- cvsl_args %>% filter(Argument == "Cases/Total Subjects in phase 1 (%)")
cases_phase2 <- cvsl_args %>% filter(Argument == "Cases/Total Subjects in phase 2 (%)")

cvsl_args %>%
  filter(!Argument %in% c("Cases/Total Subjects in phase 1 (%)",
                          "Cases/Total Subjects in phase 2 (%)")) %>%
  kable(
    booktabs = TRUE,
    linesep = "",
    caption = caption
  ) %>%
  kable_styling(latex_options = c("hold_position"),
                font_size = 9) %>%
  row_spec(0, bold=TRUE) %>%
  footnote(
    general = c(
      paste0(cases_phase1$Argument, " = ", cases_phase1$Value),
      paste0(cases_phase2$Argument, " = ", cases_phase2$Value)
    ),
    threeparttable = TRUE
  )

```



\clearpage
```{r variable-sets, warning=FALSE, echo=FALSE}

read.csv(here(Sys.getenv('file_path'), "varsets.csv"),
         row.names = 1, header = TRUE) %>%
  rename(
    `Variable Set Name` = Variable.Set.Name,
    `Variables included in the set` = Variables.included.in.the.set
  ) %>%
  {
    kable(
      .,
      booktabs = TRUE,
      linesep = "",
      caption = glue("All variable sets ({nrow(.)} in total) with immunological markers for which Super Learner was run.")
    ) %>%
    kable_styling(
      latex_options = c("hold_position"),
      font_size = 9
    ) %>%
    column_spec(2, width = "10cm") %>%
    row_spec(0, bold = TRUE)
  }
# %>%
#   footnote(c("Baseline risk factors includes the following: ",
#              "1. Risk score",
#              "2. HighRiskInd: Heightened At-Risk binary indicator",
#              "3. LatinAmerica: Binary indicator for subjects from Latin America except Columbia",
#              "4. SouthAfrica: Binary indicator for subjects from South Africa",
#              "5. Columbia: Binary indicator for subjects from Columbia",
#              "6. EnrollPeriod2: Binary indicator for subjects enrolled in the 2nd biweekly enrollment period",
#              "7. EnrollPeriod3: Binary indicator for subjects enrolled in the 3rd biweekly enrollment period",
#              "8. EnrollPeriod4: Binary indicator for subjects enrolled in the 4th biweekly enrollment period",
#              "9. EnrollPeriod5: Binary indicator for subjects enrolled in the 5th biweekly enrollment period",
#              "10. EnrollPeriod6: Binary indicator for subjects enrolled in the 6th biweekly enrollment period",
#              "11. EnrollPeriod7: Binary indicator for subjects enrolled in the 7th biweekly enrollment period"),
#            threeparttable = TRUE)

```


\begin{landscape}

\clearpage

```{r base-varset-markers, warning=FALSE, echo=FALSE, message=FALSE}

df = read.csv(here(Sys.getenv('file_path'), "varsets_with_markers_table.csv"), header = TRUE) 

# Find the row number that matches the target string
cutoff_row <- which(df$varset == "varset_combin_D1nD15")

df %>% 
  dplyr::slice(1:cutoff_row) %>% # Filter rows from the top up to and including that row
  mutate(markers = if_else(varset == "varset_baselineRiskFactors", "N/A", markers)) %>%
  rename(`Variable Set` = `varset`,
         Markers = markers) %>%
  kable(
    booktabs = TRUE,
    longtable = TRUE,
    linesep = "",
    caption = glue("Markers included in the base, unique variable sets. Variable sets that are a combination of these base variable sets are not shown."),
    caption.short = ""
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "repeat_header", "striped"),
    font_size = 9
  ) %>%
  column_spec(2, width = "12cm") %>%
  kable_classic("striped")

rm(df)

```


\end{landscape}

\clearpage

```{r DiscreteSLperformance-allvarsets, warning=FALSE, echo=FALSE, message=FALSE}

DiscreteSLperf_allvarsets <- read.csv(here(Sys.getenv('file_path'), "DiscreteSLperformance_allvarsets.csv"),
                              row.names = 1,
                              header = TRUE)  %>%
  mutate(varsetStr = str_replace_all(varset, "_", "\\\\_"),
         varsetStr = fct_inorder(varsetStr),
         varset = fct_inorder(varset))

DiscreteSLperf_allvarsets %>%
  select(-varsetStr) %>%
  rename(
    `Variable set` = varset,
    `CV-AUC (95% CI)` = AUCstr
  ) %>%
  {
    kable(
      .,
      booktabs = TRUE,
      linesep = "",
      caption = glue("Discrete Super Learner performance across all {nrow(.)} variable sets sorted by weighted CV-AUC performance.")
    ) %>%
    kable_styling(
      latex_options = c("hold_position"),
      font_size = 9
    )
  }


```


\clearpage
```{r, echo=FALSE, out.width="99%", out.height="120%", fig.height=50, fig.cap="Forest plot showing Discrete Super Learner performance (weighted CV-AUC with 95\\% CI) across the 50 top-performing variable sets."}

knitr::include_graphics(here(Sys.getenv('file_path'), "figs", "forest_vacc_cvaucs_allDiscrete SLs.png"))

```




\clearpage

```{r SLperformance-allvarsets, warning=FALSE, echo=FALSE, message=FALSE}

SLperf_allvarsets <- read.csv(here(Sys.getenv('file_path'), "SLperformance_allvarsets.csv"),
                              row.names = 1,
                              header = TRUE)  %>%
  mutate(varsetStr = str_replace_all(varset, "_", "\\\\_"),
         varsetStr = fct_inorder(varsetStr),
         varset = fct_inorder(varset))

SLperf_allvarsets %>%
  select(-varsetStr) %>%
  rename(
    `Variable set` = varset,
    `CV-AUC (95% CI)` = AUCstr
  ) %>%
  {
    kable(
      .,
      booktabs = TRUE,
      linesep = "",
      caption = glue("Super Learner performance across all {nrow(.)} variable sets sorted by weighted CV-AUC performance.")
    ) %>%
    kable_styling(
      latex_options = c("hold_position"),
      font_size = 9
    )
  }


```




\clearpage
```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap="Forest plot showing Super Learner performance (weighted CV-AUC with 95\\% CI) across the 50 top-performing variable sets."}

knitr::include_graphics(here(Sys.getenv('file_path'), "figs", "forest_vacc_cvaucs_allSLs.png"))

```



<!-- \clearpage -->
<!-- \section{Variable set importance} -->

<!-- ```{r vim-estimates-grp, warning=FALSE, echo=FALSE, message=FALSE} -->
<!-- caption <- "Estimated variable importance (estimated difference in CV-AUC with 95\\% CI) of each variable set relative to baseline risk factors." -->

<!-- read.csv(here("cor_surrogates", "output", Sys.getenv("TRIAL"), "vim_estimates.csv"), -->
<!--          row.names = 1, -->
<!--          header = TRUE) %>% -->
<!--   filter(group) %>% -->
<!--   filter(!grepl("base", variable_set)) %>% -->
<!--   arrange(-as.numeric(est)) %>% -->
<!--   mutate(est = format(round(est, 3), nsmall = 3), -->
<!--          ci_ll = format(round(ci_ll, 3), nsmall = 3), -->
<!--          ci_ul = format(round(ci_ul, 3), nsmall = 3), -->
<!--          se = format(round(se, 3), nsmall = 3), -->
<!--          pval = format(round(pval, 3), nsmall = 3), -->
<!--          estCI = paste0(est, " [", ci_ll, ", ", ci_ul, "]")) %>% -->
<!--   select(variable_set, estCI, se, pval) %>% -->
<!--   rename(`Variable set` = variable_set, -->
<!--          `VIM estimate [95% CI]` = estCI, -->
<!--          `std.error` = se, -->
<!--          `p-value` = pval) %>% -->
<!--   kable( -->
<!--     booktabs = TRUE, -->
<!--     linesep = "", -->
<!--     caption = caption -->
<!--   ) %>% -->
<!--   kable_styling(latex_options = c("hold_position"), -->
<!--                 font_size = 9) -->

<!-- ``` -->

<!-- \clearpage -->
<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap="Forest plot showing estimated variable importance (estimated difference in CV-AUC with 95\\% CI) of each variable set relative to baseline risk factors."} -->

<!-- knitr::include_graphics(paste0("figs/", Sys.getenv("TRIAL"), "/group_vim_forest_plot.png")) -->

<!-- ``` -->



<!-- \clearpage -->

<!-- ```{r vim-predictiveness-grp, warning=FALSE, echo=FALSE, message=FALSE} -->
<!-- caption <- "Estimated predictiveness (CV-AUC with 95\\% CI) for all variable sets derived upon sample splitting. Discrepancies between these CV-AUC estimates and the estimates provided in Table 4 and Figure 1 are expected to diminish with increase in sample size." -->

<!-- read.csv(paste0("output/", Sys.getenv("TRIAL"), "/vim_predictiveness_estimates.csv"), -->
<!--          row.names = 1, -->
<!--          header = TRUE) %>% -->
<!--   filter(group) %>% -->
<!--   arrange(-as.numeric(est)) %>% -->
<!--   mutate(est = format(round(est, 3), nsmall = 3), -->
<!--          ci_ll = format(round(ci_ll, 3), nsmall = 3), -->
<!--          ci_ul = format(round(ci_ul, 3), nsmall = 3), -->
<!--          se = format(round(se, 3), nsmall = 3), -->
<!--          estCI = paste0(est, " [", ci_ll, ", ", ci_ul, "]")) %>% -->
<!--   select(variable_set, estCI, se) %>% -->
<!--   rename(`Variable set` = variable_set, -->
<!--          `Predictiveness estimate [95% CI]` = estCI, -->
<!--          `std.error` = se) %>% -->
<!--   kable( -->
<!--     booktabs = TRUE, -->
<!--     linesep = "", -->
<!--     caption = caption -->
<!--   ) %>% -->
<!--   kable_styling(latex_options = c("hold_position"), -->
<!--                 font_size = 9) -->

<!-- ``` -->



<!-- \clearpage -->
<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap="Forest plot showing estimated predictiveness (CV-AUC with 95\\% CI) across all variable sets derived upon sample splitting. Discrepancies between these CV-AUC estimates and the estimates provided in Table 4 and Figure 1 are expected to diminish with increase in sample size. Dashed vertical line drawn at CV-AUC = 0.5 represents predictiveness similar to random chance."} -->

<!-- knitr::include_graphics(paste0("figs/", Sys.getenv("TRIAL"), "/group_pred_forest_plot.png")) -->

<!-- ``` -->

<!-- \clearpage -->
<!-- \section{Individual variable importance} -->

<!-- ```{r vim-estimates-vars, warning=FALSE, echo=FALSE, message=FALSE} -->
<!-- caption <- "Estimated variable importance (estimated difference in CV-AUC with 95\\% CI) of each individual variable relative to baseline risk factors." -->

<!-- read.csv(paste0("output/", Sys.getenv("TRIAL"), "/vim_estimates.csv"), -->
<!--          row.names = 1, -->
<!--          header = TRUE) %>% -->
<!--   filter(!group) %>% -->
<!--   filter(!grepl("base", variable_set)) %>% -->
<!--   arrange(-as.numeric(est)) %>% -->
<!--   mutate(est = format(round(est, 3), nsmall = 3), -->
<!--          ci_ll = format(round(ci_ll, 3), nsmall = 3), -->
<!--          ci_ul = format(round(ci_ul, 3), nsmall = 3), -->
<!--          se = format(round(se, 3), nsmall = 3), -->
<!--          pval = format(round(pval, 3), nsmall = 3), -->
<!--          estCI = paste0(est, " [", ci_ll, ", ", ci_ul, "]")) %>% -->
<!--   select(variable_set, estCI, se, pval) %>% -->
<!--   rename(`Variable name` = variable_set, -->
<!--          `VIM estimate [95% CI]` = estCI, -->
<!--          `std.error` = se, -->
<!--          `p-value` = pval) %>% -->
<!--   kable( -->
<!--     booktabs = TRUE, -->
<!--     linesep = "", -->
<!--     caption = caption -->
<!--   ) %>% -->
<!--   kable_styling(latex_options = c("hold_position"), -->
<!--                 font_size = 9) -->

<!-- ``` -->

<!-- \clearpage -->
<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap="Forest plot showing estimated variable importance (estimated difference in CV-AUC with 95\\% CI) of each individual variable relative to baseline risk factors."} -->

<!-- knitr::include_graphics(paste0("figs/", Sys.getenv("TRIAL"), "/individual_vim_forest_plot.png")) -->

<!-- ``` -->



<!-- \clearpage -->

<!-- ```{r vim-predictiveness-vars, warning=FALSE, echo=FALSE, message=FALSE} -->
<!-- caption <- "Estimated predictiveness (CV-AUC with 95\\% CI) of each individual variable derived upon sample splitting." -->

<!-- read.csv(paste0("output/", Sys.getenv("TRIAL"), "/vim_predictiveness_estimates.csv"), -->
<!--          row.names = 1, -->
<!--          header = TRUE) %>% -->
<!--   filter(!group) %>% -->
<!--   arrange(-as.numeric(est)) %>% -->
<!--   mutate(est = format(round(est, 3), nsmall = 3), -->
<!--          ci_ll = format(round(ci_ll, 3), nsmall = 3), -->
<!--          ci_ul = format(round(ci_ul, 3), nsmall = 3), -->
<!--          se = format(round(se, 3), nsmall = 3), -->
<!--          estCI = paste0(est, " [", ci_ll, ", ", ci_ul, "]")) %>% -->
<!--   select(variable_set, estCI, se) %>% -->
<!--   rename(`Variable name` = variable_set, -->
<!--          `Predictiveness estimate [95% CI]` = estCI, -->
<!--          `std.error` = se) %>% -->
<!--   kable( -->
<!--     booktabs = TRUE, -->
<!--     linesep = "", -->
<!--     caption = caption -->
<!--   ) %>% -->
<!--   kable_styling(latex_options = c("hold_position"), -->
<!--                 font_size = 9) -->

<!-- ``` -->



<!-- \clearpage -->
<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap="Forest plot showing estimated predictiveness (CV-AUC with 95\\% CI) across all individual variables derived upon sample splitting. Dashed vertical line drawn at CV-AUC = 0.5 represents predictiveness similar to random chance."} -->

<!-- knitr::include_graphics(paste0("figs/", Sys.getenv("TRIAL"), "/individual_pred_forest_plot.png")) -->

<!-- ``` -->







\clearpage
# Appendix
Forest plots, ROC curves and predicted probability plots for 5 top-performing variable sets are shown below:


```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[1], "'': Weighted CV-AUC (95\\% CI) of algorithms for predicting COVID-19 cases.")}
knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("forest_vacc_cvaucs_", levels(DiscreteSLperf_allvarsets$varset)[1], ".png")))
```

```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[1], "'': Weighted CV-AUC ROC curves of top two individual learners along with Super Learner and discrete-SL.")}
knitr::include_graphics(here::here(Sys.getenv('file_path'), "figs", paste0("ROCcurve_", levels(DiscreteSLperf_allvarsets$varset)[1], ".png")))
```

```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[1], "'': Weighted prediction probability plots with median (IQR) for top two individual learners, Super Learner and discrete-SL.")}
knitr::include_graphics(here::here(Sys.getenv('file_path'), "figs", paste0("predProb_", levels(DiscreteSLperf_allvarsets$varset)[1], ".png")))
```



```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[2], "'': Weighted CV-AUC (95\\% CI) of algorithms for predicting COVID-19 cases.")}
knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("forest_vacc_cvaucs_", levels(DiscreteSLperf_allvarsets$varset)[2], ".png")))
```

```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[2], "'': Weighted CV-AUC ROC curves of top two individual learners along with Super Learner and discrete-SL.")}
knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("ROCcurve_", levels(DiscreteSLperf_allvarsets$varset)[2], ".png")))
```

```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[2], "'': Weighted prediction probability plots with median (IQR) for top two individual learners, Super Learner and discrete-SL.")}
knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("predProb_", levels(DiscreteSLperf_allvarsets$varset)[2], ".png")))
```

```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[3], "'': Weighted CV-AUC (95\\% CI) of algorithms for predicting COVID-19 cases.")}
knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("forest_vacc_cvaucs_", levels(DiscreteSLperf_allvarsets$varset)[3], ".png")))
```

```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[3], "'': Weighted CV-AUC ROC curves of top two individual learners along with Super Learner and discrete-SL.")}
knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("ROCcurve_", levels(DiscreteSLperf_allvarsets$varset)[3], ".png")))
```

```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[3], "'': Weighted prediction probability plots with median (IQR) for top two individual learners, Super Learner and discrete-SL.")}
knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("predProb_", levels(DiscreteSLperf_allvarsets$varset)[3], ".png")))
```

```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[4], "'': Weighted CV-AUC (95\\% CI) of algorithms for predicting COVID-19 cases.")}
knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("forest_vacc_cvaucs_", levels(DiscreteSLperf_allvarsets$varset)[4], ".png")))
```

```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[4], "'': Weighted CV-AUC ROC curves of top two individual learners along with Super Learner and discrete-SL.")}
knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("ROCcurve_", levels(DiscreteSLperf_allvarsets$varset)[4], ".png")))
```

```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[4], "'': Weighted prediction probability plots with median (IQR) for top two individual learners, Super Learner and discrete-SL.")}
knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("predProb_", levels(DiscreteSLperf_allvarsets$varset)[4], ".png")))
```

```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[5], "'': Weighted CV-AUC (95\\% CI) of algorithms for predicting COVID-19 cases.")}
knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("forest_vacc_cvaucs_", levels(DiscreteSLperf_allvarsets$varset)[5], ".png")))
```

```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[5], "'': Weighted CV-AUC ROC curves of top two individual learners along with Super Learner and discrete-SL.")}
knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("ROCcurve_", levels(DiscreteSLperf_allvarsets$varset)[5], ".png")))
```

```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[5], "'': Weighted prediction probability plots with median (IQR) for top two individual learners, Super Learner and discrete-SL.")}
knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("predProb_", levels(DiscreteSLperf_allvarsets$varset)[5], ".png")))
```




<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[6], "'': Weighted CV-AUC (95\\% CI) of algorithms for predicting COVID-19 cases.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("forest_vacc_cvaucs_", levels(DiscreteSLperf_allvarsets$varset)[6], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[6], "'': Weighted CV-AUC ROC curves of top two individual learners along with Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("ROCcurve_", levels(DiscreteSLperf_allvarsets$varset)[6], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[6], "'': Weighted prediction probability plots with median (IQR) for top two individual learners, Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("predProb_", levels(DiscreteSLperf_allvarsets$varset)[6], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[7], "'': Weighted CV-AUC (95\\% CI) of algorithms for predicting COVID-19 cases.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("forest_vacc_cvaucs_", levels(DiscreteSLperf_allvarsets$varset)[7], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[7], "'': Weighted CV-AUC ROC curves of top two individual learners along with Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("ROCcurve_", levels(DiscreteSLperf_allvarsets$varset)[7], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[7], "'': Weighted prediction probability plots with median (IQR) for top two individual learners, Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("predProb_", levels(DiscreteSLperf_allvarsets$varset)[7], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[8], "'': Weighted CV-AUC (95\\% CI) of algorithms for predicting COVID-19 cases.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("forest_vacc_cvaucs_", levels(DiscreteSLperf_allvarsets$varset)[8], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[8], "'': Weighted CV-AUC ROC curves of top two individual learners along with Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("ROCcurve_", levels(DiscreteSLperf_allvarsets$varset)[8], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[8], "'': Weighted prediction probability plots with median (IQR) for top two individual learners, Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("predProb_", levels(DiscreteSLperf_allvarsets$varset)[8], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[9], "'': Weighted CV-AUC (95\\% CI) of algorithms for predicting COVID-19 cases.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("forest_vacc_cvaucs_", levels(DiscreteSLperf_allvarsets$varset)[9], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[9], "'': Weighted CV-AUC ROC curves of top two individual learners along with Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("ROCcurve_", levels(DiscreteSLperf_allvarsets$varset)[9], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[9], "'': Weighted prediction probability plots with median (IQR) for top two individual learners, Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("predProb_", levels(DiscreteSLperf_allvarsets$varset)[9], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[10], "'': Weighted CV-AUC (95\\% CI) of algorithms for predicting COVID-19 cases.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("forest_vacc_cvaucs_", levels(DiscreteSLperf_allvarsets$varset)[10], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[10], "'': Weighted CV-AUC ROC curves of top two individual learners along with Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("ROCcurve_", levels(DiscreteSLperf_allvarsets$varset)[10], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[10], "'': Weighted prediction probability plots with median (IQR) for top two individual learners, Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("predProb_", levels(DiscreteSLperf_allvarsets$varset)[10], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[11], "'': Weighted CV-AUC (95\\% CI) of algorithms for predicting COVID-19 cases.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("forest_vacc_cvaucs_", levels(DiscreteSLperf_allvarsets$varset)[11], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[11], "'': Weighted CV-AUC ROC curves of top two individual learners along with Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("ROCcurve_", levels(DiscreteSLperf_allvarsets$varset)[11], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[11], "'': Weighted prediction probability plots with median (IQR) for top two individual learners, Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("predProb_", levels(DiscreteSLperf_allvarsets$varset)[11], ".png"))) -->
<!-- ``` -->


<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[12], "'': Weighted CV-AUC (95\\% CI) of algorithms for predicting COVID-19 cases.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("forest_vacc_cvaucs_", levels(DiscreteSLperf_allvarsets$varset)[12], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[12], "'': Weighted CV-AUC ROC curves of top two individual learners along with Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("ROCcurve_", levels(DiscreteSLperf_allvarsets$varset)[12], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[12], "'': Weighted prediction probability plots with median (IQR) for top two individual learners, Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("predProb_", levels(DiscreteSLperf_allvarsets$varset)[12], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[13], "'': Weighted CV-AUC (95\\% CI) of algorithms for predicting COVID-19 cases.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("forest_vacc_cvaucs_", levels(DiscreteSLperf_allvarsets$varset)[13], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[13], "'': Weighted CV-AUC ROC curves of top two individual learners along with Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("ROCcurve_", levels(DiscreteSLperf_allvarsets$varset)[13], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[13], "'': Weighted prediction probability plots with median (IQR) for top two individual learners, Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here("cor_surrogates", "figs", Sys.getenv("TRIAL"), paste0("predProb_", levels(DiscreteSLperf_allvarsets$varset)[13], ".png"))) -->
<!-- ``` -->



<!-- ```{r get-reference-varset-index, echo=FALSE, include=FALSE} -->

<!-- ref_varset_index = which(DiscreteSLperf_allvarsets$varset == "1_baselineRiskFactors") -->

<!-- ``` -->


<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[ref_varset_index], "'': Weighted CV-AUC (95\\% CI) of algorithms for predicting COVID-19 cases.")} -->
<!-- knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("forest_vacc_cvaucs_", levels(DiscreteSLperf_allvarsets$varset)[ref_varset_index], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[ref_varset_index], "'': Weighted CV-AUC ROC curves of top two individual learners along with Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("ROCcurve_", levels(DiscreteSLperf_allvarsets$varset)[ref_varset_index], ".png"))) -->
<!-- ``` -->

<!-- ```{r, echo=FALSE, out.width="99%", out.height="120%", fig.cap=paste0("Variable set ``", levels(DiscreteSLperf_allvarsets$varsetStr)[ref_varset_index], "'': Weighted prediction probability plots with median (IQR) for top two individual learners, Super Learner and discrete-SL.")} -->
<!-- knitr::include_graphics(here(Sys.getenv('file_path'), "figs", paste0("predProb_", levels(DiscreteSLperf_allvarsets$varset)[ref_varset_index], ".png"))) -->
<!-- ``` -->



\clearpage
\begin{landscape}

```{r allvarsets-allFolds-discreteSLs, warning=FALSE, echo=FALSE, message=FALSE}
caption <- "Predictors and their coefficients in the Discrete SL learner (top-performing learner) selected for each of the 5 folds across top 5 variable sets and the reference variable set. Results shown are for the first random seed (out of 10 random seeds)."

if(!basename(file_path) %in% c("nonnaive_1dose_allcases_briskscore", "nonnaive_1dosemRNA_allcases_briskscore")){
  tab <- read.csv(here(Sys.getenv('file_path'), "all_varsets_all_folds_discreteSLmodels.csv"),
         row.names = 1,
         header = TRUE) %>%
  select(-"Predictors.Features") %>%
  select(varset, fold, Learner, everything()) %>%
  mutate(order = match(varset, DiscreteSLperf_allvarsets$varset)) %>%
  #arrange(order, fold, -abs(Coefficient), -abs(Gain)) %>%
  arrange(order, fold, -abs(Coefficient)) %>%
  mutate(Coefficient = format(round(Coefficient, 3), nsmall = 3),
         Odds.Ratio = format(round(Odds.Ratio, 3), nsmall = 3),
         #Gain = format(round(Gain, 3), nsmall = 3),
         #Cover = format(round(Cover, 3), nsmall = 3),
         #Frequency = format(round(Frequency, 3), nsmall = 3)
         ) %>%
  select(-order) %>%
  rename(`Variable Set` = varset,
         Fold = fold)
} else if (basename(file_path) == "nonnaive_1dose_allcases_briskscore"){
  tab <- read.csv(here(Sys.getenv('file_path'), "all_varsets_all_folds_discreteSLmodels.csv"),
         row.names = 1,
         header = TRUE) %>%
  #select(-"Predictors.Features") %>%
  rename(`Predictors/Features` = `Predictors.Features`) %>%
  select(varset, fold, Learner, everything()) %>%
  mutate(order = match(varset, DiscreteSLperf_allvarsets$varset)) %>%
  arrange(order, fold, -abs(Coefficient), -abs(Gain)) %>%
  mutate(Coefficient = format(round(Coefficient, 3), nsmall = 3),
         Odds.Ratio = format(round(Odds.Ratio, 3), nsmall = 3),
         #Gain = format(round(Gain, 3), nsmall = 3),
         #Cover = format(round(Cover, 3), nsmall = 3),
         #Frequency = format(round(Frequency, 3), nsmall = 3)
         ) %>%
  select(-order) %>%
  rename(`Variable Set` = varset,
         Fold = fold)
} else if (basename(file_path) == "nonnaive_1dosemRNA_allcases_briskscore"){
  tab <- read.csv(here(Sys.getenv('file_path'), "all_varsets_all_folds_discreteSLmodels.csv"),
         row.names = 1,
         header = TRUE) %>%
  #select(-"Predictors.Features") %>%
  rename(`Predictors/Features` = `Predictors.Features`) %>%
  select(varset, fold, Learner, everything()) %>%
  mutate(order = match(varset, DiscreteSLperf_allvarsets$varset)) %>%
  arrange(order, fold, -abs(Coefficient), -abs(Gain)) %>%
  mutate(Coefficient = format(round(Coefficient, 3), nsmall = 3),
         Odds.Ratio = format(round(Odds.Ratio, 3), nsmall = 3),
         #Gain = format(round(Gain, 3), nsmall = 3),
         #Cover = format(round(Cover, 3), nsmall = 3),
         #Frequency = format(round(Frequency, 3), nsmall = 3)
         ) %>%
  select(-order) %>%
  rename(`Variable Set` = varset,
         Fold = fold)
}



tab %>%
  kable(
    booktabs = TRUE,
    longtable = TRUE,
    linesep = "",
    caption = caption
  ) %>%
  kable_styling(latex_options = c("hold_position", "repeat_header"),
                font_size = 5)
# %>%
#   row_spec(which(tab$`Variable Set` %in% c("1_baselineRiskFactors",
#                                        "2_bAbSpike_D57",
#                                        "27_pnabID80_D29_D57",
#                                        "34_allMarkers_combScores_D29_D57")), bold = T, color = "red")

```

\end{landscape}

